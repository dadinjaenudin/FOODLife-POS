<!--
============================================================================
CUSTOMER DISPLAY (customer_display.html)
============================================================================
Layar kedua (second monitor) yang menampilkan informasi bill dan
slideshow promosi ke customer. Dijalankan dari POS Launcher Qt
(pos_launcher_qt.py) sebagai QWebEngineView window terpisah.

ARSITEKTUR: SSE (Server-Sent Events)
=====================================
SSE adalah protokol HTTP one-way streaming dimana server mengirim
event secara real-time ke client melalui koneksi HTTP yang tetap
terbuka (persistent connection).

DATA FLOW:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  POS Main Screen          ‚îÇ
‚îÇ  (Django + HTMX)          ‚îÇ
‚îÇ  - User tambah item       ‚îÇ
‚îÇ  - User buka payment      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ HTTP POST (clone bill panel HTML)
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Flask Local API (:5000)  ‚îÇ
‚îÇ  POST /api/customer-      ‚îÇ
‚îÇ       display/update      ‚îÇ
‚îÇ  - Simpan ke display_data ‚îÇ
‚îÇ  - notify_subscribers()   ‚îÇ
‚îÇ    ‚Üí queue.put(data)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ SSE stream (text/event-stream)
          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Customer Display (ini)   ‚îÇ
‚îÇ  GET /api/customer-       ‚îÇ
‚îÇ      display/stream       ‚îÇ
‚îÇ  - EventSource listener   ‚îÇ
‚îÇ  - updateDisplay(data)    ‚îÇ
‚îÇ  - Render bill panel HTML ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

ENDPOINT API (Flask Local - localhost:5000):
- GET  /health                        : Health check
- GET  /api/customer-display/stream   : SSE stream (persistent connection)
- POST /api/customer-display/update   : Terima update dari POS
- GET  /api/customer-display/config   : Config branding/slideshow

FUNGSI UTAMA:
- connectSSE()        : Health check ‚Üí startSSE()
- startSSE()          : Buat EventSource, handle onmessage/onerror
- updateDisplay(data) : Render bill panel HTML atau empty state
- handleModalDisplay(): Tampilkan payment modal di customer display
- showQRCode(data)    : Tampilkan QR code untuk pembayaran digital
- loadConfig()        : Load branding config + slideshow images

LAYOUT (2-column grid):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      ‚îÇ              ‚îÇ
‚îÇ   Slideshow (70%)    ‚îÇ  Bill Panel  ‚îÇ
‚îÇ   Promo images dari  ‚îÇ  (30%)       ‚îÇ
‚îÇ   MinIO storage      ‚îÇ  Mirror dari ‚îÇ
‚îÇ                      ‚îÇ  POS bill    ‚îÇ
‚îÇ                      ‚îÇ              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Footer: Running text + status      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

RECONNECTION:
- connectSSE() cek /health dulu sebelum buka SSE
- Jika gagal, retry setiap 3 detik
- EventSource.onerror ‚Üí close + retry 3 detik
- Server kirim keepalive setiap 30 detik agar koneksi tidak timeout

ANTI-FLICKER:
- Track lastBillHash & lastModalHash untuk skip duplicate update
- Hanya toggle display state jika berubah (showContainers/hideContainers)
- Modal inject langsung tanpa delay
============================================================================
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Display</title>
    
    <!-- Disable caching to always show fresh content -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <!-- Tailwind CSS (Local) -->
    <script src="assets/tailwind.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            color: #333;
            position: relative;
        }
        
        /* ========== HEADER ========== */
        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }
        
        .header-logo {
            width: 60px;
            height: 60px;
            margin-right: 1rem;
            border-radius: 50%;
            background: #667eea;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }
        
        .header-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 50%;
        }
        
        .header-text h1 {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.25rem;
        }
        
        .header-text p {
            font-size: 1rem;
            color: #666;
        }
        
        /* ========== MAIN CONTENT ========== */
        .main-content {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-columns: 7fr 3fr;
            gap: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        /* ========== SLIDESHOW (LEFT 70%) ========== */
        .slideshow-container {
            background: #f8f9fa;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            width: 100%;
            height: 100vh;
        }
        
        .slide {
            display: none;
            width: 100%;
            height: 100vh;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .slide.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        /* Slide Images from MinIO */
        .slide-image {
            width: 100%;
            height: 100vh;
            object-fit: cover;
            border-radius: 0;
        }
        
        .slide-error {
            padding: 4rem;
            font-size: 2rem;
            color: #dc3545;
            background: #fff3cd;
            border-radius: 10px;
        }
        
        .slide-content {
            padding: 2rem;
            border-radius: 15px;
            width: 100%;
        }
        
        .slide h2 {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #667eea;
        }
        
        .slide p {
            font-size: 2rem;
            color: #333;
        }
        
        .slide-indicators {
            position: absolute;
            bottom: 3.5rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            z-index: 20;
        }
        
        .slide-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #d1d5db;
            transition: all 0.3s;
        }
        
        .slide-indicator.active {
            background: #667eea;
            width: 30px;
            border-radius: 6px;
        }
        
        /* ========== BILLING INFO (RIGHT 30% FULL HEIGHT) ========== */
        .billing-container {
            background: white;
            padding: 0;
            color: #333;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100vh;
            width: 100%;
            max-width: 100%;
            margin: 0;
            border: none;
            box-sizing: border-box;
        }
        
        .billing-header {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
            margin: 0;
            padding: 1.5rem 1rem 0.75rem 1rem;
            border-bottom: 3px solid #667eea;
        }
        
        .items-list {
            flex: 1;
            overflow-y: auto;
            margin: 0;
            padding: 1rem;
        }
        
        .empty-bill {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            padding: 2rem 1rem;
        }
        
        .empty-bill svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-bill img {
            width: 140px;
            height: 140px;
            object-fit: contain;
            border-radius: 16px;
            margin-bottom: 1rem;
        }

        .empty-bill p {
            font-size: 1.1rem;
        }
        
        /* ========== FOOTER (RUNNING TEXT + STATUS) ========== */
        .footer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: #f8f9fa;
            border-top: 2px solid #e9ecef;
            padding: 0.5rem 1rem;
            overflow: hidden;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .running-text {
            flex: 1;
            display: inline-block;
            white-space: nowrap;
            animation: marquee 30s linear infinite;
            font-size: 1.4rem;
            font-weight: 500;
            padding-left: 100%;
            color: #666;
        }
        
        @keyframes marquee {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
        
        /* ========== CONNECTION STATUS ========== */
        .connection-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-left: 1rem;
        }
        
        .status-connected {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }
        
        .status-disconnected {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        
        /* ========== SCROLLBAR ========== */
        .billing-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .billing-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .billing-container::-webkit-scrollbar-thumb {
            background: #667eea;
            border-radius: 10px;
        }
        
        .billing-container::-webkit-scrollbar-thumb:hover {
            background: #764ba2;
        }

        /* ========== HIDE POS-ONLY CONTROLS IN MIRRORED BILL PANEL ========== */
        /* Customer sees: item list, prices, totals only.
           Hide: all buttons, keyboard shortcuts, qty controls, button grids */
        #bill-panel-container button,
        #bill-panel-container kbd,
        #bill-panel-container .inline-flex,
        #bill-panel-container [class*="grid-cols"] {
            display: none !important;
        }

        /* ========== QR CODE MODAL ========== */
        .qr-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease-out;
        }
        
        .qr-modal.active {
            display: flex;
        }
        
        .qr-content {
            background: white;
            padding: 3rem;
            border-radius: 30px;
            text-align: center;
            animation: scaleIn 0.3s ease-out;
        }
        
        @keyframes scaleIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        
        .qr-content h2 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        
        .qr-content p {
            color: #666;
            font-size: 1.4rem;
            margin-bottom: 2rem;
        }
        
        .qr-code-container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 20px;
            margin-bottom: 2rem;
        }
        
        .qr-code-container img {
            width: 300px;
            height: 300px;
            border: 5px solid #667eea;
            border-radius: 15px;
        }
        
        .qr-amount {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
            margin-top: 1.5rem;
        }
        
        .qr-timer {
            font-size: 1.2rem;
            color: #999;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Main Content -->
    <div class="main-content">
        <!-- Slideshow (Left 70%) -->
        <div class="slideshow-container">
            <!-- Header -->
            <div class="header">
                <div class="header-logo" id="header-logo">
                    üè™
                </div>
                <div class="header-text">
                    <h1 id="brand-name">Loading...</h1>
                </div>
            </div>
            
            <div id="slideshow-slides">
                <!-- Slides will be loaded here -->
            </div>
            <div class="slide-indicators" id="slide-indicators"></div>
            
            <!-- Footer (Running Text + Connection Status) -->
            <div class="footer">
                <div class="running-text" id="running-text">Loading...</div>
                <span class="connection-status status-disconnected" id="connection-status">Connecting...</span>
            </div>
        </div>
        
        <!-- Billing Info (Right 55%) - Bill Panel Mirror -->
        <div id="bill-panel-container" class="billing-container">
            <div class="billing-header">
                üìã Your Order
            </div>
            
            <div class="items-list" id="items-list">
                <div class="empty-bill" id="empty-bill-default">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                    <p>Waiting for items...</p>
                </div>
            </div>
            

        </div>
    </div>
    
    <!-- Modal Overlay for Customer Display -->
    <div id="customer-modal-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 99999; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(8px); align-items: center; justify-content: center; padding: 2rem;">
        <div id="customer-modal-content" style="background: white; border-radius: 1rem; max-width: 90%; max-height: 90%; overflow: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);">
            <!-- Modal content will be injected here -->
        </div>
    </div>
    
    <!-- QR Code Modal (for payment) -->
    <div class="qr-modal" id="qr-modal">
        <div class="qr-content">
            <h2>üí≥ Scan to Pay</h2>
            <p>Scan QR code dengan aplikasi pembayaran Anda</p>
            <div class="qr-code-container">
                <img id="qr-code-image" src="" alt="QR Code" style="display: none;">
                <div id="qr-loading" style="font-size: 3rem; color: #667eea;">
                    ‚è≥ Generating...
                </div>
            </div>
            <div class="qr-amount" id="qr-amount">Rp 0</div>
            <div class="qr-timer" id="qr-timer">Expires in 5:00</div>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://127.0.0.1:5000';
        let eventSource = null;
        let config = null;
        let currentSlide = 0;
        let slideInterval = null;

        // Anti-flicker: track last rendered content to skip duplicate updates
        let lastBillHash = '';
        let lastModalHash = '';
        let lastUpdatedAt = 0;
        let currentDisplayState = 'hidden'; // 'hidden' | 'active'
        
        // ========== UTILITY FUNCTIONS ==========
        function formatCurrency(amount) {
            return 'Rp ' + Math.floor(amount).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        }
        
        // ========== LOAD CONFIGURATION ==========
        async function loadConfig(retries = 10, delay = 2000) {
            console.log('[Config] Starting config load process...');
            console.log(`[Config] API URL: ${API_URL}/api/customer-display/config`);
            
            for (let i = 0; i < retries; i++) {
                try {
                    console.log(`[Config] Attempt ${i + 1}/${retries}: Fetching config...`);
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    const response = await fetch(`${API_URL}/api/customer-display/config`, {
                        signal: controller.signal,
                        cache: 'no-cache',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                    clearTimeout(timeoutId);
                    
                    console.log(`[Config] Response status: ${response.status}`);
                    console.log(`[Config] Response type: ${response.type}`);
                    console.log(`[Config] Response OK: ${response.ok}`);
                    
                    // Check if response is actually JSON
                    const contentType = response.headers.get('content-type');
                    console.log(`[Config] Content-Type: ${contentType}`);
                    
                    if (!contentType || !contentType.includes('application/json')) {
                        throw new Error(`Expected JSON, got ${contentType}`);
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    config = await response.json();
                    console.log('[Config] ‚úÖ Config loaded successfully');
                    console.log('[Config] Source: Django API Database');
                    console.log('[Config] Brand:', config.brand?.name || 'N/A');
                    console.log('[Config] Slides:', config.slideshow?.length || 0);
                    console.log('[Config] Running Text Speed:', config.running_text_speed || 'N/A');
                    console.log('[Config] Theme:', config.theme ? 'Custom' : 'Default');
                    
                    // Apply config
                    applyBrandConfig();
                    initSlideshow();
                    initRunningText();
                    return; // Success!
                } catch (error) {
                    console.error(`[Config] ‚ùå Attempt ${i + 1} failed:`, error.message);
                    console.error('[Config] Error details:', error);
                    
                    if (i < retries - 1) {
                        console.log(`[Config] Retrying in ${delay}ms...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error('[Config] ‚ùå All retries failed. Using defaults.');
                        // Use defaults
                        document.getElementById('brand-name').textContent = 'POS System';
                        document.getElementById('running-text').textContent = 'Welcome!';
                    }
                }
            }
        }
        
        function applyBrandConfig() {
            if (!config || !config.brand) return;
            
            const brand = config.brand;
            document.getElementById('brand-name').textContent = brand.name || 'POS System';
            
            // Logo
            if (brand.logo_url) {
                const logoHtml = `<img src="${brand.logo_url}" alt="Logo" onerror="console.error('[Brand] Logo failed to load:', '${brand.logo_url}'); this.style.display='none';">`;
                document.getElementById('header-logo').innerHTML = logoHtml;
                console.log('[Brand] Logo URL:', brand.logo_url);
            }

            // Store image for empty-bill state
            if (config.store_image_url) {
                const emptyBill = document.getElementById('empty-bill-default');
                if (emptyBill) {
                    const svg = emptyBill.querySelector('svg');
                    if (svg) {
                        const img = document.createElement('img');
                        img.src = config.store_image_url;
                        img.alt = brand.name || '';
                        img.onerror = function() { this.style.display = 'none'; svg.style.display = ''; };
                        svg.style.display = 'none';
                        svg.parentNode.insertBefore(img, svg);
                    }
                }
                console.log('[Brand] Store image URL:', config.store_image_url);
            }

            // Theme colors
            if (config.theme) {
                const theme = config.theme;
                if (theme.primary_color && theme.secondary_color) {
                    document.body.style.background = `linear-gradient(135deg, ${theme.primary_color} 0%, ${theme.secondary_color} 100%)`;
                }
            }
        }
        
        // ========== SLIDESHOW ==========
        async function initSlideshow() {
            console.log('[Customer Display] Initializing slideshow from local config...');
            
            try {
                // Use slideshow data from local API config (already fetched server-side)
                const slides = (config && Array.isArray(config.slideshow)) ? config.slideshow : [];
                
                if (!slides.length) {
                    console.log('[Customer Display] No slides available, showing default');
                    showDefaultSlide();
                    // Show slideshow container even with default slide
                    const slideshowContainer = document.querySelector('.slideshow-container');
                    if (slideshowContainer) slideshowContainer.style.display = 'flex';
                    return;
                }
                
                console.log(`[Customer Display] Loaded ${slides.length} slides from config`);
                
                const slidesContainer = document.getElementById('slideshow-slides');
                const indicatorsContainer = document.getElementById('slide-indicators');
                
                // Create slides with images (URLs already converted to absolute by local_api.py)
                slidesContainer.innerHTML = slides.map((slide, index) => `
                    <div class="slide ${index === 0 ? 'active' : ''}" data-index="${index}" data-duration="${(slide.duration_seconds || slide.duration || 5) * 1000}">
                        <img src="${slide.image_url}" 
                             alt="${slide.title || 'Slide'}" 
                             class="slide-image"
                             loading="${index === 0 ? 'eager' : 'lazy'}"
                             onerror="console.error('[Slideshow] Image failed to load:', '${slide.image_url}'); this.style.display='none'; this.parentElement.innerHTML='<div class=\\'slide-error\\'>Image failed to load<br><small>${slide.image_url}</small></div>';">
                    </div>
                `).join('');
                
                // Create indicators
                indicatorsContainer.innerHTML = slides.map((_, index) => 
                    `<div class="slide-indicator ${index === 0 ? 'active' : ''}" data-index="${index}"></div>`
                ).join('');
                
                // Show slideshow container
                const slideshowContainer = document.querySelector('.slideshow-container');
                if (slideshowContainer) {
                    slideshowContainer.style.display = 'flex';
                    console.log('[Customer Display] Slideshow container shown');
                }
                
                // Start rotation
                console.log('[Customer Display] Starting slideshow...');
                startSlideshow(slides);
                
            } catch (error) {
                console.error('[Customer Display] Failed to load slideshow:', error);
                showDefaultSlide();
                // Show slideshow container even on error
                const slideshowContainer = document.querySelector('.slideshow-container');
                if (slideshowContainer) slideshowContainer.style.display = 'flex';
            }
        }
        
        function showDefaultSlide() {
            // Show default welcome slide if no slides available
            const brandName = config && config.brand && config.brand.name ? config.brand.name : 'YOGYA Food Life';
            const slidesContainer = document.getElementById('slideshow-slides');
            if (slidesContainer) {
                slidesContainer.innerHTML = `
                    <div class="slide active">
                        <div class="slide-content" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                            <h2>üéâ Selamat datang di ${brandName}!</h2>
                            <p>Nikmati berbagai menu pilihan terbaik</p>
                        </div>
                    </div>
                `;
            }
            
            // Clear indicators for default slide
            const indicatorsContainer = document.getElementById('slide-indicators');
            if (indicatorsContainer) {
                indicatorsContainer.innerHTML = '';
            }
            
            console.log('[Customer Display] Showing default welcome slide');
        }
        
        function startSlideshow(slides) {
            if (slideInterval) clearInterval(slideInterval);
            
            if (!slides || slides.length === 0) {
                console.log('[Slideshow] No slides to rotate');
                return;
            }
            
            console.log('[Slideshow] Starting rotation with', slides.length, 'slides');
            
            function nextSlide() {
                currentSlide = (currentSlide + 1) % slides.length;
                console.log('[Slideshow] Moving to slide', currentSlide + 1, 'of', slides.length);
                showSlide(currentSlide);
                
                // Use slide-specific duration or default 5 seconds
                const slide = slides[currentSlide];
                const duration = (slide.duration_seconds || slide.duration || 5) * 1000;
                console.log('[Slideshow] Next rotation in', duration / 1000, 'seconds');
                slideInterval = setTimeout(nextSlide, duration);
            }
            
            // Only start rotation if more than 1 slide
            if (slides.length > 1) {
                // Start with first slide's duration
                const firstSlide = slides[0];
                const firstDuration = (firstSlide.duration_seconds || firstSlide.duration || 5) * 1000;
                console.log('[Slideshow] First rotation in', firstDuration / 1000, 'seconds');
                slideInterval = setTimeout(nextSlide, firstDuration);
            } else {
                console.log('[Slideshow] Only 1 slide, no rotation needed');
            }
        }
        
        function showSlide(index) {
            // Update slides
            const slides = document.querySelectorAll('.slide');
            slides.forEach((slide, i) => {
                slide.classList.toggle('active', i === index);
            });
            
            // Update indicators
            const indicators = document.querySelectorAll('.slide-indicator');
            indicators.forEach((indicator, i) => {
                indicator.classList.toggle('active', i === index);
            });
        }
        
        // ========== RUNNING TEXT ==========
        function initRunningText() {
            const runningTextEl = document.getElementById('running-text');
            const footer = document.querySelector('.footer');
            
            // Always show footer
            if (footer) footer.style.display = 'flex';
            
            // Set running text from config or use default
            if (config && config.running_text) {
                runningTextEl.textContent = config.running_text;
                console.log('[Customer Display] Running text loaded:', config.running_text);
            } else {
                runningTextEl.textContent = 'Selamat datang di YOGYA Food Life ‚Ä¢ Nikmati berbagai menu pilihan terbaik ‚Ä¢ Terima kasih atas kunjungan Anda';
                console.log('[Customer Display] Using default running text');
            }
        }
        
        // ========== CONTAINER HELPERS (anti-flicker) ==========
        function showContainers() {
            const bp = document.getElementById('bill-panel-container');
            const ss = document.querySelector('.slideshow-container');
            const hd = document.querySelector('.header');
            if (currentDisplayState === 'active') return; // Already visible
            if (bp) bp.style.display = 'block';
            if (ss) ss.style.display = 'block';
            if (hd) hd.style.display = 'flex';
            currentDisplayState = 'active';
        }

        function hideContainers() {
            const bp = document.getElementById('bill-panel-container');
            const ss = document.querySelector('.slideshow-container');
            const hd = document.querySelector('.header');
            if (currentDisplayState === 'hidden') return; // Already hidden
            if (bp) bp.style.display = 'none';
            if (ss) ss.style.display = 'none';
            if (hd) hd.style.display = 'none';
            currentDisplayState = 'hidden';
        }

        // ========== DISPLAY UPDATE (anti-flicker) ==========
        function updateDisplay(data) {
            // Handle modal display
            if (data.show_modal !== undefined) {
                handleModalDisplay(data.show_modal, data.modal_html);
            }

            // Check if showing QR code for payment
            if (data.show_qr && data.qr_code) {
                showQRCode(data);
                return;
            } else {
                hideQRCode();
            }

            // Skip if updated_at hasn't changed (duplicate SSE event)
            if (data.updated_at && data.updated_at === lastUpdatedAt && !data.show_modal) {
                return;
            }
            lastUpdatedAt = data.updated_at || 0;

            const billPanelContainer = document.getElementById('bill-panel-container');

            // Check if we have bill panel HTML (new format - mirror POS bill panel)
            if (data.bill_panel_html && data.has_bill) {
                // Anti-flicker: skip innerHTML replacement if content is the same
                const newHash = data.bill_panel_html.length + '_' + data.updated_at;
                if (newHash === lastBillHash) {
                    return; // Content unchanged, skip re-render
                }
                lastBillHash = newHash;

                billPanelContainer.innerHTML = data.bill_panel_html;
                // Set styling once (className check avoids redundant reflow)
                if (billPanelContainer.className !== '') {
                    billPanelContainer.className = '';
                    billPanelContainer.style.background = 'white';
                }

                showContainers();
                return;
            }

            // Fallback to legacy JSON format or empty state
            // Restore billing container styling if it was removed
            if (!billPanelContainer.classList.contains('billing-container')) {
                billPanelContainer.className = 'billing-container';
                billPanelContainer.innerHTML = `
                    <div class="billing-header">Your Order</div>
                    <div class="items-list" id="items-list"></div>
                    <div class="billing-total" id="billing-total" style="display: none;">
                        <div class="total-row"><span>Subtotal</span><span id="subtotal-value">Rp 0</span></div>
                        <div class="total-row grand-total"><span>TOTAL</span><span id="total-value">Rp 0</span></div>
                    </div>
                `;
            }

            const itemsListEl = document.getElementById('items-list');
            const billingTotalEl = document.getElementById('billing-total');

            if (!data.items || data.items.length === 0) {
                // Empty state ‚Äî hide all UI for blank screen
                if (currentDisplayState !== 'hidden') {
                    const storeImg = (config && config.store_image_url)
                        ? `<img src="${config.store_image_url}" alt="" onerror="this.style.display='none'; this.nextElementSibling.style.display='';">`
                        : '';
                    const svgDisplay = storeImg ? 'style="display:none;"' : '';
                    itemsListEl.innerHTML = `
                        <div class="empty-bill">
                            ${storeImg}
                            <svg ${svgDisplay} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                            </svg>
                            <p>Waiting for items...</p>
                        </div>
                    `;
                    billingTotalEl.style.display = 'none';
                    hideContainers();
                }
                lastBillHash = '';
            } else {
                // Show items (legacy format)
                itemsListEl.innerHTML = data.items.map(item => `
                    <div class="item-row">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">${item.quantity} √ó ${formatCurrency(item.price)}</div>
                        </div>
                        <div class="item-price">${formatCurrency(item.quantity * item.price)}</div>
                    </div>
                `).join('');

                billingTotalEl.style.display = 'block';
                document.getElementById('subtotal-value').textContent = formatCurrency(data.subtotal || data.total || 0);
                document.getElementById('total-value').textContent = formatCurrency(data.total || 0);

                showContainers();
            }
        }
        
        // ========== MODAL DISPLAY ==========
        function handleModalDisplay(showModal, modalHTML) {
            const modalOverlay = document.getElementById('customer-modal-overlay');
            const modalContent = document.getElementById('customer-modal-content');

            if (showModal && modalHTML) {
                // Anti-flicker: skip if modal content is the same
                const newHash = modalHTML.length + '_' + modalHTML.substring(0, 100);
                if (newHash === lastModalHash && modalOverlay.style.display === 'flex') {
                    return; // Same modal already showing
                }
                lastModalHash = newHash;

                // Inject directly ‚Äî no delay to avoid blank frame flicker
                modalContent.innerHTML = modalHTML;
                modalOverlay.style.display = 'flex';
                modalOverlay.style.alignItems = 'center';
                modalOverlay.style.justifyContent = 'center';
            } else {
                if (modalOverlay.style.display !== 'none') {
                    modalOverlay.style.display = 'none';
                    modalContent.innerHTML = '';
                    lastModalHash = '';
                }
            }
        }
        
        // ========== QR CODE DISPLAY ==========
        let qrTimer = null;
        let qrTimeRemaining = 300; // 5 minutes
        
        function showQRCode(data) {
            const modal = document.getElementById('qr-modal');
            const qrImage = document.getElementById('qr-code-image');
            const qrLoading = document.getElementById('qr-loading');
            const qrAmount = document.getElementById('qr-amount');
            
            modal.classList.add('active');
            qrAmount.textContent = formatCurrency(data.total || 0);
            
            // Show QR code image
            if (data.qr_code) {
                qrImage.src = data.qr_code;
                qrImage.style.display = 'block';
                qrLoading.style.display = 'none';
            }
            
            // Start countdown timer
            qrTimeRemaining = 300;
            startQRTimer();
        }
        
        function hideQRCode() {
            const modal = document.getElementById('qr-modal');
            modal.classList.remove('active');
            if (qrTimer) {
                clearInterval(qrTimer);
                qrTimer = null;
            }
        }
        
        function startQRTimer() {
            if (qrTimer) clearInterval(qrTimer);
            
            qrTimer = setInterval(() => {
                qrTimeRemaining--;
                
                const minutes = Math.floor(qrTimeRemaining / 60);
                const seconds = qrTimeRemaining % 60;
                document.getElementById('qr-timer').textContent = 
                    `Expires in ${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                if (qrTimeRemaining <= 0) {
                    clearInterval(qrTimer);
                    hideQRCode();
                }
            }, 1000);
        }
        
        // ========== SSE CONNECTION ==========
        function connectSSE() {
            const statusEl = document.getElementById('connection-status');
            statusEl.textContent = 'Connecting...';
            statusEl.className = 'connection-status status-disconnected';
            
            console.log('Attempting SSE connection...');
            
            // First, check if API is available
            fetch(`${API_URL}/health`)
                .then(response => response.json())
                .then(health => {
                    console.log('API health check OK:', health);
                    startSSE();
                })
                .catch(error => {
                    console.error('API not available:', error.message);
                    statusEl.textContent = 'API not available';
                    setTimeout(connectSSE, 3000);
                });
        }
        
        function startSSE() {
            const statusEl = document.getElementById('connection-status');
            
            try {
                eventSource = new EventSource(`${API_URL}/api/customer-display/stream`);
            } catch (e) {
                console.error('Failed to create EventSource:', e);
                setTimeout(connectSSE, 3000);
                return;
            }
            
            eventSource.onopen = function() {
                console.log('SSE connected');
                statusEl.textContent = '‚óè Connected';
                statusEl.className = 'connection-status status-connected';
            };
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateDisplay(data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };
            
            eventSource.onerror = function(error) {
                console.warn('SSE disconnected, reconnecting in 3s...');
                statusEl.textContent = 'Reconnecting...';
                statusEl.className = 'connection-status status-disconnected';
                if (eventSource) {
                    eventSource.close();
                    eventSource = null;
                }
                setTimeout(connectSSE, 3000);
            };
        }
        
        // ========== INITIALIZATION ==========
        async function init() {
            // Clear browser storage to prevent stale data
            try {
                localStorage.clear();
                sessionStorage.clear();
            } catch (e) { /* ignore */ }

            // Force clear bill panel and modal containers
            const billPanel = document.getElementById('bill-panel');
            const modalOverlay = document.getElementById('modal-overlay');
            const modalContent = document.getElementById('modal-content');

            if (billPanel) billPanel.innerHTML = '';
            if (modalOverlay) modalOverlay.style.display = 'none';
            if (modalContent) modalContent.innerHTML = '';

            // Start hidden ‚Äî containers shown when SSE data arrives
            hideContainers();

            console.log('[Customer Display] Initialized');
            await loadConfig();
            connectSSE();
        }
        
        // Start after DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
        
        // ========== STUB FUNCTIONS (Prevent errors from cloned HTML) ==========
        // POS bill panel HTML may reference these ‚Äî stubs prevent JS errors
        window.checkShiftActive = function() { return false; };
        window.openFloorPlanModal = function() {};
        window.updateCustomerDisplay = function() {};
        window.closeModal = function() {};
        window.printReceipt = function() {};
        
        // Cleanup
        window.addEventListener('beforeunload', function() {
            if (slideInterval) clearInterval(slideInterval);
            if (eventSource) eventSource.close();
        });
    </script>
</body>
</html>
