{% extends 'base.html' %}

{% block title %}POS - {{ request.user.outlet.name }}{% endblock %}

{% block extra_head %}
<!-- Using system fonts for offline mode -->
<style>
    /* Typography */
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }
    h1, h2, h3, h4, h5, h6 {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-weight: 600;
    }
    
    /* Hide scrollbar for category navigation */
    .scrollbar-hide::-webkit-scrollbar {
        display: none;
    }

    .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }

    /* Floor Plan Overlay Animations */
    @keyframes slideInLeft {
        from {
            transform: translateX(-100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes slideOutLeft {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(-100%);
            opacity: 0;
        }
    }

    .animate-slideInLeft {
        animation: slideInLeft 0.3s ease-out forwards;
    }

    .animate-slideOutLeft {
        animation: slideOutLeft 0.3s ease-in forwards;
    }

    /* Hide kitchen printer widget and all footer widgets when in floor plan modal */
    #floor-plan-modal #kitchen-printer-widget,
    #floor-plan-modal #printer-status-widget,
    #floor-plan-modal #pos-footer,
    #floor-plan-modal [id*="widget"],
    #floor-plan-modal .fixed.bottom-0 {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- ==================================================
     POS MAIN INTERFACE - 3 COLUMN LAYOUT
     1. Left: Icon-only sidebar navigation (64px)
     2. Center: Main content with header, categories, products, footer (flex-1)
     3. Right: Bill panel with order summary (384px)
     ================================================== -->
<div class="flex h-screen bg-gray-50" x-data="posModal()">
    
    <!-- Custom Modal for Shift Warning -->
    <div x-show="modal.show" 
         x-transition:enter="transition ease-out duration-300"
         x-transition:enter-start="opacity-0"
         x-transition:enter-end="opacity-100"
         x-transition:leave="transition ease-in duration-200"
         x-transition:leave-start="opacity-100"
         x-transition:leave-end="opacity-0"
         class="fixed inset-0 z-50 overflow-y-auto"
         style="display: none;">
        <!-- Backdrop -->
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity"></div>
        
        <!-- Modal -->
        <div class="flex items-center justify-center min-h-screen p-4">
            <div x-show="modal.show"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="transition ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
                <!-- Modal Header -->
                <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-yellow-50 to-amber-50">
                    <div class="flex items-center space-x-3">
                        <!-- Warning Icon -->
                        <div class="flex-shrink-0">
                            <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                </svg>
                            </div>
                        </div>
                        <!-- Title -->
                        <h3 class="text-xl font-bold text-gray-800" x-text="modal.title"></h3>
                    </div>
                </div>
                
                <!-- Modal Body -->
                <div class="px-6 py-5">
                    <p class="text-gray-700" x-text="modal.message"></p>
                </div>
                
                <!-- Modal Footer -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-end space-x-3">
                    <button @click="modal.show = false"
                            class="px-5 py-2.5 bg-gray-200 text-gray-700 rounded-lg font-medium hover:bg-gray-300 transition-colors">
                        <span x-text="modal.cancelText"></span>
                    </button>
                    <button @click="modal.onConfirm()"
                            class="px-5 py-2.5 rounded-lg font-medium text-white bg-green-600 hover:bg-green-700 transition-colors">
                        <span x-text="modal.confirmText"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== LEFT: SIDEBAR (Icon + Text Navigation) ==================== -->
    <aside class="w-48 bg-white flex flex-col">

        <!-- Branding Logo -->
        <div>
            <div class="h-16 flex flex-col items-center justify-center px-4 gap-1">
                {% if store_config.login_logo %}
                <div class="w-10 h-10 rounded-full overflow-hidden bg-green-50 border-2 border-green-200 flex-shrink-0">
                    <img src="{{ store_config.login_logo.url }}" alt="Logo" class="w-full h-full object-contain p-0.5">
                </div>
                {% endif %}
                <span class="text-sm font-bold text-gray-900 text-center" style="font-family:'Outfit',sans-serif;">{{ store_config.brand.name }}</span>
            </div>
            
            <!-- User Info -->
            <div class="flex flex-col items-center gap-2 px-4 pb-3">
                {% if request.user.profile_photo %}
                <img src="{{ request.user.profile_photo.url }}" alt="" class="w-24 h-24 rounded-full object-cover border-2 border-gray-200">
                {% else %}
                <div class="w-24 h-24 rounded-full bg-green-100 flex items-center justify-center text-green-700 text-3xl font-bold">
                    {{ request.user.get_full_name.0|default:request.user.username.0|upper }}
                </div>
                {% endif %}
                <span class="text-xs font-medium text-gray-700 text-center truncate w-full">{{ request.user.get_full_name|default:request.user.username }}</span>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="flex-1 py-3 px-3 space-y-1 overflow-y-auto">
            <!-- Menu (Active) -->
            <a href="{% url 'pos:main' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold bg-green-600 text-white transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                <span>Menu</span>
            </a>

            <!-- Table Services -->
            <button onclick="openFloorPlanModal()" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200 w-full">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                <span>Table Services</span>
            </button>

            <!-- My Shift -->
            <button onclick="openMyShiftDashboard()" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200 w-full">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                <span>My Shift</span>
            </button>

            <!-- Reprint -->
            <button onclick="openReprintReconciliation()" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200 w-full">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/></svg>
                <span>Reprint</span>
            </button>

            <div class="h-px bg-gray-100 my-2"></div>

            <!-- Shift Status -->
            <div id="shift-status-sidebar" hx-get="{% url 'pos:shift_status' %}" hx-trigger="load, every 30s" hx-swap="innerHTML" class="py-1"></div>

            <div class="h-px bg-gray-100 my-2"></div>

            <!-- Kitchen Stations -->
            <a href="{% url 'kitchen:kds_station' 'kitchen' %}" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/></svg>
                <span>Kitchen</span>
            </a>

            <a href="{% url 'kitchen:kds_station' 'bar' %}" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                <span>Bar</span>
            </a>

            <a href="{% url 'kitchen:kds_station' 'dessert' %}" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 15.546c-.523 0-1.046.151-1.5.454a2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0 2.704 2.704 0 00-3 0 2.704 2.704 0 01-3 0A1.75 1.75 0 003 15.546M12 3v1m0 11v1m-4-7h1m6 0h1M7.757 5.757l.707.707m6.072 6.072l.707.707M5.757 12.243l.707-.707m6.072-6.072l.707-.707"/></svg>
                <span>Dessert</span>
            </a>

            <a href="{% url 'pos:queue_display' %}" target="_blank" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/></svg>
                <span>Queue</span>
            </a>

            <a href="{% url 'core:profile_settings' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-gray-900 hover:bg-green-50 hover:text-green-600 transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span>Settings</span>
            </a>
        </nav>

        <!-- Bottom: Logout -->
        <div class="px-3 py-3">
            <a href="{% url 'core:logout' %}" class="flex items-center gap-3 px-3 py-2.5 rounded-xl text-sm font-semibold text-red-500 hover:bg-red-50 hover:text-red-600 transition-all duration-200">
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- ==================== CENTER: MAIN CONTENT ==================== -->
    <main class="flex-1 flex flex-col">

        <!-- Header: Search Bar -->
        <header class="bg-gray-50 px-6 py-4">
            <div class="flex items-center justify-between gap-4">
                <div class="flex items-center gap-4 flex-1">
                    <!-- Hamburger (optional visual) -->
                    <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" onclick="document.querySelector('aside').classList.toggle('hidden')">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                    </button>

                    <!-- Search Bar -->
                    <div class="flex-1 relative max-w-xl">
                        <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <input type="text" id="product-search" placeholder="Search Product here..."
                            class="w-full pl-12 pr-4 py-3 text-sm bg-gray-50 border border-gray-200 rounded-xl focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-100 focus:bg-white transition-all"
                            hx-get="{% url 'pos:products' %}" hx-trigger="keyup changed delay:300ms"
                            hx-target="#product-grid" hx-include="this" name="search">
                    </div>
                </div>

                <!-- Right: Shift Status + Notification -->
                <div class="flex items-center gap-3">
                    <!-- Shift Status Indicator -->
                    <div id="header-shift-status" 
                         hx-get="{% url 'pos:shift_status_header' %}" 
                         hx-trigger="load, every 30s, shiftStatusChanged from:body" 
                         hx-swap="innerHTML">
                        <div class="px-3 py-2 bg-gray-200 rounded-lg animate-pulse">
                            <span class="text-xs text-gray-500">Loading...</span>
                        </div>
                    </div>
                    
                    <button class="p-2.5 bg-gray-50 hover:bg-gray-100 rounded-xl transition-colors relative">
                        <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/></svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content Area: Categories + Products (will be covered by floor plan) -->
        <div id="pos-content-area" class="flex-1 flex flex-col relative overflow-hidden">
            <!-- Shift Not Active Overlay (Hidden by default, shown by JS) -->
            <div id="shift-required-overlay" class="hidden absolute inset-0 bg-gray-900/50 backdrop-blur-sm z-40 flex items-center justify-center">
                <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md mx-4 text-center transform animate-slideUp">
                    <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-10 h-10 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Shift Not Active</h3>
                    <p class="text-gray-600 mb-6">You need to open your shift before you can start taking orders.</p>
                    <button onclick="openShiftFromOverlay()" class="w-full px-6 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white font-bold rounded-lg transition-all shadow-lg">
                        Open Shift Now
                    </button>
                </div>
            </div>
        <!-- Category Filter - Icon Card Style -->
        <nav class="bg-gray-50 px-6 py-4">
            <!-- Level 1 (Parent) Categories -->
            <div class="flex gap-3 overflow-x-auto pb-1 scrollbar-hide">
                <a href="{% url 'pos:main' %}"
                   class="flex-shrink-0 flex flex-col items-center gap-1.5 px-4 py-2 rounded-2xl border-2 transition-all duration-200 min-w-[80px] {% if not selected_parent %}border-green-500 bg-green-50{% else %}border-gray-200 bg-white hover:border-green-300 hover:bg-green-50/50{% endif %}">
                    <div class="w-8 h-8 flex items-center justify-center">
                        <svg class="w-6 h-6 {% if not selected_parent %}text-green-600{% else %}text-gray-500{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"/>
                        </svg>
                    </div>
                    <span class="text-xs font-bold {% if not selected_parent %}text-green-700{% else %}text-gray-700{% endif %}">All</span>
                    <span class="text-[10px] {% if not selected_parent %}text-green-500{% else %}text-gray-400{% endif %}">{{ products|length }} Items</span>
                </a>

                {% for category in parent_categories %}
                <a href="{% url 'pos:main' %}?parent={{ category.id }}"
                   class="flex-shrink-0 flex flex-col items-center gap-1.5 px-4 py-2 rounded-2xl border-2 transition-all duration-200 min-w-[80px] {% if selected_parent and selected_parent.id == category.id %}border-green-500 bg-green-50{% else %}border-gray-200 bg-white hover:border-green-300 hover:bg-green-50/50{% endif %}">
                    <div class="w-8 h-8 flex items-center justify-center">
                        {% if category.icon %}
                        <span class="text-xl">{{ category.icon }}</span>
                        {% else %}
                        <svg class="w-6 h-6 {% if selected_parent and selected_parent.id == category.id %}text-green-600{% else %}text-gray-500{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8.25v-1.5m0 1.5c-1.355 0-2.697.056-4.024.166C6.845 8.51 6 9.473 6 10.608v2.513m6-4.87c1.355 0 2.697.055 4.024.165C17.155 8.51 18 9.473 18 10.608v2.513m-3-4.87v-1.5m-6 1.5v-1.5m12 9.75l-1.5.75a3.354 3.354 0 01-3 0 3.354 3.354 0 00-3 0 3.354 3.354 0 01-3 0 3.354 3.354 0 00-3 0 3.354 3.354 0 01-3 0L3 16.5m15-3.38a48.474 48.474 0 00-6-.37c-2.032 0-4.034.125-6 .37"/>
                        </svg>
                        {% endif %}
                    </div>
                    <span class="text-xs font-bold {% if selected_parent and selected_parent.id == category.id %}text-green-700{% else %}text-gray-700{% endif %}">{{ category.name }}</span>
                </a>
                {% endfor %}
            </div>

            <!-- Level 2 (Sub) Categories -->
            {% if selected_parent %}
            <div class="flex items-center gap-2 mt-3 overflow-x-auto pb-1 scrollbar-hide">
                <button
                    class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-semibold bg-green-500 text-white"
                    hx-get="{% url 'pos:products' %}?parent={{ selected_parent.id }}" hx-target="#product-grid"
                    hx-swap="innerHTML swap:200ms settle:300ms">
                    All {{ selected_parent.name }}
                </button>

                {% for category in subcategories %}
                <button
                    class="flex-shrink-0 px-4 py-2 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 hover:bg-green-50 hover:text-green-700 transition-colors"
                    hx-get="{% url 'pos:products' %}?category={{ category.id }}" hx-target="#product-grid"
                    hx-swap="innerHTML swap:200ms settle:300ms">
                    {% if category.icon %}<span class="mr-1">{{ category.icon }}</span>{% endif %}
                    {{ category.name }}
                </button>
                {% endfor %}
            </div>
            {% endif %}
        </nav>

        <!-- Product Grid Container (Responsive, scrollable) -->
        <section id="product-grid" class="flex-1 p-4 overflow-y-auto bg-gray-50" style="padding-bottom: 6rem;">
            {% include 'pos/partials/product_grid.html' %}
        </section>
        </div>
        <!-- End Content Area -->

        <!-- Footer: System Info Bar -->
        <footer id="pos-footer" class="bg-white border-t border-gray-100">
            <div class="flex items-center px-4 py-3">
                <!-- System Info Tags -->
                <div class="flex items-center gap-3 text-sm text-gray-700">
                    <span class="px-6 py-2.5 bg-gray-100 border-2 border-gray-300 rounded-full font-semibold">{{ store_config.brand.company.code }}</span>
                    <span class="text-gray-300">â€¢</span>
                    <span class="px-6 py-2.5 bg-gray-100 border-2 border-gray-300 rounded-full font-semibold">{{ store_config.brand.code }}</span>
                    <span class="text-gray-300">â€¢</span>
                    <span class="px-6 py-2.5 bg-green-100 border-2 border-green-400 text-green-700 rounded-full font-semibold">{{ store_config.store_code }}</span>
                    <span class="text-gray-300">â€¢</span>
                    <span class="px-6 py-2.5 bg-gray-100 border-2 border-gray-300 rounded-full font-semibold" id="footer-terminal-code">-</span>
                </div>
            </div>
            <script>
                (function () {
                    const terminalCode = '{{ terminal_config.terminal_code|default:"NOT REGISTERED" }}';
                    const terminalEl = document.getElementById('footer-terminal-code');
                    if (terminalEl) {
                        terminalEl.textContent = terminalCode;
                        if (terminalCode === 'NOT REGISTERED') {
                            terminalEl.classList.add('text-red-700', 'bg-red-100', 'border-red-400', 'animate-pulse');
                            terminalEl.classList.remove('bg-gray-100', 'border-gray-300');
                        }
                    }
                })();
            </script>
        </footer>

        <!-- Kitchen Printer Status Widget (POS Footer Area) -->
           <div id="kitchen-printer-widget"
               class="fixed bottom-0 right-[44rem] z-40 bg-white border-t-2 border-l-2 border-gray-200 rounded-tl-xl shadow-lg"
               style="max-width: 360px;">
              <div class="flex items-center gap-2 px-3 py-2.5 h-12">
                <div class="relative">
                    <svg class="w-5 h-5 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    <span id="kitchen-printer-dot" class="absolute -top-1 -right-1 h-2.5 w-2.5 rounded-full border-2 border-white bg-gray-400"></span>
                </div>
                <div class="flex-1 min-w-0">
                    <div class="text-xs font-semibold text-gray-900" id="kitchen-printer-title">Kitchen Printer</div>
                    <div class="text-[10px] text-gray-500" id="kitchen-printer-subtitle">Loading...</div>
                </div>
                <button id="kitchen-printer-toggle" class="ml-1 text-gray-400 hover:text-gray-600" aria-label="Toggle">
                    <svg id="kitchen-printer-chevron" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                    </svg>
                </button>
            </div>
            <div id="kitchen-printer-body" class="border-t border-gray-200 px-3 py-2 text-[11px] text-gray-500">
                <div id="kitchen-printer-list" class="space-y-1.5"></div>
                <div class="mt-2 flex items-center justify-between">
                    <button id="kitchen-agent-start" class="px-2 py-1 text-[10px] bg-green-600 text-white rounded-md hover:bg-green-700">
                        Start Agent
                    </button>
                    <button id="kitchen-agent-stop" class="px-2 py-1 text-[10px] bg-red-600 text-white rounded-md hover:bg-red-700">
                        Stop Agent
                    </button>
                    <span id="kitchen-agent-msg" class="text-[10px] text-gray-400 truncate max-w-[80px]"></span>
                </div>
            </div>
        </div>
        <script>
            (function () {
                const endpoint = '{% url "pos:kitchen_printer_status" %}';
                const dot = document.getElementById('kitchen-printer-dot');
                const subtitle = document.getElementById('kitchen-printer-subtitle');
                const counts = document.getElementById('kitchen-printer-counts');
                const last = document.getElementById('kitchen-printer-last');
                const list = document.getElementById('kitchen-printer-list');
                const body = document.getElementById('kitchen-printer-body');
                const toggleBtn = document.getElementById('kitchen-printer-toggle');
                const chevron = document.getElementById('kitchen-printer-chevron');
                let agentStatus = 'unknown';
                const btnStart = document.getElementById('kitchen-agent-start');
                const btnStop = document.getElementById('kitchen-agent-stop');
                const agentMsg = document.getElementById('kitchen-agent-msg');

                function setCollapsed(collapsed) {
                    if (!body || !chevron) return;
                    body.style.display = collapsed ? 'none' : 'flex';
                    chevron.style.transform = collapsed ? 'rotate(180deg)' : 'rotate(0deg)';
                }

                function setDot(status) {
                    if (!dot) return;
                    dot.classList.remove('bg-green-500', 'bg-red-500', 'bg-yellow-500', 'bg-gray-400');
                    if (status === 'online') dot.classList.add('bg-green-500');
                    else if (status === 'offline') dot.classList.add('bg-red-500');
                    else if (status === 'degraded') dot.classList.add('bg-yellow-500');
                    else dot.classList.add('bg-gray-400');
                }

                async function refresh() {
                    try {
                        const res = await fetch(endpoint, { credentials: 'same-origin' });
                        const data = await res.json();

                        try {
                            const agentRes = await fetch('{% url "pos:kitchen_agent_status" %}', { credentials: 'same-origin' });
                            const agentData = await agentRes.json();
                            agentStatus = agentData.status || 'unknown';
                        } catch (e) {
                            agentStatus = 'unknown';
                        }

                        setDot(data.overall);
                        if (subtitle) {
                            const printerText = data.overall === 'online'
                                ? 'Online'
                                : data.overall === 'offline'
                                    ? 'Offline'
                                    : data.overall === 'degraded'
                                        ? 'Degraded'
                                        : 'Unknown';
                            const agentText = agentStatus === 'running' ? 'Agent: On' : agentStatus === 'stopped' ? 'Agent: Off' : 'Agent: ?';
                            subtitle.textContent = `${printerText} â€¢ ${agentText}`;
                        }
                        if (btnStart && btnStop) {
                            btnStart.disabled = agentStatus === 'running';
                            btnStop.disabled = agentStatus !== 'running';
                            btnStart.classList.toggle('opacity-50', btnStart.disabled);
                            btnStop.classList.toggle('opacity-50', btnStop.disabled);
                        }
                        if (counts) counts.textContent = '';
                        if (last) last.textContent = '';
                        if (list) {
                            list.innerHTML = '';
                            (data.printers || []).forEach((p) => {
                                const row = document.createElement('div');
                                const dotClass = p.status === 'online' ? 'bg-green-500' : p.status === 'offline' ? 'bg-red-500' : 'bg-gray-400';
                                const badgeClass = p.status === 'online'
                                    ? 'bg-green-100 text-green-700'
                                    : p.status === 'offline'
                                        ? 'bg-red-100 text-red-700'
                                        : 'bg-gray-100 text-gray-600';
                                row.className = 'flex items-center justify-between px-2 py-1 rounded-md bg-gray-50';
                                row.innerHTML = `
                                    <div class="flex items-center gap-2 min-w-0">
                                        <span class="h-2 w-2 rounded-full ${dotClass}"></span>
                                        <span class="text-[11px] font-semibold text-gray-800">${(p.station_code || '').toUpperCase()}</span>
                                        <span class="text-[10px] text-gray-500 truncate max-w-[140px]">${p.printer_name || ''}</span>
                                    </div>
                                    <span class="text-[10px] px-2 py-0.5 rounded-full font-semibold ${badgeClass}">${p.status}</span>
                                `;
                                list.appendChild(row);
                            });
                        }
                    } catch (e) {
                        setDot('unknown');
                        if (subtitle) subtitle.textContent = 'Unknown';
                    }
                }

                async function callAgent(endpointUrl, successMsg) {
                    try {
                        if (agentMsg) agentMsg.textContent = '...';
                        const res = await fetch(endpointUrl, {
                            method: 'POST',
                            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                            credentials: 'same-origin'
                        });
                        const data = await res.json();
                        if (agentMsg) agentMsg.textContent = data.message || successMsg;
                        refresh();
                    } catch (e) {
                        if (agentMsg) agentMsg.textContent = 'Failed';
                    }
                }

                if (btnStart) {
                    btnStart.addEventListener('click', function () {
                        callAgent('{% url "pos:kitchen_agent_start" %}', 'Started');
                    });
                }
                if (btnStop) {
                    btnStop.addEventListener('click', function () {
                        callAgent('{% url "pos:kitchen_agent_stop" %}', 'Stopped');
                    });
                }

                if (toggleBtn) {
                    toggleBtn.addEventListener('click', function () {
                        const collapsed = body && body.style.display !== 'none' ? true : false;
                        setCollapsed(collapsed);
                    });
                }

                setCollapsed(true);
                refresh();
                setInterval(refresh, 30000);
            })();
        </script>

        <!-- Printer Status Widget -->
        {% include 'pos/printer_status.html' %}
    </main>

    <!-- ==================== RIGHT: BILL PANEL ==================== -->
    <aside class="w-96 bg-white border-l flex flex-col shadow-lg" id="bill-panel">
        {% include 'pos/partials/bill_panel.html' %}
    </aside>

</div>

<!-- JavaScript: Category Button Active State Management -->
<script>
    // POS Modal Alpine.js Component - Global Function
    function posModal() {
        return {
            modal: {
                show: false,
                title: '',
                message: '',
                confirmText: 'OK',
                cancelText: 'Batal',
                onConfirm: () => { this.modal.show = false; }
            },

            showModal(options) {
                this.modal = {
                    show: true,
                    title: options.title || '',
                    message: options.message || '',
                    confirmText: options.confirmText || 'OK',
                    cancelText: options.cancelText || 'Batal',
                    onConfirm: options.onConfirm || (() => { this.modal.show = false; })
                };
            }
        };
    }

    // Quick Order Alpine.js Component - Global Function
    function quickOrder() {
        console.log('ðŸ”µ Alpine.js quickOrder() initialized:', new Date().toISOString());
        return {
            items: [],
            customerName: '',
            paymentMethod: 'cash',
            paymentAmount: 0,

            get total() {
                return this.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            },

            get formattedPaymentAmount() {
                return this.formatNumber(this.paymentAmount);
            },

            set formattedPaymentAmount(value) {
                // Remove all commas and parse as number
                this.paymentAmount = parseInt(value.replace(/,/g, '')) || 0;
            },

            addItem(productId, name, price) {
                console.log('âž• Adding item:', productId, name, price);
                const existingItem = this.items.find(item => item.product_id === productId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    this.items.push({
                        product_id: productId,
                        name: name,
                        price: price,
                        quantity: 1
                    });
                }
                // Auto set payment amount
                this.paymentAmount = this.total;
                // Update customer display in kiosk mode
                updateCustomerDisplay(this.items, this.total, this.paymentAmount, this.paymentMethod);
            },

            removeItem(index) {
                this.items.splice(index, 1);
                this.paymentAmount = this.total;
                // Update customer display in kiosk mode
                updateCustomerDisplay(this.items, this.total, this.paymentAmount, this.paymentMethod);
            },

            increaseQty(index) {
                this.items[index].quantity++;
                this.paymentAmount = this.total;
                // Update customer display in kiosk mode
                updateCustomerDisplay(this.items, this.total, this.paymentAmount, this.paymentMethod);
            },

            decreaseQty(index) {
                if (this.items[index].quantity > 1) {
                    this.items[index].quantity--;
                    this.paymentAmount = this.total;
                    // Update customer display in kiosk mode
                    updateCustomerDisplay(this.items, this.total, this.paymentAmount, this.paymentMethod);
                } else {
                    this.removeItem(index);
                }
            },

            parseIndonesianNumber(str) {
                // Convert Indonesian format (10.000,00) to number (10000)
                // Remove thousand separators (.) and replace decimal comma (,) with dot
                return parseFloat(str.replace(/\./g, '').replace(',', '.'));
            },

            formatRupiah(amount) {
                // Format dengan pemisah ribuan (koma)
                const num = Math.round(amount).toString();
                const formatted = num.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                console.log('formatRupiah:', amount, '=>', 'Rp ' + formatted);
                return 'Rp ' + formatted;
            },

            formatNumber(amount) {
                // Format number dengan pemisah ribuan (koma) tanpa prefix Rp
                const num = Math.round(amount).toString();
                return num.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            },

            submitOrder() {
                if (this.items.length === 0 || this.paymentAmount < this.total) {
                    return;
                }

                const formData = new FormData();
                formData.append('items', JSON.stringify(this.items));
                formData.append('payment_method', this.paymentMethod);
                formData.append('payment_amount', this.paymentAmount);
                formData.append('customer_name', this.customerName);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                fetch('/pos/quick-order/create/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById('modal-container').innerHTML = html;
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Failed to create order');
                    });
            }
        }
    }

    /**
     * Check if shift is active before allowing operations
     * @returns {boolean} true if shift is active, false otherwise
     */
    function checkShiftActive() {
        const shiftHeader = document.getElementById('header-shift-status');
        
        // Check if shift status header shows active shift
        const hasActiveShift = shiftHeader && shiftHeader.textContent.includes('Shift Active');
        
        if (!hasActiveShift) {
            // Get Alpine.js component instance
            const posContainer = document.querySelector('[x-data*="posModal"]');
            if (posContainer && window.Alpine) {
                const component = window.Alpine.$data(posContainer);
                component.showModal({
                    title: 'Shift Belum Dibuka',
                    message: 'Silakan buka shift terlebih dahulu sebelum melakukan transaksi',
                    confirmText: 'Buka Shift',
                    cancelText: 'Batal',
                    onConfirm: () => {
                        component.modal.show = false;
                        openShiftModal();
                    }
                });
            } else {
                // Fallback to standard alert if Alpine.js not available
                if (confirm('Silakan buka shift terlebih dahulu sebelum melakukan transaksi.\n\nKlik OK untuk buka shift.')) {
                    openShiftModal();
                }
            }
            return false;
        }
        
        return true;
    }

    /**
     * Check shift status on page load and show modal if no active shift
     */
    function checkShiftOnLoad() {
        console.log('ðŸ” Checking shift status on load...');
        fetch('/pos/shift/status-check/', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log('ðŸ“Š Shift status response:', data);
            if (!data.has_active_shift) {
                console.log('âŒ No active shift detected');
                // Show the overlay
                updateShiftOverlay(false);
                
                // Auto-open shift modal after brief delay
                setTimeout(() => {
                    console.log('â° Opening shift modal after delay...');
                    openShiftModal();
                }, 500);
            } else {
                console.log('âœ… Active shift detected');
                // Hide the overlay
                updateShiftOverlay(true);
            }
        })
        .catch(error => {
            console.error('âŒ Error checking shift status:', error);
        });
    }

    /**
     * Open shift modal from the overlay
     */
    function openShiftFromOverlay() {
        openShiftModal();
    }

    /**
     * Show or hide the shift required overlay
     * @param {boolean} hasShift - true if shift is active, false otherwise
     */
    function updateShiftOverlay(hasShift) {
        const overlay = document.getElementById('shift-required-overlay');
        if (overlay) {
            if (hasShift) {
                overlay.classList.add('hidden');
            } else {
                overlay.classList.remove('hidden');
            }
        }
    }

    /**
     * Listen for shift status changes (when shift opens/closes)
     */
    document.addEventListener('shiftStatusChanged', function(event) {
        const hasShift = event.detail && event.detail.hasActiveShift;
        updateShiftOverlay(hasShift);
        
        // Trigger HTMX to refresh shift status header
        const shiftHeader = document.getElementById('header-shift-status');
        if (shiftHeader) {
            htmx.trigger(shiftHeader, 'refresh');
        }
    });

    // Ensure modal-container always exists on page load
    document.addEventListener('DOMContentLoaded', function () {
        let modalContainer = document.getElementById('modal-container');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modal-container';
            // Add inline styles to ensure it's always on top and positioned correctly
            modalContainer.style.cssText = 'position: relative; z-index: 9999;';
            document.body.appendChild(modalContainer);
            console.log('âœ… Modal container created and appended to body');
        }
        
        // Load terminal configuration for auto print settings
        loadTerminalConfig();
        
        // Check shift status on page load
        console.log('ðŸš€ Starting shift status check...');
        checkShiftOnLoad();
        
        // Update customer display on page load (if bill panel exists)
        setTimeout(() => {
            const billPanel = document.getElementById('bill-panel');
            if (billPanel && typeof updateCustomerDisplay === 'function') {
                console.log('ðŸ“± Page loaded with active bill, updating customer display...');
                updateCustomerDisplay([], 0);
            }
        }, 500);
    });

    /**
     * Updates active category button styling after product grid HTMX swap
     * Removes active state from all buttons and adds it to the clicked button
     */
    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'product-grid') {
            // Remove active styling from all category buttons
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                btn.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-700');
            });

            // Add active styling to clicked button
            event.detail.elt.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-700');
            event.detail.elt.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
        }
        
        // Update customer display when bill panel is swapped
        if (event.detail.target.id === 'bill-panel' || event.detail.target.closest('#bill-panel')) {
            console.log('ðŸ“± Bill panel swapped, updating customer display...');
            setTimeout(() => {
                if (typeof updateCustomerDisplay === 'function') {
                    updateCustomerDisplay([], 0);
                }
            }, 100);
        }
    });

    /**
     * Ensure modal container exists before any HTMX request to it
     */
    document.addEventListener('htmx:beforeRequest', function (event) {
        // Log all shift-related requests for debugging
        const url = event.detail.pathInfo.requestPath;
        if (url && url.includes('shift')) {
            console.log('ðŸ”” HTMX Shift Request:', url);
            console.log('   Triggered by:', event.detail.elt);
            console.log('   Element ID:', event.detail.elt.id);
            console.log('   Element classes:', event.detail.elt.className);
        }
        
        // Check if request is targeting modal-container
        const targetSelector = event.detail.elt.getAttribute('hx-target');
        if (targetSelector === '#modal-container') {
            // Ensure it exists
            let modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'modal-container';
                document.body.appendChild(modalContainer);
                // Update the target reference
                event.detail.target = modalContainer;
            }
        }
    });

    /**
     * Handle HTMX target errors silently
     */
    document.addEventListener('htmx:targetError', function (event) {
        const targetSelector = event.detail.elt.getAttribute('hx-target');

        if (targetSelector === '#modal-container') {
            // Recreate modal container if missing
            let modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'modal-container';
                document.body.appendChild(modalContainer);
            }

            // Retry the request
            const url = event.detail.elt.getAttribute('hx-get') || event.detail.elt.getAttribute('hx-post');
            if (url) {
                htmx.ajax('GET', url, { target: '#modal-container', swap: 'innerHTML' });
            }
        }
    });

    /**
     * Ensure modal container doesn't get completely removed
     */
    document.addEventListener('htmx:beforeSwap', function (event) {
        if (event.detail.target.id === 'modal-container') {
            // Allow the swap to happen normally
            event.detail.shouldSwap = true;
        }
    });

    /**
     * Clean up after HTMX requests to modal-container
     */
    document.addEventListener('htmx:afterSwap', function (event) {
        if (event.detail.target.id === 'modal-container') {
            // Ensure button is re-enabled
            const heldBillsBtn = document.getElementById('held-bills-btn');
            if (heldBillsBtn) {
                heldBillsBtn.disabled = false;
                heldBillsBtn.classList.remove('htmx-request');
            }
            console.log('Modal content swapped successfully');

            // Reprocess modal content to enable HTMX attributes
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                htmx.process(modalContainer);
            }
            
            // Clone and send modal to customer display
            setTimeout(() => {
                sendModalToCustomerDisplay();
            }, 200);
        }

        // Re-process HTMX attributes when bill-panel is updated (after resume or add item)
        if (event.detail.target.id === 'bill-panel') {
            // Use setTimeout to ensure DOM is fully updated
            setTimeout(function () {
                const billPanel = document.getElementById('bill-panel');
                if (billPanel) {
                    // Force HTMX to re-process all elements inside
                    htmx.process(billPanel);
                    
                    // Trigger customer display update
                    if (isKioskMode()) {
                        updateCustomerDisplay([], 0);
                        console.log('ðŸ“º Customer display update triggered after bill-panel HTMX swap');
                    }

                    // Specifically re-enable the View Held Bills button
                    const heldBillsBtn = document.getElementById('held-bills-btn');
                    if (heldBillsBtn) {
                        heldBillsBtn.classList.remove('htmx-request', 'htmx-swapping');
                        heldBillsBtn.disabled = false;
                        htmx.process(heldBillsBtn);
                    }
                }

                // Re-process product grid to enable Add buttons
                const productGrid = document.getElementById('product-grid');
                if (productGrid) {
                    htmx.process(productGrid);
                }
            }, 50);
        }

        // Also handle when bill-panel is swapped as outerHTML (target is the swapped element itself)
        // Check if the swapped element is bill-panel or contains bill-panel
        const swappedElement = event.detail.target;
        if (swappedElement && (swappedElement.id === 'bill-panel' || swappedElement.querySelector('#bill-panel'))) {
            setTimeout(function () {
                const billPanel = document.getElementById('bill-panel');
                if (billPanel) {
                    console.log('Re-processing bill-panel after outerHTML swap');
                    htmx.process(billPanel);
                    
                    // Update customer display
                    if (isKioskMode()) {
                        setTimeout(() => {
                            updateCustomerDisplay([], 0); // Trigger update with dummy params
                        }, 100);
                    }
                }
            }, 100);
        }
    });

    /**
     * After settle - ensure all HTMX elements are processed
     * This is called after animations complete
     */
    document.addEventListener('htmx:afterSettle', function (event) {
        // Only process if the target IS the bill-panel itself (not sidebar or other elements)
        const target = event.detail.target;
        if (target && target.id === 'bill-panel') {
            console.log('htmx:afterSettle - Re-processing bill-panel');
            htmx.process(target);

            // Also reprocess modal container to ensure delete buttons work
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                htmx.process(modalContainer);
            }
            
            // Update customer display after bill panel settles
            if (isKioskMode()) {
                setTimeout(() => {
                    updateCustomerDisplay([], 0); // Trigger update with dummy params
                }, 50);
            }
        }
    });

    /**
     * Log when HTMX requests are triggered for debugging
     */
    document.addEventListener('htmx:trigger', function (event) {
        const url = event.detail.elt.getAttribute('hx-get') ||
            event.detail.elt.getAttribute('hx-post') ||
            event.detail.elt.getAttribute('hx-delete');
        console.log('HTMX Request triggered:', url, event.detail.elt);
    });

    /**
     * Listen for hold bill completion and reload page
     */
    document.addEventListener('htmx:afterRequest', function(event) {
        const url = event.detail.pathInfo.requestPath;
        console.log('=== HTMX After Request ===');
        console.log('URL:', url);
        console.log('Status:', event.detail.xhr.status);
        
        // Check if this is a hold bill request
        if (url && url.includes('/hold/') && event.detail.successful) {
            console.log('Hold bill successful! Reloading page in 300ms...');
            
            // Close modal first
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }
            
            // Reload page to refresh product grid
            setTimeout(function() {
                window.location.reload(true);
            }, 300);
        }
    });

    /**
     * Global modal functions - Must be in main.html to persist after modal content swaps
     */
    function closeHeldBillsModal() {
        const modalContainer = document.getElementById('modal-container');
        if (modalContainer) {
            // Clear content first
            modalContainer.innerHTML = '';

            // Force HTMX to re-process this element
            htmx.process(modalContainer);

            console.log('Held Bills modal closed and processed');
        }
    }

    function cancelHeldBill(billId) {
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        fetch(`/pos/bill/${billId}/cancel/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        }).then(response => {
            if (response.ok) {
                closeHeldBillsModal();
                // Refresh bill panel if active
                const billPanel = document.getElementById('bill-panel');
                if (billPanel) {
                    htmx.trigger(billPanel, 'refreshBillPanel');
                }
            }
        });
    }

    /**
     * Show toast notification
     */
    function showToast(message, type = 'info') {
        // Create toast element
        const toast = document.createElement('div');
        toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${type === 'warning' ? 'bg-yellow-500 text-white' :
            type === 'error' ? 'bg-red-500 text-white' :
                type === 'success' ? 'bg-green-500 text-white' :
                    'bg-blue-500 text-white'
            }`;
        toast.textContent = message;

        // Add to body
        document.body.appendChild(toast);

        // Animate in
        setTimeout(() => toast.style.opacity = '1', 10);

        // Remove after 3 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Listen for HTMX notification events
    document.addEventListener('showNotification', function (event) {
        const detail = event.detail;
        showToast(detail.message, detail.type || 'info');
    });

    // Category button active state toggle
    document.addEventListener('DOMContentLoaded', function () {
        const categoryButtons = document.querySelectorAll('.category-btn');

        categoryButtons.forEach(button => {
            button.addEventListener('click', function () {
                // Remove active state from all buttons
                categoryButtons.forEach(btn => {
                    // Remove all possible background colors including black
                    btn.classList.remove('bg-emerald-50', 'border-emerald-500', 'bg-black', 'bg-gray-900');
                    btn.classList.add('bg-white', 'border-gray-200');

                    // Reset icon background
                    const icon = btn.querySelector('div');
                    if (icon) {
                        icon.classList.remove('bg-emerald-500', 'bg-black', 'bg-gray-900');
                        icon.classList.add('bg-gray-100');

                        // Reset icon color
                        const svg = icon.querySelector('svg');
                        if (svg) {
                            svg.classList.remove('text-white');
                            svg.classList.add('text-gray-600');
                        }
                    }
                });

                // Add active state to clicked button
                this.classList.remove('bg-white', 'border-gray-200', 'bg-black', 'bg-gray-900');
                this.classList.add('bg-emerald-50', 'border-emerald-500');

                // Update icon background
                const activeIcon = this.querySelector('div');
                if (activeIcon) {
                    activeIcon.classList.remove('bg-gray-100');
                    activeIcon.classList.add('bg-emerald-500');

                    // Update icon color
                    const activeSvg = activeIcon.querySelector('svg');
                    if (activeSvg) {
                        activeSvg.classList.remove('text-gray-600');
                        activeSvg.classList.add('text-white');
                    }
                }
            });
        });
    });

    // Function to open reprint reconciliation modal
    function openReprintReconciliation() {
        fetch('/pos/shift/history/')
            .then(response => response.text())
            .then(html => {
                // Remove existing modal if any
                const existingModal = document.getElementById('reprint-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Inject modal HTML
                document.body.insertAdjacentHTML('beforeend', html);

                // Format amounts after modal is injected
                setTimeout(() => {
                    document.querySelectorAll('#reprint-modal .amount').forEach(function (el) {
                        const value = el.textContent.trim();
                        const formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        el.textContent = formatted;
                    });
                }, 100);
            })
            .catch(error => {
                console.error('Error loading shift history:', error);
                alert('Failed to load shift history');
            });
    }

    // Function to print reconciliation (called from modal buttons)
    function printReconciliation(shiftId) {
        const printUrl = `/pos/shift/${shiftId}/print-reconciliation/`;
        window.open(printUrl, '_blank', 'width=800,height=600');

        // Show success toast
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50';
        toast.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        <div>
            <p class="font-bold">Opening Print...</p>
            <p class="text-sm text-blue-100">Reconciliation report</p>
        </div>
    `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, 2000);

        // Close modal after slight delay
        setTimeout(() => {
            const modal = document.getElementById('reprint-modal');
            if (modal) modal.remove();
        }, 500);
    }

    // Function to open My Shift Dashboard
    function openMyShiftDashboard() {
        fetch('/pos/shift/my-dashboard/')
            .then(response => response.text())
            .then(html => {
                // Remove existing modal if any
                const existingModal = document.getElementById('my-shift-modal');
                if (existingModal) {
                    existingModal.remove();
                }

                // Inject modal HTML
                document.body.insertAdjacentHTML('beforeend', html);

                // Format amounts after modal is injected
                setTimeout(() => {
                    document.querySelectorAll('#my-shift-modal .amount').forEach(function (el) {
                        const value = el.textContent.trim();
                        const formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                        el.textContent = formatted;
                    });
                }, 100);
            })
            .catch(error => {
                console.error('Error loading shift dashboard:', error);

                // Show error toast
                const toast = document.createElement('div');
                toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-red-500 to-rose-600 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50';
                toast.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="font-bold">Error</p>
                    <p class="text-sm">Please open a shift first</p>
                </div>
            `;
                document.body.appendChild(toast);

                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transition = 'opacity 0.3s';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            });
    }

    // Print Interim Report - Global function for My Shift Dashboard
    function printInterimReport() {
        // Get shift ID from modal data attribute or fetch from session
        const modal = document.getElementById('my-shift-modal');
        if (!modal) return;

        const shiftId = modal.dataset.shiftId;
        if (!shiftId) {
            console.error('No shift ID found');
            return;
        }

        const printUrl = `/pos/shift/${shiftId}/print-interim/`;
        window.open(printUrl, '_blank', 'width=800,height=600');

        // Show toast
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-2 z-50';
        toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
        </svg>
        <div>
            <p class="font-bold text-sm">Opening Print...</p>
            <p class="text-xs text-blue-100">Interim report</p>
        </div>
    `;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transition = 'opacity 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, 2000);
    }

    // Check if there's active bill before closing shift
    function checkAndOpenCloseShift() {
        // Check if bill panel has active bill
        const billPanel = document.getElementById('bill-panel');
        if (!billPanel) {
            // No bill panel found, allow close shift
            closeShiftModal();
            return;
        }

        // More accurate detection: Check if there's "Order Summary" title (only exists when bill is active)
        const orderSummaryTitle = billPanel.querySelector('h2');
        const hasActiveBill = orderSummaryTitle && orderSummaryTitle.textContent.includes('Order Summary');
        
        // If there's an active bill, show alert and prevent
        if (hasActiveBill) {
            // Show beautiful alert modal
            const alertModal = document.createElement('div');
            alertModal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 animate-fadeIn';
            alertModal.innerHTML = `
                <div class="bg-white rounded-2xl w-full max-w-md mx-4 overflow-hidden shadow-2xl transform animate-slideUp">
                    <!-- Header -->
                    <div class="bg-gradient-to-r from-orange-500 to-red-600 p-6 text-center">
                        <div class="w-20 h-20 bg-white/20 backdrop-blur-sm rounded-full flex items-center justify-center mx-auto mb-4">
                            <svg class="w-10 h-10 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <h2 class="text-2xl font-bold text-white">Cannot Close Shift</h2>
                    </div>
                    
                    <!-- Content -->
                    <div class="p-6">
                        <p class="text-gray-700 text-lg mb-4 text-center">
                            You have an active bill open!
                        </p>
                        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-6">
                            <p class="text-orange-800 text-sm">
                                <strong>âš ï¸ Please complete or close the active bill first:</strong>
                            </p>
                            <ul class="text-orange-700 text-sm mt-2 space-y-1 ml-4">
                                <li>â€¢ Complete payment, or</li>
                                <li>â€¢ Hold the bill, or</li>
                                <li>â€¢ Void/cancel the bill</li>
                            </ul>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="flex gap-3 p-6 pt-0">
                        <button 
                            onclick="this.closest('div[class*=fixed]').remove()"
                            class="flex-1 px-4 py-3 bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl">
                            OK, Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(alertModal);
            return;
        }
        
        // No active bill, open close shift modal
        closeShiftModal();
    }

    function openShiftModal() {
        console.log('ðŸ”µ Opening shift modal...');
        const modalContainer = document.getElementById('modal-container');
        console.log('   Modal container exists:', !!modalContainer);
        
        // Add one-time event listener for after swap
        modalContainer.addEventListener('htmx:afterSwap', function checkModal() {
            console.log('âœ… Shift modal HTML swapped');
            const shiftModal = document.getElementById('shift-open-modal');
            const sessionModal = document.getElementById('session-required-modal');
            
            console.log('   shift-open-modal exists:', !!shiftModal);
            console.log('   session-required-modal exists:', !!sessionModal);
            
            if (shiftModal) {
                console.log('âœ… Shift modal rendered successfully');
                console.log('   Classes:', shiftModal.className);
                console.log('   Display:', window.getComputedStyle(shiftModal).display);
                console.log('   Z-index:', window.getComputedStyle(shiftModal).zIndex);
            } else if (sessionModal) {
                console.log('âš ï¸ Session required modal shown (no active store session)');
            } else {
                console.log('âŒ No modal element found!');
                console.log('   Container HTML:', modalContainer.innerHTML.substring(0, 300));
            }
            
            // Remove this one-time listener
            modalContainer.removeEventListener('htmx:afterSwap', checkModal);
        }, { once: true });
        
        htmx.ajax('GET', '{% url "pos:shift_open_form" %}', {
            target: '#modal-container',
            swap: 'innerHTML'
        });
    }

    function closeShiftModal() {
        htmx.ajax('GET', '{% url "pos:shift_close_form" %}', {
            target: '#modal-container',
            swap: 'innerHTML'
        });
    }

    // Open Cash Drop Modal
    function openCashDropModal() {
        htmx.ajax('GET', '{% url "pos:cash_drop_form" %}', {
            target: '#modal-container',
            swap: 'innerHTML'
        });
    }

    // Open Floor Plan Modal
    function openFloorPlanModal() {
        // Check if floor plan is already open
        const existingModal = document.getElementById('floor-plan-modal');
        if (existingModal) {
            console.log('â„¹ï¸ Floor plan already open, skipping...');
            return; // Don't open again
        }
        
        // Create overlay that covers main content area
        const overlay = document.createElement('div');
        overlay.id = 'floor-plan-modal';
        overlay.className = 'absolute inset-0 bg-white z-50 animate-slideInLeft';
        overlay.innerHTML = `
            <div class="w-full h-full flex flex-col bg-gradient-to-br from-gray-50 to-white">
                <!-- Header with Gradient -->
                <div class="relative bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 px-4 py-3 overflow-hidden shadow-lg">
                    <!-- Animated Background Pattern -->
                    <div class="absolute inset-0 opacity-20">
                        <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_120%,rgba(255,255,255,0.3),transparent)]"></div>
                    </div>
                    
                    <div class="relative flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="w-10 h-10 bg-white/20 backdrop-blur-md rounded-xl flex items-center justify-center shadow-lg">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h4a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM14 13a1 1 0 011-1h4a1 1 0 011 1v6a1 1 0 01-1 1h-4a1 1 0 01-1-1v-6z"></path>
                                </svg>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white tracking-tight">Floor Plan</h2>
                                <p class="text-xs text-white/80 font-medium">Select your table</p>
                            </div>
                        </div>
                        
                        <!-- Legend inline with title -->
                        <div class="flex items-center gap-1.5">
                            <div class="flex items-center gap-1 px-2 py-1 bg-white/20 backdrop-blur-md rounded-lg">
                                <svg class="w-3 h-3 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-bold text-white text-xs">Available</span>
                            </div>
                            <div class="flex items-center gap-1 px-2 py-1 bg-white/20 backdrop-blur-md rounded-lg">
                                <svg class="w-3 h-3 text-red-300 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-bold text-white text-xs">Occupied</span>
                            </div>
                            <div class="flex items-center gap-1 px-2 py-1 bg-white/20 backdrop-blur-md rounded-lg">
                                <svg class="w-3 h-3 text-purple-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"></path>
                                </svg>
                                <span class="font-bold text-white text-xs">Joined</span>
                            </div>
                            <div class="flex items-center gap-1 px-2 py-1 bg-white/20 backdrop-blur-md rounded-lg">
                                <svg class="w-3 h-3 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                </svg>
                                <span class="font-bold text-white text-xs">Cleaning</span>
                            </div>
                        </div>
                        
                        <button onclick="closeFloorPlanModal()" 
                            class="w-9 h-9 bg-red-500/90 hover:bg-red-600 rounded-lg flex items-center justify-center transition-all group shadow-lg hover:shadow-xl">
                            <svg class="w-5 h-5 text-white group-hover:rotate-90 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                
                <!-- Content - Loading -->
                <div id="floor-plan-content" class="flex-1 overflow-hidden">
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-12 w-12 border-b-4 border-blue-600 mx-auto mb-4"></div>
                            <p class="text-gray-600 font-medium">Loading floor plan...</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Append to content area (categories + products)
        const contentArea = document.getElementById('pos-content-area');
        if (contentArea) {
            contentArea.appendChild(overlay);
        }
        
        // Load floor plan content via iframe to preserve all scripts and styles
        fetch('{% url "tables:floor_plan" %}')
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Get the main content (skip header with back button)
                const mainContentDoc = doc.querySelector('.min-h-screen');
                
                if (mainContentDoc) {
                    // Remove the sticky header with back button
                    const header = mainContentDoc.querySelector('.sticky');
                    if (header) {
                        header.remove();
                    }
                    
                    // Insert content first
                    const contentDiv = document.getElementById('floor-plan-content');
                    contentDiv.innerHTML = mainContentDoc.innerHTML;
                    
                    console.log('ðŸ“¦ Content inserted, checking for scripts...');
                    
                    // Remove any previously appended floor plan scripts to prevent duplicates
                    document.querySelectorAll('script.floor-plan-script').forEach(s => {
                        s.remove();
                        console.log('ðŸ§¹ Removed old floor plan script');
                    });
                    
                    // Reset Alpine initialization flag
                    window.floorPlanInitialized = false;
                    
                    // Flag to track if we've already executed scripts for THIS modal instance
                    if (window.floorPlanScriptsLoaded) {
                        console.log('âš ï¸ Floor plan scripts already loaded, skipping script execution');
                        window.floorPlanLoading = false;
                        return;
                    }
                    
                    console.log('ðŸ“œ Executing floor plan scripts for the first time...');
                    
                    // Get all script tags from original page and execute them properly
                    const scripts = doc.querySelectorAll('script');
                    let scriptCount = 0;
                    scripts.forEach(script => {
                        // Skip JSON scripts and external scripts
                        if (script.type === 'application/json' || script.src) {
                            return;
                        }
                        
                        // Only append JavaScript scripts once
                        if (script.textContent && (!script.type || script.type === 'text/javascript')) {
                            try {
                                const newScript = document.createElement('script');
                                newScript.className = 'floor-plan-script'; // Mark for cleanup
                                newScript.textContent = script.textContent;
                                document.body.appendChild(newScript);
                                scriptCount++;
                            } catch (e) {
                                console.error('Error appending script:', e);
                            }
                        }
                    });
                    
                    console.log(`âœ… Executed ${scriptCount} scripts`);
                    
                    // Mark scripts as loaded
                    window.floorPlanScriptsLoaded = true;
                    window.floorPlanLoading = false;
                    
                    console.log('âœ… Floor plan loaded successfully');
                }
            })
            .catch(error => {
                window.floorPlanLoading = false;
                console.error('Error loading floor plan:', error);
                document.getElementById('floor-plan-content').innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <div class="text-center p-8">
                            <div class="text-red-600 mb-4">
                                <svg class="w-16 h-16 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-700 font-medium mb-4">Failed to load floor plan</p>
                            <button onclick="closeFloorPlanModal()" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                `;
            });
    }
    
    function closeFloorPlanModal() {
        const overlay = document.getElementById('floor-plan-modal');
        if (overlay) {
            overlay.classList.add('animate-slideOutLeft');
            setTimeout(() => {
                overlay.remove();
                
                // Reset all flags to allow fresh initialization on next open
                window.floorPlanScriptsLoaded = false;
                window.floorPlanLoading = false;
                window.floorPlanInitialized = false; // Reset Alpine init flag
                
                console.log('ðŸ”„ Floor plan modal closed, all flags reset for next open');
            }, 300);
        }
    }
    
    // Close modal on ESC key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && document.getElementById('floor-plan-modal')) {
            closeFloorPlanModal();
        }
    });

    // Kiosk mode: Auto-fullscreen when opened from pos.exe
    (function() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('kiosk') === '1') {
            // Try to enter fullscreen
            setTimeout(() => {
                const elem = document.documentElement;
                if (elem.requestFullscreen) {
                    elem.requestFullscreen().catch(err => {
                        console.log('Fullscreen failed:', err);
                    });
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            }, 1000);
        }
    })();

    // ==================== POS LAUNCHER INTEGRATION ====================
    // Event-Based Hybrid: Send data to local API for printing and customer display
    
    const LOCAL_API_URL = 'http://127.0.0.1:5000';
    
    // Terminal configuration from database
    let terminalConfig = null;
    
    /**
     * Load terminal configuration from server
     */
    async function loadTerminalConfig() {
        try {
            // Get terminal/company/brand/store codes from localStorage (set by POSLauncher)
            // Fall back to URL parameters for immediate access
            let terminalCode = localStorage.getItem('terminal_code');
            let companyCode = localStorage.getItem('company_code');
            let brandCode = localStorage.getItem('brand_code');
            let storeCode = localStorage.getItem('store_code');
            
            const urlParams = new URLSearchParams(window.location.search);
            
            if (!terminalCode) {
                terminalCode = urlParams.get('terminal');
            }
            if (!companyCode) {
                companyCode = urlParams.get('company');
            }
            if (!brandCode) {
                brandCode = urlParams.get('brand');
            }
            if (!storeCode) {
                storeCode = urlParams.get('store');
            }
            
            if (!terminalCode) {
                console.warn('âš ï¸ Terminal code not found in localStorage or URL parameters');
                return;
            }
            
            console.log('ðŸ“¡ Loading terminal config:');
            console.log('   Terminal:', terminalCode);
            console.log('   Company:', companyCode || 'N/A');
            console.log('   Brand:', brandCode || 'N/A');
            console.log('   Store:', storeCode || 'N/A');
            
            // Build API URL with all available codes for validation
            let apiUrl = `/api/terminal/config?terminal_code=${terminalCode}`;
            if (companyCode) apiUrl += `&company_code=${companyCode}`;
            if (brandCode) apiUrl += `&brand_code=${brandCode}`;
            if (storeCode) apiUrl += `&store_code=${storeCode}`;
            
            const response = await fetch(apiUrl);
            const data = await response.json();
            
            if (data.success) {
                terminalConfig = data;
                console.log('âœ… Terminal config loaded and validated:', terminalConfig);
                console.log('   Auto Print Receipt:', terminalConfig.device_config?.auto_print_receipt);
                console.log('   Auto Print Kitchen:', terminalConfig.device_config?.auto_print_kitchen_order);
                console.log('   Print To:', terminalConfig.device_config?.print_to);
            } else {
                console.error('âŒ Failed to load terminal config:', data.error);
            }
        } catch (error) {
            console.error('âŒ Error loading terminal config:', error);
        }
    }
    
    /**
     * Check if running in kiosk mode
     */
    function isKioskMode() {
        // Check localStorage first (set by PyQt launcher)
        if (localStorage.getItem('kiosk_mode') === '1') {
            return true;
        }
        
        // Fall back to URL parameter for compatibility
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('kiosk') === '1';
    }
    
    /**
     * Send modal to customer display
     */
    function sendModalToCustomerDisplay() {
        console.log('ðŸŽ­ sendModalToCustomerDisplay() called');
        console.log('ðŸ” Kiosk mode:', isKioskMode());
        
        if (!isKioskMode()) {
            console.log('âš ï¸ Not in kiosk mode, skipping modal sync');
            return;
        }
        
        const modalContainer = document.getElementById('modal-container');
        console.log('ðŸ” Modal container:', modalContainer);
        console.log('ðŸ” Modal container innerHTML length:', modalContainer ? modalContainer.innerHTML.trim().length : 0);
        
        if (!modalContainer || !modalContainer.innerHTML.trim()) {
            console.log('âš ï¸ Modal container empty, clearing modal on customer display...');
            // Clear modal on customer display
            fetch(`${LOCAL_API_URL}/api/customer-display/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    show_modal: false,
                    modal_html: null
                })
            });
            return;
        }
        
        // â›” BLACKLIST FIRST: Exclude specific internal modals before whitelist check
        const modalContent = modalContainer.innerHTML;
        
        console.log('ðŸ” Checking modal content (first 500 chars):', modalContent.substring(0, 500));
        
        // Quick Order modal - ALWAYS skip (staff-only)
        // Multiple checks for robust detection
        const isQuickOrder = modalContent.includes('Quick Order') || 
                            modalContent.includes('quickOrder()') || 
                            modalContent.includes('Select Products') ||
                            modalContent.includes('Select items & pay instantly') ||
                            modalContent.includes('z-[60]');
        
        if (isQuickOrder) {
            console.log('â›” Quick Order modal detected - Skipping customer display sync (staff-only)');
            // Clear any existing modal on customer display
            fetch(`${LOCAL_API_URL}/api/customer-display/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    show_modal: false,
                    modal_html: null
                })
            });
            return;
        }
        
        // â›” WHITELIST APPROACH - Only Payment modals should be shown to customers
        const isPaymentModal = modalContent.includes('Payment - ') && 
                              (modalContent.includes('Payment Method') || modalContent.includes('Quick Amount'));
        
        if (!isPaymentModal) {
            console.log('â›” Not a payment modal - Skipping customer display sync');
            console.log('   This is an internal/staff modal (Hold Bill, PIN, Shift, etc.)');
            // Clear any existing modal on customer display
            fetch(`${LOCAL_API_URL}/api/customer-display/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    show_modal: false,
                    modal_html: null
                })
            });
            return;
        }
        
        console.log('âœ… Modal is customer-facing (Payment related), proceeding with clone...');
        
        console.log('ðŸŽ­ Cloning modal for customer display...');
        
        // Get Alpine.js component data from original modal (before cloning)
        const originalModal = modalContainer.querySelector('[x-data]');
        let alpineData = null;
        if (originalModal && originalModal._x_dataStack && originalModal._x_dataStack.length > 0) {
            alpineData = originalModal._x_dataStack[0];
            console.log('ðŸ“Š Alpine.js data captured:', {
                amount: alpineData.amount,
                amountDisplay: alpineData.amountDisplay,
                remaining: alpineData.remaining,
                change: alpineData.change,
                method: alpineData.method,
                payments: alpineData.payments
            });
        } else {
            console.error('âŒ Failed to capture Alpine.js data!', {
                originalModal,
                hasDataStack: originalModal?._x_dataStack,
                stackLength: originalModal?._x_dataStack?.length
            });
        }
        
        // Clone modal
        const modalClone = modalContainer.cloneNode(true);
        
        // Replace Alpine.js x-text bindings with actual values
        if (alpineData) {
            // Helper function to safely evaluate expressions
            const safeEval = (expr, context) => {
                try {
                    const func = new Function(...Object.keys(context), `return ${expr}`);
                    return func(...Object.values(context));
                } catch (e) {
                    console.warn('Failed to eval:', expr, e);
                    return null;
                }
            };
            
            const context = {
                formatNumber: alpineData.formatNumber.bind(alpineData),
                remaining: alpineData.remaining,
                change: alpineData.change,
                amount: alpineData.amount,
                method: alpineData.method,
                payments: alpineData.payments
            };
            
            // Process x-show first (handle visibility)
            const xShowElements = modalClone.querySelectorAll('[x-show]');
            xShowElements.forEach(el => {
                const xShowValue = el.getAttribute('x-show');
                const result = safeEval(xShowValue, context);
                if (result === false) {
                    el.style.display = 'none';
                } else {
                    el.style.display = '';
                }
                el.removeAttribute('x-show');
                console.log('ðŸ” x-show:', xShowValue, 'â†’', result);
            });
            
            // Process x-text (replace with actual text)
            const xTextElements = modalClone.querySelectorAll('[x-text]');
            xTextElements.forEach(el => {
                const xTextValue = el.getAttribute('x-text');
                const result = safeEval(xTextValue, context);
                if (result !== null) {
                    el.textContent = result;
                    console.log('âœ… x-text:', xTextValue, 'â†’', result);
                }
                el.removeAttribute('x-text');
            });
        }
        
        console.log('ðŸ“Š Clone snapshot taken at:', new Date().toISOString().substr(11, 12));
        
        // Disable buttons but keep them visible for customer display
        const buttons = modalClone.querySelectorAll('button');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.style.pointerEvents = 'none';
            btn.style.opacity = '0.7';
            // Remove event handlers
            btn.removeAttribute('onclick');
            btn.removeAttribute('hx-get');
            btn.removeAttribute('hx-post');
            btn.removeAttribute('hx-target');
            btn.removeAttribute('hx-swap');
            // Remove Alpine.js click handlers
            Array.from(btn.attributes).forEach(attr => {
                if (attr.name.startsWith('@') || attr.name.startsWith('x-on:')) {
                    btn.removeAttribute(attr.name);
                }
            });
        });
        
        // Remove interactivity from other elements
        const interactiveElements = modalClone.querySelectorAll('[hx-get], [hx-post], [onclick], [x-on\\:click]');
        interactiveElements.forEach(el => {
            el.removeAttribute('hx-get');
            el.removeAttribute('hx-post');
            el.removeAttribute('hx-target');
            el.removeAttribute('hx-swap');
            el.removeAttribute('onclick');
            // Remove Alpine.js attributes
            Array.from(el.attributes).forEach(attr => {
                if (attr.name.startsWith('x-') || attr.name.startsWith('@')) {
                    el.removeAttribute(attr.name);
                }
            });
        });
        
        // Make all input fields read-only (but keep them visible)
        const inputs = modalClone.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            input.readOnly = true;
            input.disabled = true;
            input.style.pointerEvents = 'none';
        });
        
        // Remove ALL Alpine.js attributes and onclick handlers from entire clone
        const allElements = modalClone.querySelectorAll('*');
        allElements.forEach(el => {
            Array.from(el.attributes).forEach(attr => {
                // Remove Alpine.js attributes
                if (attr.name.startsWith('x-') || attr.name.startsWith('@') || attr.name.startsWith(':')) {
                    el.removeAttribute(attr.name);
                }
                // Remove onclick and other event handlers (to prevent "function not defined" errors on customer display)
                if (attr.name.startsWith('on')) {
                    el.removeAttribute(attr.name);
                }
            });
        });
        console.log('ðŸ§¹ Cleaned all Alpine.js attributes and event handlers from clone');
        
        // Set input values AFTER removing Alpine attributes to ensure they stick
        if (alpineData) {
            // Target the VISIBLE amount input (not the hidden one for form submission)
            const amountInput = modalClone.querySelector('input[name="amount_display"]') || 
                               modalClone.querySelector('input[type="text"][placeholder="0"]:not([type="hidden"])') ||
                               modalClone.querySelector('input[placeholder="0"]');
            if (amountInput) {
                // Try various ways to get the display value
                let displayValue = '';
                
                // Helper function to format number (in case Alpine's formatNumber is not accessible)
                const formatNumber = (num) => {
                    if (!num && num !== 0) return '0';
                    const str = Math.floor(num).toString();
                    return str.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                };
                
                if (alpineData.amountDisplay) {
                    displayValue = alpineData.amountDisplay;
                } else if (alpineData.amount) {
                    // Try Alpine's formatNumber first, fallback to local function
                    try {
                        displayValue = alpineData.formatNumber ? alpineData.formatNumber(alpineData.amount) : formatNumber(alpineData.amount);
                    } catch (e) {
                        displayValue = formatNumber(alpineData.amount);
                    }
                }
                
                console.log('ðŸ’° Setting amount input:', {
                    rawAmount: alpineData.amount,
                    amountDisplay: alpineData.amountDisplay,
                    finalDisplayValue: displayValue,
                    inputName: amountInput.getAttribute('name'),
                    inputType: amountInput.getAttribute('type'),
                    inputPlaceholder: amountInput.getAttribute('placeholder'),
                    inputHTML: amountInput.outerHTML.substring(0, 150)
                });
                
                // Set both property and attribute for maximum compatibility
                amountInput.value = displayValue;
                amountInput.setAttribute('value', displayValue);
                
                console.log('âœ… Amount input value set successfully');
            } else {
                console.warn('âš ï¸ Amount input not found in clone. Available inputs:', 
                    modalClone.querySelectorAll('input').length);
            }
        } else {
            console.warn('âš ï¸ No Alpine data available to set input value');
        }
        
        const modalHTML = modalClone.innerHTML;
        
        console.log('ðŸ“ Cloned modal HTML length:', modalHTML.length);
        console.log('ðŸ“„ Modal HTML preview (first 300 chars):', modalHTML.substring(0, 300));
        
        // Add timestamp for debugging
        const timestamp = Date.now();
        console.log('â±ï¸ Sending update at timestamp:', timestamp);
        
        fetch(`${LOCAL_API_URL}/api/customer-display/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                show_modal: true,
                modal_html: modalHTML
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('âœ… Modal sent to customer display:', data);
        })
        .catch(error => {
            console.error('âŒ Failed to send modal to customer display:', error);
        });
    }
    
    /**
     * Update customer display with current cart (mirror bill panel)
     * @param {Array} items - Array of cart items (not used in current implementation, kept for compatibility)
     * @param {Number} total - Total amount (not used in current implementation, kept for compatibility)
     * @param {Number} paymentAmount - Payment amount (not used in current implementation, kept for compatibility)
     * @param {String} paymentMethod - Payment method (not used in current implementation, kept for compatibility)
     * @param {Boolean} clearDisplay - If true, send empty state to clear customer display
     */
    function updateCustomerDisplay(items, total, paymentAmount = 0, paymentMethod = 'cash', clearDisplay = false) {
        console.log('ðŸ”µ updateCustomerDisplay() called', clearDisplay ? '(CLEAR MODE)' : '');
        console.log('ðŸ” Kiosk mode check - localStorage:', localStorage.getItem('kiosk_mode'));
        
        // Only send if local API is available (running in launcher)
        if (!isKioskMode()) {
            console.log('âš ï¸ Not in kiosk mode - localStorage:', localStorage.getItem('kiosk_mode'), 'URL param:', new URLSearchParams(window.location.search).get('kiosk'));
            return; // Not in kiosk mode, skip
        }
        
        console.log('âœ… Kiosk mode active');
        
        // If clearDisplay is true, send empty state
        if (clearDisplay) {
            console.log('ðŸ§¹ Sending CLEAR signal to customer display...');
            const displayData = {
                bill_panel_html: null,
                has_bill: false
            };
            
            fetch(`${LOCAL_API_URL}/api/customer-display/update`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(displayData)
            })
            .then(response => response.json())
            .then(data => {
                console.log('âœ… Customer display cleared successfully:', data);
            })
            .catch(error => {
                console.error('âŒ Failed to clear customer display:', error);
            });
            return;
        }
        
        console.log('ðŸ“¸ Capturing bill panel...');
        
        // Capture bill panel HTML
        const billPanel = document.getElementById('bill-panel');
        if (!billPanel) {
            console.warn('âŒ Bill panel not found in DOM');
            return;
        }
        
        console.log('âœ… Bill panel found, cloning HTML...');
        
        // Clone and clean up the bill panel HTML
        const billPanelClone = billPanel.cloneNode(true);
        
        // COMPLETELY REMOVE all buttons from customer display
        const buttons = billPanelClone.querySelectorAll('button');
        console.log(`ðŸ—‘ï¸ Removing ${buttons.length} buttons from customer display...`);
        buttons.forEach(btn => btn.remove());
        
        // Remove other interactive elements (but keep the structure)
        const interactiveElements = billPanelClone.querySelectorAll('[hx-get], [hx-post], [onclick]');
        console.log(`ðŸ”§ Cleaning ${interactiveElements.length} interactive elements...`);
        
        interactiveElements.forEach(el => {
            el.removeAttribute('hx-get');
            el.removeAttribute('hx-post');
            el.removeAttribute('hx-target');
            el.removeAttribute('hx-swap');
            el.removeAttribute('hx-vals');
            el.removeAttribute('onclick');
            el.style.cursor = 'default';
        });
        
        const billPanelHTML = billPanelClone.outerHTML;
        console.log(`âœ… Bill panel HTML captured (${billPanelHTML.length} chars)`);
        
        const displayData = {
            bill_panel_html: billPanelHTML,
            has_bill: true
        };
        
        console.log('ðŸ“¤ Sending to local API...', LOCAL_API_URL);
        
        fetch(`${LOCAL_API_URL}/api/customer-display/update`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(displayData)
        })
        .then(response => response.json())
        .then(data => {
            console.log('âœ… Customer display updated successfully:', data);
        })
        .catch(error => {
            console.error('âŒ Customer display update failed:', error.message);
            console.error('   Make sure POS Launcher is running!');
        });
    }
    
    /**
     * Send receipt to local printer
     */
    function sendReceiptToLocalPrinter(bill) {
        // Check if auto print receipt is enabled in terminal config
        if (!terminalConfig?.device_config?.auto_print_receipt) {
            console.log('âš ï¸ Auto print receipt disabled in terminal config');
            return;
        }
        
        if (!isKioskMode()) {
            console.log('âš ï¸ Not in kiosk mode, skipping auto print');
            return; // Not in kiosk mode, skip
        }
        
        console.log('ðŸ–¨ï¸ Auto print receipt enabled, sending to printer...');
        
        // Wait a bit to ensure bill data is fully saved
        setTimeout(() => {
            // Fetch complete bill data from server
            fetch(`/pos/bill/${bill.id}/data/`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(billData => {
                const receiptData = {
                    outlet_name: billData.outlet_name || '{{ request.user.outlet.name }}',
                    outlet_address: billData.outlet_address || '',
                    outlet_phone: billData.outlet_phone || '',
                    bill_number: billData.bill_number,
                    date: billData.date || new Date().toISOString(),
                    cashier: billData.cashier || '{{ request.user.get_full_name }}',
                    customer_name: billData.customer_name || null,
                    table: billData.table || null,
                    items: billData.items || [],
                    payments: billData.payments || [],
                    subtotal: billData.subtotal,
                    discount: billData.discount || 0,
                    tax: billData.tax || 0,
                    service: billData.service || 0,
                    total: billData.total,
                    footer: billData.footer || 'Terima Kasih!'
                };
                
                return fetch(`${LOCAL_API_URL}/api/print`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(receiptData)
                });
            })
            .then(response => response.json())
            .then(data => {
                console.log('ðŸ–¨ï¸ Receipt sent to local printer:', data);
            })
            .catch(error => {
                console.warn('âš ï¸ Local print failed (local API not available):', error.message);
            });
        }, 500);
    }
    
    // Listen for payment complete event to trigger local print
    document.body.addEventListener('paymentComplete', function(e) {
        console.log('ðŸ’° Payment complete, sending to local printer...');
        
        // Clear customer display (show waiting state)
        console.log('ðŸ§¹ Clearing customer display after payment (from listener)');
        updateCustomerDisplay([], 0, 0, 'cash', true);
        
        // Extract bill data from success modal
        const modalContainer = document.getElementById('modal-container');
        if (modalContainer) {
            const billIdMatch = modalContainer.innerHTML.match(/billId\s*=\s*(\d+)/);
            if (billIdMatch) {
                const billId = parseInt(billIdMatch[1]);
                sendReceiptToLocalPrinter({ id: billId });
            }
        }
    });

</script>

{% endblock %}