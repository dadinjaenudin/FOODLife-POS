{% comment %}
============================================================================
PRINTER STATUS WIDGET (printer_status.html)
============================================================================
Widget status receipt printer di sidebar kiri halaman POS.
Cek status POS Launcher service DAN status hardware printer fisik.

DIPANGGIL DARI: sidebar.html via include tag

FITUR:
- Compact sidebar item: icon + label + status dot
- Pulsing red heartbeat animation saat service/printer offline
- Amber dot saat warning (cover open, paper low, dll)
- Green steady dot saat service + printer ready
- Flyout panel ke kanan saat di-klik (status detail, test print)
- Auto-check setiap 10 detik (selalu aktif, bukan hanya saat flyout)
- Test print via /api/print endpoint

STATUS LEVELS:
- online  : Service running + printer hardware ready
- warning : Service running + printer ada warning (cover open, toner low, dll)
- offline : Service not running ATAU printer error/offline/not available

ENDPOINT API (POS Launcher - localhost:5000):
- GET  /health              : Health check → {status:'ok', platform, timestamp}
- GET  /api/printer/status  : Printer hardware → {printer_name, printer_status, message, status_flags}
- POST /api/print           : Print to local printer
============================================================================
{% endcomment %}

{# Heartbeat keyframes - CSS animation untuk pulsing red dot saat offline #}
<style>
    @keyframes heartbeat {
        0%, 100% { transform: scale(1); opacity: 1; }
        15% { transform: scale(1.4); opacity: 1; }
        30% { transform: scale(1); opacity: 0.7; }
        45% { transform: scale(1.25); opacity: 1; }
        60% { transform: scale(1); opacity: 0.7; }
    }
    .heartbeat-pulse {
        animation: heartbeat 1.5s ease-in-out infinite;
    }
    @keyframes ripple {
        0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.5); }
        70% { box-shadow: 0 0 0 6px rgba(239, 68, 68, 0); }
        100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }
    .heartbeat-ripple {
        animation: ripple 1.5s ease-in-out infinite;
    }
</style>

{# SIDEBAR ITEM: Compact button with status dot #}
<div id="printer-status-widget" class="relative"
     x-data="printerStatusWidget()"
     x-init="init()">
    <button @click="toggleFlyout()"
            class="flex items-center gap-2 px-2 py-2 rounded-lg text-xs font-semibold transition-all duration-200 w-full"
            :class="status === 'offline' ? 'text-red-600 bg-red-50 hover:bg-red-100' : status === 'warning' ? 'text-amber-600 bg-amber-50 hover:bg-amber-100' : 'text-gray-900 hover:bg-green-50 hover:text-green-600'">
        <div class="relative flex-shrink-0">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
            </svg>
            {# Status dot - heartbeat pulse saat offline, amber saat warning, steady green saat online #}
            <span class="absolute -top-0.5 -right-0.5 h-2.5 w-2.5 rounded-full border border-white"
                  :class="{
                      'bg-green-500': status === 'online',
                      'bg-amber-500': status === 'warning',
                      'bg-red-500 heartbeat-pulse heartbeat-ripple': status === 'offline',
                      'bg-gray-400': status === 'checking'
                  }"></span>
        </div>
        <span class="truncate">Receipt Printer</span>
        {# Status badge kecil di samping label #}
        <span x-show="status === 'offline'" x-cloak
              class="ml-auto text-[9px] font-bold text-red-500 uppercase tracking-wide">OFF</span>
        <span x-show="status === 'warning'" x-cloak
              class="ml-auto text-[9px] font-bold text-amber-500 uppercase tracking-wide">!</span>
    </button>

    {# FLYOUT PANEL: Fixed popup (tidak mempengaruhi sidebar layout) #}
    <div x-show="flyoutOpen" x-cloak
         x-ref="flyoutPanel"
         @click.outside="flyoutOpen = false"
         x-transition:enter="transition ease-out duration-150"
         x-transition:enter-start="opacity-0 scale-95"
         x-transition:enter-end="opacity-100 scale-100"
         x-transition:leave="transition ease-in duration-100"
         x-transition:leave-start="opacity-100 scale-100"
         x-transition:leave-end="opacity-0 scale-95"
         class="fixed z-[9999] bg-white border border-gray-200 rounded-lg shadow-xl overflow-y-auto"
         :style="flyoutPosition"
         style="width: 240px; max-height: calc(100vh - 16px);">

        {# Flyout Header - compact, color-coded #}
        <div class="flex items-center justify-between px-2.5 py-1.5 border-b"
             :class="headerClass()">
            <div class="flex items-center gap-1.5">
                <div class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0"
                     :class="status === 'online' ? 'bg-green-100' : status === 'warning' ? 'bg-amber-100' : status === 'offline' ? 'bg-red-100' : 'bg-gray-100'">
                    <template x-if="status === 'online'">
                        <svg class="w-3 h-3 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                        </svg>
                    </template>
                    <template x-if="status === 'warning'">
                        <svg class="w-3 h-3 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 9v2m0 4h.01"/>
                        </svg>
                    </template>
                    <template x-if="status === 'offline'">
                        <svg class="w-3 h-3 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </template>
                    <template x-if="status === 'checking'">
                        <svg class="w-3 h-3 text-gray-400 animate-spin" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
                        </svg>
                    </template>
                </div>
                <div>
                    <div class="text-[11px] font-bold text-gray-900">Receipt Printer</div>
                    <div class="text-[9px]"
                         :class="status === 'online' ? 'text-green-600' : status === 'warning' ? 'text-amber-600' : status === 'offline' ? 'text-red-600' : 'text-gray-500'"
                         x-text="statusText()">Checking...</div>
                </div>
            </div>
            <button @click="flyoutOpen = false" class="text-gray-400 hover:text-gray-600 p-0.5">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        {# Status Details - compact #}
        <div class="px-2.5 py-1.5 space-y-0.5">
            {# Service status #}
            <div class="flex justify-between items-center text-[10px]">
                <span class="text-gray-500">Service:</span>
                <span class="font-medium"
                      :class="serviceOnline ? 'text-green-600' : 'text-red-600'"
                      x-text="serviceOnline ? 'Running' : 'Not Running'"></span>
            </div>
            {# Printer hardware status - hanya tampil jika service online #}
            <div class="flex justify-between items-center text-[10px]" x-show="serviceOnline">
                <span class="text-gray-500">Printer:</span>
                <span class="font-medium"
                      :class="printerStatus === 'ready' ? 'text-green-600' : printerStatus === 'warning' ? 'text-amber-600' : 'text-red-600'"
                      x-text="printerMessage || 'Checking...'"></span>
            </div>
            {# Printer name #}
            <div class="flex justify-between items-center text-[10px]" x-show="printerName">
                <span class="text-gray-500">Device:</span>
                <span class="font-medium text-gray-700 truncate max-w-[120px]" x-text="printerName"></span>
            </div>
            {# Platform #}
            <div class="flex justify-between items-center text-[10px]" x-show="platformInfo">
                <span class="text-gray-500">Platform:</span>
                <span class="font-medium text-gray-700" x-text="platformInfo"></span>
            </div>
        </div>

        {# Warning/Error detail - shows specific printer issue #}
        <div x-show="status === 'warning' && printerMessage" x-cloak
             class="mx-2.5 mb-1.5 px-2 py-1 bg-amber-50 border border-amber-200 rounded text-[9px] text-amber-700"
             x-text="printerMessage"></div>

        {# Offline Warning - when service not running #}
        <div x-show="!serviceOnline" x-cloak class="mx-2.5 mb-1.5 px-2 py-1 bg-red-50 border border-red-200 rounded text-[9px] text-red-700">
            POS Launcher tidak berjalan di komputer ini.
        </div>

        {# Printer offline - when service running but printer has error #}
        <div x-show="serviceOnline && printerStatus === 'offline'" x-cloak
             class="mx-2.5 mb-1.5 px-2 py-1 bg-red-50 border border-red-200 rounded text-[9px] text-red-700"
             x-text="printerMessage || 'Printer tidak tersedia'"></div>

        {# Action Buttons - compact #}
        <div class="px-2.5 py-1.5 border-t border-gray-100">
            <button @click="testPrint()" :disabled="loading || status === 'offline' || status === 'checking'"
                    class="w-full flex items-center justify-center gap-1 px-1.5 py-1 bg-purple-600 hover:bg-purple-700 disabled:bg-gray-300 disabled:cursor-not-allowed text-white rounded text-[9px] font-semibold transition-colors">
                <span x-text="loading ? '...' : 'Test Print'"></span>
            </button>
        </div>

    </div>
</div>

<script>
function printerStatusWidget() {
    return {
        flyoutOpen: false,
        flyoutPosition: '',
        loading: false,
        pollInterval: null,

        // Overall status: 'online' | 'warning' | 'offline' | 'checking'
        status: 'checking',

        // Service level
        serviceOnline: false,
        platformInfo: '',

        // Printer hardware level
        printerName: '',
        printerStatus: '',     // 'ready' | 'warning' | 'offline' | 'error' | 'unknown'
        printerMessage: '',
        printerFlags: [],

        init() {
            // Langsung cek saat init agar heartbeat muncul segera
            this.checkAll();
            // Auto-poll setiap 10 detik (selalu aktif, tidak hanya saat flyout terbuka)
            this.pollInterval = setInterval(() => {
                this.checkAll();
            }, 10000);
        },

        async checkAll() {
            // Step 1: Cek service (health check)
            const serviceUp = await this._checkService();

            if (!serviceUp) {
                this.serviceOnline = false;
                this.status = 'offline';
                this.printerName = '';
                this.printerStatus = '';
                this.printerMessage = '';
                this.printerFlags = [];

                return;
            }

            this.serviceOnline = true;

            // Step 2: Cek printer hardware
            await this._checkPrinter();

            // Step 3: Tentukan overall status
            if (this.printerStatus === 'ready') {
                this.status = 'online';
            } else if (this.printerStatus === 'warning') {
                this.status = 'warning';
            } else {
                // printer offline/error/unknown → overall offline
                this.status = 'offline';
            }

            this.lastCheck = new Date();
        },

        async _checkService() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 3000);
                const response = await fetch('http://localhost:5000/health', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (response.ok) {
                    const data = await response.json();
                    this.platformInfo = data.platform || '';
                    return data.status === 'ok';
                }
                return false;
            } catch (error) {
                this.platformInfo = '';
                return false;
            }
        },

        async _checkPrinter() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5s (WMI check needs time)
                const response = await fetch('http://localhost:5000/api/printer/status', {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                if (response.ok) {
                    const data = await response.json();
                    this.printerName = data.printer_name || '';
                    this.printerStatus = data.printer_status || 'unknown';
                    this.printerMessage = data.message || '';
                    this.printerFlags = data.status_flags || [];
                } else {
                    this.printerStatus = 'unknown';
                    this.printerMessage = 'Cannot get status';
                }
            } catch (error) {
                this.printerStatus = 'unknown';
                this.printerMessage = 'Status check failed';
            }
        },

        headerClass() {
            if (this.status === 'online') return 'border-green-100 bg-green-50';
            if (this.status === 'warning') return 'border-amber-100 bg-amber-50';
            if (this.status === 'offline') return 'border-red-100 bg-red-50';
            return 'border-gray-100';
        },

        toggleFlyout() {
            this.flyoutOpen = !this.flyoutOpen;
            if (this.flyoutOpen) {
                this.checkAll();
                // Posisi awal: di samping kanan tombol
                const btn = this.$el.querySelector('button');
                if (btn) {
                    const rect = btn.getBoundingClientRect();
                    this.flyoutPosition = `top:${rect.top}px; left:${rect.right + 6}px;`;
                }
                // Setelah render, ukur tinggi asli dan reposisi jika perlu
                this.$nextTick(() => this.adjustFlyoutPosition());
            }
        },

        adjustFlyoutPosition() {
            const btn = this.$el.querySelector('button');
            const panel = this.$refs.flyoutPanel;
            if (!btn || !panel) return;
            const rect = btn.getBoundingClientRect();
            const panelRect = panel.getBoundingClientRect();
            const flyoutWidth = 240;
            let top = rect.top;
            let left = rect.right + 6;
            // Jaga agar tidak keluar layar bawah (pakai tinggi asli)
            if (top + panelRect.height > window.innerHeight - 8) {
                top = window.innerHeight - panelRect.height - 8;
            }
            if (top < 8) top = 8;
            // Jaga agar tidak keluar layar kanan
            if (left + flyoutWidth > window.innerWidth) {
                left = rect.left - flyoutWidth - 6;
            }
            this.flyoutPosition = `top:${top}px; left:${left}px;`;
        },

        statusText() {
            if (this.status === 'checking') return 'Checking...';
            if (!this.serviceOnline) return 'Service Offline';
            if (this.printerStatus === 'ready') return 'Printer Ready';
            if (this.printerStatus === 'warning') return this.printerMessage || 'Warning';
            if (this.printerMessage) return this.printerMessage;
            return 'Printer Offline';
        },

        async testPrint() {
            this.loading = true;
            try {
                const now = new Date();
                const timestamp = now.toLocaleString('id-ID');
                const sep = '='.repeat(42);
                const dash = '-'.repeat(42);
                const testText = [
                    sep,
                    '          ** TEST PRINT **',
                    sep,
                    '',
                    '  FoodLife POS - Receipt Printer Test',
                    '',
                    dash,
                    '  Status  : OK',
                    '  Time    : ' + timestamp,
                    '  Printer : ' + (this.printerName || 'Default'),
                    dash,
                    '',
                    '  Printer is working correctly.',
                    '',
                    sep,
                    '',
                    '',
                    ''
                ].join('\n');
                const response = await fetch('http://localhost:5000/api/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        type: 'receipt',
                        text: testText,
                        auto_cut: true
                    })
                });
                const data = await response.json();
                if (data.success) {
                    if (typeof showToast === 'function') showToast('Test print berhasil dikirim', 'success');
                } else {
                    if (typeof showToast === 'function') showToast(data.error || 'Print gagal', 'error');
                }
            } catch (error) {
                if (typeof showToast === 'function') showToast('Tidak dapat terhubung ke POS Launcher', 'error');
            } finally {
                this.loading = false;
            }
        },

        destroy() {
            if (this.pollInterval) clearInterval(this.pollInterval);
        }
    }
}
</script>
