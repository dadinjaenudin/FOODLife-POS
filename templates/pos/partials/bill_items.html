{% load humanize %}

{% for item in bill.items.all %}
{% if not item.is_void %}
<!-- Differentiate sent items with green background and disabled controls -->
<div class="{% if item.status == 'sent' %}bg-green-50 border-green-200{% else %}bg-white border-gray-100 hover:shadow-md{% endif %} rounded-lg p-2 flex gap-2 border transition-all">
    <!-- Product Image -->
    {% if item.product.image %}
    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-12 h-12 object-cover rounded-lg flex-shrink-0 {% if item.status == 'sent' %}opacity-70{% endif %}">
    {% else %}
    <div class="w-12 h-12 bg-gradient-to-br {% if item.status == 'sent' %}from-green-100 to-green-200{% else %}from-blue-50 to-indigo-50{% endif %} rounded-lg flex items-center justify-center flex-shrink-0">
        <span class="text-xl">{% if item.status == 'sent' %}‚úì{% else %}üçΩÔ∏è{% endif %}</span>
    </div>
    {% endif %}
    
    <!-- Item Info -->
    <div class="flex-1 min-w-0">
        <div class="flex items-center gap-1.5">
            <h4 class="font-semibold {% if item.status == 'sent' %}text-green-900{% else %}text-gray-900{% endif %} text-sm">{{ item.product.name }}</h4>
            {% if item.status == 'sent' %}
            <span class="text-[10px] font-semibold text-green-600 bg-green-100 px-1.5 py-0.5 rounded-full">Sent</span>
            {% endif %}
        </div>
        
        {% if item.modifiers %}
        <p class="text-[10px] text-gray-500 mt-0.5">
            {% for mod in item.modifiers %}{{ mod.name }}{% if not forloop.last %}, {% endif %}{% endfor %}
        </p>
        {% endif %}
        
        {% if item.notes %}
        <p class="text-[10px] text-blue-600 mt-0.5 italic">{{ item.notes }}</p>
        {% endif %}
        
        <!-- Quantity Controls -->
        <div class="flex items-center gap-1 {% if item.status == 'sent' %}bg-green-100{% else %}bg-gray-50{% endif %} rounded-lg p-0.5 mt-1.5 inline-flex">
            <button 
                class="w-6 h-6 rounded bg-white hover:bg-gray-200 flex items-center justify-center text-gray-700 font-bold shadow-sm transition-all active:scale-95"
                hx-post="{% url 'pos:update_item_qty' item.id %}"
                hx-vals='{"action": "decrease"}'
                hx-target="#bill-panel"
                hx-swap="outerHTML"
                {% if item.status == 'sent' %}disabled class="opacity-50 cursor-not-allowed"{% endif %}
                title="{% if item.status == 'sent' %}Cannot modify sent item{% else %}Decrease{% endif %}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M20 12H4"></path>
                </svg>
            </button>
            <span class="w-8 text-center text-sm font-bold {% if item.status == 'sent' %}text-green-900{% else %}text-gray-900{% endif %}">{{ item.quantity }}</span>
            <button 
                class="w-6 h-6 rounded bg-white hover:bg-blue-50 flex items-center justify-center text-blue-600 font-bold shadow-sm transition-all active:scale-95"
                hx-post="{% url 'pos:update_item_qty' item.id %}"
                hx-vals='{"action": "increase"}'
                hx-target="#bill-panel"
                hx-swap="outerHTML"
                {% if item.status == 'sent' %}disabled class="opacity-50 cursor-not-allowed"{% endif %}
                title="{% if item.status == 'sent' %}Cannot modify sent item{% else %}Increase{% endif %}">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M12 4v16m8-8H4"></path>
                </svg>
            </button>
        </div>
    </div>
    
    <!-- Price Column - Right Aligned -->
    <div class="flex flex-col items-end justify-between">
        <div class="font-bold text-gray-900 text-right whitespace-nowrap text-sm">Rp {{ item.total|floatformat:0|intcomma }}</div>
        
        <!-- Actions: Edit & Delete/Void - Horizontal -->
        <div class="flex items-center gap-1">
            {% if item.status == 'pending' %}
            <!-- Edit Modifier Button (only for pending items) -->
            <button 
                class="w-9 h-9 rounded-lg hover:bg-blue-50 flex items-center justify-center text-blue-600 transition-all"
                hx-get="{% url 'pos:edit_item_modal' item.id %}"
                hx-target="#modal-container"
                title="Edit Modifiers">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
            </button>
            <!-- Remove (for pending items) -->
            <button 
                class="w-9 h-9 rounded-lg hover:bg-red-50 flex items-center justify-center text-red-500 transition-all"
                hx-get="{% url 'pos:confirm_remove_item' item.id %}"
                hx-target="#modal-container"
                title="Remove">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
            </button>
            {% else %}
            <!-- Void (for sent items - requires supervisor PIN) -->
            <button 
                class="w-9 h-9 rounded-lg hover:bg-orange-50 flex items-center justify-center text-orange-600 transition-all"
                hx-get="{% url 'pos:void_item' item.id %}"
                hx-target="#modal-container"
                title="Void (Supervisor PIN Required)">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                </svg>
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}
{% empty %}
<div class="text-center py-12 text-gray-400">
    <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
    </svg>
    <p class="font-medium">No items in cart</p>
    <p class="text-sm mt-1">Add products to get started</p>
</div>
{% endfor %}
