{% comment %}
============================================================================
BILL PANEL (bill_panel.html)
============================================================================
File ini menampilkan PANEL BILL di sisi kanan halaman POS (lebar 288px).
Panel ini adalah "keranjang belanja" di mana kasir bisa melihat item yang
dipesan, total harga, dan melakukan aksi (kirim ke dapur, bayar, dll).

FILE INI MEMILIKI 2 STATE UTAMA:
1. if bill       -> Ada bill aktif: tampilkan Order Summary
2. else          -> Tidak ada bill: tampilkan menu Start Order

DIPANGGIL DARI:
- main.html via include tag (render awal)
- HTMX swap (saat bill dibuat/diupdate, panel ini di-replace)

CONTEXT VARIABLES (dari views.py):
- bill               : Object bill aktif (None jika belum ada)
- active_items_count  : Jumlah item pending (belum dikirim ke dapur)
- has_sent_items      : Boolean, apakah ada item yang sudah sent
- store_config        : Konfigurasi toko (login_image, dll)

LAYOUT (288px, kolom kanan):
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ HEADER (hijau)     ‚îÇ  <- Bill number, Table, Member
‚îÇ #BL-2024-001       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Item 1       Rp xx ‚îÇ  <- Scrollable area (bill_items.html)
‚îÇ Item 2       Rp xx ‚îÇ
‚îÇ ...                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Subtotal     Rp xx ‚îÇ  <- Fixed footer: totals
‚îÇ Tax          Rp xx ‚îÇ
‚îÇ Total        Rp xx ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ [Send to Kitchen]  ‚îÇ  <- Action buttons
‚îÇ [Split]  [Payment] ‚îÇ
‚îÇ [Hold][Void][Move] ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
============================================================================
{% endcomment %}

{% load humanize %}
{% load static %}

{% comment %} STATE 1: ADA BILL AKTIF - Tampilkan panel Order Summary lengkap {% endcomment %}
{% if bill %}
<aside class="bg-white border-l shadow-lg flex flex-col" id="bill-panel" style="width:288px; min-width:288px; max-width:288px; height:100vh; flex-shrink:0;">

    {% comment %}
    HEADER: Info Bill - Color-coded berdasarkan status
    - Hijau  : Ada item pending (belum dikirim ke dapur)
    - Biru   : Semua item sudah dikirim ke dapur (menunggu)
    - Kuning : Bill di-hold
    - Merah  : Bill void
    {% endcomment %}
    <div class="px-4 py-1.5 border-b bill-header-active
        {% if bill.status == 'hold' %}bg-gradient-to-br from-amber-500 to-amber-600
        {% elif bill.status == 'void' %}bg-gradient-to-br from-red-500 to-red-600
        {% elif active_items_count > 0 %}bg-gradient-to-br from-green-500 to-green-600
        {% elif has_sent_items %}bg-gradient-to-br from-blue-500 to-blue-600
        {% else %}bg-gradient-to-br from-green-500 to-green-600
        {% endif %}">
        <div class="flex justify-between items-start">
            <div class="flex-1 min-w-0">
                <h2 class="text-base font-bold text-white mb-0.5">
                    {% if bill.status == 'hold' %}Bill On Hold
                    {% elif active_items_count > 0 %}Order Summary
                        <span class="text-xs font-normal text-white/80">- {{ active_items_count }} pending</span>
                    {% elif has_sent_items %}Order Summary
                        <span class="text-xs font-normal text-white/80">- Sent to Kitchen</span>
                    {% else %}Order Summary
                    {% endif %}
                </h2>

                {# Nomor Bill #}
                <div class="flex items-center gap-1">
                    <svg class="w-3 h-3 text-white/90 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span class="text-xs font-mono text-white font-semibold truncate">#{{ bill.bill_number }}</span>
                </div>

                {% comment %}
                Nomor Meja
                Jika bill punya table -> tampilkan "Table X"
                Jika tidak (Take Away) -> tampilkan warning "[No Table]"
                {% endcomment %}
                <div class="flex items-center gap-1 mt-0.5">
                    {% if bill.table %}
                    <svg class="w-3 h-3 text-white/90 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span class="text-xs font-semibold text-white truncate">Table {{ bill.table.number }}</span>
                    {% else %}
                    <svg class="w-3 h-3 text-yellow-200 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                    <span class="text-[10px] text-yellow-200 font-semibold">[No Table]</span>
                    {% endif %}
                </div>

                {% comment %} Info Member (jika ada) - Member bisa di-attach ke bill untuk program loyalti {% endcomment %}
                {% if bill.member_code %}
                <div class="flex items-center gap-1.5 mt-0.5">
                    <svg class="w-3.5 h-3.5 text-white/90 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span class="text-xs text-white">
                        <span class="font-bold">{{ bill.member_name }}</span>
                        <span class="text-white/70"> - </span>
                        <span class="font-mono">{{ bill.member_code }}</span>
                    </span>
                </div>
                {% endif %}
            </div>

            {% comment %}
            TOMBOL AKSI DI HEADER
            1. Display: Manual update customer display (layar pelanggan)
            2. Member: Attach/ubah member ke bill
            {% endcomment %}
            <div class="flex items-center gap-1">
                {# Tombol Update Customer Display #}
                <button
                    onclick="if(typeof updateCustomerDisplay === 'function') { updateCustomerDisplay([], 0); console.log('Manual update triggered'); } else { console.error('updateCustomerDisplay not found'); }"
                    class="flex flex-col items-center justify-center px-2 py-1 bg-blue-500/20 hover:bg-blue-500/30 text-white rounded-md transition-all shadow-sm hover:shadow-md backdrop-blur-sm"
                    title="Update Customer Display (Manual)">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                    <span class="text-[9px] font-bold">Display</span>
                </button>

                {# Tombol Attach Member (via HTMX modal) #}
                <button
                    hx-get="{% url 'pos:member_pin_modal' bill.id %}"
                    hx-target="#modal-container"
                    class="flex flex-col items-center justify-center px-2 py-1 bg-white/20 hover:bg-white/30 text-white rounded-md transition-all shadow-sm hover:shadow-md backdrop-blur-sm"
                    title="Attach Member to Bill">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span class="text-[9px] font-bold">Member</span>
                </button>
            </div>
        </div>
    </div>

{% comment %} DEBUG SCRIPT: Log info bill ke console browser (berguna untuk debugging) {% endcomment %}
<script>
    console.log('=== BILL DEBUG ===');
    console.log('Bill ID: {{ bill.id }}');
    console.log('Bill Number: {{ bill.bill_number }}');
    console.log('Bill Table: {{ bill.table }}');
    console.log('Bill Table ID: {{ bill.table.id|default:"NULL" }}');
    console.log('Bill Table Name: {{ bill.table.name|default:"NULL" }}');
    console.log('Bill Table Number: {{ bill.table.number|default:"NULL" }}');
    console.log('Active Items Count: {{ active_items_count }}');
    console.log('Has Sent Items: {{ has_sent_items }}');
    console.log('==================');

    // Animasi highlight saat header muncul (misal setelah merge bill)
    setTimeout(() => {
        const header = document.querySelector('.bill-header-active');
        if (header) {
            header.style.animation = 'highlightPulse 2s ease-in-out';
        }
    }, 100);
</script>

<style>
    @keyframes highlightPulse {
        0%, 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        50% { box-shadow: 0 0 20px 5px rgba(59, 130, 246, 0.5); }
    }
</style>

    {% comment %}
    DAFTAR ITEM BILL (Scrollable)
    Area ini bisa di-scroll jika item banyak.
    flex-1 + min-h-0 = mengisi sisa ruang antara header dan footer.
    Konten di-render dari bill_items.html
    {% endcomment %}
    <div id="bill-items" class="flex-1 overflow-y-auto p-1.5 space-y-1 min-h-0">
        {% include 'pos/partials/bill_items.html' %}
    </div>

    {% comment %} FIXED FOOTER: TOTALS + ACTION BUTTONS - selalu terlihat di bawah (tidak ikut scroll) {% endcomment %}
    <div class="flex-shrink-0 border-t bg-white">

        {% comment %} RINGKASAN HARGA - Subtotal, Discount, Tax, Service Charge, dan TOTAL {% endcomment %}
        <div class="px-3 py-2 space-y-1.5 bg-gray-50 border-b">
            {# Subtotal: harga sebelum diskon/pajak #}
            <div class="flex justify-between text-xs text-gray-700">
                <span>Subtotal</span>
                <span class="font-semibold text-right">Rp {{ bill.subtotal|floatformat:0|intcomma }}</span>
            </div>

            {# Diskon (hanya tampil jika ada) #}
            {% if bill.discount_amount > 0 %}
            <div class="flex justify-between text-[11px] text-red-600">
                <span>Discount ({{ bill.discount_percent }}%)</span>
                <span class="font-medium text-right">-Rp {{ bill.discount_amount|floatformat:0|intcomma }}</span>
            </div>
            {% endif %}

            {# Pajak (hanya tampil jika ada) - dari setting outlet #}
            {% if bill.tax_amount > 0 %}
            <div class="flex justify-between text-[11px] text-gray-600">
                <span>Tax ({{ bill.outlet.tax_rate }}%)</span>
                <span class="font-medium text-right">Rp {{ bill.tax_amount|floatformat:0|intcomma }}</span>
            </div>
            {% endif %}

            {# Service Charge (hanya tampil jika ada) - dari setting outlet #}
            {% if bill.service_charge > 0 %}
            <div class="flex justify-between text-[11px] text-gray-600">
                <span>Service ({{ bill.outlet.service_charge }}%)</span>
                <span class="font-medium text-right">Rp {{ bill.service_charge|floatformat:0|intcomma }}</span>
            </div>
            {% endif %}

            {# TOTAL AKHIR (bold, ukuran besar) #}
            <div class="flex justify-between text-base font-bold text-gray-900 pt-1.5 border-t">
                <span>Total</span>
                <span class="text-right">Rp {{ bill.total|floatformat:0|intcomma }}</span>
            </div>
        </div>


        {% comment %}
        ACTION BUTTONS
        Tombol aksi berubah tergantung kondisi bill:

        KONDISI 1: active_items_count > 0 (ada item pending)
        -> Tampilkan "Send to Kitchen"

        KONDISI 2: active_items_count = 0 DAN tidak ada sent items
        -> Tampilkan "Cancel Bill" (bill kosong, bisa dibatalkan)

        KONDISI 3: lainnya (semua item sudah sent)
        -> Tidak ada tombol utama, langsung ke Split/Payment
        {% endcomment %}
        <div class="p-1.5 space-y-1.5">

        {% if active_items_count > 0 %}
        {% comment %}
        TOMBOL: SEND TO KITCHEN
        Kirim semua item pending ke dapur.
        Badge menunjukkan jumlah item yang akan dikirim.
        Menggunakan HTMX POST, hasilnya replace #bill-panel
        {% endcomment %}
        <button
            class="w-full py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
            hx-post="{% url 'pos:send_to_kitchen' bill.id %}"
            hx-target="#bill-panel"
            hx-swap="outerHTML"
            title="Send to Kitchen (F1)">
            <span class="text-xl">üßë‚Äçüç≥</span>
            <span class="text-sm">Send to Kitchen</span>
            <span class="ml-1 px-2 py-0.5 bg-white/30 rounded-full text-xs font-bold">{{ active_items_count }}</span>
            <kbd class="ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px] font-mono">F1</kbd>
        </button>

        {% elif not has_sent_items %}
        {% comment %}
        TOMBOL: CANCEL BILL
        Hanya muncul jika TIDAK ADA item yang sudah sent ke dapur.
        (Bill kosong atau semua item pending sudah dihapus)
        Buka modal konfirmasi sebelum cancel
        {% endcomment %}
        <button
            class="w-full py-2 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-2 shadow-md hover:shadow-lg"
            onclick="showCancelBillModal({{ bill.id }})"
            title="Cancel Bill (F8)">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            <span class="text-sm">Cancel Bill</span>
            <kbd class="ml-1 px-1.5 py-0.5 bg-white/20 rounded text-[9px] font-mono">F8</kbd>
        </button>
        {% endif %}

        {# ROW: SPLIT BILL + PAYMENT (2 kolom) #}
        <div class="grid grid-cols-2 gap-1.5">
            {% comment %}
            Tombol Split Bill - Pecah bill jadi beberapa bill
            Disabled jika item kurang dari 2 (tidak bisa split 1 item)
            {% endcomment %}
            <button
                class="py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg {% if bill.items.count < 2 %}opacity-50 cursor-not-allowed{% endif %}"
                hx-get="{% url 'pos:split_bill_modal' bill.id %}"
                hx-target="#modal-container"
                hx-swap="innerHTML"
                {% if bill.items.count < 2 %}disabled{% endif %}
                title="{% if bill.items.count < 2 %}Need at least 2 items to split{% else %}Split bill into multiple bills{% endif %}">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                <span class="text-sm">Split</span>
            </button>

            {# Tombol Payment - Buka modal pembayaran #}
            <button
                class="py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all flex items-center justify-center gap-1.5 shadow-md hover:shadow-lg"
                hx-get="{% url 'pos:payment_modal' bill.id %}"
                hx-target="#modal-container"
                title="Payment (F2)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                </svg>
                <span class="text-sm">Payment</span>
                <kbd class="px-1 py-0.5 bg-white/20 rounded text-[9px] font-mono">F2</kbd>
            </button>
        </div>

        {% comment %}
        ROW: HOLD / VOID / MOVE / MERGE (4 kolom)
        Tombol-tombol manajemen bill:
        - Hold   : Tahan bill (simpan sementara, bisa dilanjutkan nanti)
        - Void   : Batalkan seluruh bill (butuh PIN supervisor)
        - Move   : Pindahkan bill ke meja lain
        - Merge  : Gabungkan bill ini dengan bill lain
        {% endcomment %}
        <div class="grid grid-cols-4 gap-1.5">
            {# HOLD: Simpan bill sementara #}
            <button
                class="flex flex-col items-center justify-center gap-0.5 py-2 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all shadow-sm hover:shadow-md"
                hx-get="{% url 'pos:hold_modal' bill.id %}"
                hx-target="#modal-container"
                title="Hold Bill (F3)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-[10px]">Hold<kbd class="ml-0.5 px-1 py-0.5 bg-white/20 rounded text-[8px] font-mono">F3</kbd></span>
            </button>

            {# VOID: Batalkan seluruh bill #}
            <button
                class="flex flex-col items-center justify-center gap-0.5 py-2 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all shadow-sm hover:shadow-md"
                hx-get="{% url 'pos:confirm_void_modal' bill.id %}"
                hx-target="#modal-container">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
                </svg>
                <span class="text-[10px]">Void</span>
            </button>

            {# MOVE: Pindah ke meja lain #}
            <button
                class="flex flex-col items-center justify-center gap-0.5 py-2 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all shadow-sm hover:shadow-md"
                hx-get="{% url 'pos:move_table_modal' bill.id %}"
                hx-target="#modal-container"
                title="Move to another table">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                <span class="text-[10px]">Move</span>
            </button>

            {# MERGE: Gabung dengan bill lain #}
            <button
                class="flex flex-col items-center justify-center gap-0.5 py-2 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold rounded-lg transition-all shadow-sm hover:shadow-md"
                hx-get="{% url 'pos:merge_bills_modal' bill.id %}"
                hx-target="#modal-container"
                hx-swap="innerHTML"
                title="Merge with another bill">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path>
                </svg>
                <span class="text-[10px]">Merge</span>
            </button>
        </div>
    </div>
    {# End Fixed Footer #}
</aside>

{% comment %}
STATE 2: TIDAK ADA BILL AKTIF
Tampilkan menu "Start Order" dengan 4 pilihan:
1. Choose Table  -> Buka floor plan, pilih meja (dine-in)
2. Take Away     -> Buat bill tanpa meja (takeaway)
3. Quick Order   -> Order cepat + langsung bayar
4. Resume Bill   -> Lanjutkan bill yang di-hold sebelumnya
{% endcomment %}
{% else %}
<aside class="bg-white border-l shadow-lg flex flex-col" id="bill-panel" style="width:288px; min-width:288px; max-width:288px; height:100vh; flex-shrink:0;">
    <div class="flex-1 flex flex-col items-center justify-center p-8">

        {% comment %}
        Gambar Ilustrasi / Logo Toko
        Priority: 1) store_config.login_image  2) Brand logo  3) SVG fallback
        {% endcomment %}
        <div class="mb-6">
            {% if store_config.login_image %}
            <img src="{{ store_config.login_image.url }}"
                 alt="{{ store_config.store_name }}"
                 class="w-48 h-48 object-contain rounded-2xl shadow-lg bg-white"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-48 h-48 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl flex items-center justify-center shadow-lg" style="display:none;">
                <svg class="w-24 h-24 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            {% elif store_config.brand.logo %}
            <img src="{{ store_config.brand.logo.url }}"
                 alt="{{ store_config.brand.name }}"
                 class="w-48 h-48 object-contain rounded-2xl shadow-lg bg-white"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
            <div class="w-48 h-48 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl flex items-center justify-center shadow-lg" style="display:none;">
                <svg class="w-24 h-24 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            {% else %}
            <div class="w-48 h-48 bg-gradient-to-br from-blue-50 to-indigo-100 rounded-2xl flex items-center justify-center shadow-lg">
                <svg class="w-24 h-24 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
            </div>
            {% endif %}
        </div>

        <h3 class="text-xl font-bold text-gray-900 mb-2">No active bill</h3>
        <p class="text-sm text-gray-500 mb-8">Select a table or start a new order</p>

        {# 4 TOMBOL START ORDER #}
        <div class="w-full max-w-xs space-y-3">

            {% comment %}
            1. CHOOSE TABLE (Dine-in)
            Buka floor plan modal untuk pilih meja.
            Fungsi openFloorPlanModal() didefinisikan di main.html
            {% endcomment %}
            <button onclick="openFloorPlanModal()"
               class="group flex items-center gap-3 w-full px-4 py-3 bg-white hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-500 rounded-xl transition-all duration-200 hover:shadow-lg"
               title="Choose Table (F4)">
                <div class="w-10 h-10 bg-blue-100 group-hover:bg-blue-500 rounded-lg flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 text-blue-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                    </svg>
                </div>
                <div class="flex-1 text-left">
                    <p class="font-semibold text-gray-900 group-hover:text-blue-600 transition-colors">Choose Table <kbd class="px-1.5 py-0.5 bg-blue-100 text-blue-600 rounded text-[9px] font-mono">F4</kbd></p>
                    <p class="text-xs text-gray-500">Dine-in order</p>
                </div>
                <svg class="w-5 h-5 text-gray-400 group-hover:text-blue-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            {% comment %}
            2. TAKE AWAY ORDER
            Buat bill baru tanpa meja (order_type: "takeaway").
            Menggunakan HTMX POST, hasilnya replace #bill-panel
            {% endcomment %}
            <button
                class="group flex items-center gap-3 w-full px-4 py-3 bg-white hover:bg-green-50 border-2 border-gray-200 hover:border-green-500 rounded-xl transition-all duration-200 hover:shadow-lg"
                hx-post="{% url 'pos:open_bill' %}"
                hx-vals='{"order_type": "takeaway"}'
                hx-target="#bill-panel"
                hx-swap="outerHTML">
                <div class="w-10 h-10 bg-green-100 group-hover:bg-green-500 rounded-lg flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 text-green-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path>
                    </svg>
                </div>
                <div class="flex-1 text-left">
                    <p class="font-semibold text-gray-900 group-hover:text-green-600 transition-colors">Take Away Order</p>
                    <p class="text-xs text-gray-500">Regular takeaway order</p>
                </div>
                <svg class="w-5 h-5 text-gray-400 group-hover:text-green-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            {% comment %}
            3. QUICK ORDER
            Order cepat: pilih produk + langsung bayar dalam 1 modal.
            Cocok untuk transaksi cepat tanpa perlu duduk di meja
            {% endcomment %}
            <button
                onclick="console.log('Quick Order button clicked');"
                class="group flex items-center gap-3 w-full px-4 py-3 bg-white hover:bg-purple-50 border-2 border-gray-200 hover:border-purple-500 rounded-xl transition-all duration-200 hover:shadow-lg"
                hx-get="{% url 'pos:quick_order' %}"
                hx-target="#modal-container"
                hx-swap="innerHTML">
                <div class="w-10 h-10 bg-purple-100 group-hover:bg-purple-500 rounded-lg flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 text-purple-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                </div>
                <div class="flex-1 text-left">
                    <p class="font-semibold text-gray-900 group-hover:text-purple-600 transition-colors">Quick Order</p>
                    <p class="text-xs text-gray-500">Fast order & payment</p>
                </div>
                <svg class="w-5 h-5 text-gray-400 group-hover:text-purple-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            {% comment %}
            4. RESUME BILL
            Buka daftar bill yang di-hold sebelumnya.
            User bisa pilih bill mana yang mau dilanjutkan.
            {% endcomment %}
            <button
                id="held-bills-btn"
                class="group flex items-center gap-3 w-full px-4 py-3 bg-white hover:bg-amber-50 border-2 border-gray-200 hover:border-amber-500 rounded-xl transition-all duration-200 hover:shadow-lg"
                hx-get="{% url 'pos:held_bills' %}"
                hx-target="#modal-container"
                hx-swap="innerHTML">
                <div class="w-10 h-10 bg-amber-100 group-hover:bg-amber-500 rounded-lg flex items-center justify-center transition-colors">
                    <svg class="w-5 h-5 text-amber-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div class="flex-1 text-left">
                    <p class="font-semibold text-gray-900 group-hover:text-amber-600 transition-colors">Resume Bill</p>
                    <p class="text-xs text-gray-500">Continue held order</p>
                </div>
                <svg class="w-5 h-5 text-gray-400 group-hover:text-amber-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
            </button>
        </div>
    </div>
</aside>

{% comment %}
JAVASCRIPT: Shift Required Warning
Fungsi ini dipanggil jika user coba buat order tapi shift belum dibuka.
Tampilkan popup peringatan dengan tombol untuk buka shift.
{% endcomment %}
<script>
function showShiftRequiredMessage() {
    const toast = document.createElement('div');
    toast.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white px-8 py-6 rounded-2xl shadow-2xl z-[100] max-w-md';
    toast.innerHTML = `
        <div class="flex items-start gap-4">
            <svg class="w-12 h-12 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
            </svg>
            <div>
                <p class="font-bold text-xl mb-2">Shift Belum Dibuka!</p>
                <p class="text-base mb-4">Anda harus membuka shift terlebih dahulu sebelum melakukan transaksi.</p>
                <button onclick="this.parentElement.parentElement.parentElement.remove(); document.querySelector('[hx-get*=shift_open_form]').click();"
                        class="bg-white text-red-600 px-6 py-2 rounded-lg font-semibold hover:bg-red-50 transition">
                    Buka Shift Sekarang
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(toast);

    // Auto hilang setelah 10 detik
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.5s';
        setTimeout(() => toast.remove(), 500);
    }, 10000);
}
</script>

{% endif %}

{% comment %}
MODAL: CANCEL BILL CONFIRMATION
Modal konfirmasi untuk cancel bill kosong (tanpa item sent).
Muncul saat user klik tombol "Cancel Bill" di atas.

ALUR:
1. User klik "Cancel Bill" -> showCancelBillModal(billId)
2. Modal muncul dengan pilihan "Keep Bill" atau "Yes, Cancel"
3. Jika "Yes, Cancel" -> POST /pos/bill/id/cancel-empty/
4. Setelah cancel, halaman reload untuk refresh semua elemen
{% endcomment %}
<div id="cancel-bill-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target === this) closeCancelBillModal()">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transform transition-all">
        {# Header modal (merah) #}
        <div class="px-6 py-4 border-b bg-gradient-to-r from-red-500 to-red-600 text-white rounded-t-2xl">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div>
                    <h3 class="text-xl font-bold">Cancel Bill</h3>
                    <p class="text-sm text-white/80">This action cannot be undone</p>
                </div>
            </div>
        </div>

        {# Konten modal #}
        <div class="px-6 py-6">
            <div class="text-center mb-6">
                <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4">
                    <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <p class="text-gray-700 text-lg font-medium mb-2">Cancel this empty bill?</p>
                <p class="text-gray-500 text-sm">The bill will be removed and you'll return to the start screen.</p>
            </div>
        </div>

        {# Footer: tombol Keep Bill dan Yes, Cancel #}
        <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex gap-3">
            <button
                onclick="closeCancelBillModal()"
                class="flex-1 px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 transition font-semibold">
                Keep Bill
            </button>
            <button
                id="confirm-cancel-btn"
                onclick="confirmCancelBill()"
                class="flex-1 px-4 py-3 bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-xl transition font-semibold shadow-lg">
                Yes, Cancel
            </button>
        </div>
    </div>
</div>

{# JAVASCRIPT: Cancel Bill Modal Logic #}
<script>
// Simpan bill ID di window object untuk menghindari error re-declaration
// saat HTMX swap (karena script bisa di-load ulang)
if (typeof window.cancelBillId === 'undefined') {
    window.cancelBillId = null;
}

// Buka modal cancel bill
function showCancelBillModal(billId) {
    window.cancelBillId = billId;
    document.getElementById('cancel-bill-modal').classList.remove('hidden');
}

// Tutup modal cancel bill
function closeCancelBillModal() {
    document.getElementById('cancel-bill-modal').classList.add('hidden');
    window.cancelBillId = null;
}

// Konfirmasi cancel bill -> kirim POST request ke server
function confirmCancelBill() {
    if (!window.cancelBillId) return;

    // Tampilkan loading spinner di tombol
    const btn = document.getElementById('confirm-cancel-btn');
    btn.disabled = true;
    btn.innerHTML = '<svg class="animate-spin h-5 w-5 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

    // Kirim request cancel via HTMX
    htmx.ajax('POST', `/pos/bill/${window.cancelBillId}/cancel-empty/`, {
        target: '#bill-panel',
        swap: 'outerHTML'
    }).then(() => {
        console.log('Cancel bill successful!');
        closeCancelBillModal();

        // Reload halaman untuk refresh product grid
        // (karena product card perlu update state: bill sudah tidak ada)
        setTimeout(() => {
            console.log('Reloading page to refresh product grid...');
            window.location.reload(true);
        }, 300);
    }).catch(() => {
        // Jika gagal, kembalikan tombol ke semula
        btn.disabled = false;
        btn.innerHTML = 'Yes, Cancel';
        showToast('Failed to cancel bill', 'error');
    });
}
</script>
