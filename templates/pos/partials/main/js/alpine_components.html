{% comment %}
============================================================================
ALPINE.JS COMPONENTS (alpine_components.html)
============================================================================
File ini berisi definisi ALPINE.JS COMPONENTS yang digunakan di halaman POS.
Alpine.js adalah library JavaScript ringan untuk menambah interaktivitas ke HTML.

DIPANGGIL DARI: main.html via include tag (di bagian bawah, setelah HTML)

KOMPONEN:
1. posModal()   - Modal warning/konfirmasi (digunakan saat shift belum aktif)
2. quickOrder() - Quick order flow (pilih produk → bayar langsung tanpa bill)

CATATAN:
- posModal() digunakan oleh x-data di main.html container utama
- quickOrder() digunakan oleh modal Quick Order
- Kedua fungsi ini HARUS didefinisikan secara global (window scope)
============================================================================
{% endcomment %}

<script>
    {% comment %}
    ====================================================================
    posModal() - Alpine.js Component untuk Modal Warning/Konfirmasi
    ====================================================================
    Digunakan oleh elemen utama POS: <div x-data="posModal()">

    CARA PAKAI:
    1. Di HTML: <div x-data="posModal()">
    2. Di JS: component.showModal({ title, message, confirmText, onConfirm })
    3. Modal muncul dengan animasi fade-in
    4. User klik Confirm → jalankan onConfirm callback
    5. User klik Cancel → tutup modal

    CONTOH PENGGUNAAN (dari checkShiftActive):
    component.showModal({
        title: 'Shift Belum Dibuka',
        message: 'Silakan buka shift terlebih dahulu...',
        confirmText: 'Buka Shift',
        onConfirm: () => { openShiftModal(); }
    });
    ====================================================================
    {% endcomment %}
    function posModal() {
        return {
            modal: {
                show: false,
                title: '',
                message: '',
                confirmText: 'OK',
                cancelText: 'Batal',
                onConfirm: () => { this.modal.show = false; }
            },

            showModal(options) {
                this.modal = {
                    show: true,
                    title: options.title || '',
                    message: options.message || '',
                    confirmText: options.confirmText || 'OK',
                    cancelText: options.cancelText || 'Batal',
                    onConfirm: options.onConfirm || (() => { this.modal.show = false; })
                };
            }
        };
    }

    {% comment %}
    ====================================================================
    quickOrder() - Alpine.js Component untuk Quick Order
    ====================================================================
    Flow pemesanan cepat tanpa perlu buat bill terlebih dahulu.
    Digunakan di modal Quick Order yang dibuka dari bill_panel.html.

    FITUR:
    - Tambah/kurang item ke keranjang sementara (client-side)
    - Hitung total otomatis
    - Format angka ke Rupiah (pemisah ribuan)
    - Input nominal pembayaran
    - Submit order ke server via fetch API
    - Update customer display (jika mode kiosk)

    STATE:
    - items[]        : Array item di keranjang {product_id, name, price, quantity}
    - customerName   : Nama pelanggan (opsional)
    - paymentMethod  : Metode bayar ('cash' / 'qris' / dll)
    - paymentAmount  : Nominal pembayaran
    ====================================================================
    {% endcomment %}
    function quickOrder() {
        return {
            items: [],
            customerName: '',
            submitting: false,

            {# Computed: Total harga semua item #}
            get total() {
                return this.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            },

            {# Tambah item ke keranjang (jika sudah ada, qty +1) #}
            addItem(productId, name, price) {
                const existingItem = this.items.find(item => item.product_id === productId);
                if (existingItem) {
                    existingItem.quantity++;
                } else {
                    this.items.push({
                        product_id: productId,
                        name: name,
                        price: price,
                        quantity: 1
                    });
                }
            },

            {# Hapus item dari keranjang berdasarkan index #}
            removeItem(index) {
                this.items.splice(index, 1);
            },

            {# Tambah qty item +1 #}
            increaseQty(index) {
                this.items[index].quantity++;
            },

            {# Kurangi qty item -1 (jika qty=1, hapus item) #}
            decreaseQty(index) {
                if (this.items[index].quantity > 1) {
                    this.items[index].quantity--;
                } else {
                    this.removeItem(index);
                }
            },

            {# Parse format angka Indonesia (10.000,00) ke number (10000) #}
            parseIndonesianNumber(str) {
                return parseFloat(str.replace(/\./g, '').replace(',', '.'));
            },

            {# Format angka ke Rupiah: 10000 → "Rp 10,000" #}
            formatRupiah(amount) {
                const num = Math.round(amount).toString();
                const formatted = num.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                return 'Rp ' + formatted;
            },

            {% comment %}
            submitOrder - Create bill with items, then open standard payment modal.
            Step 1: POST /pos/quick-order/create/ → returns JSON {bill_id}
            Step 2: GET /pos/bill/{bill_id}/payment/ → loads payment modal HTML
            {% endcomment %}
            submitOrder() {
                if (this.items.length === 0 || this.submitting) return;
                this.submitting = true;

                const formData = new FormData();
                formData.append('items', JSON.stringify(this.items));
                formData.append('customer_name', this.customerName);
                formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

                fetch('/pos/quick-order/create/', {
                    method: 'POST',
                    body: formData,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.bill_id) {
                        {# Close quick order modal #}
                        const quickOrderModal = document.querySelector('[x-data="quickOrder()"]');
                        if (quickOrderModal) quickOrderModal.closest('.fixed').remove();

                        {# Load payment modal via HTMX (same as bill panel Payment button) #}
                        htmx.ajax('GET', '/pos/bill/' + data.bill_id + '/payment/', {
                            target: '#modal-container',
                            swap: 'innerHTML'
                        });

                        {# Refresh bill panel to show the new active bill #}
                        htmx.ajax('GET', '/pos/bill/' + data.bill_id + '/refresh/', {
                            target: '#bill-panel',
                            swap: 'outerHTML'
                        });
                    } else {
                        showToast('Failed to create order', 'error');
                        this.submitting = false;
                    }
                })
                .catch(error => {
                    console.error('Quick order error:', error);
                    showToast('Failed to create order: ' + error.message, 'error');
                    this.submitting = false;
                });
            }
        }
    }
</script>
