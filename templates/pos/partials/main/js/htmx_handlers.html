{% comment %}
============================================================================
HTMX EVENT HANDLERS (htmx_handlers.html)
============================================================================
File ini berisi semua EVENT HANDLER untuk HTMX di halaman POS.
HTMX adalah library yang memungkinkan update partial halaman tanpa reload.

DIPANGGIL DARI: main.html via include tag

EVENT HANDLERS:
1. htmx:afterSwap      - Setelah HTMX selesai swap konten baru
   - Update styling category button aktif
   - Update customer display saat bill panel berubah
   - Re-enable tombol Held Bills setelah modal swap
   - Re-process HTMX attributes di bill-panel dan product-grid

2. htmx:beforeRequest  - Sebelum HTMX kirim request
   - Pastikan modal-container ada sebelum request ke sana
   - Log debug untuk shift-related requests

3. htmx:targetError    - Saat target element tidak ditemukan
   - Recreate modal-container jika hilang
   - Retry request yang gagal

4. htmx:beforeSwap     - Sebelum HTMX swap konten
   - Ensure modal-container swap diizinkan

5. htmx:afterSettle    - Setelah animasi HTMX selesai
   - Re-process bill-panel dan modal-container

6. htmx:trigger        - Saat HTMX request di-trigger
   - Debug logging

7. htmx:afterRequest   - Setelah HTMX request selesai
   - Handle hold bill → reload page

CATATAN:
- Bill panel perlu di-re-process setelah swap karena outerHTML swap
  menghapus HTMX bindings dari element baru
- Modal container kadang hilang setelah swap, perlu di-recreate
============================================================================
{% endcomment %}

<script>
    {% comment %}
    ====================================================================
    htmx:afterSwap - Handler setelah HTMX selesai menukar konten
    ====================================================================
    Dipanggil setiap kali HTMX berhasil swap HTML baru ke dalam DOM.
    Handler ini menangani beberapa target berbeda:
    - #product-grid: Update styling tombol kategori aktif
    - #bill-panel: Re-process HTMX, update customer display
    - #modal-container: Re-enable buttons, process HTMX, sync ke customer display
    {% endcomment %}
    document.addEventListener('htmx:afterSwap', function (event) {
        {# TARGET: Product Grid - Update category button active state #}
        if (event.detail.target.id === 'product-grid') {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'border-gray-300', 'text-gray-700');
                btn.classList.add('bg-gray-100', 'border-gray-300', 'text-gray-700');
            });

            event.detail.elt.classList.remove('bg-gray-100', 'border-gray-300', 'text-gray-700');
            event.detail.elt.classList.add('bg-white', 'border-gray-300', 'text-gray-700');
        }

        {# TARGET: Bill Panel - Update customer display #}
        if (event.detail.target.id === 'bill-panel' || event.detail.target.closest('#bill-panel')) {
            setTimeout(() => {
                if (typeof updateCustomerDisplay === 'function') {
                    updateCustomerDisplay([], 0);
                }
            }, 100);
        }
    });

    {% comment %}
    htmx:beforeRequest - Pastikan modal-container ada sebelum request
    {% endcomment %}
    document.addEventListener('htmx:beforeRequest', function (event) {
        {# Block request ke modal-container jika payment modal sedang aktif (kecuali dari dalam payment modal sendiri) #}
        const targetSelector = event.detail.elt.getAttribute('hx-target');
        if (targetSelector === '#modal-container' && window._paymentModalActive) {
            if (!event.detail.elt.closest('[data-payment-modal]')) {
                event.preventDefault();
                return;
            }
        }

        {# Pastikan modal-container ada jika request menarget ke sana #}
        if (targetSelector === '#modal-container') {
            let modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'modal-container';
                document.body.appendChild(modalContainer);
                event.detail.target = modalContainer;
            }
        }
    });

    {% comment %}
    htmx:targetError - Recreate modal-container jika hilang, retry request
    {% endcomment %}
    document.addEventListener('htmx:targetError', function (event) {
        const targetSelector = event.detail.elt.getAttribute('hx-target');

        {# Block retry ke modal-container jika payment modal aktif #}
        if (targetSelector === '#modal-container' && window._paymentModalActive) {
            if (!event.detail.elt.closest('[data-payment-modal]')) {
                return;
            }
        }

        if (targetSelector === '#modal-container') {
            let modalContainer = document.getElementById('modal-container');
            if (!modalContainer) {
                modalContainer = document.createElement('div');
                modalContainer.id = 'modal-container';
                document.body.appendChild(modalContainer);
            }

            {# Retry request yang gagal #}
            const url = event.detail.elt.getAttribute('hx-get') || event.detail.elt.getAttribute('hx-post');
            if (url) {
                htmx.ajax('GET', url, { target: '#modal-container', swap: 'innerHTML' });
            }
        }
    });

    {% comment %}
    htmx:beforeSwap - Izinkan swap pada modal-container
    {% endcomment %}
    document.addEventListener('htmx:beforeSwap', function (event) {
        {# 422 = validation error — always allow swap (retargeted via HX-Retarget) #}
        if (event.detail.xhr.status === 422) {
            event.detail.shouldSwap = true;
            event.detail.isError = false;
            return;
        }
        if (event.detail.target.id === 'modal-container') {
            {# Block swap ke modal-container jika payment modal aktif (kecuali dari payment modal sendiri) #}
            if (window._paymentModalActive) {
                const elt = event.detail.requestConfig?.elt;
                if (!elt || !elt.closest('[data-payment-modal]')) {
                    event.detail.shouldSwap = false;
                    return;
                }
            }
            event.detail.shouldSwap = true;
        }
    });

    {% comment %}
    htmx:afterSwap (kedua) - Handle modal-container dan bill-panel setelah swap
    {% endcomment %}
    document.addEventListener('htmx:afterSwap', function (event) {
        {# TARGET: Modal Container - Re-enable buttons, process HTMX, sync customer display #}
        if (event.detail.target.id === 'modal-container') {
            const heldBillsBtn = document.getElementById('held-bills-btn');
            if (heldBillsBtn) {
                heldBillsBtn.disabled = false;
                heldBillsBtn.classList.remove('htmx-request');
            }

            {# Re-process HTMX di dalam modal (agar tombol HTMX di modal berfungsi) #}
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                htmx.process(modalContainer);
            }

            {# Kirim modal ke customer display (jika payment modal) #}
            {# Delay 500ms: wait for Alpine init after clone+replace (rAF+setTimeout+MO) #}
            setTimeout(() => {
                sendModalToCustomerDisplay();
            }, 500);
        }

        {# TARGET: Bill Panel - Re-process HTMX dan update customer display #}
        if (event.detail.target.id === 'bill-panel') {
            setTimeout(function () {
                const billPanel = document.getElementById('bill-panel');
                if (billPanel) {
                    htmx.process(billPanel);

                    if (isKioskMode()) {
                        updateCustomerDisplay([], 0);
                    }

                    {# Re-enable tombol View Held Bills #}
                    const heldBillsBtn = document.getElementById('held-bills-btn');
                    if (heldBillsBtn) {
                        heldBillsBtn.classList.remove('htmx-request', 'htmx-swapping');
                        heldBillsBtn.disabled = false;
                        htmx.process(heldBillsBtn);
                    }
                }

                {# Re-process product grid agar tombol Add berfungsi #}
                const productGrid = document.getElementById('product-grid');
                if (productGrid) {
                    htmx.process(productGrid);
                }
            }, 50);
        }

        {# Handle outerHTML swap pada bill-panel #}
        const swappedElement = event.detail.target;
        if (swappedElement && (swappedElement.id === 'bill-panel' || swappedElement.querySelector('#bill-panel'))) {
            setTimeout(function () {
                const billPanel = document.getElementById('bill-panel');
                if (billPanel) {
                    htmx.process(billPanel);

                    if (isKioskMode()) {
                        setTimeout(() => {
                            updateCustomerDisplay([], 0);
                        }, 100);
                    }
                }
            }, 100);
        }
    });

    {% comment %}
    htmx:afterSettle - Re-process setelah animasi selesai
    {% endcomment %}
    document.addEventListener('htmx:afterSettle', function (event) {
        const target = event.detail.target;
        if (target && target.id === 'bill-panel') {
            htmx.process(target);

            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                htmx.process(modalContainer);
            }

            if (isKioskMode()) {
                setTimeout(() => {
                    updateCustomerDisplay([], 0);
                }, 50);
            }
        }
    });

    {% comment %}
    htmx:afterRequest - Handle hold bill completion
    Jika hold bill berhasil, tutup modal dan reload halaman.
    {% endcomment %}
    document.addEventListener('htmx:afterRequest', function(event) {
        const url = event.detail.pathInfo.requestPath;

        if (url && url.includes('/hold/') && event.detail.successful) {

            {# Tutup modal #}
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                modalContainer.innerHTML = '';
            }

            {# Reload halaman untuk refresh product grid #}
            setTimeout(function() {
                window.location.reload(true);
            }, 300);
        }
    });
</script>
