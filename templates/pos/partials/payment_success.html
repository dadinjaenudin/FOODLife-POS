{% load humanize %}

<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-md p-8 text-center">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        
        <h2 class="text-2xl font-bold text-green-600 mb-2">Payment Successful!</h2>
        <p class="text-gray-500 mb-4">{{ bill.bill_number }}</p>
        
        {% if split_payment %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="text-sm text-blue-700 font-semibold">
                ðŸ’³ Split Payment ({{ payment_count }} methods)
            </div>
        </div>
        {% endif %}
        
        <div class="text-3xl font-bold mb-6">Rp {{ bill.total|floatformat:0|intcomma }}</div>
        
        {% if bill.queue_number %}
        <div class="bg-blue-100 rounded-lg p-4 mb-6">
            <div class="text-sm text-blue-600">Queue Number</div>
            <div class="text-4xl font-bold text-blue-700">{{ bill.queue_number }}</div>
        </div>
        {% endif %}
        
        <div class="flex gap-3">
            <button 
                class="flex-1 py-3 rounded-lg border border-gray-300 font-medium hover:bg-gray-50"
                onclick="printReceipt({{ bill.id }})">
                Reprint
            </button>
            <button 
                class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700"
                onclick="console.log('âœ… Done button clicked - clearing modal');
                    document.getElementById('modal-container').innerHTML = ''; 
                    // Clear modal on customer display
                    if (typeof sendModalToCustomerDisplay === 'function') {
                        sendModalToCustomerDisplay();
                        console.log('ðŸ§¹ Sent clear modal to customer display');
                    }
                    // Clear customer display bill panel
                    if (typeof updateCustomerDisplay === 'function') {
                        updateCustomerDisplay([], 0, 0, 'cash', true);
                    }
                    // Refresh product grid to show No Active Bill
                    htmx.ajax('GET', '{% url 'pos:products' %}?category=all', {target: '#product-grid', swap: 'innerHTML'});
                    setTimeout(() => { window.location.reload(true); }, 300);">
                Done
            </button>
        </div>
    </div>
</div>

<script>
// Auto print receipt on success - Open in new window immediately
(function() {
    console.log('Payment success modal loaded, opening print preview...');
    const billId = {{ bill.id }};
    const printUrl = `/pos/bill/${billId}/print-preview/`;
    const printWindow = window.open(printUrl, 'PrintReceipt', 'width=400,height=600,menubar=no,toolbar=no,location=no');
    
    if (!printWindow) {
        showToast('Print preview blocked by popup blocker. Please allow popups for this site.', 'warning');
    }

    // Dispatch payment complete event for listeners (printer, customer display)
    document.body.dispatchEvent(new CustomEvent('paymentComplete', { 
        detail: { billId: billId } 
    }));
    console.log('ðŸŽ‰ Payment complete event dispatched');
    
    // Clear modal on customer display (success modal only shows on main display)
    setTimeout(() => {
        if (typeof sendModalToCustomerDisplay === 'function') {
            console.log('ðŸ§¹ Clearing modal from customer display after payment');
            // Temporarily clear modal-container to trigger clear on customer display
            const modalContent = document.getElementById('modal-container').innerHTML;
            document.getElementById('modal-container').innerHTML = '';
            sendModalToCustomerDisplay();
            // Restore modal for main display
            setTimeout(() => {
                document.getElementById('modal-container').innerHTML = modalContent;
            }, 100);
        }
        
        // Clear customer display bill panel (show waiting state)
        if (typeof updateCustomerDisplay === 'function') {
            console.log('ðŸ§¹ Clearing customer display bill panel');
            updateCustomerDisplay([], 0, 0, 'cash', true);
        }
    }, 500);
})();

function printReceipt(billId) {
    const printUrl = `/pos/bill/${billId}/print-preview/`;
    const printWindow = window.open(printUrl, 'PrintReceipt', 'width=400,height=600,menubar=no,toolbar=no,location=no');
    
    if (!printWindow) {
        showToast('Print preview blocked by popup blocker. Please allow popups for this site.', 'warning');
    }
}

function closeModal() {
    document.getElementById('modal-container').innerHTML = '';
}
</script>
