{% load humanize %}

<div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg w-full max-w-md p-8 text-center">
        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
        </div>
        
        <h2 class="text-2xl font-bold text-green-600 mb-2">Payment Successful!</h2>
        <p class="text-gray-500 mb-4">{{ bill.bill_number }}</p>
        
        {% if split_payment %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4">
            <div class="text-sm text-blue-700 font-semibold">
                ðŸ’³ Split Payment ({{ payment_count }} methods)
            </div>
        </div>
        {% endif %}
        
        <div class="text-3xl font-bold mb-6">Rp {{ bill.total|floatformat:0|intcomma }}</div>
        
        {% if bill.queue_number %}
        <div class="bg-blue-100 rounded-lg p-4 mb-6">
            <div class="text-sm text-blue-600">Queue Number</div>
            <div class="text-4xl font-bold text-blue-700">{{ bill.queue_number }}</div>
        </div>
        {% endif %}
        
        <div class="flex gap-3">
            <button 
                class="flex-1 py-3 rounded-lg border border-gray-300 font-medium hover:bg-gray-50"
                onclick="printReceipt({{ bill.id }})">
                Reprint
            </button>
            <button
                class="flex-1 py-3 rounded-lg bg-blue-600 text-white font-bold hover:bg-blue-700"
                onclick="closeDone()">
                Done
            </button>
        </div>
    </div>
</div>

<script>
// Auto print receipt on success - Open in new window immediately
(function() {
    console.log('Payment success modal loaded, opening print preview...');
    const billId = {{ bill.id }};
    const printUrl = `/pos/bill/${billId}/print-preview/`;
    const printWindow = window.open(printUrl, 'PrintReceipt', 'width=400,height=600,menubar=no,toolbar=no,location=no');

    if (!printWindow) {
        showToast('Print preview blocked by popup blocker. Please allow popups for this site.', 'warning');
    }

    // Dispatch payment complete event for listeners (printer, customer display)
    document.body.dispatchEvent(new CustomEvent('paymentComplete', {
        detail: { billId: billId }
    }));
    console.log('Payment complete event dispatched');

    // Send payment success modal to customer display
    setTimeout(() => {
        if (typeof isKioskMode === 'function' && isKioskMode()) {
            const LOCAL_API = 'http://127.0.0.1:5000';

            // Build a clean success HTML for customer display (no buttons)
            const successHtml = `
                <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:50;">
                    <div style="background:white;border-radius:12px;max-width:420px;width:100%;padding:3rem;text-align:center;">
                        <div style="width:80px;height:80px;background:#dcfce7;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 1.5rem;">
                            <svg width="40" height="40" fill="none" stroke="#16a34a" viewBox="0 0 24 24" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <h2 style="font-size:1.75rem;font-weight:bold;color:#16a34a;margin-bottom:0.5rem;">Pembayaran Berhasil!</h2>
                        <p style="color:#6b7280;margin-bottom:1rem;">{{ bill.bill_number }}</p>
                        <div style="font-size:2.25rem;font-weight:bold;color:#111827;margin-bottom:1.5rem;">Rp {{ bill.total|floatformat:0|intcomma }}</div>
                        {% if bill.queue_number %}
                        <div style="background:#dbeafe;border-radius:12px;padding:1.5rem;margin-bottom:1rem;">
                            <div style="font-size:0.875rem;color:#2563eb;">Nomor Antrian</div>
                            <div style="font-size:3rem;font-weight:bold;color:#1d4ed8;">{{ bill.queue_number }}</div>
                        </div>
                        {% endif %}
                        <p style="color:#9ca3af;font-size:0.875rem;">Terima kasih atas kunjungan Anda!</p>
                    </div>
                </div>`;

            console.log('Sending payment success to customer display');
            fetch(LOCAL_API + '/api/customer-display/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ show_modal: true, modal_html: successHtml })
            }).catch(err => console.warn('Customer display update failed:', err.message));

            // Clear customer display after 8 seconds (show waiting state)
            setTimeout(() => {
                console.log('Clearing customer display after payment success');
                fetch(LOCAL_API + '/api/customer-display/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ show_modal: false, modal_html: null })
                }).catch(() => {});
                if (typeof updateCustomerDisplay === 'function') {
                    updateCustomerDisplay([], 0, 0, 'cash', true);
                }
            }, 8000);
        }
    }, 300);
})();

// Clear payment modal active flag so other modals can work
window._paymentModalActive = false;

function printReceipt(billId) {
    const printUrl = `/pos/bill/${billId}/print-preview/`;
    const printWindow = window.open(printUrl, 'PrintReceipt', 'width=400,height=600,menubar=no,toolbar=no,location=no');

    if (!printWindow) {
        showToast('Print preview blocked by popup blocker. Please allow popups for this site.', 'warning');
    }
}

function closeDone() {
    console.log('Done button clicked - clearing modal');
    document.getElementById('modal-container').innerHTML = '';
    window._paymentModalActive = false;

    // Clear modal on customer display
    if (typeof isKioskMode === 'function' && isKioskMode()) {
        fetch('http://127.0.0.1:5000/api/customer-display/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ show_modal: false, modal_html: null })
        }).catch(() => {});
        if (typeof updateCustomerDisplay === 'function') {
            updateCustomerDisplay([], 0, 0, 'cash', true);
        }
    }

    // Refresh page
    htmx.ajax('GET', '{% url "pos:products" %}?category=all', {target: '#product-grid', swap: 'innerHTML'});
    setTimeout(() => { window.location.reload(true); }, 300);
}

function closeModal() {
    document.getElementById('modal-container').innerHTML = '';
    window._paymentModalActive = false;
}
</script>
