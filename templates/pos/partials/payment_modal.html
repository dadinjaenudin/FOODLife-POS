{% load humanize %}
<!--
============================================================================
PAYMENT MODAL (payment_modal.html) — v12
============================================================================
Modal pembayaran utama di POS. Dipanggil saat kasir klik tombol "Payment"
(F2) pada bill yang aktif.

DIPANGGIL DARI:
  - Bill panel: tombol "Payment" → HTMX GET {% url 'pos:payment_modal' bill.id %}
  - Keyboard shortcut F2 (keyboard_shortcuts.html)
  - Inject ke #modal-container via hx-target="#modal-container" hx-swap="innerHTML"

ARSITEKTUR: Django Template + Alpine.js + HTMX
===============================================
File ini adalah Django template yang di-render server-side, lalu di-inject
ke halaman POS via HTMX. Setelah inject, Alpine.js mengelola semua state
dan interaksi di client-side (tanpa reload).

SERVER → CLIENT DATA FLOW:
┌─────────────────────────────────────────────────────────┐
│  Django View: payment_modal() (apps/pos/views.py)       │
│  - Load PaymentMethodProfile dari terminal.payment_profiles │
│  - Prefetch DataEntryPrompt per profil                  │
│  - Serialize ke payment_methods_json (array of objects)  │
│  - Load EFTTerminal master data                         │
│  - Render template ini dengan context:                  │
│    • bill, total_int, payment_methods_json               │
│    • payment_methods_list (untuk server-side rendering)   │
│    • use_profiles (bool), default_method                 │
│    • eft_terminals (master data dropdown)                │
└──────────┬──────────────────────────────────────────────┘
           │ HTML response (HTMX swap ke #modal-container)
           ▼
┌─────────────────────────────────────────────────────────┐
│  Browser: Alpine.js component paymentModal()            │
│  - Parse payment_methods_json → array of payment methods │
│  - Manage state: amount, method, payments[], promptValues │
│  - Numpad routing: amount field ↔ prompt fields          │
│  - QRIS: generate QR, poll status, auto-submit on paid  │
│  - syncDisplay() → kirim clone ke customer display (SSE) │
└──────────┬──────────────────────────────────────────────┘
           │ Form submit via HTMX POST (manual atau QRIS auto-submit)
           ▼
┌─────────────────────────────────────────────────────────┐
│  Django View: process_payment() (apps/pos/views.py)     │
│  - Baca: method, amount, reference, profile_id,          │
│    prompt_data, payments[] (split)                       │
│  - Buat Payment record(s) di database                   │
│  - Update Bill status → paid                            │
│  - Return: payment_success.html (inject ke modal)        │
└─────────────────────────────────────────────────────────┘

LAYOUT VISUAL:
┌────────────────────────────────────────────────────┐
│  Header: "Payment" + Bill Number + Table           │
├────────────────────────────────────────────────────┤
│  Summary Cards:  [Total]  [Bayar]  [Kembalian/Sisa]│
├────────────────────────────────────────────────────┤
│  Applied Payments (jika split): Cash 50K  Card 50K │
├──────────────┬─────────────────────────────────────┤
│  LEFT (30%)  │  RIGHT (70%)                        │
│              │                                     │
│  Metode:     │  [Rp ____________] Amount Input     │
│  ○ Cash      │                                     │
│  ● Card  ←── │  [Account No: ____]  ← Prompt       │
│  ○ QRIS      │  [EFT No: ▾ BCA ]  ← Dropdown      │
│  ○ DANA      │  [Approval: _____]  ← Prompt        │
│  ○ Voucher   │                                     │
│              │  ┌─────────────────────────────┐    │
│              │  │  QRIS QR CODE OVERLAY       │    │
│              │  │  (replaces numpad when       │    │
│              │  │   QRIS is active)            │    │
│              │  │  ┌───────────────┐           │    │
│              │  │  │   QR IMAGE    │           │    │
│              │  │  │   (base64)    │           │    │
│              │  │  └───────────────┘           │    │
│              │  │  [Cancel] [Simulate]         │    │
│              │  └─────────────────────────────┘    │
│              │                                     │
│              │  [Numpad] (hidden saat QRIS aktif)  │
│              │  [Ext│50K│100│Rnd]  Quick Amount    │
├──────────────┴─────────────────────────────────────┤
│  [Cancel]  [+ Split]  [====== Bayar Rp XXX ======] │
│  (Cancel disabled saat QRIS polling/paid)          │
│  (Bayar shows "Menunggu QRIS..." saat polling)     │
└────────────────────────────────────────────────────┘

KONSEP UTAMA:
=============

1. DYNAMIC PAYMENT PROFILES (use_profiles=true)
   Metode pembayaran dikonfigurasi dari backoffice (PaymentMethodProfile model).
   Setiap profil bisa punya "Data Entry Prompts" — field input tambahan
   seperti account_no, eft_no, approval_code, qrcontent.

   Contoh: Credit Card punya 3 prompts:
   - account_no (6 digit, numeric)
   - eft_no (dropdown dari EFTTerminal master data)
   - approval_code (4-6 digit, numeric)

   Contoh: QRIS BCA CPM punya 2 prompts:
   - amount (field_type=amount)
   - qrcontent (field_type=scanner, use_scanner=true) → trigger QR generate button

   Jika terminal belum dikonfigurasi profil → fallback ke mode legacy
   (hardcoded methods tanpa dynamic prompts).

2. NUMPAD ROUTING
   Numpad on-screen bisa memasukkan angka ke 2 target berbeda:
   - Amount field (default) → untuk input nominal pembayaran
   - Prompt field (jika diklik) → untuk input data seperti approval code

   State `activeField` menentukan target:
   - 'amount' → numpad input ke amount
   - 'prompt:account_no' → numpad input ke field account_no
   - 'prompt:approval_code' → numpad input ke field approval_code

   Visual indicator hijau muncul saat numpad diarahkan ke prompt field.
   Tombol "← Amount" untuk kembali ke mode amount.

3. SPLIT PAYMENT
   Kasir bisa membagi pembayaran ke beberapa metode:
   - Klik "+ Split" untuk menambahkan pembayaran parsial ke list
   - Setiap split punya: method, amount, reference, profile_id, prompt_data
   - Sisa (remaining) otomatis dihitung
   - "Bayar" hanya aktif jika total payments >= total bill

   Contoh: Bill Rp 200.000
   → Cash Rp 100.000 (klik + Split)
   → Card Rp 100.000 (klik Bayar)

4. CUSTOMER DISPLAY SYNC
   Setiap perubahan state (ketik angka, ganti metode, tambah split)
   otomatis di-sync ke layar customer via:
   syncDisplay() → 400ms debounce → sendModalToCustomerDisplay()
   → Clone modal → Fix URL → Kirim ke Flask API → SSE → Customer Display

5. ALPINE.JS + HTMX INITIALIZATION TRICK
   Modal ini menggunakan x-ignore pada element utama agar Alpine.js
   TIDAK auto-initialize saat HTMX inject HTML. Kemudian script di bawah
   melakukan clone+replace tanpa x-ignore, sehingga Alpine init secara
   natural. Ini menghindari bug "initTree" pada Alpine.js saat dipakai
   dengan HTMX swap.

6. FORM SUBMISSION
   Form dikirim via HTMX POST ke process_payment endpoint.
   Hidden inputs berisi semua data yang diperlukan:
   - method, amount, reference (pembayaran saat ini)
   - profile_id, prompt_data (untuk dynamic profiles)
   - payments[0..N][method/amount/reference/profile_id/prompt_data] (split)

   Dua cara submit:
   a) Manual: kasir klik tombol "Bayar" → submitPayment() → canPay check → form.requestSubmit()
   b) QRIS auto-submit: setelah QRIS confirmed paid → 800ms delay → form.requestSubmit()
      (bypass canPay, karena QRIS sudah terbayar dan HARUS diproses)

7. QRIS PAYMENT INTEGRATION
   Untuk metode pembayaran dengan prompt field_type='scanner' (misal QRIS BCA CPM),
   tombol "Generate QR" muncul di samping input field.

   Flow QRIS:
   a) Kasir masukkan nominal → klik "Generate QR"
   b) Frontend POST ke /pos/bill/{id}/qris/create/ → backend buat QRISTransaction
      + generate QR image (base64 PNG via library qrcode)
   c) QR code tampil di modal (menggantikan numpad area)
   d) Frontend polling setiap 3 detik ke /pos/bill/{id}/qris/{txn_id}/status/
   e) Customer scan QR → gateway update status ke 'paid'
   f) Polling detect 'paid' → isi qrcontent field → show success → auto-submit form

   State Machine (qrisState):
     idle → generating → polling → paid → idle (auto-submit)
                                  → error (expired/cancelled/failed)

   Safety Rules:
   - Tombol "Bayar" DISABLED saat qrisState='polling'/'generating'
   - Tombol "Cancel" DISABLED saat qrisState='polling'/'paid'
   - Auto-submit BYPASS canPay (QRIS terbayar = HARUS diproses)
   - Ganti metode → auto-cancel QRIS pending
   - Tutup modal → auto-cancel QRIS + hide customer display QR

   Gateway Abstraction (apps/pos/payment_gateway.py):
   - MockQRISGateway: development (simulate payment via button)
   - Production: Midtrans/Xendit (setting PAYMENT_GATEWAY di Django settings)
   - Lihat markdown/QRIS_PAYMENT_INTEGRATION.md untuk panduan production

CONTEXT VARIABLES (dari Django view):
=====================================
- bill                  : Object Bill aktif (id, bill_number, table, total)
- total_int             : Integer total bill (tanpa desimal)
- payment_methods_json  : JSON array metode pembayaran, contoh:
                          [{"id":"cash","label":"Cash","color":"#16a34a",
                            "profile_id":"uuid","method_id":"cash",
                            "allow_change":true,"prompts":[...]}]
- payment_methods_list  : QuerySet/list objek untuk server-side rendering
                          (setiap objek punya: id, label, color, prompts[], ref, refPlaceholder)
- use_profiles          : Boolean — true jika terminal punya payment profiles
- default_method        : String ID metode default (biasanya 'cash')
- eft_terminals         : QuerySet EFTTerminal untuk dropdown eft_no

ALPINE.JS STATE (paymentModal()):
==================================
- method          : String ID metode terpilih (misal 'cash', 'credit_card')
- amount          : Integer nominal input (misal 50000)
- amountDisplay   : String formatted (misal '50,000')
- reference       : String referensi legacy (non-profile mode)
- promptValues    : Object {field_name: value} untuk dynamic prompts
                    Contoh: {account_no: '123456', eft_no: '01', approval_code: 'ABC'}
- payments[]      : Array split payments yang sudah di-add
- activeField     : String target numpad ('amount' atau 'prompt:field_name')
- total           : Integer total bill (read-only)

QRIS STATE:
- qrisState         : 'idle' | 'generating' | 'polling' | 'paid' | 'error'
- qrisTransactionId : String ID transaksi QRIS dari gateway
- qrisQrImage       : String base64 data URL QR code PNG
- qrisFieldName     : String nama prompt field untuk auto-fill (biasanya 'qrcontent')
- qrisError         : String pesan error
- qrisAmount        : Integer nominal QRIS transaction
- _qrisTimer        : Handle setInterval untuk polling (3 detik)

COMPUTED PROPERTIES:
- selectedMethod    → Object metode terpilih dari paymentMethods array
- currentProfileId  → UUID profile_id (untuk hidden input)
- currentMethodId   → String method_id legacy (cash/card/qris/dll)
- currentAllowChange→ Boolean apakah metode ini boleh kembalian
- promptDataJson    → JSON string dari promptValues (untuk hidden input)
- paidTotal         → Sum semua payments[].amount
- remaining         → total - paidTotal (minimum 0)
- changeAmount      → Kembalian (hanya jika allow_change dan bayar > total)
- canPay            → Boolean apakah tombol "Bayar" aktif
                      (return false jika qrisState='polling'/'generating')

QRIS METHODS:
- generateQR(fieldName)   → POST /qris/create/, show QR, start polling
- _startQRISPolling()     → Poll GET /qris/{txn}/status/ setiap 3 detik
- _stopQRISPolling()      → clearInterval polling timer
- _hideCustomerQR()       → POST ke Flask API untuk hide QR di customer display
- cancelQRIS()            → POST /qris/{txn}/cancel/, reset semua QRIS state
- simulateQRIS()          → POST /qris/{txn}/simulate-modal/ (DEV ONLY)

QRIS API ENDPOINTS:
- POST /pos/bill/{id}/qris/create/           → Buat transaksi, return QR image
- GET  /pos/bill/{id}/qris/{txn}/status/     → Cek status (polling)
- POST /pos/bill/{id}/qris/{txn}/cancel/     → Batalkan transaksi
- POST /pos/bill/{id}/qris/{txn}/simulate-modal/ → Simulate paid (DEV ONLY)

FILE TERKAIT:
- apps/pos/views.py → payment_modal(), process_payment(), qris_create/status/cancel
- apps/pos/payment_gateway.py → PaymentGateway ABC, MockQRISGateway, get_payment_gateway()
- apps/pos/models.py → Payment, QRISTransaction
- apps/core/models.py → PaymentMethodProfile, DataEntryPrompt, EFTTerminal
- templates/pos/partials/payment_success.html → Halaman sukses setelah bayar
- templates/pos/partials/main/js/launcher_integration.html → sendModalToCustomerDisplay()
- pos_launcher_qt/local_api.py → Flask API customer display QR (/api/customer-display/qr)
- markdown/QRIS_PAYMENT_INTEGRATION.md → Dokumentasi lengkap QRIS + panduan production
============================================================================
-->

<!--
PENTING: Script paymentModal() harus di-define SEBELUM HTML-nya.
Karena HTMX menjalankan <script> setelah DOM insert, Alpine.js butuh
function ini sudah ada saat x-data="paymentModal()" di-evaluate.
-->
<script>
/**
 * paymentModal() — Alpine.js component untuk seluruh payment modal.
 *
 * CATATAN: Menggunakan `var` dan `function(){}` (bukan arrow function)
 * agar kompatibel dengan Alpine.js proxy + touch device.
 */
function paymentModal() {
    // ===== DATA DARI SERVER (Django template tags) =====
    // payment_methods_json berisi array of objects, contoh:
    // [{id:"cash", label:"Cash", color:"#16a34a", profile_id:"uuid-xxx",
    //   method_id:"cash", allow_change:true, prompts:[{field_name:"...", label:"..."}]}]
    var _paymentMethods = [];
    try { _paymentMethods = {{ payment_methods_json|safe }}; } catch(e) {}
    var _useProfiles = {{ use_profiles|yesno:"true,false" }};  // true jika terminal punya payment profiles
    var _defaultMethod = '{{ default_method|escapejs }}' || 'cash';  // metode default saat modal dibuka
    var _billId = '{{ bill.id }}';
    var _csrfToken = '{{ csrf_token }}';

    return {
        // ===== REACTIVE STATE =====
        useProfiles: _useProfiles,        // Mode profil dinamis atau legacy
        paymentMethods: _paymentMethods,  // Array semua metode pembayaran
        method: _defaultMethod,           // ID metode terpilih saat ini
        amount: 0,                        // Nominal input (integer, tanpa format)
        amountDisplay: '',                // Nominal terformat untuk display ('50,000')
        reference: '',                    // Referensi legacy (hanya non-profile mode)
        promptValues: {},                 // Data entry prompts: {field_name: value}
        total: parseInt('{{ total_int|escapejs }}') || 0,  // Total bill (read-only)
        payments: [],                     // Array split payments yang sudah di-add
        activeField: 'amount',            // Target numpad: 'amount' atau 'prompt:field_name'
        _syncTimer: null,                 // Debounce timer untuk syncDisplay()

        // ===== QRIS STATE =====
        // QRIS payment flow: kasir generate QR → customer scan → polling detect paid → auto-submit
        // State machine: idle → generating → polling → paid → idle (form auto-submit)
        //                                             → error (expired/cancelled/failed)
        // Lihat: markdown/QRIS_PAYMENT_INTEGRATION.md untuk dokumentasi lengkap
        // Gateway: apps/pos/payment_gateway.py (MockQRISGateway dev, production via settings)
        qrisState: 'idle',               // idle | generating | polling | paid | error
        qrisTransactionId: '',           // QRIS transaction ID dari gateway (misal 'MOCK-A1B2C3D4E5F6')
        qrisQrImage: '',                 // Base64 QR code image (data:image/png;base64,...)
        qrisFieldName: '',               // Nama prompt field untuk auto-fill saat paid (biasanya 'qrcontent')
        qrisError: '',                   // Pesan error untuk ditampilkan di UI
        qrisAmount: 0,                   // Nominal yang dipakai untuk QRIS transaction
        _qrisTimer: null,                // setInterval handle untuk polling (3 detik)

        // ===== COMPUTED PROPERTIES =====

        /** Object metode pembayaran yang sedang dipilih */
        get selectedMethod() {
            return this.paymentMethods.find(m => m.id === this.method) || null;
        },

        /** UUID payment profile (untuk hidden input form) */
        get currentProfileId() {
            var sm = this.selectedMethod;
            return (sm && sm.profile_id) ? sm.profile_id : '';
        },

        /** Legacy method ID: 'cash'/'card'/'qris'/dll (untuk backward compat) */
        get currentMethodId() {
            var sm = this.selectedMethod;
            return (sm && sm.method_id) ? sm.method_id : this.method;
        },

        /** Apakah metode ini boleh kasih kembalian (true untuk cash) */
        get currentAllowChange() {
            var sm = this.selectedMethod;
            return sm ? (sm.allow_change !== false) : true;
        },

        /** JSON string dari promptValues untuk dikirim ke server via hidden input */
        get promptDataJson() {
            if (!this.useProfiles) return '';
            var vals = this.promptValues;
            var hasAny = false;
            for (var k in vals) { if (vals[k]) { hasAny = true; break; } }
            return hasAny ? JSON.stringify(vals) : '';
        },

        /** Total semua split payments yang sudah di-add */
        get paidTotal() {
            var sum = 0;
            for (var i = 0; i < this.payments.length; i++) sum += this.payments[i].amount;
            return sum;
        },

        /** Sisa yang harus dibayar (total - sudah dibayar) */
        get remaining() {
            var r = this.total - this.paidTotal;
            return r > 0 ? r : 0;
        },

        /** Angka "Bayar" yang ditampilkan di summary card */
        get displayPaying() {
            return this.payments.length > 0 ? this.paidTotal : this.amount;
        },

        /**
         * Kembalian — hanya muncul jika:
         * - Single payment: amount > total DAN metode allow_change
         * - Split payment: paidTotal > total DAN payment terakhir allow_change
         * Non-cash (allow_change=false) TIDAK boleh bayar lebih dari sisa
         */
        get changeAmount() {
            if (this.payments.length === 0 && this.currentAllowChange && this.amount > this.total) {
                return this.amount - this.total;
            }
            if (this.payments.length > 0 && this.paidTotal > this.total) {
                var lastPmt = this.payments[this.payments.length - 1];
                var lastMethod = this.paymentMethods.find(function(m) { return m.id === lastPmt.method; });
                if (lastMethod && lastMethod.allow_change !== false) return this.paidTotal - this.total;
            }
            return 0;
        },

        /**
         * HTML untuk menampilkan list split payments yang sudah di-add.
         * Menggunakan x-html (bukan x-for) untuk menghindari bug Alpine.js initTree
         * saat dipakai dengan HTMX swap.
         */
        get paymentsListHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                h += '<div class="flex items-center gap-1.5 bg-white border rounded-lg px-2 py-1">';
                h += '<div class="w-2 h-2 rounded-full flex-shrink-0" style="background:' + this.getMethodColor(p.method) + '"></div>';
                h += '<span class="text-[11px] font-bold text-gray-700">' + this.getMethodLabel(p.method) + '</span>';
                h += '<span class="text-[11px] font-bold text-green-600">Rp ' + this.fmt(p.amount) + '</span>';
                h += '<button type="button" data-rm="' + i + '" class="w-4 h-4 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded">';
                h += '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                h += '</button></div>';
            }
            return h;
        },

        /**
         * Hidden inputs untuk split payments — dikirim ke server saat form submit.
         * Format: payments[0][method], payments[0][amount], payments[0][reference], dll.
         * Server-side process_payment() membaca array ini untuk membuat Payment records.
         */
        get paymentsHiddenHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                var mid = (p.method_id || p.method || '').replace(/"/g, '&quot;');
                var ref = (p.reference || '').replace(/"/g, '&quot;');
                var pid = (p.profile_id || '').replace(/"/g, '&quot;');
                var pd = (p.prompt_data || '').replace(/"/g, '&quot;');
                h += '<input type="hidden" name="payments[' + i + '][method]" value="' + mid + '">';
                h += '<input type="hidden" name="payments[' + i + '][amount]" value="' + p.amount + '">';
                h += '<input type="hidden" name="payments[' + i + '][reference]" value="' + ref + '">';
                h += '<input type="hidden" name="payments[' + i + '][profile_id]" value="' + pid + '">';
                h += '<input type="hidden" name="payments[' + i + '][prompt_data]" value="' + pd + '">';
            }
            return h;
        },

        /**
         * Validasi: tombol "Bayar" aktif jika:
         * - Single payment: amount >= total DAN amount > 0
         * - Split payment: total semua payments >= total bill
         * - QRIS sedang polling/generating → DISABLE (harus tunggu konfirmasi)
         *
         * CATATAN QRIS: Saat QRIS polling, canPay return false agar kasir
         * tidak bisa klik "Bayar" manual. Setelah QRIS confirmed paid,
         * auto-submit BYPASS canPay via form.requestSubmit() langsung.
         * Ini mencegah skenario bahaya: uang masuk tapi transaksi tidak tercatat.
         */
        get canPay() {
            // Block manual pay while QRIS is in progress — payment will auto-submit on confirmation
            if (this.qrisState === 'polling' || this.qrisState === 'generating') return false;
            if (this.payments.length === 0) return this.amount >= this.total && this.amount > 0;
            return this.paidTotal >= this.total;
        },

        // ===== METHODS =====

        /** Format angka ke string dengan separator ribuan: 50000 → '50,000' */
        fmt(n) {
            if (!n && n !== 0) return '0';
            return Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        },

        /** Cari label metode berdasarkan ID (untuk display di split payments list) */
        getMethodLabel(id) {
            var m = this.paymentMethods.find(function(pm) { return pm.id === id; });
            return m ? m.label : id;
        },

        /** Cari warna metode berdasarkan ID (untuk color dot di split payments list) */
        getMethodColor(id) {
            var m = this.paymentMethods.find(function(pm) { return pm.id === id; });
            return m ? m.color : '#6b7280';
        },

        /** Handler saat user ketik langsung di input amount (bukan numpad) */
        onInput(val) {
            var clean = val.replace(/\D/g, '');
            this.amount = clean ? parseInt(clean) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
            this.syncDisplay();
        },

        /**
         * Handler numpad (0-9, 00, 000, DEL, C).
         * Routing berdasarkan activeField:
         * - 'prompt:xxx' → append/delete ke promptValues[xxx]
         * - 'amount' (default) → append/delete ke amount
         */
        numpad(key) {
            // Route numpad ke prompt field jika activeField = 'prompt:xxx'
            if (this.activeField && this.activeField.startsWith('prompt:')) {
                var fieldName = this.activeField.substring(7);  // 'prompt:account_no' → 'account_no'
                var val = this.promptValues[fieldName] || '';
                if (key === 'C') val = '';
                else if (key === 'DEL') val = val.slice(0, -1);
                else val = val + key;
                this.promptValues[fieldName] = val;
                this.syncDisplay();
                return;
            }
            // Default: numpad ke amount field
            var raw = this.amount.toString();
            if (key === 'C') raw = '';
            else if (key === 'DEL') raw = raw.slice(0, -1);
            else raw = raw + key;
            this.amount = raw ? parseInt(raw) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
            this.syncDisplay();
        },

        /** Set amount langsung (dari quick amount buttons: Exact, 50K, 100K, Round) */
        setAmount(val) {
            this.activeField = 'amount';
            this.amount = val;
            this.amountDisplay = this.fmt(val);
            this.syncDisplay();
        },

        /** Ganti metode pembayaran — reset semua input prompt dan kembali ke amount */
        setMethod(id) {
            // Cancel any pending QRIS when switching methods
            if (this.qrisState !== 'idle') this.cancelQRIS();
            this.method = id;
            this.reference = '';
            this.promptValues = {};
            this.activeField = 'amount';
            this.syncDisplay();
        },

        /** Set activeField saat user klik/focus prompt field */
        focusField(fieldName) {
            this.activeField = fieldName;
        },

        /**
         * Sync state ke customer display (debounce 400ms).
         * Memanggil sendModalToCustomerDisplay() di launcher_integration.html
         * yang akan clone modal → fix URL → kirim via SSE ke layar customer.
         */
        syncDisplay() {
            if (this._syncTimer) clearTimeout(this._syncTimer);
            this._syncTimer = setTimeout(function() {
                if (typeof sendModalToCustomerDisplay === 'function') sendModalToCustomerDisplay();
            }, 400);
        },

        /** Focus ke input field barcode scanner (untuk prompt dengan use_scanner=true) */
        activateScanner(fieldName) {
            var self = this;
            this.$nextTick(function() {
                var input = self.$el.querySelector('[data-prompt-field="' + fieldName + '"]');
                if (input) input.focus();
            });
        },

        // ===== QRIS METHODS =====
        // Flow: generateQR() → _startQRISPolling() → [paid] → auto-submit form
        // Semua API endpoint: /pos/bill/{id}/qris/...
        // Gateway abstraction: apps/pos/payment_gateway.py

        /**
         * Generate QRIS QR code untuk pembayaran.
         *
         * Flow:
         * 1. Validasi amount > 0
         * 2. POST /pos/bill/{id}/qris/create/ → server buat QRISTransaction + generate QR image
         * 3. Response berisi: transaction_id, qr_string, qr_image (base64 PNG)
         * 4. Tampilkan QR di modal (menggantikan numpad area)
         * 5. Kirim QR ke customer display via local Flask API (opsional, non-blocking)
         * 6. Start polling status setiap 3 detik
         *
         * Server-side (qris_create view):
         * - Cancel existing pending QRIS untuk bill ini
         * - Panggil gateway.create_qris_transaction() → INSERT QRISTransaction
         * - Generate QR image via library qrcode (base64 PNG)
         *
         * @param {string} fieldName - nama prompt field untuk auto-fill saat paid (biasanya 'qrcontent')
         */
        generateQR(fieldName) {
            var amount = this.amount;
            if (!amount || amount <= 0) {
                this.qrisError = 'Masukkan nominal terlebih dahulu';
                this.qrisState = 'error';
                console.warn('[QRIS] Generate failed: amount is 0 or empty');
                return;
            }

            this.qrisState = 'generating';
            this.qrisError = '';
            this.qrisFieldName = fieldName;
            this.qrisAmount = amount;
            this._qrisCreateTime = Date.now();   // Track kapan QR di-generate
            this._qrisPollCount = 0;             // Counter polling
            this._qrisPollErrors = 0;            // Counter polling errors

            var self = this;
            var t0 = Date.now();
            console.log('[QRIS] Creating transaction — bill:', _billId, 'amount:', amount, 'field:', fieldName, 'time:', new Date().toISOString());

            fetch('/pos/bill/' + _billId + '/qris/create/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': _csrfToken,
                },
                body: 'amount=' + amount
            })
            .then(function(r) {
                var responseTime = Date.now() - t0;
                console.log('[QRIS] Create response — status:', r.status, 'time:', responseTime + 'ms');
                if (!r.ok) {
                    console.error('[QRIS] Create HTTP error — status:', r.status, r.statusText);
                }
                return r.json();
            })
            .then(function(data) {
                var totalTime = Date.now() - t0;
                if (!data.success) {
                    self.qrisState = 'error';
                    self.qrisError = data.error || 'Gagal membuat QRIS';
                    console.error('[QRIS] Create failed —', data.error, 'response_time:', totalTime + 'ms');
                    return;
                }

                self.qrisTransactionId = data.transaction_id;
                console.log('[QRIS] Transaction created —',
                    'txn_id:', data.transaction_id,
                    'amount:', data.amount,
                    'expires_at:', data.expires_at,
                    'has_qr_image:', !!data.qr_image,
                    'response_time:', totalTime + 'ms'
                );

                // Use QR image from server response (generated by qrcode library)
                if (data.qr_image) {
                    self.qrisQrImage = data.qr_image;
                } else {
                    console.warn('[QRIS] No QR image in response — qrcode library mungkin error di server');
                }

                // Also show QR on customer display via local API (non-blocking, may fail if not running)
                fetch('http://127.0.0.1:5000/api/customer-display/qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        qr_data: data.qr_string,
                        total: amount,
                        payment_method: 'QRIS'
                    })
                }).catch(function() {});

                // Start polling
                self.qrisState = 'polling';
                console.log('[QRIS] Polling started — interval: 3000ms, txn_id:', data.transaction_id);
                self._startQRISPolling();
            })
            .catch(function(err) {
                var totalTime = Date.now() - t0;
                self.qrisState = 'error';
                self.qrisError = 'Network error: ' + err.message;
                console.error('[QRIS] Create network error —', err.message, 'response_time:', totalTime + 'ms');
            });
        },

        /**
         * Poll QRIS transaction status setiap 3 detik.
         *
         * GET /pos/bill/{id}/qris/{transaction_id}/status/
         * Response: { status: 'pending'|'paid'|'expired'|'failed'|'cancelled', paid_at, transaction_id }
         *
         * Jika status='paid':
         *   1. Isi prompt field (qrcontent) dengan transaction_id
         *   2. Set qrisState='paid' → tampilkan success overlay
         *   3. Stop polling + hide customer display QR
         *   4. Setelah 800ms → set qrisState='idle' → form.requestSubmit()
         *      (BYPASS canPay — QRIS sudah terbayar, HARUS diproses)
         *
         * Jika status='expired'/'cancelled'/'failed':
         *   → Show error state, stop polling
         *
         * KEAMANAN: Auto-submit menggunakan form.requestSubmit() bukan submitPayment()
         * karena submitPayment() cek canPay yang bisa return false. QRIS yang sudah
         * terbayar WAJIB diproses — tidak boleh ada uang masuk tanpa Payment record.
         */
        _startQRISPolling() {
            var self = this;
            if (self._qrisTimer) clearInterval(self._qrisTimer);

            self._qrisTimer = setInterval(function() {
                self._qrisPollCount = (self._qrisPollCount || 0) + 1;
                var pollNum = self._qrisPollCount;
                var t0 = Date.now();
                var elapsedSinceCreate = self._qrisCreateTime ? ((Date.now() - self._qrisCreateTime) / 1000).toFixed(1) : '?';

                fetch('/pos/bill/' + _billId + '/qris/' + self.qrisTransactionId + '/status/')
                .then(function(r) {
                    var responseTime = Date.now() - t0;
                    if (!r.ok) {
                        console.error('[QRIS] Poll #' + pollNum + ' HTTP error — status:', r.status, 'time:', responseTime + 'ms');
                    }
                    return r.json();
                })
                .then(function(data) {
                    var responseTime = Date.now() - t0;

                    if (data.status === 'paid') {
                        var totalWaitTime = self._qrisCreateTime ? ((Date.now() - self._qrisCreateTime) / 1000).toFixed(1) : '?';
                        console.log('[QRIS] ✓ PAYMENT CONFIRMED —',
                            'txn_id:', self.qrisTransactionId,
                            'status: paid',
                            'paid_at:', data.paid_at,
                            'poll_count:', pollNum,
                            'wait_time:', totalWaitTime + 's',
                            'last_poll_response:', responseTime + 'ms',
                            'amount:', self.qrisAmount,
                            'bill:', _billId,
                            'time:', new Date().toISOString()
                        );

                        // Fill qrcontent field with transaction reference
                        self.promptValues[self.qrisFieldName] = self.qrisTransactionId;
                        self.qrisState = 'paid';
                        self._stopQRISPolling();
                        self._hideCustomerQR();
                        self.syncDisplay();
                        // Auto-submit payment after brief success display (800ms)
                        // PENTING: Jangan tunggu kasir klik manual — QRIS sudah terbayar,
                        // harus langsung diproses agar tidak ada resiko uang masuk tapi transaksi batal.
                        setTimeout(function() {
                            self.qrisState = 'idle';
                            self.$nextTick(function() {
                                // Force submit — bypass canPay karena QRIS sudah terbayar
                                console.log('[QRIS] Auto-submitting payment form —',
                                    'txn_id:', self.qrisTransactionId,
                                    'amount:', self.amount,
                                    'total:', self.total,
                                    'method:', self.method,
                                    'time:', new Date().toISOString()
                                );
                                var form = document.getElementById('payment-form');
                                if (form) {
                                    // requestSubmit() triggers native submit event yang HTMX intercept
                                    if (form.requestSubmit) {
                                        form.requestSubmit();
                                    } else {
                                        form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                                    }
                                } else {
                                    console.error('[QRIS] CRITICAL — payment-form not found in DOM! Payment may not be recorded.');
                                }
                            });
                        }, 800);
                    } else if (data.status === 'expired' || data.status === 'cancelled' || data.status === 'failed') {
                        var totalWaitTime = self._qrisCreateTime ? ((Date.now() - self._qrisCreateTime) / 1000).toFixed(1) : '?';
                        console.warn('[QRIS] ✗ Transaction ended —',
                            'txn_id:', self.qrisTransactionId,
                            'status:', data.status,
                            'poll_count:', pollNum,
                            'elapsed:', totalWaitTime + 's',
                            'last_poll_response:', responseTime + 'ms',
                            'amount:', self.qrisAmount,
                            'bill:', _billId,
                            'time:', new Date().toISOString()
                        );
                        self.qrisState = 'error';
                        self.qrisError = 'QRIS ' + data.status;
                        self._stopQRISPolling();
                        self._hideCustomerQR();
                    }
                    // Log setiap 5 poll untuk monitoring (tapi tidak spam setiap 3 detik)
                    else if (pollNum % 5 === 0) {
                        console.log('[QRIS] Polling #' + pollNum + ' — status:', data.status,
                            'elapsed:', elapsedSinceCreate + 's',
                            'response:', responseTime + 'ms'
                        );
                    }
                })
                .catch(function(err) {
                    self._qrisPollErrors = (self._qrisPollErrors || 0) + 1;
                    var responseTime = Date.now() - t0;
                    console.error('[QRIS] Poll #' + pollNum + ' network error —',
                        err.message,
                        'response_time:', responseTime + 'ms',
                        'total_errors:', self._qrisPollErrors,
                        'txn_id:', self.qrisTransactionId
                    );
                });
            }, 3000);
        },

        /** Stop QRIS polling interval (clearInterval) */
        _stopQRISPolling() {
            if (this._qrisTimer) {
                clearInterval(this._qrisTimer);
                this._qrisTimer = null;
            }
        },

        /** Hide QR dari customer display via Flask API (non-blocking, fail silently) */
        _hideCustomerQR() {
            fetch('http://127.0.0.1:5000/api/customer-display/hide-qr', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: '{}'
            }).catch(function() {});
        },

        /**
         * Cancel QRIS transaction yang sedang pending.
         * POST /pos/bill/{id}/qris/{txn}/cancel/ → update status='cancelled'
         * Reset semua QRIS state ke idle, stop polling, hide customer display QR.
         * Dipanggil dari: tombol Cancel di QR overlay, setMethod(), closeModal()
         */
        cancelQRIS() {
            var self = this;
            var elapsed = self._qrisCreateTime ? ((Date.now() - self._qrisCreateTime) / 1000).toFixed(1) : '?';
            console.log('[QRIS] Cancelling —',
                'txn_id:', self.qrisTransactionId || '(none)',
                'state:', self.qrisState,
                'poll_count:', self._qrisPollCount || 0,
                'elapsed:', elapsed + 's',
                'bill:', _billId,
                'time:', new Date().toISOString()
            );
            if (self.qrisTransactionId) {
                fetch('/pos/bill/' + _billId + '/qris/' + self.qrisTransactionId + '/cancel/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': _csrfToken },
                }).catch(function(err) {
                    console.error('[QRIS] Cancel request failed —', err.message);
                });
            }
            self._stopQRISPolling();
            self._hideCustomerQR();
            self.qrisState = 'idle';
            self.qrisTransactionId = '';
            self.qrisQrImage = '';
            self.qrisError = '';
            self.qrisFieldName = '';
        },

        /**
         * DEV ONLY: Simulate QRIS payment (ubah status jadi 'paid').
         * POST /pos/bill/{id}/qris/{txn}/simulate-modal/
         *
         * PENTING: Endpoint ini HANYA ubah QRISTransaction.status → 'paid'.
         * TIDAK membuat Payment record atau menutup bill.
         * Polling (_startQRISPolling) akan detect status='paid' → trigger auto-submit.
         *
         * Berbeda dengan /simulate/ (tanpa -modal) yang langsung auto-complete bill.
         * Endpoint -modal khusus untuk integrasi di payment modal agar Payment
         * tetap dibuat via form submission normal (process_payment view).
         */
        simulateQRIS() {
            var elapsed = this._qrisCreateTime ? ((Date.now() - this._qrisCreateTime) / 1000).toFixed(1) : '?';
            console.log('[QRIS] DEV Simulate —',
                'txn_id:', this.qrisTransactionId,
                'amount:', this.qrisAmount,
                'elapsed:', elapsed + 's',
                'time:', new Date().toISOString()
            );
            fetch('/pos/bill/' + _billId + '/qris/' + this.qrisTransactionId + '/simulate-modal/', {
                method: 'POST',
                headers: { 'X-CSRFToken': _csrfToken },
            }).catch(function(err) {
                console.error('[QRIS] Simulate request failed —', err.message);
            });
        },

        /**
         * Tambahkan pembayaran ke split list.
         * Validasi: amount > 0, dan jika non-cash (allow_change=false) tidak boleh > remaining.
         * Setelah add: reset amount, reference, promptValues, kembali ke activeField='amount'.
         */
        addPayment() {
            if (this.amount <= 0) return;
            if (!this.currentAllowChange && this.amount > this.remaining) return;
            this.payments.push({
                method: this.method,
                method_id: this.currentMethodId,
                amount: this.amount,
                reference: this.reference,
                profile_id: this.currentProfileId,
                prompt_data: this.promptDataJson
            });
            this.amount = 0;
            this.amountDisplay = '';
            this.reference = '';
            this.promptValues = {};
            this.activeField = 'amount';
            this.syncDisplay();
        },

        /** Hapus split payment dari list berdasarkan index */
        removePayment(idx) {
            this.payments.splice(idx, 1);
            this.syncDisplay();
        },

        /**
         * Submit pembayaran — trigger HTMX POST ke process_payment endpoint.
         * Form berisi: method, amount, reference, profile_id, prompt_data,
         * + payments[0..N] untuk split payments.
         * Server akan membuat Payment record(s) dan return payment_success.html.
         *
         * Menggunakan form.requestSubmit() (bukan htmx.trigger) karena:
         * - requestSubmit() trigger native SubmitEvent yang HTMX intercept
         * - htmx.trigger() fire CustomEvent yang HTMX mungkin tidak tangkap
         *
         * CATATAN: Untuk QRIS auto-submit, form.requestSubmit() dipanggil
         * langsung dari _startQRISPolling() TANPA melalui method ini,
         * karena method ini cek canPay yang bisa return false.
         */
        submitPayment() {
            console.log('[Payment] submitPayment called, canPay:', this.canPay, 'amount:', this.amount, 'total:', this.total, 'payments:', this.payments.length);
            if (!this.canPay) return;
            if (this.payments.length > 0 && this.paidTotal >= this.total) this.amount = 0;
            var form = document.getElementById('payment-form');
            console.log('[Payment] form found:', !!form);
            if (form) {
                // requestSubmit() triggers native submit event yang HTMX intercept
                if (form.requestSubmit) {
                    form.requestSubmit();
                } else {
                    form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                }
            }
        },

        /** Init: set flag _paymentModalActive dan auto-focus ke input amount */
        init() {
            // Flag ini digunakan oleh htmx_handlers.html untuk memblokir
            // HTMX request lain ke #modal-container saat payment modal aktif
            window._paymentModalActive = true;
            // Register QRIS cleanup for closeModal()
            var self = this;
            window._qrisCleanup = function() { self.cancelQRIS(); };
            this.$nextTick(() => {
                var input = this.$el.querySelector('input[name=amount_display]');
                if (input) input.focus();
            });
        }
    };
}

/**
 * Tutup modal pembayaran.
 * Reset flag _paymentModalActive dan clear modal container.
 * Juga clear modal di customer display via sendModalToCustomerDisplay().
 */
function closeModal() {
    window._paymentModalActive = false;
    // Cancel any pending QRIS transaction and hide customer display QR
    if (window._qrisCleanup) window._qrisCleanup();
    document.getElementById('modal-container').innerHTML = '';
    if (typeof sendModalToCustomerDisplay === 'function') sendModalToCustomerDisplay();
}
</script>

<!--
    MODAL CONTAINER
    - data-payment-modal: Marker agar sendModalToCustomerDisplay() tahu ini payment modal (whitelist)
    - x-data="paymentModal()": Alpine.js component (defined di <script> di atas)
    - x-ignore: PENTING — mencegah Alpine auto-init saat HTMX inject.
      Script di bawah akan clone element tanpa x-ignore untuk init yang benar.
      Tanpa trick ini, Alpine.js bug "initTree" terjadi saat HTMX swap.
-->
<div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-2"
     data-payment-modal
     x-data="paymentModal()"
     x-init="init()"
     x-ignore>

    <div class="bg-white rounded-xl w-full shadow-2xl overflow-hidden"
         style="max-width: 720px; max-height: calc(100vh - 16px); display:flex; flex-direction:column;"
         @click.stop>

        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5" style="flex-shrink:0;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold">Payment</h3>
                        <p class="text-green-100 text-[10px]">{{ bill.bill_number }}{% if bill.table %} &middot; Table {{ bill.table.number }}{% endif %}</p>
                    </div>
                </div>
                <button onclick="closeModal()" type="button"
                        class="w-7 h-7 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!--
            SUMMARY CARDS — 3 kartu ringkasan di atas:
            1. Total: total bill (read-only)
            2. Bayar: jumlah yang sedang/sudah dibayar (hijau jika >= total, amber jika kurang)
            3. Kembalian/Sisa: kembalian (hijau) atau sisa belum bayar (amber)
        -->
        <div class="grid grid-cols-3 gap-2 p-2.5 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="bg-white rounded-lg p-2 border text-center">
                <div class="text-[10px] font-semibold text-gray-500 uppercase">Total</div>
                <div class="text-lg font-bold text-gray-900">Rp <span x-text="fmt(total)"></span></div>
            </div>
            <div class="bg-white rounded-lg p-2 border text-center">
                <div class="text-[10px] font-semibold text-gray-500 uppercase">Bayar</div>
                <div class="text-lg font-bold" :class="displayPaying >= total ? 'text-green-600' : 'text-amber-600'">
                    Rp <span x-text="fmt(displayPaying)"></span>
                </div>
            </div>
            <div class="rounded-lg p-2 border text-center" :class="changeAmount > 0 ? 'bg-green-50 border-green-200' : (payments.length > 0 && paidTotal < total ? 'bg-amber-50 border-amber-200' : 'bg-white')">
                <div class="text-[10px] font-semibold uppercase" :class="changeAmount > 0 ? 'text-green-700' : (payments.length > 0 && paidTotal < total ? 'text-amber-700' : 'text-gray-500')"
                     x-text="changeAmount > 0 ? 'Kembalian' : (payments.length > 0 && paidTotal < total ? 'Sisa' : 'Kembalian')"></div>
                <div class="text-lg font-bold" :class="changeAmount > 0 ? 'text-green-600' : (payments.length > 0 && paidTotal < total ? 'text-amber-600' : 'text-gray-400')">
                    Rp <span x-text="changeAmount > 0 ? fmt(changeAmount) : (payments.length > 0 && paidTotal < total ? fmt(remaining) : fmt(0))"></span>
                </div>
            </div>
        </div>

        <!--
            APPLIED PAYMENTS LIST (Split Payments)
            Tampil jika kasir sudah menambah 1+ split payment via tombol "+ Split".
            Menggunakan x-html (bukan x-for) karena x-for dengan non-empty array
            menyebabkan bug Alpine.js initTree saat HTMX swap.
            Tombol X merah untuk hapus payment dari list.
        -->
        <div x-show="payments.length > 0" x-cloak class="px-2.5 pt-2 pb-1 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1">Pembayaran Tercatat</div>
            <div style="display:flex; flex-wrap:wrap; gap:4px;"
                 x-html="paymentsListHtml"
                 @click="var btn=$event.target.closest('[data-rm]'); if(btn) removePayment(parseInt(btn.dataset.rm))"></div>
        </div>

        <!--
            CONTENT AREA: 30/70 Split Layout
            Kiri (30%): List metode pembayaran (server-rendered)
            Kanan (70%): Input amount + prompts + numpad

            FORM SUBMISSION:
            Form ini dikirim via HTMX POST ke process_payment endpoint.
            Response HTML (payment_success.html) di-inject ke #modal-container.
        -->
        <div style="flex:1 1 0%; min-height:0; display:flex;">
            <form id="payment-form"
                  hx-post="{% url 'pos:process_payment' bill.id %}"
                  hx-target="#modal-container"
                  hx-swap="innerHTML"
                  style="display:flex; flex:1; min-height:0;">
                {% csrf_token %}
                <!--
                    HIDDEN INPUTS — Data pembayaran saat ini.
                    Dibaca oleh process_payment() di server:
                    - method: legacy method ID (cash/card/qris/dll)
                    - amount: nominal pembayaran
                    - reference: referensi legacy (non-profile mode)
                    - profile_id: UUID PaymentMethodProfile
                    - prompt_data: JSON string dari promptValues
                -->
                <input type="hidden" name="method" :value="currentMethodId">
                <input type="hidden" name="amount" :value="amount">
                <input type="hidden" name="reference" :value="reference">
                <input type="hidden" name="profile_id" :value="currentProfileId">
                <input type="hidden" name="prompt_data" :value="promptDataJson">
                <!-- Hidden inputs untuk split payments (payments[0][method], payments[0][amount], dll) -->
                <div x-html="paymentsHiddenHtml"></div>

                <!--
                    LEFT PANEL: Metode Pembayaran (30%)
                    Server-side rendered dari payment_methods_list (Django for loop).
                    Setiap tombol memanggil setMethod(id) yang:
                    1. Ganti metode aktif
                    2. Reset promptValues (karena setiap metode punya prompts berbeda)
                    3. Kembali ke activeField='amount'
                    4. Sync ke customer display

                    Tombol aktif: border hijau + shadow (via Alpine :class binding)
                -->
                <div style="width:30%; flex-shrink:0; border-right:1px solid #e5e7eb; overflow-y:auto;"
                     class="bg-gray-50">
                    <div class="p-2.5">
                        <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-2 px-1">Metode Pembayaran</div>
                        <div class="flex flex-col gap-1.5">
                            {% for pm in payment_methods_list %}
                            <button type="button"
                                    @click="setMethod('{{ pm.id }}')"
                                    class="flex items-center gap-2.5 rounded-xl border-2 transition-all px-3 py-2.5 w-full text-left"
                                    :class="method === '{{ pm.id }}'
                                        ? 'border-green-500 bg-white text-green-800 shadow-md shadow-green-500/10'
                                        : 'border-transparent bg-white/60 text-gray-600 hover:bg-white hover:border-gray-200 hover:shadow-sm'">
                                <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center shadow-sm"
                                     style="background: {{ pm.color }}">
                                    <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <circle cx="10" cy="10" r="4"/>
                                    </svg>
                                </div>
                                <span class="font-bold text-xs leading-tight">{{ pm.label }}</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!--
                    RIGHT PANEL: Amount + Prompts + Numpad (70%)
                    Berisi 4 bagian dari atas ke bawah:
                    1. Amount Input — input nominal pembayaran
                    2. Dynamic Prompts — field tambahan per metode (account_no, eft_no, dll)
                    3. Numpad — 0-9, 00, 000, DEL, C (routing ke amount atau prompt)
                    4. Quick Amounts — tombol Exact, 50K, 100K, Round
                -->
                <div style="width:70%; overflow-y:auto;" class="p-3">
                    <!--
                        AMOUNT INPUT
                        Border hijau saat fokus (activeField='amount').
                        Border merah jika non-cash dan amount > remaining (overpayment blocked).
                        Klik area input → set activeField='amount' (numpad routing).
                    -->
                    <div class="flex items-center border-2 rounded-xl mb-2.5 bg-white transition-all"
                         :class="!currentAllowChange && amount > remaining ? 'border-red-300' : (activeField === 'amount' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200')"
                         @click="activeField = 'amount'; $el.querySelector('input').focus()">
                        <span class="pl-3 font-bold text-base" :class="activeField === 'amount' ? 'text-green-600' : 'text-gray-400'">Rp</span>
                        <input type="text"
                               name="amount_display"
                               x-model="amountDisplay"
                               @input="onInput($event.target.value)"
                               @focus="activeField = 'amount'"
                               class="w-full pr-3 py-2.5 pl-1 text-right text-xl font-bold bg-transparent outline-none"
                               placeholder="0"
                               inputmode="numeric"
                               autocomplete="off">
                    </div>

                    <!--
                        DYNAMIC DATA ENTRY PROMPTS (Profile Mode)
                        Server-side rendered: Django loop semua metode + prompts-nya.
                        Client-side toggle: x-show="method === 'xxx'" — hanya tampil
                        untuk metode yang sedang dipilih.

                        Setiap prompt bisa berupa:
                        - Text input biasa (account_no, approval_code)
                        - Dropdown/select (eft_no → dari EFTTerminal master data)
                        - Scanner button (qrcontent → tombol scan barcode/QR)

                        Prompt fields punya data-prompt-field="xxx" attribute
                        agar sendModalToCustomerDisplay() bisa capture nilainya
                        saat clone modal ke customer display.

                        @focus pada input → set activeField='prompt:field_name'
                        → numpad akan route ke field ini (bukan amount).
                    -->
                    {% if use_profiles %}
                    {% for pm in payment_methods_list %}
                    {% if pm.prompts %}
                    <div x-show="method === '{{ pm.id }}'" x-cloak class="space-y-1.5 mb-2.5">
                        {% for prompt in pm.prompts %}
                        <div>
                            <label class="text-[10px] font-semibold uppercase transition-colors"
                                   :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'text-green-600' : 'text-gray-500'">
                                {{ prompt.label|default:prompt.field_name }}
                                <span x-show="activeField === 'prompt:{{ prompt.field_name }}'" class="text-[9px] text-green-500 ml-1">NUMPAD</span>
                            </label>
                            <div class="flex gap-1">
                                {% if prompt.field_name == 'eft_no' and eft_terminals %}
                                <!-- EFT Terminal dropdown from master data -->
                                <select data-prompt-field="{{ prompt.field_name }}"
                                        x-model="promptValues['{{ prompt.field_name }}']"
                                        @change="syncDisplay()"
                                        class="w-full px-2.5 py-1.5 border-2 border-gray-200 rounded-lg text-xs focus:border-green-500 outline-none font-mono bg-white">
                                    <option value="">-- Pilih EFT Terminal --</option>
                                    {% for eft in eft_terminals %}
                                    <option value="{{ eft.code }}">{{ eft.code }}: {{ eft.name }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="text"
                                       data-prompt-field="{{ prompt.field_name }}"
                                       placeholder="{{ prompt.placeholder|default:'' }}"
                                       maxlength="{{ prompt.max_length|default:99 }}"
                                       x-model="promptValues['{{ prompt.field_name }}']"
                                       @focus="activeField = 'prompt:{{ prompt.field_name }}'"
                                       @input="syncDisplay()"
                                       class="w-full px-2.5 py-1.5 border-2 rounded-lg text-xs outline-none transition-all {% if prompt.field_type == 'numeric' %}font-mono{% endif %}"
                                       :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200'">
                                {% endif %}
                                {% if prompt.use_scanner %}
                                <button type="button" @click="activateScanner('{{ prompt.field_name }}'); activeField = 'prompt:{{ prompt.field_name }}'"
                                        class="px-2 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition flex-shrink-0"
                                        title="Scan">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                    </svg>
                                </button>
                                {% endif %}
                                {% if prompt.field_type == 'scanner' %}
                                <!--
                                    Generate QR button — tampil untuk prompt dengan field_type='scanner'.
                                    Contoh: QRIS BCA CPM punya prompt 'qrcontent' (field_type=scanner).
                                    Klik → generateQR(fieldName) → buat QRIS transaction + show QR overlay.
                                    Disabled saat QRIS sudah aktif (polling/generating).
                                -->
                                <button type="button"
                                        @click="generateQR('{{ prompt.field_name }}')"
                                        :disabled="qrisState === 'polling' || qrisState === 'generating'"
                                        class="px-2 py-1.5 rounded-lg transition flex-shrink-0 flex items-center gap-1"
                                        :class="qrisState === 'polling' || qrisState === 'generating'
                                            ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                            : 'bg-purple-100 text-purple-700 hover:bg-purple-200'"
                                        title="Generate QR">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h4v4H4zM16 4h4v4h-4zM4 16h4v4H4zM16 16h2v2h-2zM20 16h0v4h-4v-2M14 12h6M12 14v6M12 4v4M4 12h4"/>
                                    </svg>
                                    <span class="text-[10px] font-bold">QR</span>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    <!--
                        LEGACY REFERENCE INPUT (Non-Profile Mode)
                        Ditampilkan jika use_profiles=false (terminal belum punya payment profiles).
                        Satu field "Reference" generic per metode yang punya ref=true.
                        Akan di-phase out setelah semua terminal pakai dynamic profiles.
                    -->
                    {% if not use_profiles %}
                    {% for pm in payment_methods_list %}
                    {% if pm.ref %}
                    <div x-show="method === '{{ pm.id }}'" x-cloak class="mb-2">
                        <input type="text"
                               x-model="reference"
                               placeholder="{{ pm.refPlaceholder|default:'Reference' }}"
                               class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-xs focus:border-green-500 outline-none">
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    <!--
                        QRIS QR CODE OVERLAY
                        Tampil saat qrisState != 'idle' — menggantikan numpad area.
                        4 state visual:
                        1. generating: spinner "Generating QR Code..."
                        2. polling: QR image + amount + "Menunggu pembayaran..." + tombol Cancel/Simulate
                        3. paid: green checkmark + "QRIS Terbayar!" + "Memproses pembayaran otomatis..."
                           (800ms kemudian form auto-submit via requestSubmit())
                        4. error: red X + pesan error + tombol "Tutup"

                        QR image berasal dari server (base64 PNG, generated via library qrcode).
                        Juga dikirim ke customer display via Flask local API (opsional).
                    -->
                    <div x-show="qrisState !== 'idle'" x-cloak class="mb-2.5">
                        <!-- Generating state -->
                        <div x-show="qrisState === 'generating'" class="flex flex-col items-center justify-center py-6 bg-gray-50 rounded-xl border-2 border-gray-200">
                            <svg class="w-8 h-8 text-purple-500 animate-spin mb-2" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                            </svg>
                            <span class="text-xs font-bold text-gray-600">Generating QR Code...</span>
                        </div>

                        <!-- Polling state — QR is shown -->
                        <div x-show="qrisState === 'polling'" class="flex flex-col items-center bg-purple-50 rounded-xl border-2 border-purple-200 p-3">
                            <div class="text-[10px] font-bold text-purple-600 uppercase tracking-wide mb-2">Scan QR untuk Bayar</div>
                            <!-- QR Image -->
                            <div class="bg-white rounded-lg p-2 shadow-sm mb-2">
                                <img x-show="qrisQrImage" :src="qrisQrImage" alt="QRIS QR Code" class="w-36 h-36 object-contain">
                                <div x-show="!qrisQrImage" class="w-36 h-36 flex items-center justify-center text-gray-400">
                                    <svg class="w-12 h-12 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 4h4v4H4zM16 4h4v4h-4zM4 16h4v4H4zM16 16h2v2h-2z"/>
                                    </svg>
                                </div>
                            </div>
                            <div class="text-sm font-bold text-purple-800 mb-1">Rp <span x-text="fmt(qrisAmount)"></span></div>
                            <div class="flex items-center gap-1.5 mb-3">
                                <span class="w-2 h-2 bg-purple-500 rounded-full animate-pulse"></span>
                                <span class="text-[10px] font-medium text-purple-600">Menunggu pembayaran...</span>
                            </div>
                            <div class="flex gap-2">
                                <button type="button" @click="cancelQRIS()"
                                        class="px-3 py-1.5 text-[10px] font-bold bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                    Cancel
                                </button>
                                <button type="button" @click="simulateQRIS()"
                                        class="px-3 py-1.5 text-[10px] font-bold bg-amber-100 text-amber-800 rounded-lg hover:bg-amber-200 transition">
                                    Simulate Payment
                                </button>
                            </div>
                        </div>

                        <!-- Paid state — success, will auto-submit -->
                        <div x-show="qrisState === 'paid'" class="flex flex-col items-center justify-center py-6 bg-green-50 rounded-xl border-2 border-green-200">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-7 h-7 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"/>
                                </svg>
                            </div>
                            <span class="text-xs font-bold text-green-700">QRIS Terbayar!</span>
                            <span class="text-[10px] text-green-600 mt-0.5">Memproses pembayaran otomatis...</span>
                            <span class="text-[9px] text-green-500 mt-0.5 font-mono" x-text="qrisTransactionId"></span>
                        </div>

                        <!-- Error state -->
                        <div x-show="qrisState === 'error'" class="flex flex-col items-center justify-center py-4 bg-red-50 rounded-xl border-2 border-red-200">
                            <div class="w-10 h-10 bg-red-100 rounded-full flex items-center justify-center mb-2">
                                <svg class="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </div>
                            <span class="text-xs font-bold text-red-700" x-text="qrisError || 'QRIS Error'"></span>
                            <button type="button" @click="qrisState = 'idle'; qrisError = ''"
                                    class="mt-2 px-3 py-1 text-[10px] font-bold bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition">
                                Tutup
                            </button>
                        </div>
                    </div>

                    <!--
                        NUMPAD TARGET INDICATOR
                        Muncul saat activeField = 'prompt:xxx' (numpad diarahkan ke prompt field).
                        Menampilkan nama field yang sedang menerima input numpad.
                        Tombol "← Amount" untuk kembali routing numpad ke amount.
                    -->
                    <div x-show="qrisState === 'idle' && activeField && activeField.startsWith('prompt:')" x-cloak
                         class="flex items-center gap-1.5 mb-1.5 px-2 py-1 bg-green-50 border border-green-200 rounded-lg">
                        <svg class="w-3 h-3 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                        </svg>
                        <span class="text-[10px] font-bold text-green-700">Numpad → <span x-text="activeField.substring(7).toUpperCase()"></span></span>
                        <button type="button" @click="activeField = 'amount'" class="ml-auto text-[9px] font-bold text-green-600 hover:text-green-800 bg-green-100 px-1.5 py-0.5 rounded">
                            ← Amount
                        </button>
                    </div>

                    <!-- NUMPAD + QUICK AMOUNTS — Hidden when QRIS overlay is active -->
                    <div x-show="qrisState === 'idle'">
                    <!--
                        NUMPAD — Grid 4 kolom, 4 baris.
                        Setiap tombol memanggil numpad(key) yang route ke:
                        - activeField='amount' → append angka ke amount
                        - activeField='prompt:xxx' → append angka ke promptValues[xxx]
                        Tombol spesial: DEL (hapus 1 digit), C (clear semua)
                        Tombol 00 dan 000 untuk input cepat ribuan.
                    -->
                    <div class="grid grid-cols-4 gap-1.5 mb-2">
                        <button type="button" @click="numpad('7')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">7</button>
                        <button type="button" @click="numpad('8')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">8</button>
                        <button type="button" @click="numpad('9')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">9</button>
                        <button type="button" @click="numpad('DEL')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-amber-100 text-amber-800 hover:bg-amber-200" style="height:44px;">&#9003;</button>
                        <button type="button" @click="numpad('4')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">4</button>
                        <button type="button" @click="numpad('5')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">5</button>
                        <button type="button" @click="numpad('6')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">6</button>
                        <button type="button" @click="numpad('C')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-red-100 text-red-800 hover:bg-red-200" style="height:44px;">C</button>
                        <button type="button" @click="numpad('1')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">1</button>
                        <button type="button" @click="numpad('2')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">2</button>
                        <button type="button" @click="numpad('3')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">3</button>
                        <button type="button" @click="numpad('00')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">00</button>
                        <button type="button" @click="numpad('0')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">0</button>
                        <button type="button" @click="numpad('000')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">000</button>
                    </div>

                    <!--
                        QUICK AMOUNT BUTTONS
                        - Exact: set amount = remaining (bayar pas)
                        - 50K: set amount = 50.000
                        - 100K: set amount = 100.000
                        - Round: pembulatan ke atas kelipatan 50.000
                        Semua memanggil setAmount() yang juga reset activeField ke 'amount'.
                    -->
                    <div class="grid grid-cols-4 gap-1.5">
                        <button type="button" @click="setAmount(remaining)"
                                class="py-2 rounded-lg bg-green-600 text-white font-bold text-xs hover:bg-green-700 active:scale-95 transition-all">
                            Exact
                        </button>
                        <button type="button" @click="setAmount(50000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            50K
                        </button>
                        <button type="button" @click="setAmount(100000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            100K
                        </button>
                        <button type="button" @click="setAmount(Math.ceil(remaining/50000)*50000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            Round
                        </button>
                    </div>
                    </div><!-- /NUMPAD + QUICK AMOUNTS wrapper -->
                </div>
            </form>
        </div>

        <!--
            FOOTER — 3 tombol aksi:
            1. Cancel: tutup modal tanpa bayar
               - DISABLED saat qrisState='polling'/'paid' (mencegah batal setelah customer bayar)
            2. + Split: tambah pembayaran parsial ke list
               - HIDDEN saat QRIS aktif (qrisState != 'idle')
               - Tampil jika amount > 0 DAN belum cukup
            3. Bayar: submit pembayaran
               - Aktif jika canPay=true (disabled saat QRIS polling/generating)
               - Saat QRIS polling: tampil "Menunggu QRIS..." dengan spinner
               - QRIS auto-submit BYPASS tombol ini (langsung form.requestSubmit)
        -->
        <div class="p-2.5 border-t bg-gray-50 flex gap-2" style="flex-shrink:0;">
            <!-- Cancel: disabled saat QRIS polling — mencegah batal setelah customer bayar -->
            <button type="button" onclick="closeModal()"
                    :disabled="qrisState === 'polling' || qrisState === 'paid'"
                    class="px-5 py-2.5 rounded-lg font-bold text-xs transition-all"
                    :class="qrisState === 'polling' || qrisState === 'paid'
                        ? 'bg-gray-200 border-2 border-gray-200 text-gray-400 cursor-not-allowed'
                        : 'bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50'">
                Cancel
            </button>
            <!-- Tombol + Split: hidden saat QRIS aktif -->
            <button type="button"
                    x-show="qrisState === 'idle' && amount > 0 && (payments.length > 0 || amount < total)"
                    x-cloak
                    @click="addPayment()"
                    class="px-4 py-2.5 rounded-lg font-bold text-xs bg-blue-600 hover:bg-blue-700 text-white transition-all">
                <span class="flex items-center justify-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    + Split
                </span>
            </button>
            <button type="button"
                    @click="submitPayment()"
                    :disabled="!canPay"
                    class="flex-1 py-2.5 rounded-lg font-bold text-sm transition-all"
                    :class="qrisState === 'polling'
                        ? 'bg-purple-500 text-white shadow-lg animate-pulse'
                        : (canPay ? 'bg-green-600 hover:bg-green-700 text-white shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed')">
                <span class="flex items-center justify-center gap-2">
                    <svg x-show="qrisState !== 'polling'" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <svg x-show="qrisState === 'polling'" x-cloak class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    <span x-text="qrisState === 'polling' ? 'Menunggu QRIS...' : (canPay ? 'Bayar Rp ' + fmt(payments.length > 0 ? paidTotal : amount) : 'Masukkan Nominal')"></span>
                </span>
            </button>
        </div>
    </div>
</div>

<!--
    STYLES
    - x-cloak: Hide elemen Alpine.js yang belum di-init (mencegah flash of unstyled content)
    - touch-action: manipulation: Hilangkan 300ms tap delay di touchscreen POS
    - -webkit-tap-highlight-color: transparent: Hilangkan highlight biru saat tap
-->
<style>
[x-cloak] { display: none !important; }
[data-payment-modal] { touch-action: manipulation; }
[data-payment-modal] button,
[data-payment-modal] select,
[data-payment-modal] input {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    cursor: pointer;
}
</style>

<!--
    ALPINE.JS INITIALIZATION TRICK
    ================================
    Masalah: HTMX inject HTML ke #modal-container → Alpine.js MutationObserver
    mendeteksi element baru dengan x-data → auto-init. Tapi pada Alpine.js
    tertentu, ini menyebabkan bug "initTree" jika ada x-for dengan array
    yang sudah berisi data (non-empty).

    Solusi:
    1. Element utama diberi x-ignore → Alpine SKIP init saat HTMX inject
    2. Script ini (berjalan setelah inject) → clone element tanpa x-ignore
    3. Replace element asli dengan clone → Alpine MO detect element baru → init natural
    4. requestAnimationFrame + setTimeout(0) → pastikan DOM settled sebelum clone

    Ini juga fix masalah touch device dimana Alpine init terlalu cepat
    sebelum DOM siap, menyebabkan event handler tidak terpasang.

    Setelah clone+replace, htmx.process() dipanggil agar HTMX attributes
    (hx-post, hx-target, dll) pada form tetap berfungsi.
-->
<script>
(function() {
    var el = document.querySelector('[data-payment-modal]');
    if (!el || typeof Alpine === 'undefined') return;

    requestAnimationFrame(function() {
        setTimeout(function() {
            if (el._x_dataStack) return;  // Sudah di-init Alpine, skip
            var clone = el.cloneNode(true);
            clone.removeAttribute('x-ignore');  // Hapus x-ignore → Alpine akan init
            el.parentNode.replaceChild(clone, el);
            if (typeof htmx !== 'undefined') htmx.process(clone);  // Re-bind HTMX
            console.log('[Payment Modal] Alpine clone+replace done, touch ready');
        }, 0);
    });
})();
</script>
