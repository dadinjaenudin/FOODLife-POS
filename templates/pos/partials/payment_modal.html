{% load humanize %}
<!-- Payment Modal v11 - Server-side rendered methods (no x-for for non-empty arrays) -->

<!-- Define paymentModal() BEFORE the HTML (HTMX executes scripts after DOM insert) -->
<script>
function paymentModal() {
    var _paymentMethods = [];
    try { _paymentMethods = {{ payment_methods_json|safe }}; } catch(e) {}
    var _useProfiles = {{ use_profiles|yesno:"true,false" }};
    var _defaultMethod = '{{ default_method|escapejs }}' || 'cash';

    return {
        useProfiles: _useProfiles,
        paymentMethods: _paymentMethods,
        method: _defaultMethod,
        amount: 0,
        amountDisplay: '',
        reference: '',
        promptValues: {},
        total: parseInt('{{ total_int|escapejs }}') || 0,
        payments: [],
        activeField: 'amount',
        _syncTimer: null,

        get selectedMethod() {
            return this.paymentMethods.find(m => m.id === this.method) || null;
        },

        get currentProfileId() {
            var sm = this.selectedMethod;
            return (sm && sm.profile_id) ? sm.profile_id : '';
        },

        get currentMethodId() {
            var sm = this.selectedMethod;
            return (sm && sm.method_id) ? sm.method_id : this.method;
        },

        get currentAllowChange() {
            var sm = this.selectedMethod;
            return sm ? (sm.allow_change !== false) : true;
        },

        get promptDataJson() {
            if (!this.useProfiles) return '';
            var vals = this.promptValues;
            var hasAny = false;
            for (var k in vals) { if (vals[k]) { hasAny = true; break; } }
            return hasAny ? JSON.stringify(vals) : '';
        },

        get paidTotal() {
            var sum = 0;
            for (var i = 0; i < this.payments.length; i++) sum += this.payments[i].amount;
            return sum;
        },

        get remaining() {
            var r = this.total - this.paidTotal;
            return r > 0 ? r : 0;
        },

        get displayPaying() {
            return this.payments.length > 0 ? this.paidTotal : this.amount;
        },

        get changeAmount() {
            if (this.payments.length === 0 && this.currentAllowChange && this.amount > this.total) {
                return this.amount - this.total;
            }
            if (this.payments.length > 0 && this.paidTotal > this.total) {
                var lastPmt = this.payments[this.payments.length - 1];
                var lastMethod = this.paymentMethods.find(function(m) { return m.id === lastPmt.method; });
                if (lastMethod && lastMethod.allow_change !== false) return this.paidTotal - this.total;
            }
            return 0;
        },

        get paymentsListHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                h += '<div class="flex items-center gap-1.5 bg-white border rounded-lg px-2 py-1">';
                h += '<div class="w-2 h-2 rounded-full flex-shrink-0" style="background:' + this.getMethodColor(p.method) + '"></div>';
                h += '<span class="text-[11px] font-bold text-gray-700">' + this.getMethodLabel(p.method) + '</span>';
                h += '<span class="text-[11px] font-bold text-green-600">Rp ' + this.fmt(p.amount) + '</span>';
                h += '<button type="button" data-rm="' + i + '" class="w-4 h-4 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded">';
                h += '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                h += '</button></div>';
            }
            return h;
        },

        get paymentsHiddenHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                var mid = (p.method_id || p.method || '').replace(/"/g, '&quot;');
                var ref = (p.reference || '').replace(/"/g, '&quot;');
                var pid = (p.profile_id || '').replace(/"/g, '&quot;');
                var pd = (p.prompt_data || '').replace(/"/g, '&quot;');
                h += '<input type="hidden" name="payments[' + i + '][method]" value="' + mid + '">';
                h += '<input type="hidden" name="payments[' + i + '][amount]" value="' + p.amount + '">';
                h += '<input type="hidden" name="payments[' + i + '][reference]" value="' + ref + '">';
                h += '<input type="hidden" name="payments[' + i + '][profile_id]" value="' + pid + '">';
                h += '<input type="hidden" name="payments[' + i + '][prompt_data]" value="' + pd + '">';
            }
            return h;
        },

        get canPay() {
            if (this.payments.length === 0) return this.amount >= this.total && this.amount > 0;
            return this.paidTotal >= this.total;
        },

        fmt(n) {
            if (!n && n !== 0) return '0';
            return Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        },

        getMethodLabel(id) {
            var m = this.paymentMethods.find(function(pm) { return pm.id === id; });
            return m ? m.label : id;
        },

        getMethodColor(id) {
            var m = this.paymentMethods.find(function(pm) { return pm.id === id; });
            return m ? m.color : '#6b7280';
        },

        onInput(val) {
            var clean = val.replace(/\D/g, '');
            this.amount = clean ? parseInt(clean) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
            this.syncDisplay();
        },

        numpad(key) {
            // Route numpad to prompt field if active
            if (this.activeField && this.activeField.startsWith('prompt:')) {
                var fieldName = this.activeField.substring(7);
                var val = this.promptValues[fieldName] || '';
                if (key === 'C') val = '';
                else if (key === 'DEL') val = val.slice(0, -1);
                else val = val + key;
                this.promptValues[fieldName] = val;
                this.syncDisplay();
                return;
            }
            // Default: amount field
            var raw = this.amount.toString();
            if (key === 'C') raw = '';
            else if (key === 'DEL') raw = raw.slice(0, -1);
            else raw = raw + key;
            this.amount = raw ? parseInt(raw) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
            this.syncDisplay();
        },

        setAmount(val) {
            this.activeField = 'amount';
            this.amount = val;
            this.amountDisplay = this.fmt(val);
            this.syncDisplay();
        },

        setMethod(id) {
            this.method = id;
            this.reference = '';
            this.promptValues = {};
            this.activeField = 'amount';
            this.syncDisplay();
        },

        focusField(fieldName) {
            this.activeField = fieldName;
        },

        syncDisplay() {
            if (this._syncTimer) clearTimeout(this._syncTimer);
            this._syncTimer = setTimeout(function() {
                if (typeof sendModalToCustomerDisplay === 'function') sendModalToCustomerDisplay();
            }, 400);
        },

        activateScanner(fieldName) {
            var self = this;
            this.$nextTick(function() {
                var input = self.$el.querySelector('[data-prompt-field="' + fieldName + '"]');
                if (input) input.focus();
            });
        },

        addPayment() {
            if (this.amount <= 0) return;
            if (!this.currentAllowChange && this.amount > this.remaining) return;
            this.payments.push({
                method: this.method,
                method_id: this.currentMethodId,
                amount: this.amount,
                reference: this.reference,
                profile_id: this.currentProfileId,
                prompt_data: this.promptDataJson
            });
            this.amount = 0;
            this.amountDisplay = '';
            this.reference = '';
            this.promptValues = {};
            this.activeField = 'amount';
            this.syncDisplay();
        },

        removePayment(idx) {
            this.payments.splice(idx, 1);
            this.syncDisplay();
        },

        submitPayment() {
            console.log('[Payment] submitPayment called, canPay:', this.canPay, 'amount:', this.amount, 'total:', this.total, 'payments:', this.payments.length);
            if (!this.canPay) return;
            if (this.payments.length > 0 && this.paidTotal >= this.total) this.amount = 0;
            var form = document.getElementById('payment-form');
            console.log('[Payment] form found:', !!form, 'htmx:', typeof htmx);
            if (form && typeof htmx !== 'undefined') {
                htmx.trigger(form, 'submit');
            } else if (form) {
                form.submit();
            }
        },

        init() {
            window._paymentModalActive = true;
            this.$nextTick(() => {
                var input = this.$el.querySelector('input[name=amount_display]');
                if (input) input.focus();
            });
        }
    };
}

function closeModal() {
    window._paymentModalActive = false;
    document.getElementById('modal-container').innerHTML = '';
    if (typeof sendModalToCustomerDisplay === 'function') sendModalToCustomerDisplay();
}
</script>

<div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-2"
     data-payment-modal
     x-data="paymentModal()"
     x-init="init()"
     x-ignore>

    <div class="bg-white rounded-xl w-full shadow-2xl overflow-hidden"
         style="max-width: 720px; max-height: calc(100vh - 16px); display:flex; flex-direction:column;"
         @click.stop>

        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5" style="flex-shrink:0;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold">Payment</h3>
                        <p class="text-green-100 text-[10px]">{{ bill.bill_number }}{% if bill.table %} &middot; Table {{ bill.table.number }}{% endif %}</p>
                    </div>
                </div>
                <button onclick="closeModal()" type="button"
                        class="w-7 h-7 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-3 gap-2 p-2.5 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="bg-white rounded-lg p-2 border text-center">
                <div class="text-[10px] font-semibold text-gray-500 uppercase">Total</div>
                <div class="text-lg font-bold text-gray-900">Rp <span x-text="fmt(total)"></span></div>
            </div>
            <div class="bg-white rounded-lg p-2 border text-center">
                <div class="text-[10px] font-semibold text-gray-500 uppercase">Bayar</div>
                <div class="text-lg font-bold" :class="displayPaying >= total ? 'text-green-600' : 'text-amber-600'">
                    Rp <span x-text="fmt(displayPaying)"></span>
                </div>
            </div>
            <div class="rounded-lg p-2 border text-center" :class="changeAmount > 0 ? 'bg-green-50 border-green-200' : (payments.length > 0 && paidTotal < total ? 'bg-amber-50 border-amber-200' : 'bg-white')">
                <div class="text-[10px] font-semibold uppercase" :class="changeAmount > 0 ? 'text-green-700' : (payments.length > 0 && paidTotal < total ? 'text-amber-700' : 'text-gray-500')"
                     x-text="changeAmount > 0 ? 'Kembalian' : (payments.length > 0 && paidTotal < total ? 'Sisa' : 'Kembalian')"></div>
                <div class="text-lg font-bold" :class="changeAmount > 0 ? 'text-green-600' : (payments.length > 0 && paidTotal < total ? 'text-amber-600' : 'text-gray-400')">
                    Rp <span x-text="changeAmount > 0 ? fmt(changeAmount) : (payments.length > 0 && paidTotal < total ? fmt(remaining) : fmt(0))"></span>
                </div>
            </div>
        </div>

        <!-- Applied Payments List (split payments) - x-html avoids x-for/initTree bug -->
        <div x-show="payments.length > 0" x-cloak class="px-2.5 pt-2 pb-1 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1">Pembayaran Tercatat</div>
            <div style="display:flex; flex-wrap:wrap; gap:4px;"
                 x-html="paymentsListHtml"
                 @click="var btn=$event.target.closest('[data-rm]'); if(btn) removePayment(parseInt(btn.dataset.rm))"></div>
        </div>

        <!-- Content: 30/70 Split Layout -->
        <div style="flex:1 1 0%; min-height:0; display:flex;">
            <form id="payment-form"
                  hx-post="{% url 'pos:process_payment' bill.id %}"
                  hx-target="#modal-container"
                  hx-swap="innerHTML"
                  style="display:flex; flex:1; min-height:0;">
                {% csrf_token %}
                <!-- Current payment hidden inputs -->
                <input type="hidden" name="method" :value="currentMethodId">
                <input type="hidden" name="amount" :value="amount">
                <input type="hidden" name="reference" :value="reference">
                <input type="hidden" name="profile_id" :value="currentProfileId">
                <input type="hidden" name="prompt_data" :value="promptDataJson">
                <!-- Applied payments hidden inputs (x-html, no x-for needed) -->
                <div x-html="paymentsHiddenHtml"></div>

                <!-- LEFT PANEL: Payment Methods (30%) -->
                <div style="width:30%; flex-shrink:0; border-right:1px solid #e5e7eb; overflow-y:auto;"
                     class="bg-gray-50">
                    <div class="p-2.5">
                        <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-2 px-1">Metode Pembayaran</div>
                        <div class="flex flex-col gap-1.5">
                            {% for pm in payment_methods_list %}
                            <button type="button"
                                    @click="setMethod('{{ pm.id }}')"
                                    class="flex items-center gap-2.5 rounded-xl border-2 transition-all px-3 py-2.5 w-full text-left"
                                    :class="method === '{{ pm.id }}'
                                        ? 'border-green-500 bg-white text-green-800 shadow-md shadow-green-500/10'
                                        : 'border-transparent bg-white/60 text-gray-600 hover:bg-white hover:border-gray-200 hover:shadow-sm'">
                                <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center shadow-sm"
                                     style="background: {{ pm.color }}">
                                    <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <circle cx="10" cy="10" r="4"/>
                                    </svg>
                                </div>
                                <span class="font-bold text-xs leading-tight">{{ pm.label }}</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- RIGHT PANEL: Amount + Prompts + Numpad (70%) -->
                <div style="width:70%; overflow-y:auto;" class="p-3">
                    <!-- Amount Input -->
                    <div class="flex items-center border-2 rounded-xl mb-2.5 bg-white transition-all"
                         :class="!currentAllowChange && amount > remaining ? 'border-red-300' : (activeField === 'amount' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200')"
                         @click="activeField = 'amount'; $el.querySelector('input').focus()">
                        <span class="pl-3 font-bold text-base" :class="activeField === 'amount' ? 'text-green-600' : 'text-gray-400'">Rp</span>
                        <input type="text"
                               name="amount_display"
                               x-model="amountDisplay"
                               @input="onInput($event.target.value)"
                               @focus="activeField = 'amount'"
                               class="w-full pr-3 py-2.5 pl-1 text-right text-xl font-bold bg-transparent outline-none"
                               placeholder="0"
                               inputmode="numeric"
                               autocomplete="off">
                    </div>

                    <!-- Dynamic Data Entry Prompts (server-side rendered per method, toggled with x-show) -->
                    {% if use_profiles %}
                    {% for pm in payment_methods_list %}
                    {% if pm.prompts %}
                    <div x-show="method === '{{ pm.id }}'" x-cloak class="space-y-1.5 mb-2.5">
                        {% for prompt in pm.prompts %}
                        <div>
                            <label class="text-[10px] font-semibold uppercase transition-colors"
                                   :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'text-green-600' : 'text-gray-500'">
                                {{ prompt.label|default:prompt.field_name }}
                                <span x-show="activeField === 'prompt:{{ prompt.field_name }}'" class="text-[9px] text-green-500 ml-1">NUMPAD</span>
                            </label>
                            <div class="flex gap-1">
                                {% if prompt.field_name == 'eft_no' and eft_terminals %}
                                <!-- EFT Terminal dropdown from master data -->
                                <select data-prompt-field="{{ prompt.field_name }}"
                                        x-model="promptValues['{{ prompt.field_name }}']"
                                        @change="syncDisplay()"
                                        class="w-full px-2.5 py-1.5 border-2 border-gray-200 rounded-lg text-xs focus:border-green-500 outline-none font-mono bg-white">
                                    <option value="">-- Pilih EFT Terminal --</option>
                                    {% for eft in eft_terminals %}
                                    <option value="{{ eft.code }}">{{ eft.code }}: {{ eft.name }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="text"
                                       data-prompt-field="{{ prompt.field_name }}"
                                       placeholder="{{ prompt.placeholder|default:'' }}"
                                       maxlength="{{ prompt.max_length|default:99 }}"
                                       x-model="promptValues['{{ prompt.field_name }}']"
                                       @focus="activeField = 'prompt:{{ prompt.field_name }}'"
                                       @input="syncDisplay()"
                                       class="w-full px-2.5 py-1.5 border-2 rounded-lg text-xs outline-none transition-all {% if prompt.field_type == 'numeric' %}font-mono{% endif %}"
                                       :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200'">
                                {% endif %}
                                {% if prompt.use_scanner %}
                                <button type="button" @click="activateScanner('{{ prompt.field_name }}'); activeField = 'prompt:{{ prompt.field_name }}'"
                                        class="px-2 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition flex-shrink-0">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    <!-- Legacy Reference Input (Non-profile mode) -->
                    {% if not use_profiles %}
                    {% for pm in payment_methods_list %}
                    {% if pm.ref %}
                    <div x-show="method === '{{ pm.id }}'" x-cloak class="mb-2">
                        <input type="text"
                               x-model="reference"
                               placeholder="{{ pm.refPlaceholder|default:'Reference' }}"
                               class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-xs focus:border-green-500 outline-none">
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    <!-- Numpad target indicator -->
                    <div x-show="activeField && activeField.startsWith('prompt:')" x-cloak
                         class="flex items-center gap-1.5 mb-1.5 px-2 py-1 bg-green-50 border border-green-200 rounded-lg">
                        <svg class="w-3 h-3 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                        </svg>
                        <span class="text-[10px] font-bold text-green-700">Numpad → <span x-text="activeField.substring(7).toUpperCase()"></span></span>
                        <button type="button" @click="activeField = 'amount'" class="ml-auto text-[9px] font-bold text-green-600 hover:text-green-800 bg-green-100 px-1.5 py-0.5 rounded">
                            ← Amount
                        </button>
                    </div>

                    <!-- Numpad -->
                    <div class="grid grid-cols-4 gap-1.5 mb-2">
                        <button type="button" @click="numpad('7')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">7</button>
                        <button type="button" @click="numpad('8')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">8</button>
                        <button type="button" @click="numpad('9')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">9</button>
                        <button type="button" @click="numpad('DEL')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-amber-100 text-amber-800 hover:bg-amber-200" style="height:44px;">&#9003;</button>
                        <button type="button" @click="numpad('4')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">4</button>
                        <button type="button" @click="numpad('5')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">5</button>
                        <button type="button" @click="numpad('6')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">6</button>
                        <button type="button" @click="numpad('C')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-red-100 text-red-800 hover:bg-red-200" style="height:44px;">C</button>
                        <button type="button" @click="numpad('1')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">1</button>
                        <button type="button" @click="numpad('2')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">2</button>
                        <button type="button" @click="numpad('3')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">3</button>
                        <button type="button" @click="numpad('00')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">00</button>
                        <button type="button" @click="numpad('0')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">0</button>
                        <button type="button" @click="numpad('000')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">000</button>
                    </div>

                    <!-- Quick Amounts -->
                    <div class="grid grid-cols-4 gap-1.5">
                        <button type="button" @click="setAmount(remaining)"
                                class="py-2 rounded-lg bg-green-600 text-white font-bold text-xs hover:bg-green-700 active:scale-95 transition-all">
                            Exact
                        </button>
                        <button type="button" @click="setAmount(50000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            50K
                        </button>
                        <button type="button" @click="setAmount(100000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            100K
                        </button>
                        <button type="button" @click="setAmount(Math.ceil(remaining/50000)*50000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            Round
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="p-2.5 border-t bg-gray-50 flex gap-2" style="flex-shrink:0;">
            <button type="button" onclick="closeModal()"
                    class="px-5 py-2.5 rounded-lg font-bold text-xs bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 transition-all">
                Cancel
            </button>
            <button type="button"
                    x-show="amount > 0 && (payments.length > 0 || amount < total)"
                    x-cloak
                    @click="addPayment()"
                    class="px-4 py-2.5 rounded-lg font-bold text-xs bg-blue-600 hover:bg-blue-700 text-white transition-all">
                <span class="flex items-center justify-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    + Split
                </span>
            </button>
            <button type="button"
                    @click="submitPayment()"
                    :disabled="!canPay"
                    class="flex-1 py-2.5 rounded-lg font-bold text-sm transition-all"
                    :class="canPay ? 'bg-green-600 hover:bg-green-700 text-white shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span x-text="canPay ? 'Bayar Rp ' + fmt(payments.length > 0 ? paidTotal : amount) : 'Masukkan Nominal'"></span>
                </span>
            </button>
        </div>
    </div>
</div>

<style>
[x-cloak] { display: none !important; }
/* Touch screen fixes: eliminate 300ms tap delay + improve responsiveness */
[data-payment-modal] { touch-action: manipulation; }
[data-payment-modal] button,
[data-payment-modal] select,
[data-payment-modal] input {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    cursor: pointer;
}
</style>

<!-- Init Alpine: clone element without x-ignore so Alpine's MO handles it naturally.
     No x-for with non-empty arrays remains, so the initTree marker bug is avoided.
     Touch fix: use rAF to ensure DOM is settled before clone+replace. -->
<script>
(function() {
    var el = document.querySelector('[data-payment-modal]');
    if (!el || typeof Alpine === 'undefined') return;

    // Use requestAnimationFrame for more reliable timing on touch devices
    requestAnimationFrame(function() {
        setTimeout(function() {
            if (el._x_dataStack) return;
            var clone = el.cloneNode(true);
            clone.removeAttribute('x-ignore');
            el.parentNode.replaceChild(clone, el);
            // Tell HTMX to process hx-* attributes on the cloned elements
            if (typeof htmx !== 'undefined') htmx.process(clone);
            console.log('[Payment Modal] Alpine clone+replace done, touch ready');
        }, 0);
    });
})();
</script>
