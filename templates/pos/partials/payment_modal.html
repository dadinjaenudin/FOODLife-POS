{% load humanize %}
<!--
============================================================================
PAYMENT MODAL (payment_modal.html) — v11
============================================================================
Modal pembayaran utama di POS. Dipanggil saat kasir klik tombol "Payment"
(F2) pada bill yang aktif.

DIPANGGIL DARI:
  - Bill panel: tombol "Payment" → HTMX GET {% url 'pos:payment_modal' bill.id %}
  - Keyboard shortcut F2 (keyboard_shortcuts.html)
  - Inject ke #modal-container via hx-target="#modal-container" hx-swap="innerHTML"

ARSITEKTUR: Django Template + Alpine.js + HTMX
===============================================
File ini adalah Django template yang di-render server-side, lalu di-inject
ke halaman POS via HTMX. Setelah inject, Alpine.js mengelola semua state
dan interaksi di client-side (tanpa reload).

SERVER → CLIENT DATA FLOW:
┌─────────────────────────────────────────────────────────┐
│  Django View: payment_modal() (apps/pos/views.py)       │
│  - Load PaymentMethodProfile dari terminal.payment_profiles │
│  - Prefetch DataEntryPrompt per profil                  │
│  - Serialize ke payment_methods_json (array of objects)  │
│  - Load EFTTerminal master data                         │
│  - Render template ini dengan context:                  │
│    • bill, total_int, payment_methods_json               │
│    • payment_methods_list (untuk server-side rendering)   │
│    • use_profiles (bool), default_method                 │
│    • eft_terminals (master data dropdown)                │
└──────────┬──────────────────────────────────────────────┘
           │ HTML response (HTMX swap ke #modal-container)
           ▼
┌─────────────────────────────────────────────────────────┐
│  Browser: Alpine.js component paymentModal()            │
│  - Parse payment_methods_json → array of payment methods │
│  - Manage state: amount, method, payments[], promptValues │
│  - Numpad routing: amount field ↔ prompt fields          │
│  - syncDisplay() → kirim clone ke customer display (SSE) │
└──────────┬──────────────────────────────────────────────┘
           │ Form submit via HTMX POST
           ▼
┌─────────────────────────────────────────────────────────┐
│  Django View: process_payment() (apps/pos/views.py)     │
│  - Baca: method, amount, reference, profile_id,          │
│    prompt_data, payments[] (split)                       │
│  - Buat Payment record(s) di database                   │
│  - Update Bill status → paid                            │
│  - Return: payment_success.html (inject ke modal)        │
└─────────────────────────────────────────────────────────┘

LAYOUT VISUAL:
┌────────────────────────────────────────────────────┐
│  Header: "Payment" + Bill Number + Table           │
├────────────────────────────────────────────────────┤
│  Summary Cards:  [Total]  [Bayar]  [Kembalian/Sisa]│
├────────────────────────────────────────────────────┤
│  Applied Payments (jika split): Cash 50K  Card 50K │
├──────────────┬─────────────────────────────────────┤
│  LEFT (30%)  │  RIGHT (70%)                        │
│              │                                     │
│  Metode:     │  [Rp ____________] Amount Input     │
│  ○ Cash      │                                     │
│  ● Card  ←── │  [Account No: ____]  ← Prompt       │
│  ○ QRIS      │  [EFT No: ▾ BCA ]  ← Dropdown      │
│  ○ DANA      │  [Approval: _____]  ← Prompt        │
│  ○ Voucher   │                                     │
│              │  [Numpad → APPROVAL_CODE]  Indicator │
│              │  ┌───┬───┬───┬───┐                  │
│              │  │ 7 │ 8 │ 9 │DEL│  Numpad          │
│              │  │ 4 │ 5 │ 6 │ C │                  │
│              │  │ 1 │ 2 │ 3 │00 │                  │
│              │  │ 0 │000│   │   │                  │
│              │  ├───┼───┼───┼───┤                  │
│              │  │Ext│50K│100│Rnd│  Quick Amount     │
│              │  └───┴───┴───┴───┘                  │
├──────────────┴─────────────────────────────────────┤
│  [Cancel]  [+ Split]  [====== Bayar Rp XXX ======] │
└────────────────────────────────────────────────────┘

KONSEP UTAMA:
=============

1. DYNAMIC PAYMENT PROFILES (use_profiles=true)
   Metode pembayaran dikonfigurasi dari backoffice (PaymentMethodProfile model).
   Setiap profil bisa punya "Data Entry Prompts" — field input tambahan
   seperti account_no, eft_no, approval_code, qrcontent.

   Contoh: Credit Card punya 3 prompts:
   - account_no (6 digit, numeric)
   - eft_no (dropdown dari EFTTerminal master data)
   - approval_code (4-6 digit, numeric)

   Jika terminal belum dikonfigurasi profil → fallback ke mode legacy
   (hardcoded methods tanpa dynamic prompts).

2. NUMPAD ROUTING
   Numpad on-screen bisa memasukkan angka ke 2 target berbeda:
   - Amount field (default) → untuk input nominal pembayaran
   - Prompt field (jika diklik) → untuk input data seperti approval code

   State `activeField` menentukan target:
   - 'amount' → numpad input ke amount
   - 'prompt:account_no' → numpad input ke field account_no
   - 'prompt:approval_code' → numpad input ke field approval_code

   Visual indicator hijau muncul saat numpad diarahkan ke prompt field.
   Tombol "← Amount" untuk kembali ke mode amount.

3. SPLIT PAYMENT
   Kasir bisa membagi pembayaran ke beberapa metode:
   - Klik "+ Split" untuk menambahkan pembayaran parsial ke list
   - Setiap split punya: method, amount, reference, profile_id, prompt_data
   - Sisa (remaining) otomatis dihitung
   - "Bayar" hanya aktif jika total payments >= total bill

   Contoh: Bill Rp 200.000
   → Cash Rp 100.000 (klik + Split)
   → Card Rp 100.000 (klik Bayar)

4. CUSTOMER DISPLAY SYNC
   Setiap perubahan state (ketik angka, ganti metode, tambah split)
   otomatis di-sync ke layar customer via:
   syncDisplay() → 400ms debounce → sendModalToCustomerDisplay()
   → Clone modal → Fix URL → Kirim ke Flask API → SSE → Customer Display

5. ALPINE.JS + HTMX INITIALIZATION TRICK
   Modal ini menggunakan x-ignore pada element utama agar Alpine.js
   TIDAK auto-initialize saat HTMX inject HTML. Kemudian script di bawah
   melakukan clone+replace tanpa x-ignore, sehingga Alpine init secara
   natural. Ini menghindari bug "initTree" pada Alpine.js saat dipakai
   dengan HTMX swap.

6. FORM SUBMISSION
   Form dikirim via HTMX POST ke process_payment endpoint.
   Hidden inputs berisi semua data yang diperlukan:
   - method, amount, reference (pembayaran saat ini)
   - profile_id, prompt_data (untuk dynamic profiles)
   - payments[0..N][method/amount/reference/profile_id/prompt_data] (split)

CONTEXT VARIABLES (dari Django view):
=====================================
- bill                  : Object Bill aktif (id, bill_number, table, total)
- total_int             : Integer total bill (tanpa desimal)
- payment_methods_json  : JSON array metode pembayaran, contoh:
                          [{"id":"cash","label":"Cash","color":"#16a34a",
                            "profile_id":"uuid","method_id":"cash",
                            "allow_change":true,"prompts":[...]}]
- payment_methods_list  : QuerySet/list objek untuk server-side rendering
                          (setiap objek punya: id, label, color, prompts[], ref, refPlaceholder)
- use_profiles          : Boolean — true jika terminal punya payment profiles
- default_method        : String ID metode default (biasanya 'cash')
- eft_terminals         : QuerySet EFTTerminal untuk dropdown eft_no

ALPINE.JS STATE (paymentModal()):
==================================
- method          : String ID metode terpilih (misal 'cash', 'credit_card')
- amount          : Integer nominal input (misal 50000)
- amountDisplay   : String formatted (misal '50,000')
- reference       : String referensi legacy (non-profile mode)
- promptValues    : Object {field_name: value} untuk dynamic prompts
                    Contoh: {account_no: '123456', eft_no: '01', approval_code: 'ABC'}
- payments[]      : Array split payments yang sudah di-add
- activeField     : String target numpad ('amount' atau 'prompt:field_name')
- total           : Integer total bill (read-only)

COMPUTED PROPERTIES:
- selectedMethod    → Object metode terpilih dari paymentMethods array
- currentProfileId  → UUID profile_id (untuk hidden input)
- currentMethodId   → String method_id legacy (cash/card/qris/dll)
- currentAllowChange→ Boolean apakah metode ini boleh kembalian
- promptDataJson    → JSON string dari promptValues (untuk hidden input)
- paidTotal         → Sum semua payments[].amount
- remaining         → total - paidTotal (minimum 0)
- changeAmount      → Kembalian (hanya jika allow_change dan bayar > total)
- canPay            → Boolean apakah tombol "Bayar" aktif

FILE TERKAIT:
- apps/pos/views.py → payment_modal() (line ~1699) dan process_payment() (line ~1901)
- apps/core/models.py → PaymentMethodProfile, DataEntryPrompt, EFTTerminal
- apps/pos/models.py → Payment (payment_profile, payment_metadata)
- templates/pos/partials/payment_success.html → Halaman sukses setelah bayar
- templates/pos/partials/main/js/launcher_integration.html → sendModalToCustomerDisplay()
============================================================================
-->

<!--
PENTING: Script paymentModal() harus di-define SEBELUM HTML-nya.
Karena HTMX menjalankan <script> setelah DOM insert, Alpine.js butuh
function ini sudah ada saat x-data="paymentModal()" di-evaluate.
-->
<script>
/**
 * paymentModal() — Alpine.js component untuk seluruh payment modal.
 *
 * CATATAN: Menggunakan `var` dan `function(){}` (bukan arrow function)
 * agar kompatibel dengan Alpine.js proxy + touch device.
 */
function paymentModal() {
    // ===== DATA DARI SERVER (Django template tags) =====
    // payment_methods_json berisi array of objects, contoh:
    // [{id:"cash", label:"Cash", color:"#16a34a", profile_id:"uuid-xxx",
    //   method_id:"cash", allow_change:true, prompts:[{field_name:"...", label:"..."}]}]
    var _paymentMethods = [];
    try { _paymentMethods = {{ payment_methods_json|safe }}; } catch(e) {}
    var _useProfiles = {{ use_profiles|yesno:"true,false" }};  // true jika terminal punya payment profiles
    var _defaultMethod = '{{ default_method|escapejs }}' || 'cash';  // metode default saat modal dibuka

    return {
        // ===== REACTIVE STATE =====
        useProfiles: _useProfiles,        // Mode profil dinamis atau legacy
        paymentMethods: _paymentMethods,  // Array semua metode pembayaran
        method: _defaultMethod,           // ID metode terpilih saat ini
        amount: 0,                        // Nominal input (integer, tanpa format)
        amountDisplay: '',                // Nominal terformat untuk display ('50,000')
        reference: '',                    // Referensi legacy (hanya non-profile mode)
        promptValues: {},                 // Data entry prompts: {field_name: value}
        total: parseInt('{{ total_int|escapejs }}') || 0,  // Total bill (read-only)
        payments: [],                     // Array split payments yang sudah di-add
        activeField: 'amount',            // Target numpad: 'amount' atau 'prompt:field_name'
        _syncTimer: null,                 // Debounce timer untuk syncDisplay()

        // ===== COMPUTED PROPERTIES =====

        /** Object metode pembayaran yang sedang dipilih */
        get selectedMethod() {
            return this.paymentMethods.find(m => m.id === this.method) || null;
        },

        /** UUID payment profile (untuk hidden input form) */
        get currentProfileId() {
            var sm = this.selectedMethod;
            return (sm && sm.profile_id) ? sm.profile_id : '';
        },

        /** Legacy method ID: 'cash'/'card'/'qris'/dll (untuk backward compat) */
        get currentMethodId() {
            var sm = this.selectedMethod;
            return (sm && sm.method_id) ? sm.method_id : this.method;
        },

        /** Apakah metode ini boleh kasih kembalian (true untuk cash) */
        get currentAllowChange() {
            var sm = this.selectedMethod;
            return sm ? (sm.allow_change !== false) : true;
        },

        /** JSON string dari promptValues untuk dikirim ke server via hidden input */
        get promptDataJson() {
            if (!this.useProfiles) return '';
            var vals = this.promptValues;
            var hasAny = false;
            for (var k in vals) { if (vals[k]) { hasAny = true; break; } }
            return hasAny ? JSON.stringify(vals) : '';
        },

        /** Total semua split payments yang sudah di-add */
        get paidTotal() {
            var sum = 0;
            for (var i = 0; i < this.payments.length; i++) sum += this.payments[i].amount;
            return sum;
        },

        /** Sisa yang harus dibayar (total - sudah dibayar) */
        get remaining() {
            var r = this.total - this.paidTotal;
            return r > 0 ? r : 0;
        },

        /** Angka "Bayar" yang ditampilkan di summary card */
        get displayPaying() {
            return this.payments.length > 0 ? this.paidTotal : this.amount;
        },

        /**
         * Kembalian — hanya muncul jika:
         * - Single payment: amount > total DAN metode allow_change
         * - Split payment: paidTotal > total DAN payment terakhir allow_change
         * Non-cash (allow_change=false) TIDAK boleh bayar lebih dari sisa
         */
        get changeAmount() {
            if (this.payments.length === 0 && this.currentAllowChange && this.amount > this.total) {
                return this.amount - this.total;
            }
            if (this.payments.length > 0 && this.paidTotal > this.total) {
                var lastPmt = this.payments[this.payments.length - 1];
                var lastMethod = this.paymentMethods.find(function(m) { return m.id === lastPmt.method; });
                if (lastMethod && lastMethod.allow_change !== false) return this.paidTotal - this.total;
            }
            return 0;
        },

        /**
         * HTML untuk menampilkan list split payments yang sudah di-add.
         * Menggunakan x-html (bukan x-for) untuk menghindari bug Alpine.js initTree
         * saat dipakai dengan HTMX swap.
         */
        get paymentsListHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                h += '<div class="flex items-center gap-1.5 bg-white border rounded-lg px-2 py-1">';
                h += '<div class="w-2 h-2 rounded-full flex-shrink-0" style="background:' + this.getMethodColor(p.method) + '"></div>';
                h += '<span class="text-[11px] font-bold text-gray-700">' + this.getMethodLabel(p.method) + '</span>';
                h += '<span class="text-[11px] font-bold text-green-600">Rp ' + this.fmt(p.amount) + '</span>';
                h += '<button type="button" data-rm="' + i + '" class="w-4 h-4 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded">';
                h += '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                h += '</button></div>';
            }
            return h;
        },

        /**
         * Hidden inputs untuk split payments — dikirim ke server saat form submit.
         * Format: payments[0][method], payments[0][amount], payments[0][reference], dll.
         * Server-side process_payment() membaca array ini untuk membuat Payment records.
         */
        get paymentsHiddenHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                var mid = (p.method_id || p.method || '').replace(/"/g, '&quot;');
                var ref = (p.reference || '').replace(/"/g, '&quot;');
                var pid = (p.profile_id || '').replace(/"/g, '&quot;');
                var pd = (p.prompt_data || '').replace(/"/g, '&quot;');
                h += '<input type="hidden" name="payments[' + i + '][method]" value="' + mid + '">';
                h += '<input type="hidden" name="payments[' + i + '][amount]" value="' + p.amount + '">';
                h += '<input type="hidden" name="payments[' + i + '][reference]" value="' + ref + '">';
                h += '<input type="hidden" name="payments[' + i + '][profile_id]" value="' + pid + '">';
                h += '<input type="hidden" name="payments[' + i + '][prompt_data]" value="' + pd + '">';
            }
            return h;
        },

        /**
         * Validasi: tombol "Bayar" aktif jika:
         * - Single payment: amount >= total DAN amount > 0
         * - Split payment: total semua payments >= total bill
         */
        get canPay() {
            if (this.payments.length === 0) return this.amount >= this.total && this.amount > 0;
            return this.paidTotal >= this.total;
        },

        // ===== METHODS =====

        /** Format angka ke string dengan separator ribuan: 50000 → '50,000' */
        fmt(n) {
            if (!n && n !== 0) return '0';
            return Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        },

        /** Cari label metode berdasarkan ID (untuk display di split payments list) */
        getMethodLabel(id) {
            var m = this.paymentMethods.find(function(pm) { return pm.id === id; });
            return m ? m.label : id;
        },

        /** Cari warna metode berdasarkan ID (untuk color dot di split payments list) */
        getMethodColor(id) {
            var m = this.paymentMethods.find(function(pm) { return pm.id === id; });
            return m ? m.color : '#6b7280';
        },

        /** Handler saat user ketik langsung di input amount (bukan numpad) */
        onInput(val) {
            var clean = val.replace(/\D/g, '');
            this.amount = clean ? parseInt(clean) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
            this.syncDisplay();
        },

        /**
         * Handler numpad (0-9, 00, 000, DEL, C).
         * Routing berdasarkan activeField:
         * - 'prompt:xxx' → append/delete ke promptValues[xxx]
         * - 'amount' (default) → append/delete ke amount
         */
        numpad(key) {
            // Route numpad ke prompt field jika activeField = 'prompt:xxx'
            if (this.activeField && this.activeField.startsWith('prompt:')) {
                var fieldName = this.activeField.substring(7);  // 'prompt:account_no' → 'account_no'
                var val = this.promptValues[fieldName] || '';
                if (key === 'C') val = '';
                else if (key === 'DEL') val = val.slice(0, -1);
                else val = val + key;
                this.promptValues[fieldName] = val;
                this.syncDisplay();
                return;
            }
            // Default: numpad ke amount field
            var raw = this.amount.toString();
            if (key === 'C') raw = '';
            else if (key === 'DEL') raw = raw.slice(0, -1);
            else raw = raw + key;
            this.amount = raw ? parseInt(raw) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
            this.syncDisplay();
        },

        /** Set amount langsung (dari quick amount buttons: Exact, 50K, 100K, Round) */
        setAmount(val) {
            this.activeField = 'amount';
            this.amount = val;
            this.amountDisplay = this.fmt(val);
            this.syncDisplay();
        },

        /** Ganti metode pembayaran — reset semua input prompt dan kembali ke amount */
        setMethod(id) {
            this.method = id;
            this.reference = '';
            this.promptValues = {};
            this.activeField = 'amount';
            this.syncDisplay();
        },

        /** Set activeField saat user klik/focus prompt field */
        focusField(fieldName) {
            this.activeField = fieldName;
        },

        /**
         * Sync state ke customer display (debounce 400ms).
         * Memanggil sendModalToCustomerDisplay() di launcher_integration.html
         * yang akan clone modal → fix URL → kirim via SSE ke layar customer.
         */
        syncDisplay() {
            if (this._syncTimer) clearTimeout(this._syncTimer);
            this._syncTimer = setTimeout(function() {
                if (typeof sendModalToCustomerDisplay === 'function') sendModalToCustomerDisplay();
            }, 400);
        },

        /** Focus ke input field barcode scanner (untuk prompt dengan use_scanner=true) */
        activateScanner(fieldName) {
            var self = this;
            this.$nextTick(function() {
                var input = self.$el.querySelector('[data-prompt-field="' + fieldName + '"]');
                if (input) input.focus();
            });
        },

        /**
         * Tambahkan pembayaran ke split list.
         * Validasi: amount > 0, dan jika non-cash (allow_change=false) tidak boleh > remaining.
         * Setelah add: reset amount, reference, promptValues, kembali ke activeField='amount'.
         */
        addPayment() {
            if (this.amount <= 0) return;
            if (!this.currentAllowChange && this.amount > this.remaining) return;
            this.payments.push({
                method: this.method,
                method_id: this.currentMethodId,
                amount: this.amount,
                reference: this.reference,
                profile_id: this.currentProfileId,
                prompt_data: this.promptDataJson
            });
            this.amount = 0;
            this.amountDisplay = '';
            this.reference = '';
            this.promptValues = {};
            this.activeField = 'amount';
            this.syncDisplay();
        },

        /** Hapus split payment dari list berdasarkan index */
        removePayment(idx) {
            this.payments.splice(idx, 1);
            this.syncDisplay();
        },

        /**
         * Submit pembayaran — trigger HTMX POST ke process_payment endpoint.
         * Form berisi: method, amount, reference, profile_id, prompt_data,
         * + payments[0..N] untuk split payments.
         * Server akan membuat Payment record(s) dan return payment_success.html.
         */
        submitPayment() {
            console.log('[Payment] submitPayment called, canPay:', this.canPay, 'amount:', this.amount, 'total:', this.total, 'payments:', this.payments.length);
            if (!this.canPay) return;
            if (this.payments.length > 0 && this.paidTotal >= this.total) this.amount = 0;
            var form = document.getElementById('payment-form');
            console.log('[Payment] form found:', !!form, 'htmx:', typeof htmx);
            if (form && typeof htmx !== 'undefined') {
                htmx.trigger(form, 'submit');
            } else if (form) {
                form.submit();
            }
        },

        /** Init: set flag _paymentModalActive dan auto-focus ke input amount */
        init() {
            // Flag ini digunakan oleh htmx_handlers.html untuk memblokir
            // HTMX request lain ke #modal-container saat payment modal aktif
            window._paymentModalActive = true;
            this.$nextTick(() => {
                var input = this.$el.querySelector('input[name=amount_display]');
                if (input) input.focus();
            });
        }
    };
}

/**
 * Tutup modal pembayaran.
 * Reset flag _paymentModalActive dan clear modal container.
 * Juga clear modal di customer display via sendModalToCustomerDisplay().
 */
function closeModal() {
    window._paymentModalActive = false;
    document.getElementById('modal-container').innerHTML = '';
    if (typeof sendModalToCustomerDisplay === 'function') sendModalToCustomerDisplay();
}
</script>

<!--
    MODAL CONTAINER
    - data-payment-modal: Marker agar sendModalToCustomerDisplay() tahu ini payment modal (whitelist)
    - x-data="paymentModal()": Alpine.js component (defined di <script> di atas)
    - x-ignore: PENTING — mencegah Alpine auto-init saat HTMX inject.
      Script di bawah akan clone element tanpa x-ignore untuk init yang benar.
      Tanpa trick ini, Alpine.js bug "initTree" terjadi saat HTMX swap.
-->
<div class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-2"
     data-payment-modal
     x-data="paymentModal()"
     x-init="init()"
     x-ignore>

    <div class="bg-white rounded-xl w-full shadow-2xl overflow-hidden"
         style="max-width: 720px; max-height: calc(100vh - 16px); display:flex; flex-direction:column;"
         @click.stop>

        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5" style="flex-shrink:0;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold">Payment</h3>
                        <p class="text-green-100 text-[10px]">{{ bill.bill_number }}{% if bill.table %} &middot; Table {{ bill.table.number }}{% endif %}</p>
                    </div>
                </div>
                <button onclick="closeModal()" type="button"
                        class="w-7 h-7 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!--
            SUMMARY CARDS — 3 kartu ringkasan di atas:
            1. Total: total bill (read-only)
            2. Bayar: jumlah yang sedang/sudah dibayar (hijau jika >= total, amber jika kurang)
            3. Kembalian/Sisa: kembalian (hijau) atau sisa belum bayar (amber)
        -->
        <div class="grid grid-cols-3 gap-2 p-2.5 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="bg-white rounded-lg p-2 border text-center">
                <div class="text-[10px] font-semibold text-gray-500 uppercase">Total</div>
                <div class="text-lg font-bold text-gray-900">Rp <span x-text="fmt(total)"></span></div>
            </div>
            <div class="bg-white rounded-lg p-2 border text-center">
                <div class="text-[10px] font-semibold text-gray-500 uppercase">Bayar</div>
                <div class="text-lg font-bold" :class="displayPaying >= total ? 'text-green-600' : 'text-amber-600'">
                    Rp <span x-text="fmt(displayPaying)"></span>
                </div>
            </div>
            <div class="rounded-lg p-2 border text-center" :class="changeAmount > 0 ? 'bg-green-50 border-green-200' : (payments.length > 0 && paidTotal < total ? 'bg-amber-50 border-amber-200' : 'bg-white')">
                <div class="text-[10px] font-semibold uppercase" :class="changeAmount > 0 ? 'text-green-700' : (payments.length > 0 && paidTotal < total ? 'text-amber-700' : 'text-gray-500')"
                     x-text="changeAmount > 0 ? 'Kembalian' : (payments.length > 0 && paidTotal < total ? 'Sisa' : 'Kembalian')"></div>
                <div class="text-lg font-bold" :class="changeAmount > 0 ? 'text-green-600' : (payments.length > 0 && paidTotal < total ? 'text-amber-600' : 'text-gray-400')">
                    Rp <span x-text="changeAmount > 0 ? fmt(changeAmount) : (payments.length > 0 && paidTotal < total ? fmt(remaining) : fmt(0))"></span>
                </div>
            </div>
        </div>

        <!--
            APPLIED PAYMENTS LIST (Split Payments)
            Tampil jika kasir sudah menambah 1+ split payment via tombol "+ Split".
            Menggunakan x-html (bukan x-for) karena x-for dengan non-empty array
            menyebabkan bug Alpine.js initTree saat HTMX swap.
            Tombol X merah untuk hapus payment dari list.
        -->
        <div x-show="payments.length > 0" x-cloak class="px-2.5 pt-2 pb-1 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1">Pembayaran Tercatat</div>
            <div style="display:flex; flex-wrap:wrap; gap:4px;"
                 x-html="paymentsListHtml"
                 @click="var btn=$event.target.closest('[data-rm]'); if(btn) removePayment(parseInt(btn.dataset.rm))"></div>
        </div>

        <!--
            CONTENT AREA: 30/70 Split Layout
            Kiri (30%): List metode pembayaran (server-rendered)
            Kanan (70%): Input amount + prompts + numpad

            FORM SUBMISSION:
            Form ini dikirim via HTMX POST ke process_payment endpoint.
            Response HTML (payment_success.html) di-inject ke #modal-container.
        -->
        <div style="flex:1 1 0%; min-height:0; display:flex;">
            <form id="payment-form"
                  hx-post="{% url 'pos:process_payment' bill.id %}"
                  hx-target="#modal-container"
                  hx-swap="innerHTML"
                  style="display:flex; flex:1; min-height:0;">
                {% csrf_token %}
                <!--
                    HIDDEN INPUTS — Data pembayaran saat ini.
                    Dibaca oleh process_payment() di server:
                    - method: legacy method ID (cash/card/qris/dll)
                    - amount: nominal pembayaran
                    - reference: referensi legacy (non-profile mode)
                    - profile_id: UUID PaymentMethodProfile
                    - prompt_data: JSON string dari promptValues
                -->
                <input type="hidden" name="method" :value="currentMethodId">
                <input type="hidden" name="amount" :value="amount">
                <input type="hidden" name="reference" :value="reference">
                <input type="hidden" name="profile_id" :value="currentProfileId">
                <input type="hidden" name="prompt_data" :value="promptDataJson">
                <!-- Hidden inputs untuk split payments (payments[0][method], payments[0][amount], dll) -->
                <div x-html="paymentsHiddenHtml"></div>

                <!--
                    LEFT PANEL: Metode Pembayaran (30%)
                    Server-side rendered dari payment_methods_list (Django for loop).
                    Setiap tombol memanggil setMethod(id) yang:
                    1. Ganti metode aktif
                    2. Reset promptValues (karena setiap metode punya prompts berbeda)
                    3. Kembali ke activeField='amount'
                    4. Sync ke customer display

                    Tombol aktif: border hijau + shadow (via Alpine :class binding)
                -->
                <div style="width:30%; flex-shrink:0; border-right:1px solid #e5e7eb; overflow-y:auto;"
                     class="bg-gray-50">
                    <div class="p-2.5">
                        <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-2 px-1">Metode Pembayaran</div>
                        <div class="flex flex-col gap-1.5">
                            {% for pm in payment_methods_list %}
                            <button type="button"
                                    @click="setMethod('{{ pm.id }}')"
                                    class="flex items-center gap-2.5 rounded-xl border-2 transition-all px-3 py-2.5 w-full text-left"
                                    :class="method === '{{ pm.id }}'
                                        ? 'border-green-500 bg-white text-green-800 shadow-md shadow-green-500/10'
                                        : 'border-transparent bg-white/60 text-gray-600 hover:bg-white hover:border-gray-200 hover:shadow-sm'">
                                <div class="flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center shadow-sm"
                                     style="background: {{ pm.color }}">
                                    <svg class="w-3.5 h-3.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                        <circle cx="10" cy="10" r="4"/>
                                    </svg>
                                </div>
                                <span class="font-bold text-xs leading-tight">{{ pm.label }}</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!--
                    RIGHT PANEL: Amount + Prompts + Numpad (70%)
                    Berisi 4 bagian dari atas ke bawah:
                    1. Amount Input — input nominal pembayaran
                    2. Dynamic Prompts — field tambahan per metode (account_no, eft_no, dll)
                    3. Numpad — 0-9, 00, 000, DEL, C (routing ke amount atau prompt)
                    4. Quick Amounts — tombol Exact, 50K, 100K, Round
                -->
                <div style="width:70%; overflow-y:auto;" class="p-3">
                    <!--
                        AMOUNT INPUT
                        Border hijau saat fokus (activeField='amount').
                        Border merah jika non-cash dan amount > remaining (overpayment blocked).
                        Klik area input → set activeField='amount' (numpad routing).
                    -->
                    <div class="flex items-center border-2 rounded-xl mb-2.5 bg-white transition-all"
                         :class="!currentAllowChange && amount > remaining ? 'border-red-300' : (activeField === 'amount' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200')"
                         @click="activeField = 'amount'; $el.querySelector('input').focus()">
                        <span class="pl-3 font-bold text-base" :class="activeField === 'amount' ? 'text-green-600' : 'text-gray-400'">Rp</span>
                        <input type="text"
                               name="amount_display"
                               x-model="amountDisplay"
                               @input="onInput($event.target.value)"
                               @focus="activeField = 'amount'"
                               class="w-full pr-3 py-2.5 pl-1 text-right text-xl font-bold bg-transparent outline-none"
                               placeholder="0"
                               inputmode="numeric"
                               autocomplete="off">
                    </div>

                    <!--
                        DYNAMIC DATA ENTRY PROMPTS (Profile Mode)
                        Server-side rendered: Django loop semua metode + prompts-nya.
                        Client-side toggle: x-show="method === 'xxx'" — hanya tampil
                        untuk metode yang sedang dipilih.

                        Setiap prompt bisa berupa:
                        - Text input biasa (account_no, approval_code)
                        - Dropdown/select (eft_no → dari EFTTerminal master data)
                        - Scanner button (qrcontent → tombol scan barcode/QR)

                        Prompt fields punya data-prompt-field="xxx" attribute
                        agar sendModalToCustomerDisplay() bisa capture nilainya
                        saat clone modal ke customer display.

                        @focus pada input → set activeField='prompt:field_name'
                        → numpad akan route ke field ini (bukan amount).
                    -->
                    {% if use_profiles %}
                    {% for pm in payment_methods_list %}
                    {% if pm.prompts %}
                    <div x-show="method === '{{ pm.id }}'" x-cloak class="space-y-1.5 mb-2.5">
                        {% for prompt in pm.prompts %}
                        <div>
                            <label class="text-[10px] font-semibold uppercase transition-colors"
                                   :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'text-green-600' : 'text-gray-500'">
                                {{ prompt.label|default:prompt.field_name }}
                                <span x-show="activeField === 'prompt:{{ prompt.field_name }}'" class="text-[9px] text-green-500 ml-1">NUMPAD</span>
                            </label>
                            <div class="flex gap-1">
                                {% if prompt.field_name == 'eft_no' and eft_terminals %}
                                <!-- EFT Terminal dropdown from master data -->
                                <select data-prompt-field="{{ prompt.field_name }}"
                                        x-model="promptValues['{{ prompt.field_name }}']"
                                        @change="syncDisplay()"
                                        class="w-full px-2.5 py-1.5 border-2 border-gray-200 rounded-lg text-xs focus:border-green-500 outline-none font-mono bg-white">
                                    <option value="">-- Pilih EFT Terminal --</option>
                                    {% for eft in eft_terminals %}
                                    <option value="{{ eft.code }}">{{ eft.code }}: {{ eft.name }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="text"
                                       data-prompt-field="{{ prompt.field_name }}"
                                       placeholder="{{ prompt.placeholder|default:'' }}"
                                       maxlength="{{ prompt.max_length|default:99 }}"
                                       x-model="promptValues['{{ prompt.field_name }}']"
                                       @focus="activeField = 'prompt:{{ prompt.field_name }}'"
                                       @input="syncDisplay()"
                                       class="w-full px-2.5 py-1.5 border-2 rounded-lg text-xs outline-none transition-all {% if prompt.field_type == 'numeric' %}font-mono{% endif %}"
                                       :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200'">
                                {% endif %}
                                {% if prompt.use_scanner %}
                                <button type="button" @click="activateScanner('{{ prompt.field_name }}'); activeField = 'prompt:{{ prompt.field_name }}'"
                                        class="px-2 py-1.5 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition flex-shrink-0">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    <!--
                        LEGACY REFERENCE INPUT (Non-Profile Mode)
                        Ditampilkan jika use_profiles=false (terminal belum punya payment profiles).
                        Satu field "Reference" generic per metode yang punya ref=true.
                        Akan di-phase out setelah semua terminal pakai dynamic profiles.
                    -->
                    {% if not use_profiles %}
                    {% for pm in payment_methods_list %}
                    {% if pm.ref %}
                    <div x-show="method === '{{ pm.id }}'" x-cloak class="mb-2">
                        <input type="text"
                               x-model="reference"
                               placeholder="{{ pm.refPlaceholder|default:'Reference' }}"
                               class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-xs focus:border-green-500 outline-none">
                    </div>
                    {% endif %}
                    {% endfor %}
                    {% endif %}

                    <!--
                        NUMPAD TARGET INDICATOR
                        Muncul saat activeField = 'prompt:xxx' (numpad diarahkan ke prompt field).
                        Menampilkan nama field yang sedang menerima input numpad.
                        Tombol "← Amount" untuk kembali routing numpad ke amount.
                    -->
                    <div x-show="activeField && activeField.startsWith('prompt:')" x-cloak
                         class="flex items-center gap-1.5 mb-1.5 px-2 py-1 bg-green-50 border border-green-200 rounded-lg">
                        <svg class="w-3 h-3 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                        </svg>
                        <span class="text-[10px] font-bold text-green-700">Numpad → <span x-text="activeField.substring(7).toUpperCase()"></span></span>
                        <button type="button" @click="activeField = 'amount'" class="ml-auto text-[9px] font-bold text-green-600 hover:text-green-800 bg-green-100 px-1.5 py-0.5 rounded">
                            ← Amount
                        </button>
                    </div>

                    <!--
                        NUMPAD — Grid 4 kolom, 4 baris.
                        Setiap tombol memanggil numpad(key) yang route ke:
                        - activeField='amount' → append angka ke amount
                        - activeField='prompt:xxx' → append angka ke promptValues[xxx]
                        Tombol spesial: DEL (hapus 1 digit), C (clear semua)
                        Tombol 00 dan 000 untuk input cepat ribuan.
                    -->
                    <div class="grid grid-cols-4 gap-1.5 mb-2">
                        <button type="button" @click="numpad('7')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">7</button>
                        <button type="button" @click="numpad('8')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">8</button>
                        <button type="button" @click="numpad('9')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">9</button>
                        <button type="button" @click="numpad('DEL')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-amber-100 text-amber-800 hover:bg-amber-200" style="height:44px;">&#9003;</button>
                        <button type="button" @click="numpad('4')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">4</button>
                        <button type="button" @click="numpad('5')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">5</button>
                        <button type="button" @click="numpad('6')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">6</button>
                        <button type="button" @click="numpad('C')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-red-100 text-red-800 hover:bg-red-200" style="height:44px;">C</button>
                        <button type="button" @click="numpad('1')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">1</button>
                        <button type="button" @click="numpad('2')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">2</button>
                        <button type="button" @click="numpad('3')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">3</button>
                        <button type="button" @click="numpad('00')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">00</button>
                        <button type="button" @click="numpad('0')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">0</button>
                        <button type="button" @click="numpad('000')" class="rounded-lg font-bold text-base transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:44px;">000</button>
                    </div>

                    <!--
                        QUICK AMOUNT BUTTONS
                        - Exact: set amount = remaining (bayar pas)
                        - 50K: set amount = 50.000
                        - 100K: set amount = 100.000
                        - Round: pembulatan ke atas kelipatan 50.000
                        Semua memanggil setAmount() yang juga reset activeField ke 'amount'.
                    -->
                    <div class="grid grid-cols-4 gap-1.5">
                        <button type="button" @click="setAmount(remaining)"
                                class="py-2 rounded-lg bg-green-600 text-white font-bold text-xs hover:bg-green-700 active:scale-95 transition-all">
                            Exact
                        </button>
                        <button type="button" @click="setAmount(50000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            50K
                        </button>
                        <button type="button" @click="setAmount(100000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            100K
                        </button>
                        <button type="button" @click="setAmount(Math.ceil(remaining/50000)*50000)"
                                class="py-2 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                            Round
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!--
            FOOTER — 3 tombol aksi:
            1. Cancel: tutup modal tanpa bayar
            2. + Split: tambah pembayaran parsial ke list (tampil jika amount > 0 DAN belum cukup)
            3. Bayar: submit pembayaran (aktif jika canPay=true, disabled jika belum cukup)
        -->
        <div class="p-2.5 border-t bg-gray-50 flex gap-2" style="flex-shrink:0;">
            <button type="button" onclick="closeModal()"
                    class="px-5 py-2.5 rounded-lg font-bold text-xs bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50 transition-all">
                Cancel
            </button>
            <!-- Tombol + Split: tampil jika ada amount DAN (sudah ada split ATAU amount < total) -->
            <button type="button"
                    x-show="amount > 0 && (payments.length > 0 || amount < total)"
                    x-cloak
                    @click="addPayment()"
                    class="px-4 py-2.5 rounded-lg font-bold text-xs bg-blue-600 hover:bg-blue-700 text-white transition-all">
                <span class="flex items-center justify-center gap-1.5">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    + Split
                </span>
            </button>
            <button type="button"
                    @click="submitPayment()"
                    :disabled="!canPay"
                    class="flex-1 py-2.5 rounded-lg font-bold text-sm transition-all"
                    :class="canPay ? 'bg-green-600 hover:bg-green-700 text-white shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed'">
                <span class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <span x-text="canPay ? 'Bayar Rp ' + fmt(payments.length > 0 ? paidTotal : amount) : 'Masukkan Nominal'"></span>
                </span>
            </button>
        </div>
    </div>
</div>

<!--
    STYLES
    - x-cloak: Hide elemen Alpine.js yang belum di-init (mencegah flash of unstyled content)
    - touch-action: manipulation: Hilangkan 300ms tap delay di touchscreen POS
    - -webkit-tap-highlight-color: transparent: Hilangkan highlight biru saat tap
-->
<style>
[x-cloak] { display: none !important; }
[data-payment-modal] { touch-action: manipulation; }
[data-payment-modal] button,
[data-payment-modal] select,
[data-payment-modal] input {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    cursor: pointer;
}
</style>

<!--
    ALPINE.JS INITIALIZATION TRICK
    ================================
    Masalah: HTMX inject HTML ke #modal-container → Alpine.js MutationObserver
    mendeteksi element baru dengan x-data → auto-init. Tapi pada Alpine.js
    tertentu, ini menyebabkan bug "initTree" jika ada x-for dengan array
    yang sudah berisi data (non-empty).

    Solusi:
    1. Element utama diberi x-ignore → Alpine SKIP init saat HTMX inject
    2. Script ini (berjalan setelah inject) → clone element tanpa x-ignore
    3. Replace element asli dengan clone → Alpine MO detect element baru → init natural
    4. requestAnimationFrame + setTimeout(0) → pastikan DOM settled sebelum clone

    Ini juga fix masalah touch device dimana Alpine init terlalu cepat
    sebelum DOM siap, menyebabkan event handler tidak terpasang.

    Setelah clone+replace, htmx.process() dipanggil agar HTMX attributes
    (hx-post, hx-target, dll) pada form tetap berfungsi.
-->
<script>
(function() {
    var el = document.querySelector('[data-payment-modal]');
    if (!el || typeof Alpine === 'undefined') return;

    requestAnimationFrame(function() {
        setTimeout(function() {
            if (el._x_dataStack) return;  // Sudah di-init Alpine, skip
            var clone = el.cloneNode(true);
            clone.removeAttribute('x-ignore');  // Hapus x-ignore → Alpine akan init
            el.parentNode.replaceChild(clone, el);
            if (typeof htmx !== 'undefined') htmx.process(clone);  // Re-bind HTMX
            console.log('[Payment Modal] Alpine clone+replace done, touch ready');
        }, 0);
    });
})();
</script>
