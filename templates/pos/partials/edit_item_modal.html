{% load humanize %}
<!-- Edit Item Modal - Pre-filled with current selections -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" 
     onclick="if(event.target === this) this.remove()"
     onkeydown="if(event.key === 'Escape') this.remove()"
     tabindex="0"
     x-data="{ activeTab: 0 }">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md flex flex-col max-h-[90vh]" onclick="event.stopPropagation()">
        
        <!-- Header -->
        <div class="p-3 bg-gradient-to-r from-blue-600 to-indigo-700 text-white rounded-t-xl flex items-center justify-between flex-shrink-0">
            <div class="flex-1 min-w-0">
                <h2 class="text-base font-bold truncate">Edit: {{ item.product.name }}</h2>
                <div class="text-xs text-blue-100">Rp {{ item.product.price|floatformat:0|intcomma }}</div>
            </div>
            <button onclick="this.closest('.fixed').remove()" 
                    class="text-white hover:bg-white hover:bg-opacity-20 rounded-lg p-1 transition ml-2 flex-shrink-0">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
            </button>
        </div>

        <!-- Form -->
        <form hx-post="{% url 'pos:update_item' item.id %}"
              hx-target="#bill-panel"
              hx-swap="outerHTML"
              hx-on::after-request="this.closest('.fixed').remove()"
              onsubmit="convertRadioToCheckbox(this)"
              class="flex flex-col flex-1 overflow-hidden">
            
            <div class="flex-1 overflow-y-auto">
                <div class="p-4 space-y-4">
                
                <!-- Quantity -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Quantity</label>
                    <div class="flex items-center justify-center space-x-3">
                        <button type="button" 
                                onclick="var inp = this.nextElementSibling; if(inp.value > 1) inp.value = parseInt(inp.value) - 1;"
                                class="w-10 h-10 bg-red-500 hover:bg-red-600 text-white rounded-lg font-bold text-lg transition shadow-sm">
                            âˆ’
                        </button>
                        <input type="number" 
                               name="quantity" 
                               value="{{ item.quantity }}" 
                               min="1"
                               class="w-20 h-10 text-center text-xl font-bold border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                        <button type="button"
                                onclick="var inp = this.previousElementSibling; inp.value = parseInt(inp.value) + 1;"
                                class="w-10 h-10 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-bold text-lg transition shadow-sm">
                            +
                        </button>
                    </div>
                </div>

                <!-- Modifiers with Tabs -->
                {% if modifiers %}
                <div class="border-t pt-4">
                    <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-1.5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                        </svg>
                        Customize Options
                    </h3>
                    
                    <!-- Tabs Navigation -->
                    <div class="flex space-x-1 mb-3 overflow-x-auto pb-1">
                        {% for modifier in modifiers %}
                        <button type="button"
                                @click="activeTab = {{ forloop.counter0 }}"
                                :class="activeTab === {{ forloop.counter0 }} ? 'bg-blue-500 text-white shadow-md' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'"
                                class="px-3 py-2 rounded-lg text-xs font-semibold transition-all whitespace-nowrap flex items-center space-x-1 flex-shrink-0">
                            <span>{{ modifier.name }}</span>
                            {% if modifier.is_required %}
                            <span class="w-1.5 h-1.5 bg-red-500 rounded-full"></span>
                            {% endif %}
                        </button>
                        {% endfor %}
                    </div>

                    <!-- Tab Content with Scrollable Area -->
                    <div class="bg-gray-50 rounded-lg border border-gray-200 overflow-hidden">
                        <div class="max-h-64 overflow-y-auto p-3">
                            {% for modifier in modifiers %}
                            <div x-show="activeTab === {{ forloop.counter0 }}" class="space-y-2">
                                <div class="flex items-center justify-between mb-3 pb-2 border-b">
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm font-bold text-gray-700">{{ modifier.name }}</span>
                                        {% if modifier.is_required %}
                                        <span class="px-1.5 py-0.5 bg-red-500 text-white text-[10px] font-bold rounded">Required</span>
                                        {% endif %}
                                    </div>
                                    <span class="text-[10px] text-gray-500 font-medium">Max: {{ modifier.max_selections }}</span>
                                </div>
                                
                                {% for option in modifier.options.all %}
                                <label class="flex items-center justify-between p-2.5 bg-white border border-gray-200 rounded-lg cursor-pointer hover:bg-blue-50 hover:border-blue-400 transition-all hover:shadow-sm">
                                    <div class="flex items-center space-x-2.5 flex-1 min-w-0">
                                        {% if modifier.max_selections == 1 %}
                                        <input type="radio" 
                                               name="modifier_{{ modifier.id }}"
                                               value="{{ option.id }}"
                                               {% if option.id|stringformat:'s' in selected_modifier_ids %}checked{% endif %}
                                               class="w-4 h-4 text-blue-600 border-gray-300 focus:ring-blue-500">
                                        {% else %}
                                        <input type="checkbox" 
                                               name="modifiers"
                                               value="{{ option.id }}"
                                               {% if option.id|stringformat:'s' in selected_modifier_ids %}checked{% endif %}
                                               class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                        {% endif %}
                                        <span class="text-sm font-medium text-gray-800">{{ option.name }}</span>
                                        {% if option.is_default %}
                                        <span class="px-1.5 py-0.5 bg-blue-100 text-blue-700 text-[10px] font-semibold rounded">Default</span>
                                        {% endif %}
                                    </div>
                                    {% if option.price_adjustment != 0 %}
                                    <span class="text-xs font-bold ml-2 flex-shrink-0 {% if option.price_adjustment > 0 %}text-blue-600{% else %}text-red-600{% endif %}">
                                        {% if option.price_adjustment > 0 %}+{% endif %}Rp {{ option.price_adjustment|floatformat:0|intcomma }}
                                    </span>
                                    {% endif %}
                                </label>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Notes -->
                <div>
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center">
                        <svg class="w-4 h-4 mr-1.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                        </svg>
                        Notes (Optional)
                    </label>
                    <textarea name="notes"
                              rows="2"
                              placeholder="e.g., Less spicy, No ice, Extra sauce..."
                              class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 resize-none text-sm"
                              >{{ item.notes|default:"" }}</textarea>
                </div>

                </div>
            </div>

            <!-- Footer -->
            <div class="p-3 border-t bg-gray-50 rounded-b-xl flex items-center justify-between flex-shrink-0">
                <button type="button" 
                        onclick="this.closest('.fixed').remove()"
                        class="px-4 py-2 text-sm border-2 border-gray-300 text-gray-600 rounded-lg hover:bg-white hover:shadow transition">
                    Cancel
                </button>
                <button type="submit"
                        class="px-6 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white rounded-lg font-bold transition-all shadow-md hover:shadow-lg flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span>Update Item</span>
                </button>
            </div>

        </form>

    </div>
</div>

<script>
// Auto focus on modal
document.querySelector('.fixed[tabindex="0"]').focus();

// Convert radio button selections to checkbox format for backend
function convertRadioToCheckbox(form) {
    const radios = form.querySelectorAll('input[type="radio"]:checked');
    radios.forEach(radio => {
        const hidden = document.createElement('input');
        hidden.type = 'hidden';
        hidden.name = 'modifiers';
        hidden.value = radio.value;
        form.appendChild(hidden);
    });
    return true;
}
</script>
