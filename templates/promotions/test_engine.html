{% extends 'management/base.html' %}

{% block title %}Promotion Simulator{% endblock %}

{% block content %}
<div class="container mx-auto px-6 py-8">
    <!-- Header -->
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">üéÅ Promotion Simulator</h1>
            <p class="text-gray-600 mt-2">Test promotion engine before applying to POS</p>
        </div>
        <div class="flex gap-2">
            <a href="/static/markdown/PROMOTION_ENGINE_POS_INTEGRATION.md" target="_blank" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors">
                üìñ POS Integration Guide
            </a>
            <a href="{% url 'management:promotions' %}" class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-colors">
                ‚Üê Back to Promotions
            </a>
        </div>
    </div>

    <!-- Quick Guide -->
    <div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <h3 class="text-sm font-medium text-blue-800">How to Use</h3>
                <div class="mt-2 text-sm text-blue-700">
                    <ol class="list-decimal list-inside space-y-1">
                        <li>Click products on the left to add to cart</li>
                        <li>Click "Calculate Promotions" to see which promotions apply</li>
                        <li>View discount details and final total</li>
                        <li>Use "Clear Cart" to start over</li>
                    </ol>
                    <p class="mt-2"><strong>For POS Integration:</strong> Check the <a href="/static/markdown/PROMOTION_ENGINE_POS_INTEGRATION.md" target="_blank" class="underline">Integration Guide</a> for API usage examples.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left: Product Search & Add -->
        <div class="lg:col-span-1">
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Add Products</h2>
                
                <!-- Product Search -->
                <div class="mb-4">
                    <input type="text" id="productSearch" placeholder="Search products..." 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                
                <!-- Product List -->
                <div id="productList" class="space-y-2 max-h-96 overflow-y-auto">
                    {% for product in products %}
                    <div class="p-3 border border-gray-200 rounded hover:bg-gray-50 cursor-pointer product-item"
                         data-product-id="{{ product.id }}"
                         data-product-name="{{ product.name }}"
                         data-product-sku="{{ product.sku }}"
                         data-product-price="{{ product.price }}"
                         data-category-id="{{ product.category.id }}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-medium text-gray-900">{{ product.name }}</p>
                                <p class="text-xs text-gray-500">{{ product.category.name }} ‚Ä¢ {{ product.sku }}</p>
                            </div>
                            <p class="text-sm font-semibold text-blue-600">Rp {{ product.price|floatformat:0 }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Active Promotions Info -->
            <div class="bg-blue-50 rounded-lg shadow p-6 mt-6">
                <h3 class="text-lg font-bold text-blue-800 mb-3">Active Promotions</h3>
                <div class="space-y-2">
                    {% for promo in promotions %}
                    <div class="text-sm">
                        <p class="font-medium text-blue-900">{{ promo.name }}</p>
                        <p class="text-xs text-blue-700">{{ promo.promo_type|title }} ‚Ä¢ Priority: {{ promo.execution_priority }}</p>
                    </div>
                    {% empty %}
                    <p class="text-sm text-blue-700">No active promotions</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- Right: Cart & Results -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Cart -->
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Shopping Cart</h2>
                    <button id="clearCart" class="px-3 py-1 text-sm bg-red-600 hover:bg-red-700 text-white rounded transition-colors">
                        Clear Cart
                    </button>
                </div>
                
                <div id="cartItems" class="space-y-3 mb-4">
                    <!-- Cart items will be inserted here -->
                    <p class="text-gray-500 text-center py-8">Cart is empty. Add products to test promotions.</p>
                </div>
                
                <!-- Cart Summary -->
                <div class="border-t pt-4">
                    <div class="flex justify-between text-lg font-semibold mb-2">
                        <span>Subtotal:</span>
                        <span id="cartSubtotal">Rp 0</span>
                    </div>
                    <button id="calculateBtn" class="w-full px-4 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed">
                        üßÆ Calculate Promotions
                    </button>
                </div>
            </div>

            <!-- Results -->
            <div id="resultsSection" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Calculation Results</h2>
                
                <!-- Applied Promotions -->
                <div id="appliedPromotions" class="space-y-3 mb-4">
                    <!-- Results will be inserted here -->
                </div>
                
                <!-- Final Totals -->
                <div class="border-t pt-4 space-y-2">
                    <div class="flex justify-between text-gray-700">
                        <span>Subtotal:</span>
                        <span id="resultSubtotal">Rp 0</span>
                    </div>
                    <div class="flex justify-between text-green-600 font-semibold">
                        <span>Discount:</span>
                        <span id="resultDiscount">Rp 0</span>
                    </div>
                    <div class="flex justify-between text-2xl font-bold text-gray-900 border-t pt-2">
                        <span>Total:</span>
                        <span id="resultTotal">Rp 0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Cart state
let cart = [];

// Format currency
function formatRupiah(amount) {
    return 'Rp ' + Math.round(amount).toLocaleString('id-ID');
}

// Update cart display
function updateCartDisplay() {
    const cartItems = document.getElementById('cartItems');
    const cartSubtotal = document.getElementById('cartSubtotal');
    const calculateBtn = document.getElementById('calculateBtn');
    
    if (cart.length === 0) {
        cartItems.innerHTML = '<p class="text-gray-500 text-center py-8">Cart is empty. Add products to test promotions.</p>';
        cartSubtotal.textContent = 'Rp 0';
        calculateBtn.disabled = true;
        return;
    }
    
    let subtotal = 0;
    let html = '';
    
    cart.forEach(item => {
        const itemTotal = item.price * item.quantity;
        subtotal += itemTotal;
        
        html += `
            <div class="p-3 bg-gray-50 rounded">
                <div class="flex justify-between items-center">
                    <div class="flex-1">
                        <p class="font-medium text-gray-900">${item.product_name}</p>
                        <p class="text-sm text-gray-600">${formatRupiah(item.price)} √ó ${item.quantity}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-semibold text-gray-900">${formatRupiah(itemTotal)}</p>
                        <button class="text-xs text-red-600 hover:text-red-800" onclick="removeItem('${item.product_id}')">Remove</button>
                    </div>
                </div>
                <div id="item-discount-${item.product_id}"></div>
            </div>
        `;
    });
    
    cartItems.innerHTML = html;
    cartSubtotal.textContent = formatRupiah(subtotal);
    calculateBtn.disabled = false;
}

// Add product to cart
document.querySelectorAll('.product-item').forEach(item => {
    item.addEventListener('click', async function() {
        const productId = this.dataset.productId;
        const productName = this.dataset.productName;
        const productSku = this.dataset.productSku;
        const productPrice = parseFloat(this.dataset.productPrice);
        const categoryId = this.dataset.categoryId;
        
        try {
            const response = await fetch('{% url "promotions:simulator_add" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                cart = data.cart;
                updateCartDisplay();
                
                // Auto-calculate item-level promotions
                await autoCalculateItemLevel();
                
                // Visual feedback
                this.classList.add('bg-green-100');
                setTimeout(() => this.classList.remove('bg-green-100'), 300);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            alert('Failed to add product to cart');
        }
    });
});

// Auto-calculate item-level promotions
async function autoCalculateItemLevel() {
    if (cart.length === 0) {
        hideItemLevelDiscount();
        return;
    }
    
    try {
        console.log('Auto-calculating item-level promotions...');
        
        const response = await fetch('{% url "promotions:simulator_calculate" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        console.log('Auto-calculate response:', data);
        console.log('All applied promotions:', data.applied_promotions);
        
        // Log each promotion details
        if (data.applied_promotions && data.applied_promotions.length > 0) {
            data.applied_promotions.forEach((p, i) => {
                console.log(`Promotion ${i+1}:`, {
                    name: p.promotion_name,
                    code: p.promotion_code,
                    type: p.promo_type,
                    stage: p.execution_stage,
                    discount: p.discount_amount
                });
            });
        }
        
        if (data.success) {
            // Filter only item-level promotions
            const itemLevelPromos = data.applied_promotions.filter(
                p => p.execution_stage === 'item_level'
            );
            
            console.log('Item-level promotions found:', itemLevelPromos);
            console.log('Item-level count:', itemLevelPromos.length);
            
            if (itemLevelPromos.length > 0) {
                // Calculate item-level discount only
                const itemLevelDiscount = itemLevelPromos.reduce(
                    (sum, p) => sum + p.discount_amount, 0
                );
                
                console.log('Item-level discount:', itemLevelDiscount);
                
                // Show item-level discount in cart
                showItemLevelDiscount(itemLevelDiscount, itemLevelPromos);
            } else {
                console.log('No item-level promotions applicable');
                hideItemLevelDiscount();
            }
        } else {
            console.error('Auto-calculate failed:', data.error);
            hideItemLevelDiscount();
        }
    } catch (error) {
        console.error('Error auto-calculating:', error);
        hideItemLevelDiscount();
    }
}

// Show item-level discount
function showItemLevelDiscount(discount, promos) {
    // Clear all existing item discounts
    hideItemLevelDiscount();
    
    // Show discount under each affected item
    cart.forEach(item => {
        const discountContainer = document.getElementById(`item-discount-${item.product_id}`);
        if (discountContainer) {
            // Check if this item has a promotion
            const itemPromo = promos.find(p => {
                // Simple check - in real implementation, check if promo applies to this item
                return true; // For now, show on all items
            });
            
            if (itemPromo) {
                discountContainer.innerHTML = `
                    <div class="mt-2 pt-2 border-t border-green-200">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-green-700">üí∞ ${promos.map(p => p.promotion_name).join(', ')}</span>
                            <span class="font-semibold text-green-600">-${formatRupiah(discount / cart.length)}</span>
                        </div>
                    </div>
                `;
            }
        }
    });
}

// Hide item-level discount
function hideItemLevelDiscount() {
    cart.forEach(item => {
        const discountContainer = document.getElementById(`item-discount-${item.product_id}`);
        if (discountContainer) {
            discountContainer.innerHTML = '';
        }
    });
}

// Remove item from cart
async function removeItem(productId) {
    try {
        const response = await fetch('{% url "promotions:simulator_remove" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                product_id: productId
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            cart = data.cart;
            updateCartDisplay();
            
            // Hide results when cart changes
            document.getElementById('resultsSection').classList.add('hidden');
        }
    } catch (error) {
        console.error('Error removing item:', error);
    }
}

// Clear cart
document.getElementById('clearCart').addEventListener('click', async function() {
    if (!confirm('Clear all items from cart?')) return;
    
    try {
        const response = await fetch('{% url "promotions:simulator_clear" %}', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            cart = [];
            updateCartDisplay();
            document.getElementById('resultsSection').classList.add('hidden');
        }
    } catch (error) {
        console.error('Error clearing cart:', error);
    }
});

// Calculate promotions
document.getElementById('calculateBtn').addEventListener('click', async function() {
    const btn = this;
    btn.disabled = true;
    btn.textContent = '‚è≥ Calculating...';
    
    try {
        const response = await fetch('{% url "promotions:simulator_calculate" %}', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show results
            document.getElementById('resultsSection').classList.remove('hidden');
            
            // Update totals
            document.getElementById('resultSubtotal').textContent = formatRupiah(data.subtotal);
            document.getElementById('resultDiscount').textContent = formatRupiah(data.discount_amount);
            document.getElementById('resultTotal').textContent = formatRupiah(data.total);
            
            // Show applied promotions grouped by stage
            const appliedPromotions = document.getElementById('appliedPromotions');
            
            if (data.applied_promotions.length === 0) {
                appliedPromotions.innerHTML = '<p class="text-gray-500 text-center py-4">No promotions applied</p>';
            } else {
                // Debug: Log all promotions with their stages
                console.log('=== CALCULATE PROMOTIONS DEBUG ===');
                data.applied_promotions.forEach((p, i) => {
                    console.log(`Promo ${i+1}:`, {
                        name: p.promotion_name,
                        code: p.promotion_code,
                        type: p.promo_type,
                        stage: p.execution_stage,
                        has_stage: 'execution_stage' in p,
                        discount: p.discount_amount
                    });
                });
                
                // Group promotions by execution stage
                const itemLevel = data.applied_promotions.filter(p => p.execution_stage === 'item_level');
                const cartLevel = data.applied_promotions.filter(p => p.execution_stage === 'cart_level');
                const paymentLevel = data.applied_promotions.filter(p => p.execution_stage === 'payment_level');
                
                console.log('Item Level count:', itemLevel.length);
                console.log('Cart Level count:', cartLevel.length);
                console.log('Payment Level count:', paymentLevel.length);
                
                let html = '';
                
                // Note: Item Level promotions are already shown under each item in cart
                // So we only show Cart Level and Payment Level here
                
                // Cart Level Promotions
                if (cartLevel.length > 0) {
                    html += '<h3 class="text-sm font-bold text-gray-700 mb-2 mt-4">üõí Cart Level Promotions</h3>';
                    cartLevel.forEach(promo => {
                        html += `
                            <div class="p-4 bg-green-50 border border-green-200 rounded-lg mb-3">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-semibold text-green-900">${promo.promotion_name}</p>
                                        <p class="text-sm text-green-700">${promo.promotion_code} ‚Ä¢ ${promo.promo_type}</p>
                                        <span class="text-xs bg-green-200 text-green-800 px-2 py-1 rounded mt-1 inline-block">Cart Level</span>
                                    </div>
                                    <p class="text-lg font-bold text-green-600">-${formatRupiah(promo.discount_amount)}</p>
                                </div>
                                <p class="text-sm text-green-800">${promo.message}</p>
                            </div>
                        `;
                    });
                }
                
                // Payment Level Promotions
                if (paymentLevel.length > 0) {
                    html += '<h3 class="text-sm font-bold text-gray-700 mb-2 mt-4">üí≥ Payment Level Promotions</h3>';
                    paymentLevel.forEach(promo => {
                        html += `
                            <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg mb-3">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <p class="font-semibold text-purple-900">${promo.promotion_name}</p>
                                        <p class="text-sm text-purple-700">${promo.promotion_code} ‚Ä¢ ${promo.promo_type}</p>
                                        <span class="text-xs bg-purple-200 text-purple-800 px-2 py-1 rounded mt-1 inline-block">Payment Level</span>
                                    </div>
                                    <p class="text-lg font-bold text-purple-600">-${formatRupiah(promo.discount_amount)}</p>
                                </div>
                                <p class="text-sm text-purple-800">${promo.message}</p>
                            </div>
                        `;
                    });
                }
                
                appliedPromotions.innerHTML = html;
            }
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error calculating promotions:', error);
        alert('Failed to calculate promotions');
    } finally {
        btn.disabled = false;
        btn.textContent = 'üßÆ Calculate Promotions';
    }
});

// Product search
document.getElementById('productSearch').addEventListener('input', function(e) {
    const search = e.target.value.toLowerCase();
    document.querySelectorAll('.product-item').forEach(item => {
        const name = item.dataset.productName.toLowerCase();
        const sku = item.dataset.productSku.toLowerCase();
        if (name.includes(search) || sku.includes(search)) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
});

// Initialize
updateCartDisplay();
</script>
{% endblock %}
