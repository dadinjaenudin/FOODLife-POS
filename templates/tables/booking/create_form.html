<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
     onclick="if(event.target === this) closeModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col"
         x-data="{
            type: 'standard',
            date: '{{ today }}',
            time: '19:00',
            duration: {{ config.default_slot_duration|default:120 }},
            pax: 2,
            minSpend: 0,
            minSpendDisplay: '',
            depositRequired: {{ config.require_deposit|yesno:'true,false' }},
            depositAmount: 0,
            depositAmountDisplay: '',
            selectedTables: [],
            toggleTable(id) {
                const idx = this.selectedTables.indexOf(id);
                if (idx === -1) this.selectedTables.push(id);
                else this.selectedTables.splice(idx, 1);
            },
            fmtRp(n) {
                if (!n && n !== 0) return '';
                return Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            },
            onRpInput(field, val) {
                const clean = val.replace(/[^\d]/g, '');
                const num = clean ? parseInt(clean) : 0;
                this[field] = num;
                this[field + 'Display'] = num ? this.fmtRp(num) : '';
            }
         }">
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-500 to-green-600 text-white px-4 py-2.5 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold">Booking Baru</h3>
                        <p class="text-green-100 text-[10px]">Buat reservasi meja</p>
                    </div>
                </div>
                <button onclick="closeModal()"
                        class="w-7 h-7 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Form -->
        <form hx-post="{% url 'tables:booking_create' %}"
              hx-target="#modal-container" hx-swap="innerHTML"
              class="flex-1 overflow-y-auto p-4 space-y-3">
            {% csrf_token %}

            <!-- Inline error display -->
            <div id="booking-form-errors"></div>

            <!-- Type -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Tipe Booking</label>
                <select name="type" x-model="type"
                        class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400 focus:border-amber-400">
                    <option value="standard">Standard</option>
                    <option value="min_spend">Minimum Spend</option>
                    <option value="event">Event / Private Dining</option>
                </select>
            </div>

            <!-- Date & Time Row -->
            <div class="grid grid-cols-3 gap-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Tanggal</label>
                    <input type="date" name="reservation_date" x-model="date" required
                           min="{{ today }}" max="{{ max_date }}"
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Jam</label>
                    <input type="time" name="time_start" x-model="time" required
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Durasi (menit)</label>
                    <input type="number" name="duration_minutes" x-model="duration" min="60" step="30"
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
            </div>

            <!-- Guest Info -->
            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Nama Tamu *</label>
                    <input type="text" name="guest_name" required placeholder="Nama tamu"
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">No. HP</label>
                    <input type="tel" name="guest_phone" placeholder="0812xxxxxxxx"
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Jumlah Tamu</label>
                    <input type="number" name="party_size" x-model="pax" min="1" max="{{ config.max_party_size }}"
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
                <div>
                    <label class="block text-xs font-semibold text-gray-700 mb-1">Email (opsional)</label>
                    <input type="email" name="guest_email" placeholder="email@example.com"
                           class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                </div>
            </div>

            <!-- Table Selection -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Pilih Meja</label>
                <div class="border rounded-lg p-2 max-h-32 overflow-y-auto">
                    {% for area in areas %}
                    <div class="mb-1">
                        <span class="text-[10px] font-bold text-gray-400 uppercase">{{ area.name }}</span>
                        <div class="flex flex-wrap gap-1 mt-0.5">
                            {% for table in area.active_tables %}
                            <button type="button"
                                    @click="toggleTable('{{ table.id }}')"
                                    :class="selectedTables.includes('{{ table.id }}') ? 'bg-green-500 text-white border-green-500' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'"
                                    class="inline-block px-2 py-1 text-xs rounded border transition cursor-pointer">
                                {{ table.number }} <span class="text-[10px]" :class="selectedTables.includes('{{ table.id }}') ? 'text-green-100' : 'text-gray-400'">({{ table.capacity }})</span>
                            </button>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <!-- Hidden inputs for selected tables -->
                <template x-for="tid in selectedTables" :key="tid">
                    <input type="hidden" name="tables" :value="tid">
                </template>
            </div>

            <!-- Event Package (conditional) -->
            <div x-show="type === 'event'" x-cloak>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Paket Event</label>
                <select name="package" class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400">
                    <option value="">-- Pilih Paket --</option>
                    {% for pkg in packages %}
                    <option value="{{ pkg.id }}">{{ pkg.name }} (Rp {{ pkg.price_per_pax|floatformat:0 }}/pax)</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Min Spend (conditional) -->
            <div x-show="type === 'min_spend'" x-cloak>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Minimum Spend (Rp)</label>
                <input type="hidden" name="minimum_spend" :value="minSpend">
                <input type="text" x-model="minSpendDisplay"
                       @input="onRpInput('minSpend', $event.target.value)"
                       placeholder="0" inputmode="numeric" autocomplete="off"
                       class="w-full border rounded-lg px-3 py-2 text-sm text-right focus:ring-2 focus:ring-amber-400">
                <p class="text-[10px] text-gray-400 mt-0.5">Tamu wajib belanja minimal jumlah ini</p>
            </div>

            <!-- Deposit -->
            <div class="border rounded-lg p-3 bg-amber-50/50">
                <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="deposit_required" x-model="depositRequired"
                           class="rounded border-gray-300 text-amber-500 focus:ring-amber-400">
                    <span class="text-xs font-semibold text-gray-700">Require Deposit</span>
                </label>
                <div x-show="depositRequired" x-cloak class="mt-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-1">Jumlah Deposit (Rp)</label>
                    <input type="hidden" name="deposit_amount" :value="depositAmount">
                    <input type="text" x-model="depositAmountDisplay"
                           @input="onRpInput('depositAmount', $event.target.value)"
                           placeholder="0" inputmode="numeric" autocomplete="off"
                           class="w-full border rounded-lg px-3 py-2 text-sm text-right focus:ring-2 focus:ring-amber-400">
                </div>
            </div>

            <!-- Special Requests -->
            <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1">Catatan / Request Khusus</label>
                <textarea name="special_requests" rows="2" placeholder="Dekorasi, kue ultah, dll..."
                          class="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-amber-400 resize-none"></textarea>
            </div>

            <!-- Submit -->
            <div class="flex items-center gap-2 pt-2">
                <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-100 transition font-medium text-sm">
                    Batal
                </button>
                <button type="submit"
                        class="flex-1 px-4 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-bold text-sm">
                    Simpan Booking
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function closeModal() {
    const modal = document.getElementById('modal-container');
    if (modal) modal.innerHTML = '';
}
</script>
