{% load humanize %}

<script>
// URLs & data defined here so Django template tags & JSON don't break x-data
var _depositQrisUrls = {
    create: '{% url "tables:booking_deposit_qris_create" reservation.id %}',
    status: '{% url "tables:booking_deposit_qris_status" reservation.id "__TXN__" %}',
    cancel: '{% url "tables:booking_deposit_qris_cancel" reservation.id "__TXN__" %}',
    simulate: '{% url "tables:booking_deposit_qris_simulate" reservation.id "__TXN__" %}',
};
var _depositProfiles = {{ profiles_json|safe }};
var _depositSelectedProfile = '{% for p in payment_profiles %}{% if forloop.first %}{{ p.id }}{% endif %}{% empty %}{% endfor %}';
var _depositSelectedMethod = '{% for p in payment_profiles %}{% if forloop.first %}{{ p.legacy_method_id|default:p.code }}{% endif %}{% empty %}cash{% endfor %}';
var _depositAmount = {{ reservation.deposit_amount|stringformat:'f' }};

function closeModal() {
    var modal = document.getElementById('modal-container');
    if (modal) modal.innerHTML = '';
}

function depositPayment() {
    return {
        profiles: _depositProfiles || [],
        selectedProfile: _depositSelectedProfile || '',
        selectedMethod: _depositSelectedMethod || 'cash',
        promptValues: {},
        depositAmount: _depositAmount || 0,
        amount: 0,
        amountDisplay: '',
        payments: [],
        activeField: 'amount',

        qrisState: 'idle',
        qrisTransactionId: '',
        qrisQrImage: '',
        qrisFieldName: '',
        qrisError: '',
        _qrisTimer: null,

        get currentProfile() {
            var sid = this.selectedProfile;
            return this.profiles.find(function(p) { return p.id === sid; }) || null;
        },
        get currentAllowChange() {
            var cp = this.currentProfile;
            return cp ? (cp.allow_change !== false) : true;
        },
        get promptDataJson() {
            var vals = this.promptValues;
            var hasAny = false;
            for (var k in vals) { if (vals[k]) { hasAny = true; break; } }
            return hasAny ? JSON.stringify(vals) : '';
        },
        get paidTotal() {
            var sum = 0;
            for (var i = 0; i < this.payments.length; i++) sum += this.payments[i].amount;
            return sum;
        },
        get remaining() {
            var r = this.depositAmount - this.paidTotal;
            return r > 0 ? r : 0;
        },
        get displayPaying() {
            return this.payments.length > 0 ? this.paidTotal : this.amount;
        },
        get changeAmount() {
            if (this.payments.length === 0 && this.currentAllowChange && this.amount > this.depositAmount) {
                return this.amount - this.depositAmount;
            }
            if (this.payments.length > 0 && this.paidTotal > this.depositAmount) {
                var lastPmt = this.payments[this.payments.length - 1];
                var lp = this.profiles.find(function(p) { return p.id === lastPmt.profile_id; });
                if (lp && lp.allow_change !== false) return this.paidTotal - this.depositAmount;
            }
            return 0;
        },
        get canPay() {
            if (this.qrisState === 'polling' || this.qrisState === 'generating') return false;
            if (this.payments.length === 0) return this.amount >= this.depositAmount && this.amount > 0;
            return this.paidTotal >= this.depositAmount;
        },
        get paymentsListHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                h += '<div class="flex items-center gap-1.5 bg-white border rounded-lg px-2 py-1">';
                h += '<div class="w-2 h-2 rounded-full flex-shrink-0" style="background:' + this._methodColor(p.profile_id) + '"></div>';
                h += '<span class="text-[11px] font-bold text-gray-700">' + this._methodLabel(p.profile_id) + '</span>';
                h += '<span class="text-[11px] font-bold text-green-600">Rp ' + this.fmt(p.amount) + '</span>';
                h += '<button type="button" data-rm="' + i + '" class="w-4 h-4 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded">';
                h += '<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>';
                h += '</button></div>';
            }
            return h;
        },
        get paymentsHiddenHtml() {
            var h = '';
            for (var i = 0; i < this.payments.length; i++) {
                var p = this.payments[i];
                var esc = function(s) { return (s || '').replace(/"/g, '&quot;'); };
                h += '<input type="hidden" name="payments[' + i + '][method]" value="' + esc(p.method) + '">';
                h += '<input type="hidden" name="payments[' + i + '][amount]" value="' + p.amount + '">';
                h += '<input type="hidden" name="payments[' + i + '][profile_id]" value="' + esc(p.profile_id) + '">';
                h += '<input type="hidden" name="payments[' + i + '][prompt_data]" value="' + esc(p.prompt_data) + '">';
            }
            return h;
        },

        fmt: function(n) {
            if (!n && n !== 0) return '0';
            return Math.floor(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        },
        _methodLabel: function(profileId) {
            var m = this.profiles.find(function(p) { return p.id === profileId; });
            return m ? m.name : (profileId || '');
        },
        _methodColor: function(profileId) {
            var m = this.profiles.find(function(p) { return p.id === profileId; });
            return m ? m.color : '#6b7280';
        },

        select: function(method, profileId) {
            if (this.qrisState === 'polling' || this.qrisState === 'generating') {
                this.cancelQRIS();
            }
            this.selectedMethod = method;
            this.selectedProfile = profileId;
            this.promptValues = {};
            this.activeField = 'amount';
            this.qrisState = 'idle';
            this.qrisError = '';
        },

        onInput: function(val) {
            var clean = val.replace(/\D/g, '');
            this.amount = clean ? parseInt(clean) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
        },

        numpad: function(key) {
            if (this.activeField && this.activeField.startsWith('prompt:')) {
                var fieldName = this.activeField.substring(7);
                var val = this.promptValues[fieldName] || '';
                if (key === 'C') val = '';
                else if (key === 'DEL') val = val.slice(0, -1);
                else val = val + key;
                this.promptValues[fieldName] = val;
                return;
            }
            var raw = this.amount.toString();
            if (key === 'C') raw = '';
            else if (key === 'DEL') raw = raw.slice(0, -1);
            else raw = raw + key;
            this.amount = raw ? parseInt(raw) : 0;
            this.amountDisplay = this.amount ? this.fmt(this.amount) : '';
        },

        setAmount: function(val) {
            this.activeField = 'amount';
            this.amount = val;
            this.amountDisplay = this.fmt(val);
        },

        addPayment: function() {
            if (this.amount <= 0) return;
            if (!this.currentAllowChange && this.amount > this.remaining) return;
            this.payments.push({
                method: this.selectedMethod,
                amount: this.amount,
                profile_id: this.selectedProfile,
                prompt_data: this.promptDataJson
            });
            this.amount = 0;
            this.amountDisplay = '';
            this.promptValues = {};
            this.activeField = 'amount';
        },

        removePayment: function(idx) {
            this.payments.splice(idx, 1);
        },

        submitPayment: function() {
            if (!this.canPay) return;
            if (this.payments.length > 0 && this.paidTotal >= this.depositAmount) this.amount = 0;
            var form = document.getElementById('deposit-form');
            if (form) {
                if (form.requestSubmit) form.requestSubmit();
                else form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
            }
        },

        generateQR: function(fieldName) {
            var self = this;
            self.qrisFieldName = fieldName;
            self.qrisState = 'generating';
            self.qrisError = '';

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            var qrisAmount = self.amount > 0 ? self.amount : self.remaining;
            fetch(_depositQrisUrls.create, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'amount=' + qrisAmount,
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    self.qrisTransactionId = data.transaction_id;
                    self.qrisQrImage = data.qr_image || '';
                    self.amount = qrisAmount;
                    self.amountDisplay = self.fmt(qrisAmount);
                    self.qrisState = 'polling';
                    self._startPolling();
                } else {
                    self.qrisState = 'error';
                    self.qrisError = data.error || 'Gagal membuat QR';
                }
            })
            .catch(function() {
                self.qrisState = 'error';
                self.qrisError = 'Network error';
            });
        },

        _startPolling: function() {
            var self = this;
            self._qrisTimer = setInterval(function() {
                if (self.qrisState !== 'polling') {
                    self._stopPolling();
                    return;
                }
                var url = _depositQrisUrls.status.replace('__TXN__', self.qrisTransactionId);
                fetch(url)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.status === 'paid') {
                        self.qrisState = 'paid';
                        self._stopPolling();
                        self.promptValues[self.qrisFieldName] = self.qrisTransactionId;
                        setTimeout(function() {
                            self.qrisState = 'idle';
                            var form = document.getElementById('deposit-form');
                            if (form) {
                                if (form.requestSubmit) form.requestSubmit();
                                else form.dispatchEvent(new Event('submit', { bubbles: true, cancelable: true }));
                            }
                        }, 800);
                    } else if (data.status !== 'pending') {
                        self.qrisState = 'error';
                        self.qrisError = 'Transaksi ' + data.status;
                        self._stopPolling();
                    }
                })
                .catch(function() {});
            }, 3000);
        },

        _stopPolling: function() {
            if (this._qrisTimer) {
                clearInterval(this._qrisTimer);
                this._qrisTimer = null;
            }
        },

        cancelQRIS: function() {
            this._stopPolling();
            if (this.qrisTransactionId) {
                var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                var url = _depositQrisUrls.cancel.replace('__TXN__', this.qrisTransactionId);
                fetch(url, { method: 'POST', headers: {'X-CSRFToken': csrfToken} }).catch(function(){});
            }
            this.qrisState = 'idle';
            this.qrisTransactionId = '';
            this.qrisQrImage = '';
        },

        simulateQRIS: function() {
            var self = this;
            if (!self.qrisTransactionId) return;
            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            var url = _depositQrisUrls.simulate.replace('__TXN__', self.qrisTransactionId);
            fetch(url, { method: 'POST', headers: {'X-CSRFToken': csrfToken} }).catch(function(){});
        }
    };
}
</script>

<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
     onclick="if(event.target === this) closeModal()"
     data-deposit-modal
     x-data="depositPayment()"
     x-ignore>
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col"
         @click.stop>
        <!-- Header -->
        <div class="bg-gradient-to-r from-green-600 to-green-700 text-white px-4 py-2.5 rounded-t-xl" style="flex-shrink:0;">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-2.5">
                    <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-sm font-bold">Bayar Deposit</h3>
                        <p class="text-green-100 text-[10px]">{{ reservation.reservation_code }} &middot; {{ reservation.guest_name }}</p>
                    </div>
                </div>
                <button onclick="closeModal()"
                        class="w-7 h-7 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center transition">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="p-2.5 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="grid grid-cols-3 gap-2">
                <div class="bg-white rounded-lg p-2 border text-center">
                    <div class="text-[10px] font-semibold text-gray-500 uppercase">Deposit</div>
                    <div class="text-base font-bold text-gray-900">Rp <span x-text="fmt(depositAmount)"></span></div>
                    <div class="text-[9px] text-gray-400">{{ reservation.reservation_date|date:"d M" }} {{ reservation.time_start|time:"H:i" }} &middot; {{ reservation.party_size }} pax</div>
                </div>
                <div class="bg-white rounded-lg p-2 border text-center">
                    <div class="text-[10px] font-semibold text-gray-500 uppercase">Bayar</div>
                    <div class="text-base font-bold" :class="displayPaying >= depositAmount ? 'text-green-600' : 'text-amber-600'">
                        Rp <span x-text="fmt(displayPaying)"></span>
                    </div>
                </div>
                <div class="rounded-lg p-2 border text-center"
                     :class="changeAmount > 0 ? 'bg-green-50 border-green-200' : (payments.length > 0 && paidTotal < depositAmount ? 'bg-amber-50 border-amber-200' : 'bg-white')">
                    <div class="text-[10px] font-semibold uppercase"
                         :class="changeAmount > 0 ? 'text-green-700' : (payments.length > 0 && paidTotal < depositAmount ? 'text-amber-700' : 'text-gray-500')"
                         x-text="changeAmount > 0 ? 'Kembalian' : (payments.length > 0 && paidTotal < depositAmount ? 'Sisa' : 'Kembalian')"></div>
                    <div class="text-base font-bold"
                         :class="changeAmount > 0 ? 'text-green-600' : (payments.length > 0 && paidTotal < depositAmount ? 'text-amber-600' : 'text-gray-400')">
                        Rp <span x-text="changeAmount > 0 ? fmt(changeAmount) : (payments.length > 0 && paidTotal < depositAmount ? fmt(remaining) : fmt(0))"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applied Payments List (Split) -->
        <div x-show="payments.length > 0" x-cloak class="px-2.5 pt-2 pb-1 bg-gray-50 border-b" style="flex-shrink:0;">
            <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1">Pembayaran Tercatat</div>
            <div style="display:flex; flex-wrap:wrap; gap:4px;"
                 x-html="paymentsListHtml"
                 @click="($event.target.closest('[data-rm]')) && removePayment(parseInt($event.target.closest('[data-rm]').dataset.rm))"></div>
        </div>

        <!-- QRIS Overlay -->
        <template x-if="qrisState === 'polling' || qrisState === 'paid' || qrisState === 'generating'">
            <div class="flex-1 flex flex-col items-center justify-center p-6 space-y-4">
                <template x-if="qrisState === 'generating'">
                    <div class="text-center">
                        <div class="w-12 h-12 border-4 border-gray-200 border-t-green-500 rounded-full animate-spin mx-auto"></div>
                        <p class="text-sm text-gray-500 mt-3">Generating QR Code...</p>
                    </div>
                </template>
                <template x-if="qrisState === 'polling'">
                    <div class="text-center w-full">
                        <div class="inline-block p-3 bg-white border-2 rounded-xl" style="border-color:#dcfce7;">
                            <img :src="qrisQrImage" class="w-48 h-48 mx-auto" alt="QRIS QR Code">
                        </div>
                        <div class="mt-3">
                            <p class="text-lg font-bold" style="color:#166534;">Rp <span x-text="fmt(amount)"></span></p>
                            <p class="text-xs text-gray-500 mt-1">Scan QR untuk membayar deposit</p>
                        </div>
                        <div class="flex items-center justify-center gap-1.5 mt-3">
                            <div class="w-2 h-2 rounded-full animate-pulse" style="background-color:#f59e0b;"></div>
                            <span class="text-xs font-medium" style="color:#b45309;">Menunggu pembayaran...</span>
                        </div>
                        <div class="flex items-center gap-2 mt-4">
                            <button type="button" @click="cancelQRIS()"
                                    class="flex-1 px-3 py-2 border border-gray-300 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-50 transition">
                                Batal
                            </button>
                            <button type="button" @click="simulateQRIS()"
                                    class="flex-1 px-3 py-2 rounded-lg text-xs font-medium transition"
                                    style="background-color:#8b5cf6; color:#fff;">
                                Simulate Bayar
                            </button>
                        </div>
                    </div>
                </template>
                <template x-if="qrisState === 'paid'">
                    <div class="text-center">
                        <div class="w-16 h-16 rounded-full flex items-center justify-center mx-auto" style="background-color:#dcfce7;">
                            <svg class="w-8 h-8" style="color:#16a34a;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <p class="text-sm font-bold mt-3" style="color:#16a34a;">Pembayaran QRIS Berhasil!</p>
                        <p class="text-xs text-gray-500 mt-1">Memproses deposit...</p>
                    </div>
                </template>
            </div>
        </template>

        <!-- QRIS Error -->
        <template x-if="qrisState === 'error'">
            <div class="p-6 text-center">
                <div class="w-12 h-12 rounded-full flex items-center justify-center mx-auto" style="background-color:#fee2e2;">
                    <svg class="w-6 h-6" style="color:#dc2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </div>
                <p class="text-sm font-bold mt-3" style="color:#dc2626;" x-text="qrisError"></p>
                <button type="button" @click="qrisState = 'idle'; qrisError = ''"
                        class="mt-4 px-4 py-2 border border-gray-300 text-gray-600 rounded-lg text-xs font-medium hover:bg-gray-50 transition">
                    Coba Lagi
                </button>
            </div>
        </template>

        <!-- Payment Form (hidden during QRIS) -->
        <form id="deposit-form"
              hx-post="{% url 'tables:booking_deposit_pay' reservation.id %}"
              hx-target="#modal-container" hx-swap="innerHTML"
              class="flex-1 overflow-y-auto p-3 space-y-2.5"
              :class="qrisState !== 'idle' ? 'hidden' : ''">
            {% csrf_token %}

            <!-- Hidden inputs -->
            <input type="hidden" name="amount" :value="amount">
            <input type="hidden" name="payment_method" :value="selectedMethod">
            <input type="hidden" name="payment_profile" :value="selectedProfile">
            <input type="hidden" name="prompt_data" :value="promptDataJson">
            <!-- Split payment hidden inputs -->
            <div x-html="paymentsHiddenHtml"></div>

            <!-- Payment Method Buttons -->
            <div>
                <div class="text-[10px] font-bold text-gray-500 uppercase tracking-wide mb-1.5">Metode Pembayaran</div>
                <div class="grid grid-cols-3 gap-1.5">
                    {% for profile in payment_profiles %}
                    <button type="button"
                            @click="select('{{ profile.legacy_method_id|default:profile.code }}', '{{ profile.id }}')"
                            class="flex items-center gap-2 rounded-xl border-2 transition-all px-2.5 py-2 text-left"
                            :class="selectedProfile === '{{ profile.id }}'
                                ? 'border-green-500 bg-white shadow-md shadow-green-500/10'
                                : 'border-transparent bg-gray-50 text-gray-600 hover:bg-white hover:border-gray-200 hover:shadow-sm'">
                        <div class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center shadow-sm"
                             style="background:{{ profile.color|default:'#6b7280' }}">
                            <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                <circle cx="10" cy="10" r="4"/>
                            </svg>
                        </div>
                        <span class="font-bold text-[11px] leading-tight truncate"
                              :class="selectedProfile === '{{ profile.id }}' ? 'text-green-800' : 'text-gray-700'">{{ profile.name }}</span>
                    </button>
                    {% empty %}
                    <button type="button" @click="select('cash', '')"
                            class="flex items-center gap-2 rounded-xl border-2 transition-all px-2.5 py-2 text-left"
                            :class="selectedMethod === 'cash' ? 'border-green-500 bg-white shadow-md' : 'border-transparent bg-gray-50 hover:bg-white hover:border-gray-200'">
                        <div class="w-5 h-5 rounded-full flex items-center justify-center shadow-sm" style="background:#16a34a">
                            <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4"/></svg>
                        </div>
                        <span class="font-bold text-[11px]" :class="selectedMethod==='cash'?'text-green-800':'text-gray-700'">Cash</span>
                    </button>
                    <button type="button" @click="select('qris', '')"
                            class="flex items-center gap-2 rounded-xl border-2 transition-all px-2.5 py-2 text-left"
                            :class="selectedMethod === 'qris' ? 'border-green-500 bg-white shadow-md' : 'border-transparent bg-gray-50 hover:bg-white hover:border-gray-200'">
                        <div class="w-5 h-5 rounded-full flex items-center justify-center shadow-sm" style="background:#7c3aed">
                            <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4"/></svg>
                        </div>
                        <span class="font-bold text-[11px]" :class="selectedMethod==='qris'?'text-green-800':'text-gray-700'">QRIS</span>
                    </button>
                    <button type="button" @click="select('transfer', '')"
                            class="flex items-center gap-2 rounded-xl border-2 transition-all px-2.5 py-2 text-left"
                            :class="selectedMethod === 'transfer' ? 'border-green-500 bg-white shadow-md' : 'border-transparent bg-gray-50 hover:bg-white hover:border-gray-200'">
                        <div class="w-5 h-5 rounded-full flex items-center justify-center shadow-sm" style="background:#1e40af">
                            <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20"><circle cx="10" cy="10" r="4"/></svg>
                        </div>
                        <span class="font-bold text-[11px]" :class="selectedMethod==='transfer'?'text-green-800':'text-gray-700'">Transfer</span>
                    </button>
                    {% endfor %}
                </div>
            </div>

            <!-- Amount Input -->
            <div class="flex items-center border-2 rounded-xl bg-white transition-all"
                 :class="!currentAllowChange && amount > remaining ? 'border-red-300' : (activeField === 'amount' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200')"
                 @click="activeField = 'amount'; $el.querySelector('input').focus()">
                <span class="pl-3 font-bold text-sm" :class="activeField === 'amount' ? 'text-green-600' : 'text-gray-400'">Rp</span>
                <input type="text"
                       name="amount_display"
                       x-model="amountDisplay"
                       @input="onInput($event.target.value)"
                       @focus="activeField = 'amount'"
                       class="w-full pr-3 py-2 pl-1 text-right text-lg font-bold bg-transparent outline-none"
                       placeholder="0"
                       inputmode="numeric"
                       autocomplete="off">
            </div>

            <!-- Dynamic Prompt Fields per Profile -->
            {% for pm in profiles_list %}
            {% if pm.prompts %}
            <div x-show="selectedProfile === '{{ pm.id }}'" x-cloak class="space-y-2">
                {% for prompt in pm.prompts %}
                <div>
                    <label class="text-[10px] font-semibold uppercase transition-colors"
                           :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'text-green-600' : 'text-gray-500'">
                        {{ prompt.label }}{% if prompt.is_required %} *{% endif %}
                        <span x-show="activeField === 'prompt:{{ prompt.field_name }}'" class="text-[9px] text-green-500 ml-1">NUMPAD</span>
                    </label>
                    <div class="flex items-center gap-1.5">
                        {% if prompt.field_name == 'eft_no' and eft_terminals %}
                        <select x-model="promptValues['{{ prompt.field_name }}']"
                                class="flex-1 border-2 border-gray-200 rounded-lg px-2.5 py-1.5 text-xs focus:border-green-500 outline-none font-mono bg-white">
                            <option value="">-- Pilih Terminal --</option>
                            {% for eft in eft_terminals %}
                            <option value="{{ eft.code }}">{{ eft.code }}: {{ eft.name }}</option>
                            {% endfor %}
                        </select>
                        {% else %}
                        <input type="text"
                               x-model="promptValues['{{ prompt.field_name }}']"
                               placeholder="{{ prompt.placeholder }}"
                               maxlength="{{ prompt.max_length }}"
                               @focus="activeField = 'prompt:{{ prompt.field_name }}'"
                               class="flex-1 border-2 rounded-lg px-2.5 py-1.5 text-xs outline-none transition-all {% if prompt.field_type == 'numeric' %}font-mono{% endif %}"
                               :class="activeField === 'prompt:{{ prompt.field_name }}' ? 'border-green-500 ring-1 ring-green-500/30' : 'border-gray-200'">
                        {% endif %}

                        {% if prompt.field_type == 'scanner' %}
                        <button type="button"
                                @click="generateQR('{{ prompt.field_name }}')"
                                :disabled="qrisState === 'polling' || qrisState === 'generating'"
                                class="px-2.5 py-1.5 rounded-lg text-xs font-bold transition whitespace-nowrap"
                                :class="qrisState === 'polling' || qrisState === 'generating'
                                    ? 'bg-gray-100 text-gray-400 cursor-not-allowed'
                                    : 'bg-purple-100 text-purple-700 hover:bg-purple-200'">
                            <svg class="w-4 h-4 inline-block mr-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v1m6 11h2m-6 0h-2v4m0-11v3m0 0h.01M12 12h4.01M16 20h4M4 12h4m12 0h.01M5 8h2a1 1 0 001-1V5a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1zm12 0h2a1 1 0 001-1V5a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1zM5 20h2a1 1 0 001-1v-2a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1z"/>
                            </svg>
                            QR
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            {% endfor %}

            <!-- Numpad Target Indicator -->
            <div x-show="activeField && activeField.startsWith('prompt:')" x-cloak
                 class="flex items-center gap-1.5 px-2 py-1 bg-green-50 border border-green-200 rounded-lg">
                <svg class="w-3 h-3 text-green-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"/>
                </svg>
                <span class="text-[10px] font-bold text-green-700">Numpad &rarr; <span x-text="activeField.substring(7).toUpperCase()"></span></span>
                <button type="button" @click="activeField = 'amount'" class="ml-auto text-[9px] font-bold text-green-600 hover:text-green-800 bg-green-100 px-1.5 py-0.5 rounded">
                    &larr; Amount
                </button>
            </div>

            <!-- Numpad -->
            <div class="grid grid-cols-4 gap-1.5">
                <button type="button" @click="numpad('7')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">7</button>
                <button type="button" @click="numpad('8')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">8</button>
                <button type="button" @click="numpad('9')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">9</button>
                <button type="button" @click="numpad('DEL')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-amber-100 text-amber-800 hover:bg-amber-200" style="height:38px;">&#9003;</button>
                <button type="button" @click="numpad('4')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">4</button>
                <button type="button" @click="numpad('5')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">5</button>
                <button type="button" @click="numpad('6')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">6</button>
                <button type="button" @click="numpad('C')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-red-100 text-red-800 hover:bg-red-200" style="height:38px;">C</button>
                <button type="button" @click="numpad('1')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">1</button>
                <button type="button" @click="numpad('2')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">2</button>
                <button type="button" @click="numpad('3')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">3</button>
                <button type="button" @click="numpad('00')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">00</button>
                <button type="button" @click="numpad('0')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">0</button>
                <button type="button" @click="numpad('000')" class="rounded-lg font-bold text-sm transition-all active:scale-95 bg-white border border-gray-200 text-gray-800 hover:bg-gray-50" style="height:38px;">000</button>
            </div>

            <!-- Quick Amount Buttons -->
            <div class="grid grid-cols-4 gap-1.5">
                <button type="button" @click="setAmount(remaining)"
                        class="py-1.5 rounded-lg bg-green-600 text-white font-bold text-xs hover:bg-green-700 active:scale-95 transition-all">
                    Exact
                </button>
                <button type="button" @click="setAmount(50000)"
                        class="py-1.5 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                    50K
                </button>
                <button type="button" @click="setAmount(100000)"
                        class="py-1.5 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                    100K
                </button>
                <button type="button" @click="setAmount(Math.ceil(remaining/50000)*50000)"
                        class="py-1.5 rounded-lg bg-gray-100 text-gray-700 font-bold text-xs hover:bg-gray-200 active:scale-95">
                    Round
                </button>
            </div>
        </form>

        <!-- Footer -->
        <div class="p-2.5 border-t bg-gray-50 flex gap-2 rounded-b-xl" style="flex-shrink:0;">
            <button type="button"
                    hx-get="{% url 'tables:booking_dashboard' %}?date={{ reservation.reservation_date|date:'Y-m-d' }}"
                    hx-target="#modal-container" hx-swap="innerHTML"
                    :disabled="qrisState === 'polling' || qrisState === 'paid'"
                    class="px-4 py-2.5 rounded-lg font-bold text-xs transition-all"
                    :class="qrisState === 'polling' || qrisState === 'paid'
                        ? 'bg-gray-200 border-2 border-gray-200 text-gray-400 cursor-not-allowed'
                        : 'bg-white border-2 border-gray-300 text-gray-700 hover:bg-gray-50'">
                Nanti
            </button>
            <button type="button"
                    x-show="qrisState === 'idle' && amount > 0 && (payments.length > 0 || amount < depositAmount)"
                    x-cloak
                    @click="addPayment()"
                    class="px-3 py-2.5 rounded-lg font-bold text-xs bg-blue-600 hover:bg-blue-700 text-white transition-all">
                <span class="flex items-center justify-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                    Split
                </span>
            </button>
            <button type="button"
                    @click="submitPayment()"
                    :disabled="!canPay"
                    class="flex-1 py-2.5 rounded-lg font-bold text-sm transition-all"
                    :class="qrisState === 'polling'
                        ? 'bg-purple-500 text-white shadow-lg animate-pulse'
                        : (canPay ? 'bg-green-600 hover:bg-green-700 text-white shadow-lg' : 'bg-gray-300 text-gray-500 cursor-not-allowed')">
                <span class="flex items-center justify-center gap-1.5">
                    <svg x-show="qrisState !== 'polling'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                    </svg>
                    <svg x-show="qrisState === 'polling'" x-cloak class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/>
                    </svg>
                    <span x-text="qrisState === 'polling' ? 'Menunggu QRIS...' : (canPay ? 'Bayar Rp ' + fmt(payments.length > 0 ? paidTotal : amount) : 'Masukkan Nominal')"></span>
                </span>
            </button>
        </div>
    </div>
</div>

<style>
[x-cloak] { display: none !important; }
</style>

<!--
    Alpine.js + HTMX initialization trick (same as payment_modal.html).
    x-ignore prevents Alpine auto-init on HTMX inject.
    Script below clones without x-ignore so Alpine inits naturally.
-->
<script>
(function() {
    var el = document.querySelector('[data-deposit-modal]');
    if (!el || typeof Alpine === 'undefined') return;

    requestAnimationFrame(function() {
        setTimeout(function() {
            if (el._x_dataStack) return;  // Already init'd, skip
            var clone = el.cloneNode(true);
            clone.removeAttribute('x-ignore');
            el.parentNode.replaceChild(clone, el);
            if (typeof htmx !== 'undefined') htmx.process(clone);
        }, 0);
    });
})();
</script>
