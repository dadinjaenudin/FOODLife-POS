{% extends 'base.html' %}
{% load static %}

{% block title %}Floor Plan - Table Management{% endblock %}

{% block content %}
<!-- Modern Compact Layout -->
<div class="min-h-screen bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50">
    <!-- Compact Header -->
    <div class="sticky top-0 z-50 backdrop-blur-md bg-white/80 border-b border-gray-200 shadow-sm">
        <div class="max-w-full mx-auto px-3 py-2">
            <div class="flex justify-between items-center">
                <!-- Left: Title + Status Legend -->
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-2">
                        <div class="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center shadow">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM14 5a1 1 0 011-1h4a1 1 0 011 1v2a1 1 0 01-1 1h-4a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h4a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM14 13a1 1 0 011-1h4a1 1 0 011 1v6a1 1 0 01-1 1h-4a1 1 0 01-1-1v-6z"></path>
                            </svg>
                        </div>
                        <h1 class="text-lg font-bold text-gray-900">Floor Plan</h1>
                    </div>
                    
                    <!-- Status Legend - Compact -->
                    <div class="flex items-center gap-3 text-xs">
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-green-50 rounded-md border border-green-200">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <span class="font-medium text-green-700">Available</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-red-50 rounded-md border border-red-200">
                            <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                            <span class="font-medium text-red-700">Occupied</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-purple-50 rounded-md border border-purple-200">
                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                            <span class="font-medium text-purple-700">Joined</span>
                        </div>
                        <div class="flex items-center gap-1.5 px-2 py-1 bg-gray-50 rounded-md border border-gray-200">
                            <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                            <span class="font-medium text-gray-700">Needs Cleaning</span>
                        </div>
                    </div>
                </div>
                
                <!-- Right: Back Button -->
                <a href="{% url 'pos:main' %}" class="px-3 py-1.5 bg-gray-800 hover:bg-gray-900 text-white text-sm font-semibold rounded-lg transition-all shadow hover:shadow-md flex items-center gap-1.5">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                    </svg>
                    Back
                </a>
            </div>
        </div>
    </div>

    <!-- Main Content - Compact -->
    <div class="max-w-full px-3 py-3">
        {% if areas %}
            {% for area in areas %}
            <!-- Area Card - Compact -->
            <div class="mb-4">
                <div class="bg-white/90 rounded-lg shadow border border-gray-200">
                    <!-- Area Header - Compact -->
                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-3 py-2 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h2 class="text-sm font-bold text-gray-900">{{ area.name }}</h2>
                            <span class="text-xs text-gray-600">{{ area.tables.count }} tables</span>
                        </div>
                    </div>
                    
                    <!-- Tables Container - Compact Grid -->
                    <div class="p-3">
                        <!-- Compact Grid - More columns, smaller cards -->
                        <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-2">
                            {% for table in area.tables.all %}
                            <div class="relative table-card group" 
                                 data-table-id="{{ table.id }}" 
                                 data-table-number="{{ table.number }}"
                                 data-table-status="{{ table.status }}"
                                 data-is-joined="{{ table.table_group|yesno:'true,false' }}"
                                 draggable="true">
                                <!-- Joined Badge (Top Left) - Compact -->
                                {% if table.table_group %}
                                <div class="absolute -top-1 -left-1 z-20">
                                    <div class="flex h-5 w-5 bg-gradient-to-br from-purple-500 to-indigo-600 rounded-full items-center justify-center shadow border border-white">
                                        <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3zM6 8a2 2 0 11-4 0 2 2 0 014 0zM16 18v-3a5.972 5.972 0 00-.75-2.906A3.005 3.005 0 0119 15v3h-3zM4.75 12.094A5.973 5.973 0 004 15v3H1v-3a3 3 0 013.75-2.906z"/>
                                        </svg>
                                    </div>
                                </div>
                                {% endif %}
                                
                                <!-- Selection Checkbox (Top Right) - Compact -->
                                <div class="absolute top-1 right-1 z-20 selection-checkbox hidden">
                                    <input type="checkbox" 
                                           class="table-select-checkbox w-4 h-4 text-blue-600 rounded border border-white shadow cursor-pointer"
                                           data-table-id="{{ table.id }}"
                                           onclick="event.stopPropagation(); handleTableSelection()">
                                </div>
                                
                                {% if table.status == 'dirty' %}
                                <!-- Clean Table Button (for dirty tables) - COMPACT -->
                                <form method="POST" 
                                      action="{% url 'tables:clean_table' table.id %}"
                                      hx-post="{% url 'tables:clean_table' table.id %}"
                                      hx-target="body"
                                      hx-swap="outerHTML"
                                      class="h-full">
                                    {% csrf_token %}
                                    <button 
                                        type="submit"
                                        class="w-full h-full p-3 rounded-lg border-2 transition-all transform hover:scale-105 active:scale-95 shadow hover:shadow-lg
                                        border-gray-300 bg-gradient-to-br from-gray-50 to-slate-50 hover:from-gray-100 hover:to-slate-100 cursor-pointer">
                                        <div class="text-center">
                                            <!-- Clean Icon - Compact -->
                                            <div class="mb-1">
                                                <svg class="w-6 h-6 mx-auto text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                </svg>
                                            </div>
                                            
                                            <!-- Table Number - Compact -->
                                            <div class="text-lg font-black mb-1 text-gray-700">
                                                {{ table.number }}
                                            </div>
                                            
                                            <!-- Capacity - Compact -->
                                            <div class="text-xs text-gray-500 mb-1">
                                                üë• {{ table.capacity }}
                                            </div>
                                            
                                            <!-- Status Badge - Compact -->
                                            <span class="inline-block px-2 py-0.5 text-xs font-bold rounded-full bg-green-100 text-green-700">
                                                Needs Cleaning
                                            </span>
                                        </div>
                                    </button>
                                </form>
                                {% else %}
                                <!-- Regular Table Button - COMPACT -->
                                <form method="POST" action="{% url 'tables:open_table' table.id %}" class="h-full table-form">
                                    {% csrf_token %}
                                    <button 
                                        type="submit"
                                        {% if table.status == 'reserved' %}disabled{% endif %}
                                        class="w-full h-full p-3 rounded-lg border-2 transition-all transform hover:scale-105 active:scale-95 shadow hover:shadow-lg table-button
                                        {% if table.table_group %}
                                            border-purple-300 bg-gradient-to-br from-purple-50 to-indigo-50 hover:from-purple-100 hover:to-indigo-100 cursor-pointer
                                        {% elif table.status == 'available' %}
                                            border-green-300 bg-gradient-to-br from-green-50 to-emerald-50 hover:from-green-100 hover:to-emerald-100 cursor-pointer
                                        {% elif table.status == 'occupied' %}
                                            border-red-300 bg-gradient-to-br from-red-50 to-pink-50 hover:from-red-100 hover:to-pink-100 cursor-pointer
                                        {% elif table.status == 'reserved' %}
                                            border-yellow-300 bg-gradient-to-br from-yellow-50 to-amber-50 cursor-not-allowed opacity-75
                                        {% else %}
                                            border-blue-300 bg-gradient-to-br from-blue-50 to-indigo-50
                                        {% endif %}"
                                    >
                                        <div class="text-center">
                                            <!-- Table Number - Compact -->
                                            <div class="text-lg font-black mb-1 
                                                {% if table.status == 'available' %}text-green-600
                                                {% elif table.status == 'occupied' %}text-red-600
                                                {% elif table.status == 'reserved' %}text-yellow-600
                                                {% elif table.status == 'dirty' %}text-gray-600
                                                {% else %}text-blue-600{% endif %}">
                                                {{ table.number }}
                                            </div>
                                            
                                            <!-- Capacity - Compact -->
                                            <div class="text-xs text-gray-500 mb-1">
                                                üë• {{ table.capacity }}
                                            </div>
                                            
                                            <!-- Status Badge - Compact -->
                                            {% if table.table_group %}
                                            <span class="inline-block px-2 py-0.5 text-xs font-bold rounded-full bg-purple-100 text-purple-700">
                                                Joined
                                            </span>
                                            {% else %}
                                            <span class="inline-block px-2 py-0.5 text-xs font-bold rounded-full
                                                {% if table.status == 'available' %}bg-green-100 text-green-700
                                                {% elif table.status == 'occupied' %}bg-red-100 text-red-700
                                                {% elif table.status == 'reserved' %}bg-yellow-100 text-yellow-700
                                                {% elif table.status == 'dirty' %}bg-gray-100 text-gray-700
                                                {% else %}bg-blue-100 text-blue-700{% endif %}">
                                                {% if table.status == 'available' %}Available
                                                {% elif table.status == 'occupied' %}Occupied
                                                {% else %}{{ table.get_status_display }}{% endif %}
                                            </span>
                                            {% endif %}
                                        </div>
                                    </button>
                                </form>
                                {% endif %}
                                
                                <!-- Occupied Indicator - Compact -->
                                {% if table.status == 'occupied' %}
                                <div class="absolute -top-1 -right-1 z-10">
                                    <span class="flex h-5 w-5">
                                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                        <span class="relative inline-flex rounded-full h-5 w-5 bg-gradient-to-br from-red-500 to-red-600 items-center justify-center shadow">
                                            <svg class="w-2.5 h-2.5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"></path>
                                            </svg>
                                        </span>
                                    </span>
                                </div>
                                {% endif %}
                                
                                <!-- Drag Handle - Compact -->
                                <div class="absolute top-1 left-1 cursor-move opacity-0 group-hover:opacity-100 transition-opacity">
                                    <div class="w-4 h-4 bg-white/80 backdrop-blur-sm rounded shadow-sm flex items-center justify-center">
                                        <svg class="w-2.5 h-2.5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <!-- No tables message -->
            <div class="backdrop-blur-md bg-white/60 rounded-2xl shadow-xl p-12 text-center">
                <div class="w-24 h-24 mx-auto bg-gradient-to-br from-blue-100 to-indigo-100 rounded-full flex items-center justify-center mb-6">
                    <svg class="w-12 h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-gray-900 mb-2">No Tables Configured</h3>
                <p class="text-gray-600 mb-6">Create table areas and tables to get started with your floor plan</p>
                <a href="{% url 'admin:tables_tablearea_changelist' %}" class="inline-flex items-center px-6 py-3 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Setup Tables
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Floating Join Tables Button - Compact -->
<div id="join-tables-btn" class="fixed bottom-16 left-1/2 transform -translate-x-1/2 z-50 hidden">
    <button onclick="joinTables()" class="px-5 py-2.5 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white text-sm font-bold rounded-full shadow-xl flex items-center gap-2 transition-all transform hover:scale-105 active:scale-95">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
        </svg>
        <span>Join <span id="selected-count" class="font-black">0</span></span>
    </button>
</div>

<!-- Cancel Selection Button - Compact -->
<div id="cancel-selection-btn" class="fixed bottom-16 right-4 z-50 hidden">
    <button onclick="cancelSelection()" class="w-10 h-10 bg-red-500 hover:bg-red-600 text-white font-bold rounded-full shadow-xl flex items-center justify-center transition-all transform hover:scale-110 active:scale-95">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12"/>
        </svg>
    </button>
</div>

<style>
/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.animate-fadeIn {
    animation: fadeIn 0.5s ease-out forwards;
}

.animate-slideUp {
    animation: slideUp 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
}

/* Drag & Drop Styles */
.table-card {
    cursor: grab;
    user-select: none;
}

.table-card:active {
    cursor: grabbing;
}

.table-card.dragging {
    opacity: 0.4;
    transform: scale(0.9) rotate(3deg);
    z-index: 100;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
}

.table-card.drag-over {
    transform: scale(1.05);
    border: 3px dashed #3b82f6 !important;
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(99, 102, 241, 0.15)) !important;
    box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.2);
}

/* Selection Mode Styles */
.table-card.selected {
    transform: scale(1.05);
    border: 3px solid #8b5cf6 !important;
    box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.3), 0 20px 25px -5px rgba(0, 0, 0, 0.2) !important;
    z-index: 10;
}

.table-card.selection-mode {
    cursor: pointer !important;
}

.table-card.selection-mode .table-button {
    pointer-events: none;
}

/* Smooth transitions */
.table-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Hover effects for cards */
.table-card:hover {
    z-index: 10;
}

/* Glassmorphism effects */
.backdrop-blur-md {
    -webkit-backdrop-filter: blur(12px);
    backdrop-filter: blur(12px);
}
</style>

<script>
// Selection Mode State
let selectionMode = false;
let selectedTables = [];
let longPressTimer = null;
const LONG_PRESS_DURATION = 500; // 500ms

// Drag & Drop Functionality
document.addEventListener('DOMContentLoaded', function() {
    const tableCards = document.querySelectorAll('.table-card');
    let draggedElement = null;
    
    // Add long press listeners for each table
    tableCards.forEach(card => {
        const tableId = card.getAttribute('data-table-id');
        const tableStatus = card.getAttribute('data-table-status');
        
        // Long press detection (for mobile and desktop)
        card.addEventListener('mousedown', function(e) {
            if (e.button !== 0) return; // Only left click
            longPressTimer = setTimeout(() => {
                if (tableStatus === 'occupied') {
                    enterSelectionMode();
                    toggleTableSelection(tableId, card);
                }
            }, LONG_PRESS_DURATION);
        });
        
        card.addEventListener('mouseup', clearLongPress);
        card.addEventListener('mouseleave', clearLongPress);
        card.addEventListener('touchstart', function(e) {
            longPressTimer = setTimeout(() => {
                if (tableStatus === 'occupied') {
                    enterSelectionMode();
                    toggleTableSelection(tableId, card);
                }
            }, LONG_PRESS_DURATION);
        });
        card.addEventListener('touchend', clearLongPress);
        card.addEventListener('touchcancel', clearLongPress);
        
        // Click in selection mode
        card.addEventListener('click', function(e) {
            if (selectionMode) {
                e.preventDefault();
                e.stopPropagation();
                
                if (tableStatus === 'occupied') {
                    toggleTableSelection(tableId, card);
                } else {
                    showNotification('‚ö†Ô∏è Only occupied tables can be joined', 'warning');
                }
            }
        });
        
        // Existing drag functionality
        card.addEventListener('dragstart', function(e) {
            if (selectionMode) {
                e.preventDefault();
                return;
            }
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            showNotification('üí° Drag ke posisi yang diinginkan', 'info');
        });
        
        card.addEventListener('dragend', function(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.table-card').forEach(c => c.classList.remove('drag-over'));
            draggedElement = null;
        });
        
        card.addEventListener('dragover', function(e) {
            if (selectionMode) return;
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (draggedElement && draggedElement !== this) {
                this.classList.add('drag-over');
            }
        });
        
        card.addEventListener('dragleave', function(e) {
            this.classList.remove('drag-over');
        });
        
        card.addEventListener('drop', function(e) {
            if (selectionMode) return;
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if (draggedElement && draggedElement !== this) {
                const parent = this.parentNode;
                const draggedIndex = Array.from(parent.children).indexOf(draggedElement);
                const targetIndex = Array.from(parent.children).indexOf(this);
                
                if (draggedIndex < targetIndex) {
                    parent.insertBefore(draggedElement, this.nextSibling);
                } else {
                    parent.insertBefore(draggedElement, this);
                }
                
                saveTableOrder(parent);
                showNotification('‚úÖ Posisi table berhasil diubah!', 'success');
                
                draggedElement.style.transition = 'all 0.3s ease';
                draggedElement.style.transform = 'scale(1.1)';
                setTimeout(() => {
                    draggedElement.style.transform = '';
                }, 300);
            }
        });
    });
});

function clearLongPress() {
    if (longPressTimer) {
        clearTimeout(longPressTimer);
        longPressTimer = null;
    }
}

function enterSelectionMode() {
    if (selectionMode) return;
    
    selectionMode = true;
    document.querySelectorAll('.table-card').forEach(card => {
        card.classList.add('selection-mode');
        card.setAttribute('draggable', 'false');
        const checkbox = card.querySelector('.selection-checkbox');
        if (card.getAttribute('data-table-status') === 'occupied' && checkbox) {
            checkbox.classList.remove('hidden');
        }
    });
    
    document.getElementById('floor-plan-subtitle').textContent = 'Selection mode: Tap tables to join';
    showNotification('üìã Selection mode activated', 'info');
}

function exitSelectionMode() {
    selectionMode = false;
    selectedTables = [];
    
    document.querySelectorAll('.table-card').forEach(card => {
        card.classList.remove('selection-mode', 'selected');
        card.setAttribute('draggable', 'true');
        const checkbox = card.querySelector('.selection-checkbox');
        if (checkbox) {
            checkbox.classList.add('hidden');
            const input = checkbox.querySelector('input');
            if (input) input.checked = false;
        }
    });
    
    document.getElementById('join-tables-btn').classList.add('hidden');
    document.getElementById('cancel-selection-btn').classList.add('hidden');
    document.getElementById('floor-plan-subtitle').textContent = 'Tap table to create order ‚Ä¢ Long press for multi-select';
}

function toggleTableSelection(tableId, card) {
    const checkbox = card.querySelector('.table-select-checkbox');
    const isSelected = selectedTables.includes(tableId);
    
    if (isSelected) {
        selectedTables = selectedTables.filter(id => id !== tableId);
        card.classList.remove('selected');
        if (checkbox) checkbox.checked = false;
    } else {
        selectedTables.push(tableId);
        card.classList.add('selected');
        if (checkbox) checkbox.checked = true;
    }
    
    updateSelectionUI();
}

function handleTableSelection() {
    // This is called when checkbox is clicked directly
    const checkboxes = document.querySelectorAll('.table-select-checkbox:checked');
    selectedTables = Array.from(checkboxes).map(cb => cb.getAttribute('data-table-id'));
    
    // Update visual selection
    document.querySelectorAll('.table-card').forEach(card => {
        const tableId = card.getAttribute('data-table-id');
        if (selectedTables.includes(tableId)) {
            card.classList.add('selected');
        } else {
            card.classList.remove('selected');
        }
    });
    
    updateSelectionUI();
}

function updateSelectionUI() {
    const joinBtn = document.getElementById('join-tables-btn');
    const cancelBtn = document.getElementById('cancel-selection-btn');
    const countText = document.getElementById('selected-count');
    
    if (selectedTables.length >= 2) {
        joinBtn.classList.remove('hidden');
        cancelBtn.classList.remove('hidden');
        countText.textContent = `${selectedTables.length} tables selected`;
    } else if (selectedTables.length === 1) {
        joinBtn.classList.add('hidden');
        cancelBtn.classList.remove('hidden');
        countText.textContent = `${selectedTables.length} table selected`;
    } else {
        joinBtn.classList.add('hidden');
        cancelBtn.classList.add('hidden');
    }
}

function cancelSelection() {
    exitSelectionMode();
    showNotification('‚ùå Selection cancelled', 'info');
}

function joinTables() {
    if (selectedTables.length < 2) {
        showNotification('‚ö†Ô∏è Select at least 2 tables', 'warning');
        return;
    }
    
    // Check if at least one table has an active bill
    let hasBill = false;
    for (const tableId of selectedTables) {
        const card = document.querySelector(`.table-card[data-table-id="${tableId}"]`);
        const status = card ? card.getAttribute('data-table-status') : '';
        if (status === 'occupied') {
            hasBill = true;
            break;
        }
    }
    
    if (!hasBill) {
        showNotification('‚ö†Ô∏è Please open at least one table and add items before joining', 'warning');
        return;
    }
    
    // Get table numbers for confirmation
    const tableNumbers = selectedTables.map(id => {
        const card = document.querySelector(`.table-card[data-table-id="${id}"]`);
        return card ? card.getAttribute('data-table-number') : '';
    }).filter(n => n);
    
    // Show confirmation modal
    showJoinConfirmation(tableNumbers);
}

function showJoinConfirmation(tableNumbers) {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[100]';
    modal.innerHTML = `
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md mx-4 transform transition-all">
            <div class="px-6 py-4 border-b bg-gradient-to-r from-purple-500 to-indigo-600 text-white rounded-t-2xl">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Join Tables</h3>
                        <p class="text-sm text-white/80">Merge bills and combine tables</p>
                    </div>
                </div>
            </div>
            <div class="px-6 py-6">
                <div class="text-center mb-6">
                    <div class="flex justify-center items-center gap-2 mb-4">
                        ${tableNumbers.map(num => `
                            <span class="px-4 py-2 bg-purple-100 text-purple-700 font-bold rounded-lg text-lg">
                                Table ${num}
                            </span>
                        `).join('<svg class="w-5 h-5 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/></svg>')}
                    </div>
                    <p class="text-gray-700 text-lg font-medium mb-2">Join these tables?</p>
                    <p class="text-gray-500 text-sm mb-4">All bills will be merged into one</p>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 text-sm text-blue-700">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>
                        Tables will remain joined until payment
                    </div>
                </div>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-2xl flex gap-3">
                <button onclick="this.closest('.fixed').remove()" class="flex-1 px-4 py-3 border-2 border-gray-300 text-gray-700 rounded-xl hover:bg-gray-100 transition font-semibold">
                    Cancel
                </button>
                <button onclick="confirmJoinTables()" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white rounded-xl transition font-semibold shadow-lg">
                    Join Tables
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
}

function confirmJoinTables() {
    // Close modal
    document.querySelector('.fixed.inset-0').remove();
    
    // Show loading
    const joinBtn = document.getElementById('join-tables-btn');
    const originalHTML = joinBtn.innerHTML;
    joinBtn.querySelector('button').innerHTML = '<svg class="animate-spin h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';
    
    // Send to backend
    fetch('{% url "tables:join_tables" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ table_ids: selectedTables })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Join Tables Response:', data);
        if (data.success) {
            showNotification('‚úÖ Tables joined successfully!', 'success');
            exitSelectionMode();
            // Redirect to POS with joined bill
            console.log('Redirect URL:', data.redirect_url);
            if (data.redirect_url) {
                console.log('Redirecting to:', data.redirect_url);
                setTimeout(() => {
                    window.location.href = data.redirect_url;
                }, 1000);
            } else {
                console.log('No redirect URL, reloading page');
                setTimeout(() => window.location.reload(), 1500);
            }
        } else {
            console.error('Join failed:', data.error);
            showNotification('‚ö†Ô∏è ' + (data.error || 'Failed to join tables'), 'warning');
            joinBtn.innerHTML = originalHTML;
        }
    })
    .catch(error => {
        console.error('Error joining tables:', error);
        showNotification('‚ùå Error joining tables', 'warning');
        joinBtn.innerHTML = originalHTML;
    });
}

// Save table order to backend
function saveTableOrder(container) {
    const tableOrders = [];
    const cards = container.querySelectorAll('.table-card');
    
    cards.forEach((card, index) => {
        const tableId = card.getAttribute('data-table-id');
        if (tableId) {
            tableOrders.push({
                table_id: parseInt(tableId),
                sort_order: index
            });
        }
    });
    
    // Send to backend
    fetch('{% url "tables:save_table_order" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ table_orders: tableOrders })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('‚úÖ Table order saved:', data.message);
        } else {
            console.error('‚ùå Save failed:', data.error);
            showNotification('‚ö†Ô∏è Gagal menyimpan urutan', 'warning');
        }
    })
    .catch(error => {
        console.error('Network error:', error);
        showNotification('‚ö†Ô∏è Error menyimpan urutan', 'warning');
    });
}

// Show notification toast
function showNotification(message, type = 'info') {
    // Remove existing notifications
    document.querySelectorAll('.toast-notification').forEach(n => n.remove());
    
    const notification = document.createElement('div');
    notification.className = `toast-notification fixed top-24 right-6 backdrop-blur-md ${
        type === 'success' ? 'bg-green-500/90' : 
        type === 'info' ? 'bg-blue-500/90' : 
        'bg-yellow-500/90'
    } text-white px-6 py-3 rounded-lg shadow-2xl z-50 animate-slideUp font-semibold flex items-center gap-2`;
    notification.innerHTML = `
        ${type === 'success' ? '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' : 
          '<svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'}
        <span>${message}</span>
    `;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateY(-20px)';
        notification.style.transition = 'all 0.3s ease-out';
        setTimeout(() => notification.remove(), 300);
    }, 2500);
}
</script>

{% endblock %}
