{% extends 'base.html' %}

{% block title %}POS - {{ request.user.outlet.name }}{% endblock %}

{% block extra_head %}
<style>
/* Hide scrollbar for category navigation */
.scrollbar-hide::-webkit-scrollbar {
    display: none;
}
.scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}

<!-- ==================================================
     POS MAIN INTERFACE - 3 COLUMN LAYOUT
     1. Left: Icon-only sidebar navigation (64px)
     2. Center: Main content with header, categories, products, footer (flex-1)
     3. Right: Bill panel with order summary (384px)
     ================================================== -->
<div class="flex h-screen bg-gray-50">
    
    <!-- ==================== LEFT: SIDEBAR (ICON ONLY) ==================== -->
    <aside class="w-20 bg-gray-900 text-white flex flex-col">
        
        <!-- Branding Logo -->
        <div class="h-16 flex items-center justify-center border-b border-gray-800">
            <svg class="w-8 h-8 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
        </div>
        
        <!-- Main Navigation Links -->
        <nav class="flex-1 py-4 overflow-y-auto">
            <!-- Shift Status (HTMX auto-refresh) -->
            <div id="shift-status-sidebar" 
                 hx-get="{% url 'pos:shift_status' %}" 
                 hx-trigger="load, every 30s"
                 hx-swap="innerHTML"
                 class="px-2 py-2">
            </div>
            
            <!-- Divider -->
            <div class="h-px bg-gray-700 mx-2 my-2"></div>
            
            <!-- Shift Reports Group -->
            <div class="px-2 space-y-2">
                <!-- My Shift -->
                <button onclick="openMyShiftDashboard()" 
                        class="w-full py-2.5 px-3 text-xs font-bold text-white bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 rounded-lg transition-all shadow-md text-center"
                        title="My Shift Dashboard">
                    My Shift
                </button>
                
                <!-- Reprint -->
                <button onclick="openReprintReconciliation()" 
                        class="w-full py-2.5 px-3 text-xs font-bold text-gray-200 bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-lg transition-all text-center"
                        title="Reprint Reconciliation">
                    Reprint
                </button>
            </div>
            
            <!-- Divider -->
            <div class="h-px bg-gray-700 mx-2 my-2"></div>
            
            <!-- Kitchen Stations Group -->
            <div class="px-2 space-y-2">
                <!-- Kitchen -->
                <a href="{% url 'kitchen:kds_station' 'kitchen' %}" 
                   target="_blank"
                   class="w-full py-2.5 px-3 text-xs font-bold text-white bg-orange-600 hover:bg-orange-700 rounded-lg transition-all text-center block"
                   title="Kitchen Station">
                    Kitchen
                </a>
                
                <!-- Bar -->
                <a href="{% url 'kitchen:kds_station' 'bar' %}" 
                   target="_blank"
                   class="w-full py-2.5 px-3 text-xs font-bold text-white bg-purple-600 hover:bg-purple-700 rounded-lg transition-all text-center block"
                   title="Bar Station">
                    Bar
                </a>
                
                <!-- Dessert -->
                <a href="{% url 'kitchen:kds_station' 'dessert' %}" 
                   target="_blank"
                   class="w-full py-2.5 px-3 text-xs font-bold text-white bg-pink-600 hover:bg-pink-700 rounded-lg transition-all text-center block"
                   title="Dessert Station">
                    Dessert
                </a>
            </div>
        </nav>
        
        <!-- Bottom Action Buttons -->
        <div class="border-t border-gray-800">
            <!-- Profile Settings -->
            <a href="{% url 'core:profile_settings' %}" 
               class="flex items-center justify-center h-12 hover:bg-gray-800 transition-colors"
               title="Profile Settings">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
            </a>
            
            <!-- Logout -->
            <a href="{% url 'core:logout' %}" 
               class="flex items-center justify-center h-12 hover:bg-red-600 transition-colors"
               title="Logout">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
            </a>
        </div>
    </aside>
    
    <!-- ==================== CENTER: MAIN CONTENT ==================== -->
    <main class="flex-1 flex flex-col">
        
        <!-- Header Section: Outlet Info, Shift Status, User Details, Terminal -->
        <header class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 border-b border-gray-200 px-6 py-4">
            <div class="flex items-center justify-between">
                <!-- Left Side: Outlet & Shift Status -->
                <div class="flex items-center gap-4">
                    <!-- Outlet Information -->
                    <div class="flex items-center gap-3">
                        {% if store_config.login_logo %}
                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center shadow-sm border border-gray-200 overflow-hidden">
                            <img src="{{ store_config.login_logo.url }}" alt="AVRIL" class="w-full h-full object-contain p-1">
                        </div>
                        {% else %}
                        <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-full flex items-center justify-center shadow-md">
                            <span class="text-white text-xl font-bold">A</span>
                        </div>
                        {% endif %}
                        <div>
                            <h2 class="font-bold text-xl tracking-tight bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">AVRIL</h2>
                            <p class="text-xs font-medium text-gray-600 tracking-wide">Yogya Group</p>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side: Terminal Info + User + Profile Photo -->
                <div class="flex items-center gap-4">
                    <!-- Terminal Info - Inline Text (No Box) -->
                    {% if request.terminal %}
                    <div class="text-right text-xs">
                        <p class="text-gray-600">
                            <span class="font-semibold text-blue-900">{{ request.terminal.terminal_code }}</span>
                            <span class="text-gray-400 mx-1">â€¢</span>
                            <span class="text-gray-700">{{ request.user.outlet.company.name }}</span>
                            <span class="text-gray-400 mx-1">â€¢</span>
                            <span class="text-gray-700">{{ request.store.store_code }}</span>
                        </p>
                    </div>
                    {% else %}
                    <!-- Terminal Info from localStorage - Inline Text -->
                    <div class="text-right text-xs">
                        <p class="text-gray-600">
                            <span class="font-semibold text-blue-900" id="header-terminal-code">-</span>
                            <span class="text-gray-400 mx-1">â€¢</span>
                            <span class="text-gray-700" id="header-company-name">-</span>
                            <span class="text-gray-400 mx-1">â€¢</span>
                            <span class="text-gray-700" id="header-store-code">-</span>
                        </p>
                    </div>
                    <script>
                    // Load terminal info from localStorage
                    (function() {
                        const terminalCode = localStorage.getItem('terminal_code') || '-';
                        const companyName = localStorage.getItem('company_name') || '-';
                        const storeCode = localStorage.getItem('store_code') || '-';
                        
                        document.getElementById('header-terminal-code').textContent = terminalCode;
                        document.getElementById('header-company-name').textContent = companyName;
                        document.getElementById('header-store-code').textContent = storeCode;
                    })();
                    </script>
                    {% endif %}
                    
                    <!-- Vertical Divider -->
                    <div class="h-10 w-px bg-gray-300"></div>
                    
                    <!-- User & DateTime -->
                    <div class="text-right">
                        <p class="text-sm font-medium text-gray-700">
                            {{ request.user.get_full_name|default:request.user.username }}
                        </p>
                        <p class="text-xs text-gray-500">{% now "l, d M Y \a\t h:i A" %}</p>
                    </div>
                    
                    <!-- User Profile Photo -->
                    <div class="flex-shrink-0">
                        {% if request.user.profile_photo %}
                        <img src="{{ request.user.profile_photo.url }}" 
                             alt="{{ request.user.get_full_name|default:request.user.username }}"
                             class="w-10 h-10 rounded-full object-cover border-2 border-gray-200">
                        {% else %}
                        <div class="w-10 h-10 rounded-full bg-emerald-500 flex items-center justify-center border-2 border-gray-200">
                            <span class="text-white font-bold text-sm">
                                {{ request.user.get_full_name.0|default:request.user.username.0|upper }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Category Filter Tabs (Icon-Based with Horizontal Scroll) -->
        <nav class="bg-white border-b px-6 py-1">
            <div class="flex items-center gap-3">
                <!-- Category Buttons Container -->
                <div class="flex-1 flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                    <!-- All Categories (Default Active) -->
                    <button 
                        class="flex-shrink-0 flex flex-col items-center gap-0.5 px-2 py-0.5 rounded-lg bg-emerald-50 border-2 border-emerald-500 category-btn transition-all duration-200 hover:shadow-md"
                        hx-get="{% url 'pos:products' %}?category=all"
                        hx-target="#product-grid"
                        hx-swap="innerHTML swap:200ms settle:300ms">
                        <div class="w-6 h-6 bg-emerald-500 rounded-md flex items-center justify-center">
                            <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path>
                            </svg>
                        </div>
                        <span class="text-[9px] font-semibold text-gray-700">All</span>
                    </button>
                    
                    <!-- Dynamic Category Buttons -->
                    {% for category in categories %}
                    <button 
                        class="flex-shrink-0 flex flex-col items-center gap-0.5 px-2 py-0.5 rounded-lg bg-white border-2 border-gray-200 category-btn transition-all duration-200 hover:border-emerald-300 hover:shadow-md"
                        hx-get="{% url 'pos:products' %}?category={{ category.id }}"
                        hx-target="#product-grid"
                        hx-swap="innerHTML swap:200ms settle:300ms">
                        <div class="w-6 h-6 bg-gray-100 rounded-md flex items-center justify-center group-hover:bg-emerald-50">
                            {% if category.icon %}
                            <span class="text-lg">{{ category.icon }}</span>
                            {% else %}
                            <svg class="w-3.5 h-3.5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
                            </svg>
                            {% endif %}
                        </div>
                        <span class="text-[9px] font-medium text-gray-700">{{ category.name }}</span>
                    </button>
                    {% endfor %}
                </div>
                
                <!-- Search Input -->
                <div class="flex-shrink-0 relative pb-2">
                    <input 
                        type="text" 
                        id="product-search"
                        placeholder="Search menu..."
                        class="w-64 px-3 py-1.5 pr-9 text-sm border-2 border-gray-200 rounded-lg focus:outline-none focus:border-emerald-500 transition-colors"
                        hx-get="{% url 'pos:products' %}"
                        hx-trigger="keyup changed delay:300ms"
                        hx-target="#product-grid"
                        hx-include="this"
                        name="search">
                    <svg class="absolute right-3 top-2 w-4 h-4 text-gray-400 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
            </div>
        </nav>
        
        <!-- Product Grid Container (Responsive, scrollable) -->
        <section id="product-grid" class="flex-1 p-6 overflow-y-auto bg-white" style="padding-bottom: 80px;">
            {% include 'pos/partials/product_grid.html' %}
        </section>
        
        <!-- Footer Action Buttons (Single Row) - Compact Design -->
        <footer id="pos-footer" class="bg-white border-t border-gray-200 shadow-lg">
            <div class="flex gap-2 p-1.5">
                <!-- Move Table (Requires Active Bill) -->
                <button 
                    class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1 {% if bill %}bg-white border-2 border-cyan-500 hover:bg-cyan-50{% else %}bg-gray-100 border-2 border-gray-300{% endif %} rounded-lg transition-all duration-200 hover:shadow-md {% if not bill %}opacity-60 cursor-not-allowed{% endif %}"
                    {% if bill %}
                    hx-get="{% url 'pos:move_table_modal' bill.id %}"
                    hx-target="#modal-container"
                    {% else %}
                    disabled
                    title="No active bill"
                    {% endif %}>
                    <div class="w-6 h-6 {% if bill %}bg-cyan-500{% else %}bg-gray-300{% endif %} rounded-md flex items-center justify-center">
                        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" 
                                  d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                    </div>
                    <span class="text-[9px] font-semibold {% if bill %}text-gray-700{% else %}text-gray-500{% endif %}">Move Table</span>
                </button>
                
                <!-- Payment (Requires Active Bill) -->
                <button 
                    class="flex-1 flex flex-col items-center gap-0.5 px-2 py-1 {% if bill %}bg-emerald-50 border-2 border-emerald-500 hover:bg-emerald-100{% else %}bg-gray-100 border-2 border-gray-300{% endif %} rounded-lg transition-all duration-200 hover:shadow-md {% if not bill %}opacity-60 cursor-not-allowed{% endif %}"
                    {% if bill %}
                    hx-get="{% url 'pos:payment_modal' bill.id %}"
                    hx-target="#modal-container"
                    {% else %}
                    disabled
                    title="No active bill"
                    {% endif %}>
                    <div class="w-6 h-6 {% if bill %}bg-emerald-500{% else %}bg-gray-300{% endif %} rounded-md flex items-center justify-center">
                        <svg class="w-3.5 h-3.5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" 
                                  d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <span class="text-[9px] font-bold {% if bill %}text-gray-700{% else %}text-gray-500{% endif %}">PAYMENT</span>
                </button>
            </div>
        </footer>
    </main>
    
    <!-- ==================== RIGHT: BILL PANEL ==================== -->
    <aside class="w-96 bg-white border-l flex flex-col shadow-lg" id="bill-panel">
        {% include 'pos/partials/bill_panel.html' %}
    </aside>
    
</div>

<!-- JavaScript: Category Button Active State Management -->
<script>
// Quick Order Alpine.js Component - Global Function
function quickOrder() {
    console.log('ðŸ”µ Alpine.js quickOrder() initialized:', new Date().toISOString());
    return {
        items: [],
        customerName: '',
        paymentMethod: 'cash',
        paymentAmount: 0,
        
        get total() {
            return this.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        },
        
        get formattedPaymentAmount() {
            return this.formatNumber(this.paymentAmount);
        },
        
        set formattedPaymentAmount(value) {
            // Remove all commas and parse as number
            this.paymentAmount = parseInt(value.replace(/,/g, '')) || 0;
        },
        
        addItem(productId, name, price) {
            console.log('âž• Adding item:', productId, name, price);
            const existingItem = this.items.find(item => item.product_id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                this.items.push({
                    product_id: productId,
                    name: name,
                    price: price,
                    quantity: 1
                });
            }
            // Auto set payment amount
            this.paymentAmount = this.total;
        },
        
        removeItem(index) {
            this.items.splice(index, 1);
            this.paymentAmount = this.total;
        },
        
        increaseQty(index) {
            this.items[index].quantity++;
            this.paymentAmount = this.total;
        },
        
        decreaseQty(index) {
            if (this.items[index].quantity > 1) {
                this.items[index].quantity--;
                this.paymentAmount = this.total;
            } else {
                this.removeItem(index);
            }
        },
        
        parseIndonesianNumber(str) {
            // Convert Indonesian format (10.000,00) to number (10000)
            // Remove thousand separators (.) and replace decimal comma (,) with dot
            return parseFloat(str.replace(/\./g, '').replace(',', '.'));
        },
        
        formatRupiah(amount) {
            // Format dengan pemisah ribuan (koma)
            const num = Math.round(amount).toString();
            const formatted = num.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            console.log('formatRupiah:', amount, '=>', 'Rp ' + formatted);
            return 'Rp ' + formatted;
        },
        
        formatNumber(amount) {
            // Format number dengan pemisah ribuan (koma) tanpa prefix Rp
            const num = Math.round(amount).toString();
            return num.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
        },
        
        submitOrder() {
            if (this.items.length === 0 || this.paymentAmount < this.total) {
                return;
            }
            
            const formData = new FormData();
            formData.append('items', JSON.stringify(this.items));
            formData.append('payment_method', this.paymentMethod);
            formData.append('payment_amount', this.paymentAmount);
            formData.append('customer_name', this.customerName);
            formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
            
            fetch('/pos/quick-order/create/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                document.getElementById('modal-container').innerHTML = html;
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to create order');
            });
        }
    }
}

// Ensure modal-container always exists on page load
document.addEventListener('DOMContentLoaded', function() {
    let modalContainer = document.getElementById('modal-container');
    if (!modalContainer) {
        modalContainer = document.createElement('div');
        modalContainer.id = 'modal-container';
        document.body.appendChild(modalContainer);
    }
});

/**
 * Updates active category button styling after product grid HTMX swap
 * Removes active state from all buttons and adds it to the clicked button
 */
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'product-grid') {
        // Remove active styling from all category buttons
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.remove('bg-gray-900', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700');
        });
        
        // Add active styling to clicked button
        event.detail.elt.classList.remove('bg-gray-100', 'text-gray-700');
        event.detail.elt.classList.add('bg-gray-900', 'text-white');
    }
});

/**
 * Ensure modal container exists before any HTMX request to it
 */
document.addEventListener('htmx:beforeRequest', function(event) {
    // Check if request is targeting modal-container
    const targetSelector = event.detail.elt.getAttribute('hx-target');
    if (targetSelector === '#modal-container') {
        // Ensure it exists
        let modalContainer = document.getElementById('modal-container');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modal-container';
            document.body.appendChild(modalContainer);
            // Update the target reference
            event.detail.target = modalContainer;
        }
    }
});

/**
 * Handle HTMX target errors silently
 */
document.addEventListener('htmx:targetError', function(event) {
    const targetSelector = event.detail.elt.getAttribute('hx-target');
    
    if (targetSelector === '#modal-container') {
        // Recreate modal container if missing
        let modalContainer = document.getElementById('modal-container');
        if (!modalContainer) {
            modalContainer = document.createElement('div');
            modalContainer.id = 'modal-container';
            document.body.appendChild(modalContainer);
        }
        
        // Retry the request
        const url = event.detail.elt.getAttribute('hx-get') || event.detail.elt.getAttribute('hx-post');
        if (url) {
            htmx.ajax('GET', url, {target: '#modal-container', swap: 'innerHTML'});
        }
    }
});

/**
 * Ensure modal container doesn't get completely removed
 */
document.addEventListener('htmx:beforeSwap', function(event) {
    if (event.detail.target.id === 'modal-container') {
        // Allow the swap to happen normally
        event.detail.shouldSwap = true;
    }
});

/**
 * Clean up after HTMX requests to modal-container
 */
document.addEventListener('htmx:afterSwap', function(event) {
    if (event.detail.target.id === 'modal-container') {
        // Ensure button is re-enabled
        const heldBillsBtn = document.getElementById('held-bills-btn');
        if (heldBillsBtn) {
            heldBillsBtn.disabled = false;
            heldBillsBtn.classList.remove('htmx-request');
        }
        console.log('Modal content swapped successfully');
        
        // Reprocess modal content to enable HTMX attributes
        const modalContainer = document.getElementById('modal-container');
        if (modalContainer) {
            htmx.process(modalContainer);
        }
    }
    
    // Re-process HTMX attributes when bill-panel is updated (after resume or add item)
    if (event.detail.target.id === 'bill-panel') {
        // Use setTimeout to ensure DOM is fully updated
        setTimeout(function() {
            const billPanel = document.getElementById('bill-panel');
            if (billPanel) {
                // Force HTMX to re-process all elements inside
                htmx.process(billPanel);
                
                // Specifically re-enable the View Held Bills button
                const heldBillsBtn = document.getElementById('held-bills-btn');
                if (heldBillsBtn) {
                    heldBillsBtn.classList.remove('htmx-request', 'htmx-swapping');
                    heldBillsBtn.disabled = false;
                    htmx.process(heldBillsBtn);
                }
            }
            
            // Re-process product grid to enable Add buttons
            const productGrid = document.getElementById('product-grid');
            if (productGrid) {
                htmx.process(productGrid);
            }
        }, 50);
    }
    
    // Also handle when bill-panel is swapped as outerHTML (target is the swapped element itself)
    // Check if the swapped element is bill-panel or contains bill-panel
    const swappedElement = event.detail.target;
    if (swappedElement && (swappedElement.id === 'bill-panel' || swappedElement.querySelector('#bill-panel'))) {
        setTimeout(function() {
            const billPanel = document.getElementById('bill-panel');
            if (billPanel) {
                console.log('Re-processing bill-panel after outerHTML swap');
                htmx.process(billPanel);
            }
        }, 100);
    }
});

/**
 * After settle - ensure all HTMX elements are processed
 * This is called after animations complete
 */
document.addEventListener('htmx:afterSettle', function(event) {
    // Check if bill-panel was involved in the swap
    const target = event.detail.target;
    if (target && (target.id === 'bill-panel' || target.closest('#bill-panel') || document.getElementById('bill-panel'))) {
        const billPanel = document.getElementById('bill-panel');
        if (billPanel) {
            console.log('htmx:afterSettle - Re-processing bill-panel');
            htmx.process(billPanel);
            
            // Also reprocess modal container to ensure delete buttons work
            const modalContainer = document.getElementById('modal-container');
            if (modalContainer) {
                htmx.process(modalContainer);
            }
        }
    }
});

/**
 * Log when HTMX requests are triggered for debugging
 */
document.addEventListener('htmx:trigger', function(event) {
    const url = event.detail.elt.getAttribute('hx-get') || 
                event.detail.elt.getAttribute('hx-post') || 
                event.detail.elt.getAttribute('hx-delete');
    console.log('HTMX Request triggered:', url, event.detail.elt);
});

/**
 * Global modal functions - Must be in main.html to persist after modal content swaps
 */
function closeHeldBillsModal() {
    const modalContainer = document.getElementById('modal-container');
    if (modalContainer) {
        // Clear content first
        modalContainer.innerHTML = '';
        
        // Force HTMX to re-process this element
        htmx.process(modalContainer);
        
        console.log('Held Bills modal closed and processed');
    }
}

function cancelHeldBill(billId) {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/pos/bill/${billId}/cancel/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/json'
        }
    }).then(response => {
        if (response.ok) {
            closeHeldBillsModal();
            // Refresh bill panel if active
            const billPanel = document.getElementById('bill-panel');
            if (billPanel) {
                htmx.trigger(billPanel, 'refreshBillPanel');
            }
        }
    });
}

/**
 * Show toast notification
 */
function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
        type === 'warning' ? 'bg-yellow-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'success' ? 'bg-green-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    toast.textContent = message;
    
    // Add to body
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => toast.style.opacity = '1', 10);
    
    // Remove after 3 seconds
    setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

// Listen for HTMX notification events
document.addEventListener('showNotification', function(event) {
    const detail = event.detail;
    showToast(detail.message, detail.type || 'info');
});

// Category button active state toggle
document.addEventListener('DOMContentLoaded', function() {
    const categoryButtons = document.querySelectorAll('.category-btn');
    
    categoryButtons.forEach(button => {
        button.addEventListener('click', function() {
            // Remove active state from all buttons
            categoryButtons.forEach(btn => {
                btn.classList.remove('bg-emerald-50', 'border-emerald-500');
                btn.classList.add('bg-white', 'border-gray-200');
                
                // Reset icon background
                const icon = btn.querySelector('div');
                if (icon) {
                    icon.classList.remove('bg-emerald-500');
                    icon.classList.add('bg-gray-100');
                    
                    // Reset icon color
                    const svg = icon.querySelector('svg');
                    if (svg) {
                        svg.classList.remove('text-white');
                        svg.classList.add('text-gray-600');
                    }
                }
            });
            
            // Add active state to clicked button
            this.classList.remove('bg-white', 'border-gray-200');
            this.classList.add('bg-emerald-50', 'border-emerald-500');
            
            // Update icon background
            const activeIcon = this.querySelector('div');
            if (activeIcon) {
                activeIcon.classList.remove('bg-gray-100');
                activeIcon.classList.add('bg-emerald-500');
                
                // Update icon color
                const activeSvg = activeIcon.querySelector('svg');
                if (activeSvg) {
                    activeSvg.classList.remove('text-gray-600');
                    activeSvg.classList.add('text-white');
                }
            }
        });
    });
});

// Function to open reprint reconciliation modal
function openReprintReconciliation() {
    fetch('/pos/shift/history/')
        .then(response => response.text())
        .then(html => {
            // Remove existing modal if any
            const existingModal = document.getElementById('reprint-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Inject modal HTML
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Format amounts after modal is injected
            setTimeout(() => {
                document.querySelectorAll('#reprint-modal .amount').forEach(function(el) {
                    const value = el.textContent.trim();
                    const formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    el.textContent = formatted;
                });
            }, 100);
        })
        .catch(error => {
            console.error('Error loading shift history:', error);
            alert('Failed to load shift history');
        });
}

// Function to print reconciliation (called from modal buttons)
function printReconciliation(shiftId) {
    const printUrl = `/pos/shift/${shiftId}/print-reconciliation/`;
    window.open(printUrl, '_blank', 'width=800,height=600');
    
    // Show success toast
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50';
    toast.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
        </svg>
        <div>
            <p class="font-bold">Opening Print...</p>
            <p class="text-sm text-blue-100">Reconciliation report</p>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
    
    // Close modal after slight delay
    setTimeout(() => {
        const modal = document.getElementById('reprint-modal');
        if (modal) modal.remove();
    }, 500);
}

// Function to open My Shift Dashboard
function openMyShiftDashboard() {
    fetch('/pos/shift/my-dashboard/')
        .then(response => response.text())
        .then(html => {
            // Remove existing modal if any
            const existingModal = document.getElementById('my-shift-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Inject modal HTML
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Format amounts after modal is injected
            setTimeout(() => {
                document.querySelectorAll('#my-shift-modal .amount').forEach(function(el) {
                    const value = el.textContent.trim();
                    const formatted = value.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                    el.textContent = formatted;
                });
            }, 100);
        })
        .catch(error => {
            console.error('Error loading shift dashboard:', error);
            
            // Show error toast
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-red-500 to-rose-600 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50';
            toast.innerHTML = `
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="font-bold">Error</p>
                    <p class="text-sm">Please open a shift first</p>
                </div>
            `;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        });
}

// Print Interim Report - Global function for My Shift Dashboard
function printInterimReport() {
    // Get shift ID from modal data attribute or fetch from session
    const modal = document.getElementById('my-shift-modal');
    if (!modal) return;
    
    const shiftId = modal.dataset.shiftId;
    if (!shiftId) {
        console.error('No shift ID found');
        return;
    }
    
    const printUrl = `/pos/shift/${shiftId}/print-interim/`;
    window.open(printUrl, '_blank', 'width=800,height=600');
    
    // Show toast
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-4 py-3 rounded-lg shadow-2xl flex items-center gap-2 z-50';
    toast.innerHTML = `
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
        </svg>
        <div>
            <p class="font-bold text-sm">Opening Print...</p>
            <p class="text-xs text-blue-100">Interim report</p>
        </div>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

</script>

{% endblock %}