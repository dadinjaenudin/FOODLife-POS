<!-- Void Item with PIN Modal -->
<div id="void-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full">
        <!-- Header -->
        <div class="bg-gradient-to-r from-red-600 to-rose-600 text-white px-6 py-4 rounded-t-xl">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Void Item</h3>
                        <p class="text-sm text-red-100">Supervisor approval required</p>
                    </div>
                </div>
                <button onclick="document.getElementById('void-item-modal').remove()" 
                        class="text-white hover:text-red-100 transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Content -->
        <div class="p-6">
            <!-- Item Info -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-600">Item</p>
                        <p class="text-lg font-bold text-gray-900">{{ item.product.name }}</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-gray-600">Quantity</p>
                        <p class="text-lg font-bold text-gray-900">{{ item.quantity }}x</p>
                    </div>
                </div>
            </div>

            <form id="void-item-form" class="space-y-4">
                <!-- Supervisor PIN -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                        </svg>
                        Supervisor PIN
                    </label>
                    <input 
                        type="password" 
                        id="supervisor-pin"
                        name="supervisor_pin"
                        maxlength="6"
                        placeholder="Enter 6-digit PIN"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 text-center text-2xl font-mono tracking-widest"
                        required
                        autofocus>
                    <p class="text-xs text-gray-500 mt-1">Ask supervisor for their 6-digit PIN</p>
                </div>

                <!-- Void Reason -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"/>
                        </svg>
                        Reason for Void
                    </label>
                    <textarea 
                        id="void-reason"
                        name="reason"
                        rows="3"
                        placeholder="Why are you voiding this item?"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 resize-none"
                        required></textarea>
                </div>

                <!-- Error Message -->
                <div id="void-error" class="hidden bg-red-50 border-l-4 border-red-500 p-3 rounded">
                    <p class="text-sm text-red-700 font-medium"></p>
                </div>
            </form>
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 rounded-b-xl flex gap-3">
            <button 
                onclick="document.getElementById('void-item-modal').remove()"
                class="flex-1 px-4 py-2.5 border-2 border-gray-300 text-gray-700 font-bold rounded-lg hover:bg-gray-100 transition-all">
                Cancel
            </button>
            <button 
                onclick="submitVoidItem()"
                class="flex-1 px-4 py-2.5 bg-gradient-to-r from-red-600 to-rose-600 text-white font-bold rounded-lg hover:from-red-700 hover:to-rose-700 transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                </svg>
                Void Item
            </button>
        </div>
    </div>
</div>

<script>
function submitVoidItem() {
    const pin = document.getElementById('supervisor-pin').value;
    const reason = document.getElementById('void-reason').value;
    const errorDiv = document.getElementById('void-error');
    const errorText = errorDiv.querySelector('p');
    
    // Validation
    if (!pin || pin.length !== 6) {
        errorDiv.classList.remove('hidden');
        errorText.textContent = 'Please enter a valid 6-digit PIN';
        return;
    }
    
    if (!reason.trim()) {
        errorDiv.classList.remove('hidden');
        errorText.textContent = 'Please provide a reason for voiding';
        return;
    }
    
    // Hide error
    errorDiv.classList.add('hidden');
    
    // Submit via HTMX
    const formData = new FormData();
    formData.append('supervisor_pin', pin);
    formData.append('reason', reason);
    
    fetch('{% url "pos:void_item" item.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(text || 'Invalid PIN or unauthorized');
            });
        }
        return response.text();
    })
    .then(html => {
        // Update bill panel using outerHTML to replace entire element
        const billPanel = document.getElementById('bill-panel');
        if (billPanel) {
            billPanel.outerHTML = html;
        }
        
        // Close modal
        const modal = document.getElementById('void-item-modal');
        if (modal) {
            modal.remove();
        }
        
        // Reprocess HTMX on new bill-panel
        setTimeout(function() {
            const newBillPanel = document.getElementById('bill-panel');
            if (newBillPanel) {
                htmx.process(newBillPanel);
                console.log('Bill panel reprocessed after void');
            }
        }, 100);
        
        // Show success toast
        showToast('success', 'Item voided successfully');
    })
    .catch(error => {
        errorDiv.classList.remove('hidden');
        errorText.textContent = error.message || 'Invalid PIN or you do not have permission';
    });
}

function showToast(type, message) {
    const toast = document.createElement('div');
    const bgColor = type === 'success' ? 'from-green-500 to-emerald-600' : 'from-red-500 to-rose-600';
    toast.className = `fixed top-4 right-4 bg-gradient-to-r ${bgColor} text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 z-50`;
    toast.innerHTML = `
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        <p class="font-bold">${message}</p>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 2000);
}

// Auto-focus PIN input and handle Enter key
document.getElementById('supervisor-pin').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('void-reason').focus();
    }
});

document.getElementById('void-reason').addEventListener('keypress', function(e) {
    if (e.key === 'Enter' && e.ctrlKey) {
        e.preventDefault();
        submitVoidItem();
    }
});

// Only allow numbers in PIN
document.getElementById('supervisor-pin').addEventListener('input', function(e) {
    this.value = this.value.replace(/[^0-9]/g, '');
});
</script>
