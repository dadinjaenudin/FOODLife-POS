{% load humanize %}

<div class="bg-white rounded-lg shadow-lg overflow-hidden relative
            {% if order.priority == 'urgent' %}ring-4 ring-red-600 animate-pulse{% endif %}
            {% if order.priority == 'rush' %}ring-2 ring-orange-500{% endif %}"
     x-data="{ elapsedTime: {{ order.get_elapsed_time }}, updateTimer() { this.elapsedTime++; } }"
     x-init="setInterval(() => updateTimer(), 1000)">
    
    <!-- Compact Header with Timer -->
    <div class="p-2.5 
        {% if order.status == 'new' %}bg-gradient-to-r from-red-500 to-red-600
        {% elif order.status == 'preparing' %}bg-gradient-to-r from-yellow-500 to-yellow-600
        {% else %}bg-gradient-to-r from-green-500 to-green-600{% endif %} text-white">
        
        <div class="flex justify-between items-start">
            <!-- Table/Queue Info -->
            <div class="flex-1">
                <div class="font-bold text-xl leading-tight">
                    {% if order.bill.table %}
                        ü™ë {{ order.bill.table.number }}
                    {% else %}
                        #{{ order.bill.queue_number|default:order.bill.bill_number|slice:"-4" }}
                    {% endif %}
                </div>
                <div class="text-xs opacity-90 mt-0.5">
                    {{ order.created_at|date:"H:i" }}
                    {% if order.priority == 'urgent' %}
                        ‚Ä¢ üö® URGENT
                    {% elif order.priority == 'rush' %}
                        ‚Ä¢ ‚ö° RUSH
                    {% endif %}
                </div>
            </div>
            
            <!-- Big Timer -->
            <div class="text-right">
                <div class="text-3xl font-black leading-none tracking-tight
                    {% if order.get_time_status == 'overdue' %}animate-pulse{% endif %}"
                    x-text="Math.floor(elapsedTime / 60) + ':' + String(elapsedTime % 60).padStart(2, '0')">
                    0:00
                </div>
                <div class="text-[10px] opacity-80 mt-0.5">
                    max {{ order.target_prep_time }}m
                </div>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div class="mt-2 h-1.5 bg-black/20 rounded-full overflow-hidden">
            <div class="h-full bg-white transition-all duration-1000"
                 :style="'width: ' + Math.min((elapsedTime / ({{ order.target_prep_time }} * 60)) * 100, 100) + '%'">
            </div>
        </div>
    </div>
    
    <!-- Items List - Compact -->
    <div class="p-2.5 space-y-1.5 max-h-48 overflow-y-auto bg-gray-50">
        {% for item in order.bill.items.all %}
        {% if item.product.printer_target == order.station and not item.is_void %}
        <div class="bg-white rounded px-2 py-1.5 {% if item.status == 'ready' %}opacity-50 line-through{% endif %}">
            <div class="flex gap-1.5 items-center">
                <span class="bg-gray-900 text-white px-1.5 py-0.5 rounded text-xs font-bold min-w-[28px] text-center">{{ item.quantity }}x</span>
                <span class="font-semibold text-sm">{{ item.product.name }}</span>
            </div>
            {% if item.notes %}
            <div class="text-xs text-red-600 font-bold mt-1 ml-8 flex items-start gap-1">
                <span>‚ö†Ô∏è</span>
                <span>{{ item.notes }}</span>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Action Button -->
    <div class="p-2">
        {% if order.status == 'new' %}
        <button 
            class="w-full py-2.5 rounded-lg bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 text-white font-bold text-base shadow-lg hover:shadow-xl transition-all"
            hx-post="{% url 'kitchen:kds_start' order.id %}"
            hx-target="closest div.bg-white"
            hx-swap="outerHTML">
            ‚ñ∂Ô∏è START
        </button>
        
        {% elif order.status == 'preparing' %}
        <button 
            class="w-full py-2.5 rounded-lg bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold text-base shadow-lg hover:shadow-xl transition-all pulse-glow"
            hx-post="{% url 'kitchen:kds_ready' order.id %}"
            hx-swap="delete"
            hx-target="closest div.bg-white">
            ‚úÖ DONE
        </button>
        
        {% elif order.status == 'ready' %}
        <button 
            class="w-full py-2.5 rounded-lg bg-gray-200 text-gray-500 font-bold text-base cursor-not-allowed"
            disabled>
            ‚úì Ready to Serve
        </button>
        {% endif %}
    </div>
</div>

<style>
@keyframes pulse-glow {
    0%, 100% { 
        box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        transform: scale(1);
    }
    50% { 
        box-shadow: 0 6px 30px rgba(34, 197, 94, 0.6);
        transform: scale(1.02);
    }
}

.pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
}
</style>
