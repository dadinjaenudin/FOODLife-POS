{% load humanize %}

{# Alpine.js data: track elapsed time and overdue state client-side #}
<div class="kds-card rounded-xl shadow-lg overflow-hidden relative"
     x-data="{
         elapsed: Math.floor({{ order.get_elapsed_time }}),
         target: {{ order.target_prep_time }} * 60,
         get isOverdue() { return this.elapsed > this.target },
         get isWarning() { return this.elapsed > this.target * 0.7 && !this.isOverdue },
         tick() { this.elapsed++ }
     }"
     x-init="setInterval(() => tick(), 1000)"
     :class="{
         'ring-4 ring-red-500 animate-pulse': isOverdue && '{{ order.status }}' !== 'ready',
         'ring-2 ring-orange-400': isWarning && !isOverdue && '{{ order.status }}' !== 'ready',
         {% if order.priority == 'urgent' %}'ring-4 ring-red-600 animate-pulse': true,{% endif %}
         {% if order.priority == 'rush' %}'ring-2 ring-orange-500': true,{% endif %}
     }">

    {# ==================== HEADER ==================== #}
    <div class="px-3 py-2.5
        {% if order.status == 'new' %}bg-gradient-to-r from-red-500 to-red-600
        {% elif order.status == 'preparing' %}bg-gradient-to-r from-amber-500 to-orange-500
        {% else %}bg-gradient-to-r from-green-500 to-green-600{% endif %} text-white">

        <div class="flex justify-between items-start">
            {# Left: Table/Queue + Order Type #}
            <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                    {# Order Type Icon #}
                    {% if order.bill.bill_type == 'dine_in' %}
                        <span class="text-2xl" title="Dine In">ü™ë</span>
                    {% elif order.bill.bill_type == 'takeaway' %}
                        <span class="text-2xl" title="Take Away">üõçÔ∏è</span>
                    {% elif order.bill.bill_type == 'delivery' %}
                        <span class="text-2xl" title="Delivery">üõµ</span>
                    {% else %}
                        <span class="text-2xl">ü™ë</span>
                    {% endif %}

                    {# Table/Queue Number - BIG #}
                    <div class="font-black text-2xl leading-tight tracking-tight">
                        {% if order.bill.table %}
                            {{ order.bill.table.number }}
                        {% else %}
                            #{{ order.bill.queue_number|default:order.bill.bill_number|slice:"-4" }}
                        {% endif %}
                    </div>
                </div>

                {# Time + Priority badge #}
                <div class="flex items-center gap-1.5 mt-1">
                    <span class="text-xs opacity-80">{{ order.created_at|date:"H:i" }}</span>
                    {% if order.priority == 'urgent' %}
                        <span class="bg-red-900/60 text-white text-[10px] font-black px-1.5 py-0.5 rounded uppercase tracking-wide">üö® URGENT</span>
                    {% elif order.priority == 'rush' %}
                        <span class="bg-orange-900/60 text-white text-[10px] font-black px-1.5 py-0.5 rounded uppercase tracking-wide">‚ö° RUSH</span>
                    {% endif %}

                    {# Order type label #}
                    {% if order.bill.bill_type == 'takeaway' %}
                        <span class="bg-white/20 text-[10px] font-bold px-1.5 py-0.5 rounded">TAKE AWAY</span>
                    {% elif order.bill.bill_type == 'delivery' %}
                        <span class="bg-white/20 text-[10px] font-bold px-1.5 py-0.5 rounded">DELIVERY</span>
                    {% endif %}
                </div>
            </div>

            {# Right: BIG Timer #}
            <div class="text-right flex-shrink-0">
                <div class="font-black leading-none tracking-tight text-4xl"
                     :class="{ 'text-white': !isOverdue, 'text-red-200 animate-pulse': isOverdue && '{{ order.status }}' !== 'ready' }"
                     x-text="Math.floor(elapsed / 60) + ':' + String(Math.floor(elapsed % 60)).padStart(2, '0')">
                    0:00
                </div>
                <div class="text-[10px] opacity-70 mt-0.5">
                    max {{ order.target_prep_time }}m
                </div>
            </div>
        </div>

        {# OVERDUE Banner - shows when time exceeded #}
        <div x-show="isOverdue && '{{ order.status }}' !== 'ready'"
             x-transition
             class="mt-1.5 bg-red-900/70 text-red-100 text-center text-xs font-black py-1 rounded tracking-widest uppercase">
            ‚è∞ OVERDUE
        </div>

        {# Progress Bar #}
        <div class="mt-2 h-1.5 bg-black/20 rounded-full overflow-hidden">
            <div class="h-full transition-all duration-1000 rounded-full"
                 :class="isOverdue ? 'bg-red-300' : isWarning ? 'bg-yellow-300' : 'bg-white'"
                 :style="'width: ' + Math.min((elapsed / target) * 100, 100) + '%'">
            </div>
        </div>
    </div>

    {# ==================== ITEMS LIST ==================== #}
    <div class="p-2.5 space-y-1.5 max-h-64 overflow-y-auto bg-gray-50">
        {% for item in order.get_batch_items %}
        <div class="bg-white rounded-lg px-3 py-2 shadow-sm">
            {# Item name + quantity - LARGE for readability from distance #}
            <div class="flex gap-2 items-center">
                <span class="bg-gray-900 text-white px-2 py-1 rounded-md text-base font-black min-w-[36px] text-center">{{ item.quantity }}x</span>
                <span class="font-bold text-lg leading-snug">{{ item.product.name }}</span>
            </div>

            {# Modifiers - Colored Pills #}
            {% if item.modifiers %}
            <div class="flex flex-wrap gap-1 mt-1.5 ml-11">
                {% for mod in item.modifiers %}
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-bold bg-blue-100 text-blue-800 border border-blue-200">
                    {{ mod.name }}{% if mod.price and mod.price != 0 %} ({% if mod.price > 0 %}+{% endif %}{{ mod.price|floatformat:0|intcomma }}){% endif %}
                </span>
                {% endfor %}
            </div>
            {% endif %}

            {# Notes - Bold, Red, Prominent #}
            {% if item.notes %}
            <div class="mt-1.5 ml-11 bg-red-50 border border-red-200 rounded-md px-2 py-1.5 flex items-start gap-1.5">
                <span class="text-base flex-shrink-0">‚ö†Ô∏è</span>
                <span class="text-sm font-bold text-red-700 uppercase">{{ item.notes }}</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    {# ==================== ACTION FOOTER ==================== #}
    <div class="p-2.5 bg-white border-t border-gray-100">
        {% if order.status == 'new' %}
        <button
            class="w-full py-4 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600 active:from-yellow-700 active:to-orange-700 text-white font-black text-xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98]"
            hx-post="{% url 'kitchen:kds_start' order.id %}"
            hx-target="closest .kds-card"
            hx-swap="outerHTML">
            ‚ñ∂Ô∏è START
        </button>

        {% elif order.status == 'preparing' %}
        <button
            class="w-full py-4 rounded-xl bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 active:from-green-800 active:to-emerald-800 text-white font-black text-xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98] pulse-glow"
            hx-post="{% url 'kitchen:kds_ready' order.id %}"
            hx-swap="delete"
            hx-target="closest .kds-card">
            ‚úÖ DONE
        </button>

        {% elif order.status == 'ready' %}
        <button
            class="w-full py-4 rounded-xl bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 active:from-blue-800 active:to-indigo-800 text-white font-black text-xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98]"
            hx-post="{% url 'kitchen:kds_bump' order.id %}"
            hx-swap="delete"
            hx-target="closest .kds-card">
            üçΩÔ∏è SERVED
        </button>
        {% endif %}
    </div>
</div>

<style>
@keyframes pulse-glow {
    0%, 100% {
        box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
        transform: scale(1);
    }
    50% {
        box-shadow: 0 6px 30px rgba(34, 197, 94, 0.6);
        transform: scale(1.01);
    }
}

.pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
}
</style>
