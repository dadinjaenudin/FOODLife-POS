<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal Setup - {{ store.store_name }}</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
</head>
<body class="bg-gray-100">
    <div class="min-h-screen flex items-center justify-center p-4">
        <div class="max-w-2xl w-full">
            <!-- Store Info -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="text-center">
                    <h1 class="text-2xl font-bold text-gray-800">{{ store.outlet.name }}</h1>
                    <p class="text-gray-600">{{ store.store_name }} ({{ store.store_code }})</p>
                    <p class="text-sm text-gray-500 mt-2">{{ store.outlet.company.name }}</p>
                </div>
            </div>

            <!-- Already Registered Terminal (shown when localStorage has data) -->
            <div id="already-registered" class="bg-white rounded-lg shadow-lg p-8 hidden">
                <div class="text-center mb-6">
                    <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <svg class="w-12 h-12 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-2">Terminal Already Registered</h2>
                    <p class="text-gray-600">This device is already configured as a terminal</p>
                </div>

                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-6 mb-6">
                    <div class="space-y-3">
                        <div class="flex items-center justify-between py-2 border-b border-blue-200">
                            <span class="text-sm font-medium text-gray-600">Terminal Code</span>
                            <span class="text-lg font-bold text-gray-900" id="reg-terminal-code"></span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-blue-200">
                            <span class="text-sm font-medium text-gray-600">Terminal Name</span>
                            <span class="font-semibold text-gray-900" id="reg-terminal-name"></span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-blue-200">
                            <span class="text-sm font-medium text-gray-600">Device Type</span>
                            <span class="font-semibold text-gray-900" id="reg-device-type"></span>
                        </div>
                        <div class="flex items-center justify-between py-2 border-b border-blue-200">
                            <span class="text-sm font-medium text-gray-600">Store</span>
                            <span class="font-semibold text-gray-900" id="reg-store"></span>
                        </div>
                        <div class="flex items-center justify-between py-2">
                            <span class="text-sm font-medium text-gray-600">Company</span>
                            <span class="font-semibold text-gray-900" id="reg-company"></span>
                        </div>
                    </div>
                </div>

                <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6">
                    <div class="flex items-start">
                        <svg class="w-5 h-5 text-green-500 mt-0.5 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                        <div class="text-sm">
                            <p class="font-semibold text-green-800 mb-1">Terminal is Ready</p>
                            <p class="text-green-700">This device is registered and ready to use. You can proceed to POS or click Reset Terminal to register as a different terminal.</p>
                        </div>
                    </div>
                </div>

                <div class="flex gap-3">
                    <a href="{% url 'pos:main' %}" 
                       class="flex-1 px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg hover:from-green-600 hover:to-green-700 transition font-medium text-center shadow-lg">
                        üçΩÔ∏è Open POS
                    </a>
                    <button onclick="resetTerminal()" 
                            class="px-6 py-3 bg-red-100 hover:bg-red-200 text-red-700 font-semibold rounded-lg transition">
                        üîÑ Reset Terminal
                    </button>
                </div>
            </div>

            <!-- Registration Form (shown when no localStorage data) -->
            <div id="registration-form" class="bg-white rounded-lg shadow-lg p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-xl font-bold text-gray-800">üì± Terminal Registration</h2>
                </div>
                
                {% if messages %}
                    {% for message in messages %}
                        <div class="mb-4 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                <form id="terminalForm" method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Device Type -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Device Type *</label>
                        <select name="device_type" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                            <option value="">-- Select Device Type --</option>
                            <option value="pos">üñ•Ô∏è POS / Kasir</option>
                            <option value="tablet">üì± Tablet / Waiter</option>
                            <option value="kiosk">ü§ñ Self-Service Kiosk</option>
                            <option value="kitchen_display">üç≥ Kitchen Display</option>
                        </select>
                    </div>

                    <!-- Terminal Code -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Terminal Code *</label>
                        <input type="text" name="terminal_code" id="terminal_code" required 
                               placeholder="e.g., POS-001, TAB-001, KDS-001"
                               pattern="[A-Z0-9\-]+" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 uppercase"
                               maxlength="20">
                        <div id="code-validation-message" class="mt-2 text-sm hidden"></div>
                        <p class="mt-1 text-sm text-gray-500">Format: POS-001, TAB-001, etc.</p>
                    </div>

                    <!-- Terminal Name -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Terminal Name *</label>
                        <input type="text" name="terminal_name" required 
                               placeholder="e.g., Kasir Depan, Tablet Lantai 2"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                               maxlength="100">
                    </div>

                    <!-- Network Info (Auto-detected) -->
                    <div class="bg-gray-50 rounded-lg p-4 space-y-2">
                        <h3 class="text-sm font-medium text-gray-700">Network Information</h3>
                        <div class="text-sm text-gray-600 space-y-1">
                            <p>üåê IP Address: <span id="ipDisplay" class="font-mono">Detecting...</span></p>
                            <p>üîå MAC Address: <span id="macDisplay" class="font-mono">Detecting...</span></p>
                            <p>üíª Browser: <span id="browserDisplay" class="font-mono">{{ request.META.HTTP_USER_AGENT|truncatewords:10 }}</span></p>
                        </div>
                    </div>

                    <input type="hidden" name="mac_address" id="macAddressInput">

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 transition-colors">
                        Register Terminal
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Detect IP address (shown from backend, but we can enhance with client-side)
        fetch('https://api.ipify.org?format=json')
            .then(res => res.json())
            .then(data => {
                document.getElementById('ipDisplay').textContent = data.ip;
            })
            .catch(() => {
                document.getElementById('ipDisplay').textContent = '{{ request.META.REMOTE_ADDR }}';
            });

        // Try to get MAC address (limited in browser for security)
        // Most modern browsers block this, but we try via server detection
        document.getElementById('macDisplay').textContent = 'Detected by server';

        // Form submission with localStorage
        document.getElementById('terminalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            
            try {
                const response = await fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store terminal info in localStorage (permanent storage)
                    localStorage.setItem('terminal_id', data.terminal.id);
                    localStorage.setItem('terminal_code', data.terminal.code);
                    localStorage.setItem('terminal_name', data.terminal.name);
                    localStorage.setItem('terminal_type', data.terminal.type);
                    localStorage.setItem('store_id', data.terminal.store_id);
                    localStorage.setItem('store_code', data.terminal.store_code);
                    localStorage.setItem('company_id', data.terminal.company_id);
                    localStorage.setItem('company_name', data.terminal.company_name);
                    localStorage.setItem('setup_completed', 'true');
                    localStorage.setItem('setup_date', new Date().toISOString());
                    
                    // Backup to IndexedDB (more persistent)
                    if ('indexedDB' in window) {
                        const dbRequest = indexedDB.open('POSTerminal', 1);
                        dbRequest.onupgradeneeded = function(e) {
                            const db = e.target.result;
                            if (!db.objectStoreNames.contains('config')) {
                                db.createObjectStore('config');
                            }
                        };
                        dbRequest.onsuccess = function(e) {
                            const db = e.target.result;
                            const tx = db.transaction('config', 'readwrite');
                            const store = tx.objectStore('config');
                            store.put(data.terminal, 'terminal');
                        };
                    }
                    
                    // Show success and redirect
                    alert(`‚úÖ ${data.message}\n\nTerminal ID: ${data.terminal.code}\nStore: ${data.terminal.store_code}\nCompany: ${data.terminal.company_name}`);
                    window.location.href = data.redirect;
                } else {
                    alert('‚ùå Registration failed: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('‚ùå Registration failed. Please try again.');
            }
        });

        // Auto-uppercase terminal code and validate
        let validationTimeout;
        const terminalCodeInput = document.getElementById('terminal_code');
        const validationMessage = document.getElementById('code-validation-message');
        const submitButton = document.querySelector('button[type="submit"]');
        
        terminalCodeInput.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
            
            // Clear previous timeout
            clearTimeout(validationTimeout);
            
            const code = e.target.value.trim();
            if (code.length >= 3) {
                // Show checking message
                validationMessage.className = 'mt-2 text-sm text-gray-600';
                validationMessage.textContent = 'üîç Checking availability...';
                validationMessage.classList.remove('hidden');
                
                // Validate after 500ms delay (debounce)
                validationTimeout = setTimeout(async () => {
                    try {
                        const response = await fetch(`/api/terminal/check-code/?code=${encodeURIComponent(code)}`);
                        const data = await response.json();
                        
                        if (data.exists) {
                            validationMessage.className = 'mt-2 text-sm text-red-600 font-medium';
                            validationMessage.textContent = '‚ùå Terminal code already registered';
                            submitButton.disabled = true;
                            submitButton.classList.add('opacity-50', 'cursor-not-allowed');
                        } else {
                            validationMessage.className = 'mt-2 text-sm text-green-600 font-medium';
                            validationMessage.textContent = '‚úÖ Terminal code available';
                            submitButton.disabled = false;
                            submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        }
                    } catch (error) {
                        console.error('Validation error:', error);
                        validationMessage.classList.add('hidden');
                        submitButton.disabled = false;
                        submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                }, 500);
            } else {
                validationMessage.classList.add('hidden');
                submitButton.disabled = false;
                submitButton.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        });
        
        // Check localStorage on page load
        window.addEventListener('DOMContentLoaded', function() {
            const terminalId = localStorage.getItem('terminal_id');
            const terminalCode = localStorage.getItem('terminal_code');
            const terminalName = localStorage.getItem('terminal_name');
            const terminalType = localStorage.getItem('terminal_type');
            const storeCode = localStorage.getItem('store_code');
            const companyName = localStorage.getItem('company_name');
            const setupDate = localStorage.getItem('setup_date');
            
            // Check if terminal is already registered
            if (terminalId && terminalCode) {
                // Show "Already Registered" screen
                document.getElementById('already-registered').classList.remove('hidden');
                document.getElementById('registration-form').classList.add('hidden');
                
                // Populate registered terminal info
                document.getElementById('reg-terminal-code').textContent = terminalCode || 'N/A';
                document.getElementById('reg-terminal-name').textContent = terminalName || 'N/A';
                
                // Format device type
                const typeMap = {
                    'pos': 'üñ•Ô∏è POS / Kasir',
                    'tablet': 'üì± Tablet / Waiter',
                    'kiosk': 'ü§ñ Self-Service Kiosk',
                    'kitchen_display': 'üç≥ Kitchen Display'
                };
                document.getElementById('reg-device-type').textContent = typeMap[terminalType] || terminalType || 'N/A';
                document.getElementById('reg-store').textContent = storeCode || 'N/A';
                document.getElementById('reg-company').textContent = companyName || 'N/A';
            } else {
                // Show registration form
                document.getElementById('already-registered').classList.add('hidden');
                document.getElementById('registration-form').classList.remove('hidden');
            }
        });
        
        // Reset terminal function (Client-side only - clears this device registration)
        // Terminal record remains in database for audit/history
        function resetTerminal() {
            if (confirm('‚ö†Ô∏è Reset Terminal on This Device?\n\nThis will:\n‚Ä¢ Clear terminal registration from THIS device only\n‚Ä¢ Terminal data remains in database (for history)\n‚Ä¢ You can re-register with same or different terminal code\n\nContinue?')) {
                // Clear localStorage
                localStorage.removeItem('terminal_id');
                localStorage.removeItem('terminal_code');
                localStorage.removeItem('terminal_name');
                localStorage.removeItem('terminal_type');
                localStorage.removeItem('store_id');
                localStorage.removeItem('store_code');
                localStorage.removeItem('company_id');
                localStorage.removeItem('company_name');
                localStorage.removeItem('setup_completed');
                localStorage.removeItem('setup_date');
                
                // Clear IndexedDB
                if ('indexedDB' in window) {
                    const dbRequest = indexedDB.deleteDatabase('POSTerminal');
                    dbRequest.onsuccess = function() {
                        console.log('‚úÖ IndexedDB cleared');
                    };
                }
                
                alert('‚úÖ Terminal cleared from this device.\n\nYou can now:\n‚Ä¢ Re-register with a different terminal code\n‚Ä¢ Register as a new terminal\n‚Ä¢ Use this device for another store');
                location.reload();
            }
        }
    </script>
</body>
</html>
