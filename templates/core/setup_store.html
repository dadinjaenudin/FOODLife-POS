<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup Store - Edge Server</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/output.css' %}">
    <script src="{% static 'js/sweetalert2.min.js' %}"></script>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">üè™</div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">Setup Server POS</h1>
            <p class="text-gray-600">Configure your store identity for this Edge Server</p>
        </div>

        <!-- Setup Form -->
        <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8">
            {% if messages %}
            {% for message in messages %}
            <div
                class="mb-6 p-4 rounded-lg {% if message.tags == 'error' %}bg-red-100 text-red-800{% else %}bg-green-100 text-green-800{% endif %}">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}

            <form method="post" action="{% url 'core:setup_store_config' %}" class="space-y-6" id="setupForm">
                {% csrf_token %}

                <!-- Hidden company_id field -->
                <input type="hidden" name="company_id" id="company_id_hidden" value="">

                <!-- Step 1: Select Company -->
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Company *</label>
                    <select id="company_select" required
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Loading Companies... --</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Select which company this store belongs to</p>
                </div>

                <!-- Step 2: Select Store from HO -->
                <div id="store_dropdown_container" style="display: none;">
                    <label class="block text-sm font-bold text-gray-700 mb-2">Store from HO Server *</label>
                    <select id="store_select" name="ho_store_id" required
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <option value="">-- Select Company First --</option>
                    </select>
                    <p class="mt-1 text-sm text-gray-500">Select store from HO Server master data</p>
                </div>

                <!-- Info: Store will be pulled from HO -->
                <div id="store_info_box" class="bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded"
                    style="display: none;">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-yellow-700 font-medium">Store data will be pulled from HO Server</p>
                            <p class="mt-1 text-sm text-yellow-600">
                                Store code, name, address, and other details will be automatically synced from HO master
                                data.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Info: What will be synced -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700 font-medium">What happens after setup?</p>
                            <ul class="mt-2 text-sm text-blue-600 list-disc list-inside">
                                <li>Company & Store configuration</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Info Box -->
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd"
                                    d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z"
                                    clip-rule="evenodd" />
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700 font-medium">Important</p>
                            <p class="mt-1 text-sm text-blue-600">
                                This will save the store configuration directly to this Edge Server database.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex items-center space-x-4">
                    <button type="submit" id="setupButton"
                        class="flex-1 bg-blue-600 text-white py-4 px-6 rounded-lg font-bold text-lg hover:bg-blue-700 transition-colors shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        üöÄ Setup Store
                    </button>
                </div>
            </form>

            <!-- After setup -->
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600">
                    After Setup store, you can login to admin page
                    <a href="{% url 'core:terminal_setup' %}"
                        class="text-blue-600 hover:text-blue-800 font-medium">/setup/terminal/</a>
                </p>
            </div>
        </div>

        <script>
            // Helper function to get CSRF token
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }



            // Load companies from API on page load
            document.addEventListener('DOMContentLoaded', function () {
                const companySelect = document.getElementById('company_select');
                const companyIdHidden = document.getElementById('company_id_hidden');
                const storeSelect = document.getElementById('store_select');
                const storeDropdownContainer = document.getElementById('store_dropdown_container');
                const setupForm = document.getElementById('setupForm');
                const setupButton = document.getElementById('setupButton');

                // Function to load companies from HO Server
                function loadCompanies() {
                    companySelect.innerHTML = '<option value="">-- Loading Companies from HO... --</option>';

                    fetch('/api/ho/companies/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            companySelect.innerHTML = '<option value="">-- Select Company --</option>';

                            if (data.companies && data.companies.length > 0) {
                                data.companies.forEach(company => {
                                    const option = document.createElement('option');
                                    option.value = company.id;
                                    option.textContent = `${company.name} (${company.code})`;
                                    companySelect.appendChild(option);
                                });
                            } else {
                                companySelect.innerHTML = '<option value="">-- No Companies Found in HO --</option>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading companies from HO:', error);
                            companySelect.innerHTML = '<option value="">-- Error: Check HO Server Connection --</option>';
                        });
                }

                // Function to load stores from HO Server based on company
                function loadStores(companyId) {
                    if (!companyId) {
                        storeDropdownContainer.style.display = 'none';
                        storeSelect.innerHTML = '<option value="">-- Select Company First --</option>';
                        return;
                    }

                    storeDropdownContainer.style.display = 'block';
                    storeSelect.innerHTML = '<option value="">-- Loading Stores from HO... --</option>';

                    fetch('/api/ho/stores/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ company_id: companyId })
                    })
                        .then(response => response.json())
                        .then(data => {
                            storeSelect.innerHTML = '<option value="">-- Select Store --</option>';

                            if (data.stores && data.stores.length > 0) {
                                data.stores.forEach(store => {
                                    const option = document.createElement('option');
                                    option.value = store.id;
                                    option.textContent = `${store.store_name} (${store.store_code})`;
                                    storeSelect.appendChild(option);
                                });
                            } else {
                                storeSelect.innerHTML = '<option value="">-- No Stores Found for this Company --</option>';
                            }
                        })
                        .catch(error => {
                            console.error('Error loading stores from HO:', error);
                            storeSelect.innerHTML = '<option value="">-- Error: Check HO Server Connection --</option>';
                        });
                }

                // Initial load
                loadCompanies();

                // When company is selected, update hidden field and load stores
                companySelect.addEventListener('change', function () {
                    const companyId = this.value;
                    companyIdHidden.value = companyId;
                    loadStores(companyId);
                });

                // When store is selected, show info box
                storeSelect.addEventListener('change', function () {
                    const storeId = this.value;
                    const storeInfoBox = document.getElementById('store_info_box');

                    if (storeId) {
                        storeInfoBox.style.display = 'block';
                    } else {
                        storeInfoBox.style.display = 'none';
                    }
                });

                // Handle form submission with AJAX and SweetAlert
                setupForm.addEventListener('submit', function (e) {
                    e.preventDefault();

                    const companyId = companyIdHidden.value;
                    const storeId = storeSelect.value;

                    if (!companyId || !storeId) {
                        Swal.fire({
                            icon: 'warning',
                            title: 'Data Tidak Lengkap',
                            text: 'Silakan pilih Company dan Store terlebih dahulu',
                            confirmButtonColor: '#3B82F6'
                        });
                        return;
                    }

                    // Disable button and show loading
                    setupButton.disabled = true;
                    setupButton.innerHTML = '‚è≥ Processing...';

                    // Show loading alert
                    Swal.fire({
                        title: 'Sedang Setup Store...',
                        html: 'Mohon tunggu, sedang mengambil data dari HO Server dan menyimpan ke database Edge Server.',
                        allowOutsideClick: false,
                        allowEscapeKey: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Submit form via AJAX
                    const formData = new FormData(setupForm);

                    fetch(setupForm.action, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: formData
                    })
                        .then(response => response.json())
                        .then(data => {
                            setupButton.disabled = false;
                            setupButton.innerHTML = 'üöÄ Setup Store';

                            if (data.success) {
                                // Success - show success message
                                Swal.fire({
                                    icon: 'success',
                                    title: '‚úÖ Setup Berhasil!',
                                    html: `
                                        <div class="text-left">
                                            <p class="mb-2"><strong>Company:</strong> ${data.company_name}</p>
                                            <p class="mb-2"><strong>Store:</strong> ${data.store_name} (${data.store_code})</p>
                                            ${data.brand_count ? `<p class="mb-2"><strong>Brands:</strong> ${data.brand_names} (${data.brand_count} brand${data.brand_count > 1 ? 's' : ''})</p>` : ''}
                                            <hr class="my-3">
                                            <p class="mb-2"><strong>Langkah Selanjutnya:</strong></p>
                                            <p class="text-sm text-gray-600 mb-2">
                                                ${data.next_step || 'Silakan login dan sync master data dari menu Management > Master Data'}
                                            </p>
                                            <div class="bg-blue-50 p-3 rounded mt-3">
                                                <p class="text-sm text-blue-800">
                                                    üí° <strong>Tip:</strong> Setelah login, buka menu <strong>Management > Master Data</strong> 
                                                    untuk sync Categories, Products, dan data lainnya dari HO Server.
                                                </p>
                                            </div>
                                        </div>
                                    `,
                                    confirmButtonText: 'Login Sekarang',
                                    confirmButtonColor: '#10B981'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = '/login/';
                                    }
                                });
                            } else if (data.already_configured) {
                                // Already configured - show warning
                                Swal.fire({
                                    icon: 'info',
                                    title: '‚ö†Ô∏è Store Telah Di-Setup',
                                    html: `
                                        <div class="text-left">
                                            <p class="mb-2">Store telah di-setup sebelumnya:</p>
                                            <p class="mb-2"><strong>Company:</strong> ${data.company_name}</p>
                                            <p class="mb-2"><strong>Store:</strong> ${data.store_name} (${data.store_code})</p>
                                            <hr class="my-3">
                                            <p class="text-sm text-gray-600">Silakan login untuk menggunakan sistem.</p>
                                        </div>
                                    `,
                                    confirmButtonText: 'Login Sekarang',
                                    confirmButtonColor: '#3B82F6',
                                    showCancelButton: true,
                                    cancelButtonText: 'Tutup',
                                    cancelButtonColor: '#6B7280'
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        window.location.href = '/login/';
                                    }
                                });
                            } else {
                                // Error
                                Swal.fire({
                                    icon: 'error',
                                    title: '‚ùå Setup Gagal',
                                    text: data.message || 'Terjadi kesalahan saat setup store',
                                    confirmButtonColor: '#EF4444'
                                });
                            }
                        })
                        .catch(error => {
                            setupButton.disabled = false;
                            setupButton.innerHTML = 'üöÄ Setup Store';

                            console.error('Setup error:', error);
                            Swal.fire({
                                icon: 'error',
                                title: '‚ùå Error',
                                text: 'Terjadi kesalahan koneksi. Silakan coba lagi.',
                                confirmButtonColor: '#EF4444'
                            });
                        });
                });
            });
        </script>
    </div>
</body>

</html>