networks:
  pos_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16  # Explicit subnet to avoid conflict with LAN 172.17.x.x

services:
  # PostgreSQL Database untuk Edge Server
  edge_db:
    image: postgres:16-alpine
    container_name: fnb_edge_db
    environment:
      POSTGRES_DB: fnb_edge_db
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres123
    volumes:
      - edge_postgres_data:/var/lib/postgresql/data
    ports:
      - "5433:5432"  # Port 5433 untuk Edge (avoid conflict dengan HO port 5432)
    networks:
      - pos_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache & Broker untuk Edge Server
  edge_redis:
    image: redis:7-alpine
    container_name: fnb_edge_redis
    ports:
      - "6380:6379"  # Port 6380 untuk Edge (avoid conflict dengan HO port 6379)
    networks:
      - pos_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Django Application - Edge Server
  edge_web:
    build: .
    container_name: fnb_edge_web
    entrypoint: []
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        while ! nc -z edge_db 5432; do sleep 1; done &&
        echo 'Database is ready!' &&
        echo 'Waiting for MinIO...' &&
        while ! nc -z edgeminio 9000; do sleep 1; done &&
        echo 'MinIO is ready!' &&
        python manage.py migrate &&
        python manage.py runserver 0.0.0.0:8000
      "
    volumes:
      - .:/app
      - edge_static_volume:/app/staticfiles
      - ./media:/app/media
    ports:
      - "8001:8000"  # Port 8001 untuk Edge Web (avoid conflict dengan HO port 8002)
    env_file:
      - .env.edge
    depends_on:
      edge_db:
        condition: service_healthy
      edge_redis:
        condition: service_healthy
      edge_minio:
        condition: service_healthy
    networks:
      - pos_network
    restart: unless-stopped
    environment:
      - DB_HOST=edge_db
      - DB_PORT=5432
      - DB_NAME=fnb_edge_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres123
      - REDIS_URL=redis://edge_redis:6379/0
      - EDGE_MINIO_ENDPOINT=edgeminio:9000
      - EDGE_MINIO_ACCESS_KEY=foodlife_admin
      - EDGE_MINIO_SECRET_KEY=foodlife_secret_2026
      - EDGE_MINIO_SECURE=False
      - HO_API_URL=http://host.docker.internal:8002
      - HO_API_USERNAME=admin
      - HO_API_PASSWORD=admin123
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0,host.docker.internal

  # Celery Worker untuk Edge Server
  edge_celery_worker:
    build: .
    container_name: fnb_edge_celery_worker
    entrypoint: []
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        while ! nc -z edge_db 5432; do sleep 1; done &&
        echo 'Waiting for MinIO...' &&
        while ! nc -z edgeminio 9000; do sleep 1; done &&
        celery -A pos_fnb worker -l info
      "
    volumes:
      - .:/app
    env_file:
      - .env.edge
    depends_on:
      - edge_db
      - edge_redis
      - edge_web
      - edge_minio
    networks:
      - pos_network
    environment:
      - DB_HOST=edge_db
      - DB_PORT=5432
      - DB_NAME=fnb_edge_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres123
      - REDIS_URL=redis://edge_redis:6379/0
      - EDGE_MINIO_ENDPOINT=edgeminio:9000
      - EDGE_MINIO_ACCESS_KEY=foodlife_admin
      - EDGE_MINIO_SECRET_KEY=foodlife_secret_2026
      - EDGE_MINIO_SECURE=False

  # Celery Beat Scheduler untuk Edge Server
  edge_celery_beat:
    build: .
    container_name: fnb_edge_celery_beat
    entrypoint: []
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        while ! nc -z edge_db 5432; do sleep 1; done &&
        echo 'Waiting for MinIO...' &&
        while ! nc -z edgeminio 9000; do sleep 1; done &&
        celery -A pos_fnb beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
      "
    volumes:
      - .:/app
    env_file:
      - .env.edge
    depends_on:
      - edge_db
      - edge_redis
      - edge_web
      - edge_minio
    networks:
      - pos_network
    environment:
      - DB_HOST=edge_db
      - DB_PORT=5432
      - DB_NAME=fnb_edge_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres123
      - REDIS_URL=redis://edge_redis:6379/0
      - EDGE_MINIO_ENDPOINT=edgeminio:9000
      - EDGE_MINIO_ACCESS_KEY=foodlife_admin
      - EDGE_MINIO_SECRET_KEY=foodlife_secret_2026
      - EDGE_MINIO_SECURE=False

  # Kitchen Printer Agent - polls DB for print tickets, sends to network printers
  # Uses network_mode: host so container can reach LAN printers (172.17.x.x)
  # without Docker bridge subnet conflict
  kitchen_agent:
    build: .
    container_name: fnb_kitchen_agent
    network_mode: host
    entrypoint: []
    command: >
      sh -c "
        echo 'Waiting for database...' &&
        while ! nc -z localhost 5433; do sleep 1; done &&
        echo 'Database is ready!' &&
        python kitchen_printer_agent/kitchen_agent.py
      "
    environment:
      - DB_HOST=localhost
      - DB_PORT=5433
      - DB_NAME=fnb_edge_db
      - DB_USER=postgres
      - DB_PASSWORD=postgres123
      - AGENT_NAME=Kitchen-Agent-1
      - STATION_IDS=1,2,3
      - HEALTH_SERVER_PORT=5001
    volumes:
      - .:/app
    depends_on:
      edge_db:
        condition: service_healthy
    restart: unless-stopped

  # MinIO Object Storage untuk Product Images (Edge Storage - fallback/cache)
  edge_minio:
    image: minio/minio:latest
    container_name: fnb_edge_minio
    ports:
      - "9002:9000"  # MinIO API (Edge - port 9002)
      - "9003:9001"  # MinIO Console (Edge - port 9003)
    environment:
      MINIO_ROOT_USER: foodlife_admin
      MINIO_ROOT_PASSWORD: foodlife_secret_2026
      MINIO_SERVER_URL: http://edgeminio:9000
    volumes:
      - edge_minio_data:/data
    command: server /data --console-address ":9001"
    restart: unless-stopped
    networks:
      pos_network:
        aliases:
          - edgeminio
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  edge_postgres_data:
  edge_static_volume:
  edge_media_volume:
  edge_minio_data:
